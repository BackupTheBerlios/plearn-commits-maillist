<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Plearn-commits] r6834 - in trunk: commands/PLearnCommands plearn/base plearn/base/test plearn/base/test/ObjectGraphIterator plearn/base/test/PP plearn/io plearn/io/test plearn/math plearn/math/test/PentadiagonalSolveInPlace plearn/math/test/TMat plearn/math/test/VecStatsCollector plearn/math/test/pl_math plearn/misc plearn/misc/test plearn/opt/test plearn/python plearn/python/test plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results plearn/var/test plearn/vmat plearn/vmat/test plearn_learners/classifiers/test/KNNClassifier plearn_learners/distributions/test plearn_learners/generic plearn_learners/generic/test/SimpleNet plearn_learners/meta plearn_learners/regressors plearn_learners/regressors/test/GaussianProcessRegressor plearn_learners/regressors/test/KernelRidgeRegressor plearn_learners/regressors/test/LinearRegressor plearn_learners/regressors/test/PLS plearn_learners/regressors/test/StackedPCARegression plearn_learners/unsupervised/test python_modules/p! learn/math/test python_modules/plearn/parallel python_modules/plearn/plide python_modules/plearn/plide/resources python_modules/plearn/pyplearn python_modules/plearn/utilities scripts
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/plearn-commits/2007-April/index.html" >
   <LINK REL="made" HREF="mailto:plearn-commits%40lists.berlios.de?Subject=Re%3A%20%5BPlearn-commits%5D%20r6834%20-%20in%20trunk%3A%20commands/PLearnCommands%0A%20plearn/base%20plearn/base/test%20plearn/base/test/ObjectGraphIterator%0A%20plearn/base/test/PP%20plearn/io%20plearn/io/test%20plearn/math%0A%20plearn/math/test/PentadiagonalSolveInPlace%20plearn/math/test/TMat%0A%20plearn/math/test/VecStatsCollector%20plearn/math/test/pl_math%20plearn/misc%0A%20plearn/misc/test%20plearn/opt/test%20plearn/python%20plearn/python/test%0A%20plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results%0A%20plearn/var/test%20plearn/vmat%20plearn/vmat/test%0A%20plearn_learners/classifiers/test/KNNClassifier%0A%20plearn_learners/distributions/test%20plearn_learners/generic%0A%20plearn_learners/generic/test/SimpleNet%20plearn_learners/meta%0A%20plearn_learners/regressors%0A%20plearn_learners/regressors/test/GaussianProcessRegressor%0A%20plearn_learners/regressors/test/KernelRidgeRegressor%0A%20plearn_learners/regressors/test/LinearRegressor%0A%20plearn_learners/regressors/test/PLS%0A%20plearn_learners/regressors/test/StackedPCARegression%0A%20plearn_learners/unsupervised/test%20python_modules/p%21%20learn/math/test%0A%20python_modules/plearn/parallel%20python_modules/plearn/plide%0A%20python_modules/plearn/plide/resources%20python_modules/plearn/pyplearn%0A%20python_modules/plearn/utilities%20scripts&In-Reply-To=%3C200704050135.l351ZiG1026678%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000282.html">
   <LINK REL="Next"  HREF="000284.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Plearn-commits] r6834 - in trunk: commands/PLearnCommands plearn/base plearn/base/test plearn/base/test/ObjectGraphIterator plearn/base/test/PP plearn/io plearn/io/test plearn/math plearn/math/test/PentadiagonalSolveInPlace plearn/math/test/TMat plearn/math/test/VecStatsCollector plearn/math/test/pl_math plearn/misc plearn/misc/test plearn/opt/test plearn/python plearn/python/test plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results plearn/var/test plearn/vmat plearn/vmat/test plearn_learners/classifiers/test/KNNClassifier plearn_learners/distributions/test plearn_learners/generic plearn_learners/generic/test/SimpleNet plearn_learners/meta plearn_learners/regressors plearn_learners/regressors/test/GaussianProcessRegressor plearn_learners/regressors/test/KernelRidgeRegressor plearn_learners/regressors/test/LinearRegressor plearn_learners/regressors/test/PLS plearn_learners/regressors/test/StackedPCARegression plearn_learners/unsupervised/test python_modules/p! learn/math/test python_modules/plearn/parallel python_modules/plearn/plide python_modules/plearn/plide/resources python_modules/plearn/pyplearn python_modules/plearn/utilities scripts</H1>
    <B>saintmlx at BerliOS</B> 
    <A HREF="mailto:plearn-commits%40lists.berlios.de?Subject=Re%3A%20%5BPlearn-commits%5D%20r6834%20-%20in%20trunk%3A%20commands/PLearnCommands%0A%20plearn/base%20plearn/base/test%20plearn/base/test/ObjectGraphIterator%0A%20plearn/base/test/PP%20plearn/io%20plearn/io/test%20plearn/math%0A%20plearn/math/test/PentadiagonalSolveInPlace%20plearn/math/test/TMat%0A%20plearn/math/test/VecStatsCollector%20plearn/math/test/pl_math%20plearn/misc%0A%20plearn/misc/test%20plearn/opt/test%20plearn/python%20plearn/python/test%0A%20plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results%0A%20plearn/var/test%20plearn/vmat%20plearn/vmat/test%0A%20plearn_learners/classifiers/test/KNNClassifier%0A%20plearn_learners/distributions/test%20plearn_learners/generic%0A%20plearn_learners/generic/test/SimpleNet%20plearn_learners/meta%0A%20plearn_learners/regressors%0A%20plearn_learners/regressors/test/GaussianProcessRegressor%0A%20plearn_learners/regressors/test/KernelRidgeRegressor%0A%20plearn_learners/regressors/test/LinearRegressor%0A%20plearn_learners/regressors/test/PLS%0A%20plearn_learners/regressors/test/StackedPCARegression%0A%20plearn_learners/unsupervised/test%20python_modules/p%21%20learn/math/test%0A%20python_modules/plearn/parallel%20python_modules/plearn/plide%0A%20python_modules/plearn/plide/resources%20python_modules/plearn/pyplearn%0A%20python_modules/plearn/utilities%20scripts&In-Reply-To=%3C200704050135.l351ZiG1026678%40sheep.berlios.de%3E"
       TITLE="[Plearn-commits] r6834 - in trunk: commands/PLearnCommands plearn/base plearn/base/test plearn/base/test/ObjectGraphIterator plearn/base/test/PP plearn/io plearn/io/test plearn/math plearn/math/test/PentadiagonalSolveInPlace plearn/math/test/TMat plearn/math/test/VecStatsCollector plearn/math/test/pl_math plearn/misc plearn/misc/test plearn/opt/test plearn/python plearn/python/test plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results plearn/var/test plearn/vmat plearn/vmat/test plearn_learners/classifiers/test/KNNClassifier plearn_learners/distributions/test plearn_learners/generic plearn_learners/generic/test/SimpleNet plearn_learners/meta plearn_learners/regressors plearn_learners/regressors/test/GaussianProcessRegressor plearn_learners/regressors/test/KernelRidgeRegressor plearn_learners/regressors/test/LinearRegressor plearn_learners/regressors/test/PLS plearn_learners/regressors/test/StackedPCARegression plearn_learners/unsupervised/test python_modules/p! learn/math/test python_modules/plearn/parallel python_modules/plearn/plide python_modules/plearn/plide/resources python_modules/plearn/pyplearn python_modules/plearn/utilities scripts">saintmlx at mail.berlios.de
       </A><BR>
    <I>Thu Apr  5 03:35:44 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000282.html">[Plearn-commits] r6833 - trunk/plearn_learners/classifiers
</A></li>
        <LI>Next message: <A HREF="000284.html">[Plearn-commits] r6835 - trunk/plearn/misc
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#283">[ date ]</a>
              <a href="thread.html#283">[ thread ]</a>
              <a href="subject.html#283">[ subject ]</a>
              <a href="author.html#283">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: saintmlx
Date: 2007-04-05 03:35:37 +0200 (Thu, 05 Apr 2007)
New Revision: 6834

Added:
   trunk/python_modules/plearn/utilities/pltraceback.py
Modified:
   trunk/commands/PLearnCommands/HelpCommand.cc
   trunk/commands/PLearnCommands/PLearnCommandRegistry.cc
   trunk/commands/PLearnCommands/PLearnCommandRegistry.h
   trunk/commands/PLearnCommands/Plide.cc
   trunk/commands/PLearnCommands/ServerCommand.cc
   trunk/commands/PLearnCommands/plearn_main.cc
   trunk/plearn/base/HelpSystem.cc
   trunk/plearn/base/HelpSystem.h
   trunk/plearn/base/Object.h
   trunk/plearn/base/TypeFactory.cc
   trunk/plearn/base/TypeFactory.h
   trunk/plearn/base/test/ObjectGraphIterator/pytest.config
   trunk/plearn/base/test/PP/pytest.config
   trunk/plearn/base/test/pytest.config
   trunk/plearn/io/PStream.cc
   trunk/plearn/io/PStream.h
   trunk/plearn/io/fileutils.cc
   trunk/plearn/io/fileutils.h
   trunk/plearn/io/pl_log.cc
   trunk/plearn/io/pl_log.h
   trunk/plearn/io/test/pytest.config
   trunk/plearn/math/TMat_decl.h
   trunk/plearn/math/TMat_maths_impl.h
   trunk/plearn/math/test/PentadiagonalSolveInPlace/pytest.config
   trunk/plearn/math/test/TMat/pytest.config
   trunk/plearn/math/test/VecStatsCollector/pytest.config
   trunk/plearn/math/test/pl_math/pytest.config
   trunk/plearn/misc/PLearnServer.cc
   trunk/plearn/misc/PLearnServer.h
   trunk/plearn/misc/PLearnService.cc
   trunk/plearn/misc/PLearnService.h
   trunk/plearn/misc/RemotePLearnServer.cc
   trunk/plearn/misc/test/pytest.config
   trunk/plearn/misc/vmatmain.cc
   trunk/plearn/opt/test/pytest.config
   trunk/plearn/python/PythonCodeSnippet.cc
   trunk/plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results/RUN.log
   trunk/plearn/python/test/pytest.config
   trunk/plearn/var/test/pytest.config
   trunk/plearn/vmat/BootstrapSplitter.cc
   trunk/plearn/vmat/EncodedVMatrix.cc
   trunk/plearn/vmat/VMatLanguage.cc
   trunk/plearn/vmat/test/pytest.config
   trunk/plearn_learners/classifiers/test/KNNClassifier/pytest.config
   trunk/plearn_learners/distributions/test/pytest.config
   trunk/plearn_learners/generic/PLearner.cc
   trunk/plearn_learners/generic/VPLCombinedLearner.cc
   trunk/plearn_learners/generic/VPLPreprocessedLearner2.cc
   trunk/plearn_learners/generic/test/SimpleNet/pytest.config
   trunk/plearn_learners/meta/BaggingLearner.cc
   trunk/plearn_learners/meta/BaggingLearner.h
   trunk/plearn_learners/regressors/LinearRegressor.cc
   trunk/plearn_learners/regressors/test/GaussianProcessRegressor/pytest.config
   trunk/plearn_learners/regressors/test/KernelRidgeRegressor/pytest.config
   trunk/plearn_learners/regressors/test/LinearRegressor/pytest.config
   trunk/plearn_learners/regressors/test/PLS/pytest.config
   trunk/plearn_learners/regressors/test/StackedPCARegression/pytest.config
   trunk/plearn_learners/unsupervised/test/pytest.config
   trunk/python_modules/plearn/math/test/pytest.config
   trunk/python_modules/plearn/parallel/dispatch.py
   trunk/python_modules/plearn/plide/plide.py
   trunk/python_modules/plearn/plide/plide_help.py
   trunk/python_modules/plearn/plide/plide_options.py
   trunk/python_modules/plearn/plide/resources/help_prolog.html
   trunk/python_modules/plearn/pyplearn/plargs.py
   trunk/python_modules/plearn/pyplearn/pytest.config
   trunk/scripts/xdispatch
Log:
- migrated most help to HelpSystem
- ran pytest update --all
- made plide run stand-alone
- parallelized BaggingLearner::train
- more details for python errors (PythonCodeSnippet)
- added erf to VMatLanguage
- minor fixes here and there



Modified: trunk/commands/PLearnCommands/HelpCommand.cc
===================================================================
--- trunk/commands/PLearnCommands/HelpCommand.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/commands/PLearnCommands/HelpCommand.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -38,12 +38,13 @@
 
 /*! \file HelpCommand.cc */
 #include &quot;HelpCommand.h&quot;
+
 #include &lt;iostream&gt;
 #include &lt;plearn/db/getDataSet.h&gt;
 #include &lt;plearn/base/general.h&gt;        //!&lt; For prgname().
 #include &lt;plearn/base/stringutils.h&gt;
-#include &lt;plearn/base/TypeFactory.h&gt;    //!&lt; For displayObjectHelp().
 #include &lt;plearn/io/fileutils.h&gt;        //!&lt; For isfile().
+
 #include &lt;plearn/base/HelpSystem.h&gt;
 
 namespace PLearn {
@@ -104,8 +105,7 @@
          &lt;&lt; &quot;  % &quot; + prgname()  + &quot; command_name command_arguments \n&quot; &lt;&lt; endl;
 
     pout &lt;&lt; &quot;Available commands are: &quot; &lt;&lt; endl;
-    PLearnCommandRegistry::print_command_summary(cout); // TODO Change to pout.
-    pout &lt;&lt; endl;
+    pout &lt;&lt; HelpSystem::helpCommands() &lt;&lt; endl;
 
     pout &lt;&lt; &quot;For more details on a specific command, type: \n&quot; 
          &lt;&lt; &quot;  % &quot; &lt;&lt; prgname() &lt;&lt; &quot; help &lt;command_name&gt; \n&quot;
@@ -130,22 +130,22 @@
 void HelpCommand::run(const vector&lt;string&gt;&amp; args)
 {
     if(args.size()==0)
-        helpOverview();
+        helpOverview();//TODO: move to HelpSystem
     else
     {
         string about = args[0];
         if(extract_extension(about)==&quot;.plearn&quot;) // help is asked about a plearn script
-            helpAboutScript(about);
+            helpAboutScript(about);//TODO: move to HelpSystem
         if(about==&quot;scripts&quot;)
-            helpScripts();
+            helpScripts();//TODO: move to HelpSystem
         else if(about==&quot;commands&quot;)
             helpCommands();
         else if(about==&quot;datasets&quot;)
-            helpDatasets();
+            helpDatasets();//TODO: move to HelpSystem
         else if(PLearnCommandRegistry::is_registered(about))
-            PLearnCommandRegistry::help(about, cout); // TODO Change to pout.
+            pout &lt;&lt; HelpSystem::helpOnCommand(about) &lt;&lt; flush;
         else 
-            displayObjectHelp(cout, about);   // TODO Change to pout.
+            pout &lt;&lt; HelpSystem::helpOnClass(about) &lt;&lt; flush;
     }
 }
 

Modified: trunk/commands/PLearnCommands/PLearnCommandRegistry.cc
===================================================================
--- trunk/commands/PLearnCommands/PLearnCommandRegistry.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/commands/PLearnCommands/PLearnCommandRegistry.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -40,6 +40,8 @@
 #include &quot;PLearnCommandRegistry.h&quot;
 #include &lt;iostream&gt;
 #include &lt;vector&gt;
+#include &lt;plearn/base/HelpSystem.h&gt;
+#include &lt;plearn/io/PStream.h&gt;
 
 namespace PLearn {
 using namespace std;
@@ -50,13 +52,13 @@
     return commands_;
 }
 
-
 void PLearnCommandRegistry::do_register(PLearnCommand* command)
 { commands()[command-&gt;name] = command; }
 
 bool PLearnCommandRegistry::is_registered(const string&amp; commandname)
 { return commands().find(commandname)!=commands().end(); }
-  
+
+/*  
 void PLearnCommandRegistry::print_command_summary(ostream&amp; out)
 {
     command_map::iterator it = commands().begin();
@@ -68,14 +70,16 @@
     }
     out &lt;&lt; endl;
 }
+*/
 
 //! Issues a &quot;bad command&quot; message
 void PLearnCommandRegistry::badcommand(const string&amp; commandname)
 {
-    cerr &lt;&lt; &quot;No '&quot; &lt;&lt; commandname &lt;&lt; &quot;' command available.&quot; &lt;&lt; endl;
-    cerr &lt;&lt; &quot;Available commands are: &quot; &lt;&lt; endl;
-    print_command_summary(cerr);
-    cerr &lt;&lt; &quot;You can get more help for any of these commands by invoking the help command&quot; &lt;&lt; endl;
+    perr &lt;&lt; &quot;No '&quot; &lt;&lt; commandname &lt;&lt; &quot;' command available.&quot; &lt;&lt; endl;
+    perr &lt;&lt; &quot;Available commands are: &quot; &lt;&lt; endl;
+    //print_command_summary(cerr);
+    perr &lt;&lt; HelpSystem::helpCommands() &lt;&lt; flush;
+    perr &lt;&lt; &quot;You can get more help for any of these commands by invoking the help command&quot; &lt;&lt; endl;
 }
 
 void PLearnCommandRegistry::run(const string&amp; commandname, const vector&lt;string&gt;&amp; args)
@@ -86,7 +90,16 @@
     else
         it-&gt;second-&gt;run(args);
 }
-  
+
+PLearnCommand* PLearnCommandRegistry::getCommand(const string&amp; commandname)
+{
+    command_map::iterator it = commands().find(commandname);
+    if(it==commands().end()) badcommand(commandname);
+    return it-&gt;second;
+}
+
+
+/*  
 void PLearnCommandRegistry::help(const string&amp; commandname, ostream&amp; out)
 { 
     command_map::iterator it = commands().find(commandname);
@@ -99,6 +112,7 @@
         out &lt;&lt; it-&gt;second-&gt;helpmsg &lt;&lt; endl;        
     }
 }
+*/
 
 } // end of namespace PLearn
 

Modified: trunk/commands/PLearnCommands/PLearnCommandRegistry.h
===================================================================
--- trunk/commands/PLearnCommands/PLearnCommandRegistry.h	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/commands/PLearnCommands/PLearnCommandRegistry.h	2007-04-05 01:35:37 UTC (rev 6834)
@@ -56,15 +56,26 @@
     // Minor help for the HTML helper here...
     friend class HTMLHelpCommand;
 
-protected:
+<A HREF="public://">public://</A> public so that the command map can be read
     typedef map&lt;string, PLearnCommand*&gt; command_map;
 
+protected:
+
     //! Issues a &quot;bad command&quot; message
     static void badcommand(const string&amp; commandname);
 
+    //! Returns a reference to the unique command map
+    static command_map&amp; commands();
  
 public:
 
+    //! Returns a const reference to the unique command map
+    inline static const command_map&amp; allCommands() 
+    { return commands(); }
+
+    //! Returns the PLearnCommand with the given name, or error
+    static PLearnCommand* getCommand(const string&amp; commandname);
+
     //! registers a command
     static void do_register(PLearnCommand* command);
 
@@ -72,20 +83,18 @@
     static bool is_registered(const string&amp; commandname);
   
     //! prints a list of all commands with their one-line summary
-    static void print_command_summary(ostream&amp; out);
+    //static void print_command_summary(ostream&amp; out);
 
     //! run the given (registered) command with the given arguments
     static void run(const string&amp; commandname, const vector&lt;string&gt;&amp; args);
   
     //! prints out detailed help for the given command on the given stream
-    static void help(const string&amp; commandname, ostream&amp; out);
+    //static void help(const string&amp; commandname, ostream&amp; out);
 
     //! This constructor will simply register the given PLearnCommand
     inline PLearnCommandRegistry(PLearnCommand* plcommand)
     { do_register(plcommand); }
   
-    //! Returns a reference to the unique command map
-    static command_map&amp; commands();
 };
   
 

Modified: trunk/commands/PLearnCommands/Plide.cc
===================================================================
--- trunk/commands/PLearnCommands/Plide.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/commands/PLearnCommands/Plide.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -233,7 +233,6 @@
 
 const char* plide_code = &quot;from plearn.plide.plide import *\n&quot; ;
 
-
 //! The actual implementation of the 'Plide' command
 void Plide::run(const vector&lt;string&gt;&amp; args)
 {
@@ -355,6 +354,8 @@
 
 PythonObjectWrapper Plide::helpResourcesPath(const TVec&lt;PythonObjectWrapper&gt;&amp; args)
 {
+// DEPRECATED: see HelpSystem
+/*
     if (args.size() != 1)
         PLERROR(&quot;%sExpecting 1 argument; got %d&quot;, __FUNCTION__, args.size());
 
@@ -369,6 +370,7 @@
     if (! m_help_command)
         PLERROR(&quot;%sThe PLearn command 'HTMLHelpCommand' must be linked into &quot;
                 &quot;the executable in order to use the Plide help system.&quot;, __FUNCTION__);
+*/
     return PythonObjectWrapper();
 }
 

Modified: trunk/commands/PLearnCommands/ServerCommand.cc
===================================================================
--- trunk/commands/PLearnCommands/ServerCommand.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/commands/PLearnCommands/ServerCommand.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -49,6 +49,7 @@
 #include &lt;plearn/io/pl_log.h&gt;
 #include &lt;plearn/io/PrPStreamBuf.h&gt;
 #include &lt;plearn/base/tostring.h&gt;
+#include &lt;plearn/base/PrUtils.h&gt;
 #include &lt;nspr/prio.h&gt;
 #include &lt;nspr/prerror.h&gt;
 #include &lt;nspr/prnetdb.h&gt;
@@ -102,7 +103,8 @@
 
         // Allow reuse of the socket immediately after the server shuts down
         PRSocketOptionData socket_option_data;
-        socket_option_data.value.reuse_addr = PR_SockOpt_Reuseaddr;
+        socket_option_data.option = PR_SockOpt_Reuseaddr;
+        socket_option_data.value.reuse_addr = PR_TRUE;
         PR_SetSocketOption(sock, &amp;socket_option_data);
 
         string myhostname = &quot;UNKNOWN_HOSTNAME&quot;;
@@ -135,7 +137,8 @@
             PRNetAddr addr;
             PRFileDesc* fd = PR_Accept(sock, &amp;addr, PR_INTERVAL_NO_TIMEOUT);
             if(fd==0)
-                PLERROR(&quot;ServerCommand: accept returned 0, error code is: %d&quot;,PR_GetError());
+                PLERROR(&quot;ServerCommand: accept returned 0, error code is: %d : %s&quot;,
+                        PR_GetError(), getPrErrorString().c_str());
             st = PR_NetAddrToString(&amp;addr, buf, sizeof(buf));
             NORMAL_LOG &lt;&lt; &quot;PLEARN_SERVER CONNECTION_FROM &quot;  &lt;&lt; buf &lt;&lt; endl;
             PStream io(new PrPStreamBuf(fd,fd,true,true));

Modified: trunk/commands/PLearnCommands/plearn_main.cc
===================================================================
--- trunk/commands/PLearnCommands/plearn_main.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/commands/PLearnCommands/plearn_main.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -113,6 +113,16 @@
     return s;
 }
 
+
+BEGIN_DECLARE_REMOTE_FUNCTIONS
+
+    declareFunction(&quot;versionString&quot;, &amp;version_string,
+                    (BodyDoc(&quot;Returns PLearn version as a string.\n&quot;),
+                     RetDoc (&quot;version string&quot;)));
+
+END_DECLARE_REMOTE_FUNCTIONS
+
+
 static void set_global_calendars(string command_line_option)
 {
     // Assume command-line-option of the form

Modified: trunk/plearn/base/HelpSystem.cc
===================================================================
--- trunk/plearn/base/HelpSystem.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/base/HelpSystem.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -2,6 +2,7 @@
 
 // HelpSystem.cc
 // Copyright (c) 2006 Pascal Vincent
+// Copyright (C) 2007 Xavier Saint-Mleux, ApSTAT Technologies, inc.
 
 // Redistribution and use in source and binary forms, with or without
 // modification, are permitted provided that the following conditions are met:
@@ -31,54 +32,245 @@
 // This file is part of the PLearn library. For more information on the PLearn
 // library, go to the PLearn Web site at www.plearn.org
 
+#include &quot;HelpSystem.h&quot;
 
-#include &quot;HelpSystem.h&quot;
 #include &quot;stringutils.h&quot;    //!&lt; For addprefix.
+#include &quot;tostring.h&quot;
+#include &lt;plearn/misc/HTMLUtils.h&gt;
+
+#include &lt;plearn/io/openFile.h&gt;
+#include &lt;plearn/io/fileutils.h&gt;
+#include &lt;plearn/io/openString.h&gt;
+
 #include &lt;plearn/base/TypeFactory.h&gt;
 #include &lt;plearn/base/RemoteTrampoline.h&gt;
 #include &lt;plearn/base/RemoteDeclareMethod.h&gt;
 #include &lt;plearn/base/RemoteMethodDoc.h&gt;
 #include &lt;plearn/base/RemoteMethodMap.h&gt;
+#include &lt;commands/PLearnCommands/PLearnCommandRegistry.h&gt;
+#include &lt;plearn/base/Object.h&gt;
 
+
 namespace PLearn {
 using namespace std;
 
 
-vector&lt; pair&lt;string, int&gt; &gt; listFunctions()
+/*****
+ * Commands
+ */
+
+vector&lt;string&gt; HelpSystem::listCommands()
+{
+    vector&lt;string&gt; commands;
+    for(PLearnCommandRegistry::command_map::const_iterator
+            it  = PLearnCommandRegistry::allCommands().begin();
+        it != PLearnCommandRegistry::allCommands().end(); ++it)
+        commands.push_back(it-&gt;first);
+    return commands;
+}
+
+string HelpSystem::helpCommands()
+{
+    vector&lt;string&gt; commands= listCommands();
+    string s= &quot;&quot;;
+    for(vector&lt;string&gt;::iterator it= commands.begin();
+        it != commands.end(); ++it)
+    {
+        PLearnCommand* cmd= PLearnCommandRegistry::getCommand(*it);
+        s+= *it + &quot;\t:  &quot; + cmd-&gt;description + '\n';
+    }
+    return s+'\n';
+}
+
+string HelpSystem::helpOnCommand(const string&amp; commandname)
+{
+    PLearnCommand* cmd= PLearnCommandRegistry::getCommand(commandname);
+    string help= &quot;*** Help for command '&quot; + commandname + &quot;' ***\n&quot;;
+    help+= cmd-&gt;description + '\n';
+    help+= cmd-&gt;helpmsg + '\n';        
+    return help;
+}
+
+string HelpSystem::helpCommandsHTML()
+{
+    string s;
+    s.reserve(16384);
+    s+= &quot;&lt;div class=\&quot;generaltable\&quot;&gt;\n&quot;
+        &quot;&lt;h2&gt;Index of Available Commands&lt;/h2&gt;\n&quot;
+        &quot;&lt;table cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;\n&quot;;
+   
+    int i=0;
+    vector&lt;string&gt; commands= listCommands();
+    for(vector&lt;string&gt;::iterator it= commands.begin();
+        it != commands.end(); ++it, ++i)
+    {
+        PLearnCommand* cmd= PLearnCommandRegistry::getCommand(*it);
+        string helpurl= &quot;command_&quot; + *it + &quot;.html&quot;;
+        string helphtml= &quot;&lt;a href=\&quot;&quot; + helpurl + &quot;\&quot;&gt;&quot; + *it + &quot;&lt;/a&gt;&quot;;
+        s+= string(&quot;  &lt;tr class=\&quot;&quot;) + (i%2 == 0? &quot;even&quot; : &quot;odd&quot;) + &quot;\&quot;&gt;\n&quot;
+            &quot;    &lt;td&gt;&quot; + helphtml + &quot;&lt;/td&gt;&quot;
+            &quot;&lt;td&gt;&quot; + cmd-&gt;description + &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;
+    }
+    s+=&quot;&lt;/table&gt;\n&lt;/div&gt;\n&quot;;
+    return helpPrologueHTML(&quot;Command Index&quot;) + s + helpEpilogueHTML();
+}
+
+string HelpSystem::helpOnCommandHTML(const string&amp; commandname)
+{
+    PLearnCommand* cmd= PLearnCommandRegistry::getCommand(commandname);
+    string s= string(&quot;&lt;div class=\&quot;cmdname\&quot;&gt;&quot;)
+        + HTMLUtils::quote(commandname) + &quot;&lt;/div&gt;\n&quot;
+        &quot;&lt;div class=\&quot;cmddescr\&quot;&gt;&quot;
+        + HTMLUtils::quote_format_and_highlight(cmd-&gt;description) + &quot;&lt;/div&gt;\n&quot;
+        &quot;&lt;div class=\&quot;cmdhelp\&quot;&gt;&quot;
+        + HTMLUtils::quote_format_and_highlight(cmd-&gt;helpmsg) 
+        + &quot;&lt;/div&gt;\n&quot;;
+    return helpPrologueHTML(commandname) + s + helpEpilogueHTML();
+}
+
+
+/*****
+ * Functions
+ */
+
+vector&lt;pair&lt;string, int&gt; &gt; HelpSystem::listFunctions()
 { 
     return getGlobalFunctionMap().getMethodList(); 
 }
 
-vector&lt;string&gt; listFunctionPrototypes()
+vector&lt;string&gt; HelpSystem::listFunctionPrototypes()
 { 
     return getGlobalFunctionMap().getMethodPrototypes(); 
 }
 
-string helpFunction(const string&amp; functionname)
+string HelpSystem::helpFunctions()
 {
-    return getGlobalFunctionMap().getMethodHelpText(functionname);
+    vector&lt;pair&lt;string, int&gt; &gt; funcs= listFunctions();
+    string s;
+    for(vector&lt;pair&lt;string, int&gt; &gt;::iterator it= funcs.begin();
+        it != funcs.end(); ++it)
+        s+= it-&gt;first +'('+tostring(it-&gt;second)+&quot;)\t:&quot;
+            + helpOnFunction(it-&gt;first, it-&gt;second) +'\n';
+    return s;
 }
 
-vector&lt; pair&lt;string, int&gt; &gt; listMethods(const string&amp; classname)
+string HelpSystem::helpOnFunction(const string&amp; functionname, int arity)
 {
-    const RemoteMethodMap&amp; rmm = TypeFactory::instance().getTypeMapEntry(classname).get_remote_methods();
-    return rmm.getMethodList(); 
+    return getGlobalFunctionMap().getMethodHelpText(functionname, arity);
 }
 
-vector&lt;string&gt; listMethodPrototypes(const string&amp; classname)
+string HelpSystem::helpFunctionsHTML()
 {
-    const RemoteMethodMap&amp; rmm = TypeFactory::instance().getTypeMapEntry(classname).get_remote_methods();
-    return rmm.getMethodPrototypes(); 
+    string s= &quot;&lt;div class=\&quot;rmitable\&quot;&gt;\n&quot; 
+        &quot;&lt;h2&gt;List of Functions&lt;/h2&gt;\n&quot;
+        &quot;&lt;table cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;\n&quot;;
+    s.reserve(32768);
+
+    vector&lt;pair&lt;string, int&gt; &gt; functions= listFunctions();
+
+    int i= 0;
+    for(vector&lt;pair&lt;string, int&gt; &gt;::iterator it= functions.begin(); 
+        it != functions.end(); ++it)
+        s+= string(&quot;&lt;tr class=\&quot;&quot;) + (i++ == 0? &quot;first&quot; : &quot;others&quot;) + &quot;\&quot;&gt;\n&quot;
+            + helpOnFunctionHTML(it-&gt;first, it-&gt;second)
+            + &quot;&lt;/tr&gt;\n&quot;;
+
+    if(index == 0)
+        s+= &quot;&lt;tr&gt;&lt;td&gt;No Remote-Callable Functions.&lt;/td&gt;&lt;/tr&gt;\n&quot;;
+           
+    s+= &quot;&lt;/table&gt;&lt;/div&gt;\n&quot;;
+
+    return helpPrologueHTML(&quot;Function Index&quot;) + s + helpEpilogueHTML();
 }
 
-string helpMethod(const string&amp; classname, const string&amp; methodname)
+namespace
 {
-    const RemoteMethodMap&amp; rmm = TypeFactory::instance().getTypeMapEntry(classname).get_remote_methods();
-    return rmm.getMethodHelpText(methodname);
+string formatMethodDocHTML(const RemoteMethodDoc&amp; doc, const string&amp; classname= &quot;&quot;)
+{
+    // Generate the function signature and argument-list table in HTML form
+    string return_type = HTMLUtils::quote_format_and_highlight(doc.returnType());
+    string args = &quot;&quot;;
+    string arg_table = &quot;&quot;;
+    list&lt;ArgDoc&gt;::const_iterator adit= doc.argListDoc().begin(), 
+        adend= doc.argListDoc().end();
+    list&lt;string&gt;::const_iterator tyit= doc.argListType().begin(), 
+        tyend= doc.argListType().end();
+    int j=0;
+    for( ; tyit != tyend ; ++tyit) 
+    {
+        string arg_type= HTMLUtils::quote_format_and_highlight(*tyit);
+        string arg_name= &quot;&quot;;
+        string arg_doc= &quot;(no documentation)&quot;;
+
+        if(adit != adend)
+        {
+            arg_name= HTMLUtils::quote(adit-&gt;m_argument_name);
+            arg_doc= HTMLUtils::quote_format_and_highlight(adit-&gt;m_doc);
+            ++adit;
+        }
+
+        if(!args.empty())  args += &quot;, &quot;;
+
+        args+= arg_type + ' ' + arg_name;
+
+        if(!arg_table.empty()) arg_table += &quot;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&quot;;
+
+        string td1_class = (++j % 2 == 0? &quot;argnameeven&quot; : &quot;argnameodd&quot;);
+        string td2_class = (  j % 2 == 0? &quot;argdoceven&quot;  : &quot;argdocodd&quot;);
+                
+        arg_table+= 
+            &quot;  &lt;td class=\&quot;&quot; + td1_class + &quot;\&quot;&gt;&quot; + arg_type + ' ' + arg_name + &quot;&lt;/td&gt;&quot;
+            + &quot;  &lt;td class=\&quot;&quot; + td2_class + &quot;\&quot;&gt;&quot; + arg_doc  + &quot;&lt;/td&gt;&quot;;
+    } 
+
+    // Header
+    string s= &quot;&lt;td colspan=\&quot;3\&quot;&gt;&lt;div class=\&quot;rmiprototype\&quot;&gt;&quot;;
+    s+= return_type
+        + &quot; &lt;span class=\&quot;rmifuncname\&quot;&gt;&quot; + doc.name() + &quot;&lt;/span&gt;&quot;
+        + '(' + args + ')' + &quot;&lt;/div&gt;\n&quot; 
+        &quot;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td colspan=\&quot;2\&quot;&gt;&quot; 
+        + HTMLUtils::quote_format_and_highlight(doc.bodyDoc())
+        + (classname == &quot;&quot; ? &quot;&quot; 
+           : &quot; (defined by &quot; + HTMLUtils::quote_format_and_highlight(classname) + &quot;)&quot;)
+        + &quot;&lt;/td&gt;&quot;;
+
+    // Args table
+    if(!arg_table.empty())
+        s+= &quot;&lt;/tr&gt;\n&lt;tr&gt;\n&quot;
+            &quot;&lt;td class=\&quot;rmititle\&quot;&gt;Arguments&lt;/td&gt;\n&quot; + arg_table;
+
+    // Ret. val
+    string td1_class = (++j % 2 == 0? &quot;argnameeven&quot; : &quot;argnameodd&quot;);
+    string td2_class = (  j % 2 == 0? &quot;argdoceven&quot;  : &quot;argdocodd&quot;);
+            
+    if(!doc.returnType().empty() || !doc.returnDoc().empty()) 
+        s+= &quot;&lt;/tr&gt;\n&lt;tr&gt;\n&quot;
+            &quot;&lt;td class=\&quot;rmititle\&quot;&gt;Returns&lt;/td&gt;\n&quot;
+            &quot;&lt;td class=\&quot;&quot; + td1_class + &quot;\&quot;&gt;&quot; + return_type + &quot;&lt;/td&gt;&quot;
+            &quot;&lt;td class=\&quot;&quot; + td2_class + &quot;\&quot;&gt;&quot; 
+            + HTMLUtils::quote_format_and_highlight(doc.returnDoc()) + &quot;&lt;/td&gt;\n&quot;;
+
+    //last &lt;tr&gt; s/b closed by calling fn.
+    return s;
 }
+}
 
-vector&lt;string&gt; listClasses()
+string HelpSystem::helpOnFunctionHTML(const string&amp; functionname, int arity)
 {
+    // the result is a list of table fields (&lt;td&gt;...&lt;/td&gt;)
+    // should be enclosed in a table row (&lt;table&gt;&lt;tr&gt;...&lt;/tr&gt;&lt;/table&gt;)
+    const RemoteTrampoline* t= 
+        getGlobalFunctionMap().lookup(functionname, arity);
+    PLASSERT(t);
+    return formatMethodDocHTML(t-&gt;documentation());
+}
+
+/*****
+ * Classes
+ */
+
+vector&lt;string&gt; HelpSystem::listClasses()
+{
     const TypeMap&amp; type_map = TypeFactory::instance().getTypeMap();
     int nclasses = type_map.size();
     vector&lt;string&gt; class_list(type_map.size());
@@ -88,7 +280,7 @@
     return class_list;
 }
 
-map&lt;string, string&gt; getClassTree()
+map&lt;string, string&gt; HelpSystem::getClassTree()
 {
     const TypeMap&amp; type_map = TypeFactory::instance().getTypeMap();
     map&lt;string, string&gt; class_tree;
@@ -99,186 +291,819 @@
     return class_tree;
 }
 
+string HelpSystem::helpClasses()
+{
+    vector&lt;string&gt; classes= listClasses();
+    string s= &quot;&quot;;
+    for(vector&lt;string&gt;::iterator it= classes.begin();
+        it != classes.end(); ++it)
+    {
+        const TypeMapEntry&amp; e= 
+            TypeFactory::instance().getTypeMapEntry(*it);
+        s+= &quot;- &quot; + *it + &quot;\t(&quot;+ e.parent_class +&quot;)\t:  &quot; 
+            + e.one_line_descr + '\n';
+    }
+    return s+'\n';
+}
 
+string HelpSystem::helpOnClass(const string&amp; classname)
+{
 
-BEGIN_DECLARE_REMOTE_FUNCTIONS
-    declareFunction(&quot;listFunctions&quot;, &amp;listFunctions,
-                    (BodyDoc(&quot;Returns a list of all registered global functions as pairs of (funtionname, nargs)&quot;)));
+    const TypeMap&amp; type_map = TypeFactory::instance().getTypeMap();
+    TypeMap::const_iterator it = type_map.find(classname);
+    TypeMap::const_iterator itend = type_map.end();
 
-    declareFunction(&quot;listFunctionPrototypes&quot;, &amp;listFunctionPrototypes,
-                    (BodyDoc(&quot;Returns a list of the prototypes of all registered global functions&quot;)));
+    if(it==itend)
+        PLERROR(&quot;Object type %s unknown.\n&quot;
+                &quot;Did you #include it, does it call the IMPLEMENT_NAME_AND_DEEPCOPY macro?\n&quot;
+                &quot;and has it indeed been linked with your program?&quot;, classname.c_str());
 
-    declareFunction(&quot;helpFunction&quot;, &amp;helpFunction,
-                    (BodyDoc(&quot;Will return full help on all registered global functions with the given name &quot;),
-                     ArgDoc (&quot;functionname&quot;, &quot;The name of the function on which to get help&quot;)));
+    const TypeMapEntry&amp; entry = it-&gt;second;
+    Object* obj = 0;
 
-    declareFunction(&quot;listMethods&quot;, &amp;listMethods,
-                    (BodyDoc(&quot;Returns a list of all registered methods for the given class as pairs of (methodname, nargs)&quot;),
-                     ArgDoc (&quot;classname&quot;, &quot;The name of the class whose methods you want to list.&quot;)));
+    string s= &quot;################################################################## \n&quot;;
+    s+= &quot;## &quot; + classname + &quot;\n&quot;;
+    s+= &quot;## &quot; + helpClassParents(classname) + '\n';
+    s+= &quot;################################################################## \n\n&quot;;
 
-    declareFunction(&quot;listMethodPrototypes&quot;, &amp;listMethodPrototypes,
-                    (BodyDoc(&quot;Returns a list of the prototypes of all registered methods for the given class&quot;),
-                     ArgDoc (&quot;classname&quot;, &quot;The name of the class whose method prototypes you want to list.&quot;)));
+    // Display basic help
+    s+= &quot;## &quot; + entry.one_line_descr + &quot;\n\n&quot;;
+    s+= &quot;## &quot; + entry.multi_line_help + &quot;\n\n&quot;;
 
-    declareFunction(&quot;helpMethod&quot;, &amp;helpMethod,
-                    (BodyDoc(&quot;Will return full help on all registered methods of the class with the given name&quot;),
-                     ArgDoc (&quot;classname&quot;, &quot;The name of the class&quot;),
-                     ArgDoc (&quot;methodname&quot;, &quot;The name of the method&quot;)));
-                     
-    declareFunction(&quot;listClasses&quot;, &amp;listClasses,
-                    (BodyDoc(&quot;Returns a list of all registered Object classes&quot;)));
+    if(entry.constructor) // it's an instantiable class
+        obj = (*entry.constructor)();
+    else
+        s+= &quot;Note: &quot; + classname 
+            + &quot; is a base-class with pure virtual methods that cannot be instantiated directly.\n&quot; 
+            &quot;(default values for build options can only be displayed for instantiable classes, \n&quot;
+            &quot; so you'll only see question marks here.)\n\n&quot;;
+      
+    s+= &quot;################################################################## \n&quot;
+        &quot;##                         Build Options                        ## \n&quot;
+        &quot;## (including those inherited from parent and ancestor classes) ## \n&quot;
+        &quot;################################################################## \n\n&quot;;
+    s+= classname + &quot;( \n&quot;;
+    s+= helpClassOptions(classname);
+    s+= &quot;);\n\n&quot;;
 
-    declareFunction(&quot;getClassTree&quot;, &amp;getClassTree,
-                    (BodyDoc(&quot;Returns a map, mapping all registered Object classnames to their parentclassname&quot;)));
+    if(obj) delete obj;
 
-END_DECLARE_REMOTE_FUNCTIONS
+    s+= &quot;################################################################## \n&quot;;
+    s+= &quot;## Subclasses of &quot; + classname + &quot; \n&quot;
+        &quot;# (only those that can be instantiated) \n&quot;
+        &quot;################################################################## \n\n&quot;;
+    s+= addprefix(&quot;# &quot;, helpDerivedClasses(classname));
 
+    s+= &quot;\n\n################################################################## \n&quot;;
+    s+= &quot;## Remote-callable methods of &quot; + classname + &quot; \n&quot;
+        &quot;################################################################## \n\n&quot;;
+    s+= addprefix(&quot;# &quot;, helpMethods(classname));
 
-/*
+    s+= &quot;\n\n################################################################## \n\n&quot;;
 
+    return s;
+}
 
-TVec&lt;string&gt; listOptions(const string&amp; classname)
+string HelpSystem::helpClassesHTML()
 {
-    const TypeMapEntry&amp; entry = TypeFactory::instance().getTypeMapEntry(classname);
-    OptionList&amp; options = (*entry.getoptionlist_method)();    
-    TVec&lt;string&gt; optionnames;
-    for( OptionList::iterator it = options.begin(); it!=options.end(); ++it )
-        optionnames.append((*it)-&gt;optionname());
-    return optionnames;
+    string s= &quot;&lt;div class=\&quot;generaltable\&quot;&gt;\n&quot;
+        &quot;&lt;h2&gt;Index of Available Classes&lt;/h2&gt;\n&quot;
+        &quot;&lt;table cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;\n&quot;;
+    s.reserve(131072);
+    int i=0;
+    vector&lt;string&gt; classes= listClasses();
+    for(vector&lt;string&gt;::iterator it= classes.begin();
+        it != classes.end(); ++it)
+    {
+        const TypeMapEntry&amp; e= TypeFactory::instance().getTypeMapEntry(*it);
+        s+= string(&quot;  &lt;tr class=\&quot;&quot;) + (i++%2 == 0? &quot;even&quot; : &quot;odd&quot;) + &quot;\&quot;&gt;\n&quot;
+            &quot;    &lt;td&gt;&quot; 
+            + HTMLUtils::quote_format_and_highlight(*it)
+            + &quot;&lt;/td&gt;\n&quot;
+            &quot;    &lt;td&gt;&quot; 
+            + HTMLUtils::quote_format_and_highlight(e.one_line_descr)
+            + '(' + HTMLUtils::quote_format_and_highlight(e.parent_class) + ')'
+            + &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;
+    }
+    s+= &quot;&lt;/table&gt;&lt;/div&gt;\n&quot;;
+    return helpPrologueHTML(&quot;Class Index&quot;) + s + helpEpilogueHTML();
 }
 
-string helpOption(const string&amp; classname, const string&amp; optionname)
+string HelpSystem::helpOnClassHTML(const string&amp; classname)
 {
-    const TypeMapEntry&amp; entry = TypeFactory::instance().getTypeMapEntry(classname);
-    OptionList&amp; options = (*entry.getoptionlist_method)();    
-    OptionList::iterator op = options.find(optionname);
-    if(op==options.end())
-        PLERROR(&quot;Class %s has no option named %s&quot;, classname.c_str(), optionname.c_str());
+    string s= &quot;&quot;;
+    s.reserve(65536);
 
-    OptionBase::flag_t flags = (*op)-&gt;flags();
+    // Output parents heading
+    s+= helpClassParentsHTML(classname);
 
-    string descr = (*op)-&gt;description();
-    string optname = (*op)-&gt;optionname();
-    string opttype = (*op)-&gt;optiontype();
-    string defaultval = &quot;?&quot;;
-    if(obj) // it's an instantiable class
+    // Output general information
+    const TypeMapEntry&amp; entry= TypeFactory::instance().getTypeMapEntry(classname);
+    s+= &quot;&lt;div class=\&quot;classname\&quot;&gt;&quot; + HTMLUtils::quote(classname) + &quot;&lt;/div&gt;\n&quot;
+        &quot;&lt;div class=\&quot;classdescr\&quot;&gt;&quot; 
+        + HTMLUtils::quote(entry.one_line_descr) + &quot;&lt;/div&gt;\n&quot;
+        &quot;&lt;div class=\&quot;classhelp\&quot;&gt;&quot; 
+        + HTMLUtils::quote_format_and_highlight(entry.multi_line_help) 
+        + &quot;&lt;/div&gt;\n&quot;;
+  
+    if(!entry.constructor) // it's not an instantiable class
+        s+= &quot;&lt;div class=\&quot;classhelp\&quot;&gt;&lt;b&gt;Note:&lt;/b&gt;&quot; + HTMLUtils::quote(classname)
+            + &quot; is a base-class with pure virtual methods &quot;
+            &quot;that cannot be instantiated directly.\n&quot; 
+            &quot;(default values for build options can only be &quot;
+            &quot;displayed for instantiable classes, \n&quot;
+            &quot; so you'll only see question marks here.)&lt;/div&gt;\n&quot;;
+
+    // Output list of options
+    s+= helpClassOptionsHTML(classname);
+
+    // Output instantiable derived classes
+    s+= helpDerivedClassesHTML(classname);
+
+    // Output remote-callable methods
+    s+= helpMethodsHTML(classname);
+
+    return helpPrologueHTML(classname) + s + helpEpilogueHTML();
+}
+
+
+vector&lt;string&gt; HelpSystem::listClassParents(const string&amp; classname)
+{
+    string cl= classname;
+    vector&lt;string&gt; parents;
+    const TypeMapEntry* e= 
+        &amp;TypeFactory::instance().getTypeMapEntry(cl);
+    while(e-&gt;parent_class != cl)
     {
-        defaultval = (*op)-&gt;defaultval(); 
-        if(defaultval==&quot;&quot;)
-            defaultval = (*op)-&gt;writeIntoString(obj);
+        cl= e-&gt;parent_class;
+        parents.push_back(cl);
+        e= &amp;TypeFactory::instance().getTypeMapEntry(cl);
     }
+    return parents;
+}
 
-    string optflags = &quot;&quot;;
-    if(flags &amp; OptionBase::buildoption)
-        optflags += &quot; buildoption |&quot;;
-    if(flags &amp; OptionBase::learntoption)
-        optflags += &quot; learntoption |&quot;;
-    if(flags &amp; OptionBase::tuningoption)
-        optflags += &quot; tuningoption |&quot;;
-    if(flags &amp; OptionBase::nosave)
-        optflags += &quot; nosave |&quot;;
-    if(flags &amp; OptionBase::nonparentable)
-        optflags += &quot; nonparentable |&quot;;
-    if(flags &amp; OptionBase::nontraversable)
-        optflags += &quot; nontraversable |&quot;;
+string HelpSystem::helpClassParents(const string&amp; classname)
+{
+    vector&lt;string&gt; parents= listClassParents(classname);
+    string s= &quot;&quot;;
+    for(vector&lt;string&gt;::reverse_iterator it= parents.rbegin();
+        it != parents.rend(); ++it)
+        s+= *it + &quot; &gt; &quot;;
+    return s + classname;
+}
 
-    string helpstring = string(&quot;OPTION &quot;)+classname+&quot;::&quot;+optionname+&quot;\n&quot;
-        +&quot;Flags: &quot;+optflags+&quot;\n&quot;
-        +&quot;Type: &quot;+opttype+&quot;\n&quot;
-        +&quot;Description: &quot;+ descr +&quot;\n&quot;;
-    return helpstring;
+string HelpSystem::helpClassParentsHTML(const string&amp; classname)
+{
+    return string(&quot;&lt;div class=\&quot;crumbtrail\&quot;&gt;&quot;)
+        + HTMLUtils::quote_format_and_highlight(helpClassParents(classname))
+        + &quot;&lt;/div&gt;&quot;;
 }
 
+vector&lt;string&gt; HelpSystem::listDerivedClasses(const string&amp; classname)
+{
+    const TypeMapEntry&amp; entry= 
+        TypeFactory::instance().getTypeMapEntry(classname);
+    const TypeMap&amp; the_map= TypeFactory::instance().getTypeMap();
+    vector&lt;string&gt; classes;
+    for(TypeMap::const_iterator it= the_map.begin();
+        it != the_map.end(); ++it)
+    {
+        const TypeMapEntry&amp; e= it-&gt;second;
+        if(e.constructor &amp;&amp; it-&gt;first!=classname)
+        {
+            Object* o= (*e.constructor)();
+            if((*entry.isa_method)(o))
+                classes.push_back(it-&gt;first);
+            if(o) delete o;
+        }
+    }
+    return classes;
+}
 
+string HelpSystem::helpDerivedClasses(const string&amp; classname)
+{
+    vector&lt;string&gt; classes= listDerivedClasses(classname);
+    string s= &quot;&quot;;
+    for(vector&lt;string&gt;::iterator it= classes.begin();
+        it != classes.end(); ++it)
+        s+= right(*it, 30) + &quot; - &quot; 
+            + TypeFactory::instance().getTypeMapEntry(*it).one_line_descr 
+            + '\n';
+    return s;
+}
 
-void printObjectHelp(PStream out, const string&amp; classname)
+string HelpSystem::helpDerivedClassesHTML(const string&amp; classname)
 {
-    const TypeMap&amp; type_map = TypeFactory::instance().getTypeMap();
-    TypeMap::const_iterator it = type_map.find(classname);
-    TypeMap::const_iterator itend = type_map.end();
+    // Output instantiable derived classes
+    vector&lt;string&gt; classes= listDerivedClasses(classname);
 
-    if(it==itend)
-        PLERROR(&quot;Object type %s unknown.\n&quot;
-                &quot;Did you #include it, does it call the IMPLEMENT_NAME_AND_DEEPCOPY macro?\n&quot;
-                &quot;and has it indeed been linked with your program?&quot;, classname.c_str());
+    string s= &quot;&lt;div class=\&quot;generaltable\&quot;&gt;\n&quot;
+        &quot;&lt;h2&gt;List of Instantiable Derived Classes&lt;/h2&gt;\n&quot;
+        &quot;&lt;table cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;\n&quot;;
 
-    const TypeMapEntry&amp; entry = it-&gt;second;
-    Object* obj = 0;
+    int i= 0;
+    for(vector&lt;string&gt;::iterator it= classes.begin();
+        it != classes.end(); ++it)
+        s+= string(&quot;  &lt;tr class=\&quot;&quot;) + (i++%2 == 0? &quot;even&quot; : &quot;odd&quot;) + &quot;\&quot;&gt;\n&quot;
+            &quot;    &lt;td&gt;&quot;
+            + HTMLUtils::quote_format_and_highlight(*it) + &quot;&lt;/td&gt;&lt;td&gt;&quot; 
+            + HTMLUtils::quote_format_and_highlight(
+                TypeFactory::instance().getTypeMapEntry(*it).one_line_descr)
+            + &quot;    &lt;/td&gt;  &lt;/tr&gt;\n&quot;;
 
-    out &lt;&lt; &quot;****************************************************************** \n&quot;
-        &lt;&lt; &quot;** &quot; &lt;&lt; classname &lt;&lt; &quot;\n&quot;
-        &lt;&lt; &quot;****************************************************************** \n&quot; &lt;&lt; endl;
+    if(i==0)
+        s+= &quot;&lt;tr&gt;&lt;td&gt;This class does not have instantiable &quot;
+            &quot;derived classes.&lt;/td&gt;&lt;/tr&gt;\n&quot;;
 
-    // Display basic help
-    out &lt;&lt; entry.one_line_descr &lt;&lt; endl &lt;&lt; endl;
-    out &lt;&lt; entry.multi_line_help &lt;&lt; endl &lt;&lt; endl;
+    return s+&quot;&lt;/table&gt;&lt;/div&gt;\n&quot;;
+}
 
-    if(entry.constructor) // it's an instantiable class
-        obj = (*entry.constructor)();
-    else
-        out &lt;&lt; &quot;Note: &quot; &lt;&lt; classname &lt;&lt; &quot; is a base-class with pure virtual methods that cannot be instantiated directly.\n&quot; 
-            &lt;&lt; &quot;(default values for build options can only be displayed for instantiable classes, \n&quot;
-            &lt;&lt; &quot; so you'll only see question marks here.)\n&quot; &lt;&lt; endl;
-      
-    out &lt;&lt; &quot;****************************************************************** \n&quot;
-        &lt;&lt; &quot;**                         Build Options                        ** \n&quot;
-        &lt;&lt; &quot;** (including those inherited from parent and ancestor classes) ** \n&quot;
-        &lt;&lt; &quot;****************************************************************** \n&quot; &lt;&lt; endl;
+pair&lt;string, vector&lt;string&gt; &gt; HelpSystem::precisOnClass(const string&amp; classname)
+{
+    const TypeMapEntry&amp; tme = TypeFactory::instance().getTypeMapEntry(classname);
+    return make_pair(tme.one_line_descr, listBuildOptions(classname));
+}
 
-    out &lt;&lt; classname + &quot;( \n&quot;;
-    OptionList&amp; options = (*entry.getoptionlist_method)();    
 
-    for( OptionList::iterator olIt = options.begin(); olIt!=options.end(); ++olIt )
+/*****
+ * Options
+ */
+
+vector&lt;string&gt; HelpSystem::listClassOptions(const string&amp; classname)
+{
+    const TypeMapEntry&amp; e= TypeFactory::instance().getTypeMapEntry(classname);
+    OptionList&amp; optlist= (*e.getoptionlist_method)();
+    int nopts= optlist.size();
+    vector&lt;string&gt; options(nopts);
+    for(int i= 0; i &lt; nopts; ++i) options[i]= optlist[i]-&gt;optionname();
+    return options;
+}
+
+vector&lt;string&gt; HelpSystem::listBuildOptions(const string&amp; classname)
+{
+    const TypeMapEntry&amp; e= TypeFactory::instance().getTypeMapEntry(classname);
+    OptionList&amp; optlist= (*e.getoptionlist_method)();
+    vector&lt;string&gt; options;
+    for(OptionList::iterator it= optlist.begin();
+        it != optlist.end(); ++it)
+        if((*it)-&gt;flags() &amp; OptionBase::buildoption)
+            options.push_back((*it)-&gt;optionname());
+    return options;
+}
+
+string HelpSystem::helpClassOptions(const string&amp; classname)
+{
+    string s= &quot;&quot;;
+    vector&lt;string&gt; options= listClassOptions(classname);
+    for(vector&lt;string&gt;::iterator it= options.begin();
+        it != options.end(); ++it)
+        s+= helpOnOption(classname, *it) + '\n';
+    return s;
+}
+
+string HelpSystem::helpOnOption(const string&amp; classname, const string&amp; optionname)
+{
+    string s= &quot;&quot;;
+    PP&lt;OptionBase&gt; opt= getOptionByName(classname, optionname);
+    OptionBase::flag_t flags = opt-&gt;flags();
+    if(flags &amp; OptionBase::buildoption 
+       &amp;&amp; opt-&gt;level() &lt;= OptionBase::getCurrentOptionLevel())
+        s+= addprefix(&quot;# &quot;, opt-&gt;optiontype() + &quot;: &quot; + opt-&gt;description())
+            + addprefix(&quot;# &quot;, &quot;*OptionLevel: &quot; + opt-&gt;levelString())
+            + opt-&gt;optionname() + &quot; = &quot; 
+            + getOptionDefaultVal(classname, optionname) + &quot; ;\n\n&quot;;
+
+    return s;
+}
+
+string HelpSystem::helpClassOptionsHTML(const string&amp; classname)
+{
+    string s= &quot;&lt;div class=\&quot;generaltable\&quot;&gt;\n&quot; 
+        &quot;&lt;h2&gt;List of All Options&lt;/h2&gt;\n&quot; 
+        &quot;&lt;table cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;\n&quot;;
+    s.reserve(32768);
+
+    vector&lt;string&gt; options= listClassOptions(classname);
+    int i= 0;
+    for(vector&lt;string&gt;::iterator it= options.begin();
+        it != options.end(); ++it)
     {
-        OptionBase::flag_t flags = (*olIt)-&gt;flags();
-        if(flags &amp; OptionBase::buildoption)
+        PP&lt;OptionBase&gt; opt= getOptionByName(classname, *it);
+        if(opt-&gt;flags() &amp; OptionBase::buildoption 
+           &amp;&amp; opt-&gt;level() &lt;= OptionBase::getCurrentOptionLevel())
         {
-            string descr = (*olIt)-&gt;description();
-            string optname = (*olIt)-&gt;optionname();
-            string opttype = (*olIt)-&gt;optiontype();
-            string defaultval = &quot;?&quot;;
-            if(obj) // it's an instantiable class
-            {
-                defaultval = (*olIt)-&gt;defaultval(); 
-                if(defaultval==&quot;&quot;)
-                    defaultval = (*olIt)-&gt;writeIntoString(obj);
-            }
-            // string holderclass = (*olIt)-&gt;optionHolderClassName(this);
-            out &lt;&lt; addprefix(&quot;# &quot;, opttype + &quot;: &quot; + descr);
-            out &lt;&lt; optname + &quot; = &quot; + defaultval + &quot; ;\n\n&quot;;
+            s+= string(&quot;  &lt;tr class=\&quot;&quot;) + (i % 2 == 0? &quot;even&quot; : &quot;odd&quot;) + &quot;\&quot;&gt;\n&quot;
+                + helpOnOptionHTML(classname, *it) + &quot;&lt;/tr&gt;\n&quot;;
+            ++i;
         }
     }
-    out &lt;&lt; &quot;);\n\n&quot;;
+    
+    if (i==0)
+        s+= &quot;&lt;tr&gt;&lt;td&gt;This class does not specify any build options.&lt;/td&gt;&lt;/tr&gt;\n&quot;;
+    
+    s+= &quot;&lt;/table&gt;&lt;/div&gt;\n&quot;;
+    return s;
+}
 
-    if(obj)
+string HelpSystem::helpOnOptionHTML(const string&amp; classname, const string&amp; optionname)
+{
+    // the result is a list of table fields (&lt;td&gt;...&lt;/td&gt;)
+    // should be enclosed in a table row (&lt;table&gt;&lt;tr&gt;...&lt;/tr&gt;&lt;/table&gt;)
+    string s= &quot;&quot;;
+    PP&lt;OptionBase&gt; opt= getOptionByName(classname, optionname);
+    s+= &quot;    &lt;td&gt;&lt;div class=\&quot;opttype\&quot;&gt;&quot; 
+        + HTMLUtils::quote_format_and_highlight(opt-&gt;optiontype()) + &quot;&lt;/div&gt;\n&quot;
+        &quot;    &lt;div class=\&quot;optname\&quot;&gt;&quot; 
+        + HTMLUtils::quote(opt-&gt;optionname()) + &quot;&lt;/div&gt;\n&quot;;
+
+    string defaultval= getOptionDefaultVal(classname, optionname);
+    if (defaultval != &quot;?&quot;)
+        s+= &quot;    &lt;div class=\&quot;optvalue\&quot;&gt;= &quot; 
+            + HTMLUtils::quote(defaultval) + &quot;&lt;/div&gt;\n&quot;;
+
+    string flag_string = join(opt-&gt;flagStrings(), &quot; | &quot;);
+    s+= string(&quot;    &lt;div class=\&quot;opttype\&quot;&gt;&lt;i&gt;(&quot;)
+        + join(opt-&gt;flagStrings(), &quot; | &quot;) + &quot;)&lt;/i&gt;&lt;/div&gt;\n&quot;
+        + &quot;    &lt;div class=\&quot;optlevel\&quot;&gt;&lt;i&gt;(OptionLevel: &quot; 
+        + opt-&gt;levelString() + &quot;)&lt;/i&gt;&lt;/div&gt;\n&quot;
+        &quot;    &lt;/td&gt;\n&quot;;
+
+    string descr= opt-&gt;description();
+    if (removeblanks(descr) == &quot;&quot;) descr = &quot;(no description)&quot;;
+    s+= string(&quot;    &lt;td&gt;&quot;)+HTMLUtils::quote_format_and_highlight(descr);
+
+    string defclass= getOptionDefiningClass(classname, optionname);
+    if (defclass != &quot;&quot;) 
+        s+= string(&quot;    &lt;span class=\&quot;fromclass\&quot;&gt;&quot;)
+            + &quot;(defined&nbsp;by&nbsp;&quot; 
+            + HTMLUtils::highlight_known_classes(defclass) + &quot;)&quot;
+            &quot;&lt;/span&gt;\n&quot;;
+    s+= &quot;    &lt;/td&gt;\n&quot;;
+    return s;
+}
+
+string HelpSystem::getOptionDefaultVal(const string&amp; classname, 
+                                       const string&amp; optionname)
+{
+    PP&lt;OptionBase&gt; opt= getOptionByName(classname, optionname);
+    const TypeMapEntry&amp; entry= TypeFactory::instance().getTypeMapEntry(classname);
+    Object* obj= 0;
+    if(entry.constructor) obj= (*entry.constructor)();
+
+    string defaultval= &quot;?&quot;;
+    if(obj) // it's an instantiable class
+    {
+        defaultval= opt-&gt;defaultval(); 
+        if(defaultval==&quot;&quot;) defaultval= opt-&gt;writeIntoString(obj);
         delete obj;
+    }
+    return defaultval;
+}
 
-    out &lt;&lt; &quot;****************************************************************** \n&quot;
-        &lt;&lt; &quot;** Subclasses of &quot; &lt;&lt; classname &lt;&lt; &quot; \n&quot;
-        &lt;&lt; &quot;** (only those that can be instantiated) \n&quot;
-        &lt;&lt; &quot;****************************************************************** \n&quot; &lt;&lt; endl;
-    for(it = type_map.begin(); it!=itend; ++it)
+string HelpSystem::getOptionDefiningClass(const string&amp; classname, 
+                                          const string&amp; optionname)
+{
+    PP&lt;OptionBase&gt; opt= getOptionByName(classname, optionname);
+    const TypeMapEntry&amp; entry= TypeFactory::instance().getTypeMapEntry(classname);
+    string defclass= &quot;&quot;;
+    if(entry.constructor)
     {
-        // cerr &lt;&lt; &quot;Attempting to instantiate: &quot; &lt;&lt; it-&gt;first &lt;&lt; endl;
-        const TypeMapEntry&amp; e = it-&gt;second;
-        if(e.constructor &amp;&amp; it-&gt;first!=classname)
+        Object* obj= (*entry.constructor)();
+        defclass= opt-&gt;optionHolderClassName(obj);
+        delete obj;
+    }
+    return defclass;
+}
+
+/*****
+ * Methods
+ */
+
+vector&lt;pair&lt;string, int&gt; &gt; HelpSystem::listMethods(const string&amp; classname)
+{
+    return TypeFactory::instance().getTypeMapEntry(classname).
+        get_remote_methods().getMethodList();
+}
+
+vector&lt;string&gt; HelpSystem::listMethodPrototypes(const string&amp; classname)
+{
+    return TypeFactory::instance().getTypeMapEntry(classname).
+        get_remote_methods().getMethodPrototypes();
+}
+
+string HelpSystem::helpMethods(const string&amp; classname)
+{
+    vector&lt;pair&lt;string, int&gt; &gt; methods= listMethods(classname);
+    string s= &quot;&quot;;
+    for(vector&lt;pair&lt;string, int&gt; &gt;::iterator it= methods.begin();
+        it != methods.end(); ++it)
+        s+= string(&quot;\n##########\n&quot;) 
+            + helpOnMethod(classname, it-&gt;first, it-&gt;second) + '\n';
+    return s;
+}
+
+string HelpSystem::helpOnMethod(const string&amp; classname, 
+                                const string&amp; methodname, int arity)
+{
+    return TypeFactory::instance().getTypeMapEntry(classname)
+        .get_remote_methods().getMethodHelpText(methodname, arity);
+}
+
+string HelpSystem::helpMethodsHTML(const string&amp; classname)
+{
+    string s= &quot;&lt;div class=\&quot;rmitable\&quot;&gt;\n&quot; 
+        &quot;&lt;h2&gt;List of Remote-Callable Methods&lt;/h2&gt;\n&quot;
+        &quot;&lt;table cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;\n&quot;;
+    
+    vector&lt;string&gt; parents= listClassParents(classname);
+    parents.insert(parents.begin(), classname);
+    vector&lt;pair&lt;string, int&gt; &gt; methods;
+    map&lt;pair&lt;string, int&gt;, string&gt; definingclass;
+    for(vector&lt;string&gt;::iterator it= parents.begin();
+        it != parents.end(); ++it)
+    {
+        vector&lt;pair&lt;string, int&gt; &gt; ms= listMethods(*it);
+        for(vector&lt;pair&lt;string, int&gt; &gt;::iterator jt= ms.begin();
+            jt != ms.end(); ++jt)
         {
-            Object* o = (*e.constructor)();
-            if( (*entry.isa_method)(o) ) {
-                out.width(30);
-                out &lt;&lt; it-&gt;first &lt;&lt; &quot; - &quot; &lt;&lt; e.one_line_descr &lt;&lt; endl;
-            }
-            if(o)
-                delete o;
+            if(definingclass.find(*jt) == definingclass.end())
+                methods.push_back(*jt);
+            definingclass[*jt]= *it;
         }
     }
 
-    out &lt;&lt; &quot;\n\n------------------------------------------------------------------ \n&quot; &lt;&lt; endl;
+    int i= 0;
+    for(vector&lt;pair&lt;string, int&gt; &gt;::iterator it= methods.begin(); 
+        it != methods.end(); ++it)
+        s+= string(&quot;&lt;tr class=\&quot;&quot;) + (i++ == 0? &quot;first&quot; : &quot;others&quot;) + &quot;\&quot;&gt;\n&quot;
+            + helpOnMethodHTML(definingclass[*it], it-&gt;first, it-&gt;second)
+            + &quot;&lt;/tr&gt;\n&quot;;
 
+    if(index == 0)
+        s+= &quot;&lt;tr&gt;&lt;td&gt;This class does not define any remote-callable methods.&lt;/td&gt;&lt;/tr&gt;\n&quot;;
+           
+    s+= &quot;&lt;/table&gt;&lt;/div&gt;\n&quot;;
+
+    return s;
 }
 
-*/
+string HelpSystem::helpOnMethodHTML(const string&amp; classname, 
+                                    const string&amp; methodname, int arity)
+{
+    // the result is a list of table fields (&lt;td&gt;...&lt;/td&gt;)
+    // should be enclosed in a table row (&lt;table&gt;&lt;tr&gt;...&lt;/tr&gt;&lt;/table&gt;)
+    const RemoteTrampoline* t= TypeFactory::instance().getTypeMapEntry(classname)
+        .get_remote_methods().lookup(methodname, arity);
+    PLASSERT(t);
+    return formatMethodDocHTML(t-&gt;documentation(), classname);
+}
 
+
+/***
+ * General Stuff
+ */
+
+string HelpSystem::html_resources_path; // init.
+
+string HelpSystem::helpIndexHTML()
+{
+    static PPath from_dir= &quot;&quot;;
+    static string the_index= string(&quot;&lt;div class=\&quot;cmdname\&quot;&gt;\n&quot;)
+        + &quot;Welcome to PLearn User-Level Class and Commands Help\n&quot; 
+        &quot;&lt;/div&gt;&quot;
+        &quot;&lt;div class=\&quot;cmdhelp\&quot;&gt;\n&quot;
+        &quot;&lt;ul&gt;\n&quot;
+        &quot;  &lt;li&gt; &lt;a href=\&quot;classes_index.html\&quot;&gt;Class Index&lt;/a&gt;\n&quot;
+        &quot;  &lt;li&gt; &lt;a href=\&quot;commands_index.html\&quot;&gt;Command Index&lt;/a&gt;\n&quot;
+        &quot;  &lt;li&gt; &lt;a href=\&quot;functions_index.html\&quot;&gt;Function Index&lt;/a&gt;\n&quot;
+        &quot;&lt;/ul&gt;&lt;/div&gt;\n&quot;;
+
+    if(from_dir != html_resources_path)
+    {
+        from_dir= html_resources_path;
+        PPath indexfile= from_dir/&quot;index.html&quot;;
+        if(pathexists(indexfile))
+        {
+            PStream f= openFile(indexfile,
+                                PStream::raw_ascii);
+            the_index= f.readAll();
+        }
+    }
+
+    return helpPrologueHTML() + the_index + helpEpilogueHTML();
+}
+
+string HelpSystem::helpPrologueHTML(const string&amp; title)
+{
+    static PPath from_dir= &quot;&quot;;
+    static string the_prologue= &quot;&lt;html&gt;&lt;body&gt;&quot;;
+
+    if(from_dir != html_resources_path)
+    {
+        from_dir= html_resources_path;
+        PStream f= openFile(from_dir/&quot;help_prolog.html&quot;,
+                            PStream::raw_ascii);
+        the_prologue= f.readAll();
+    }
+
+    map&lt;string, string&gt; dic;
+    dic[&quot;PAGE_TITLE&quot;]= title;
+    PStream stm= openString(the_prologue, PStream::raw_ascii);
+    return readAndMacroProcess(stm, dic, false);
+}
+
+string HelpSystem::helpEpilogueHTML()
+{
+    static PPath from_dir= &quot;&quot;;
+    static string the_epilogue= &quot;&lt;/body&gt;&lt;/html&gt;&quot;;
+
+    if(from_dir != html_resources_path)
+    {
+        from_dir= html_resources_path;
+        PStream f= openFile(from_dir/&quot;help_epilog.html&quot;,
+                            PStream::raw_ascii);
+        the_epilogue= f.readAll();
+    }
+
+    return HTMLUtils::generated_by() + the_epilogue;
+}
+
+
+
+BEGIN_DECLARE_REMOTE_FUNCTIONS
+
+// Commands
+
+    declareFunction(&quot;listCommands&quot;, &amp;HelpSystem::listCommands,
+                    (BodyDoc(&quot;Returns a list of all registered &quot;
+                             &quot;commands as strings.&quot;),
+                     RetDoc (&quot;vector of command names&quot;)));
+
+    declareFunction(&quot;helpCommands&quot;, &amp;HelpSystem::helpCommands,
+                    (BodyDoc(&quot;Returns a plain text list of all &quot;
+                             &quot;registered commands.&quot;),
+                     RetDoc (&quot;plain text list of commands&quot;)));
+
+    declareFunction(&quot;helpOnCommand&quot;, &amp;HelpSystem::helpOnCommand,
+                    (BodyDoc(&quot;Will return full help for the &quot;
+                             &quot;command with the given name &quot;),
+                     ArgDoc (&quot;commandname&quot;, 
+                             &quot;The name of the command on which to get help&quot;),
+                     RetDoc (&quot;help text for the command&quot;)));
+
+    // HTML
+    declareFunction(&quot;helpCommandsHTML&quot;, &amp;HelpSystem::helpCommandsHTML,
+                    (BodyDoc(&quot;Returns an HTML list of all &quot;
+                             &quot;registered commands.&quot;),
+                     RetDoc (&quot;HTML list of commands&quot;)));
+
+    declareFunction(&quot;helpOnCommandHTML&quot;, &amp;HelpSystem::helpOnCommandHTML,
+                    (BodyDoc(&quot;Will return full help for the &quot;
+                             &quot;command with the given name, in HTML&quot;),
+                     ArgDoc (&quot;commandname&quot;, 
+                             &quot;The name of the command on which to get help&quot;),
+                     RetDoc (&quot;help text for the command, in HTML&quot;)));
+
+// Functions
+
+    declareFunction(&quot;listFunctions&quot;, &amp;HelpSystem::listFunctions,
+                    (BodyDoc(&quot;Returns a list of all registered global &quot;
+                             &quot;functions as pairs of (funtionname, nargs)&quot;),
+                     RetDoc (&quot;vector of function names, arity&quot;)));
+
+    declareFunction(&quot;listFunctionPrototypes&quot;, 
+                    &amp;HelpSystem::listFunctionPrototypes,
+                    (BodyDoc(&quot;Returns a list of the prototypes &quot;
+                             &quot;of all registered global functions&quot;),
+                     RetDoc (&quot;vector of function prototypes as strings&quot;)));
+
+    declareFunction(&quot;helpFunctions&quot;, &amp;HelpSystem::helpFunctions,
+                    (BodyDoc(&quot;Returns a list of all registered global &quot;
+                             &quot;functions as plain text&quot;),
+                     RetDoc (&quot;plain text list of functions&quot;)));
+
+    declareFunction(&quot;helpOnFunction&quot;, &amp;HelpSystem::helpOnFunction,
+                    (BodyDoc(&quot;Will return full help on all registered &quot;
+                             &quot;global functions with the given name &quot;),
+                     ArgDoc (&quot;functionname&quot;, 
+                             &quot;The name of the function on which to get help&quot;),
+                     ArgDoc (&quot;arity&quot;, &quot;The number of params&quot;),
+                     RetDoc (&quot;help text for the function&quot;)));
+
+    // HTML
+    declareFunction(&quot;helpFunctionsHTML&quot;, &amp;HelpSystem::helpFunctionsHTML,
+                    (BodyDoc(&quot;Returns a list of all registered global &quot;
+                             &quot;functions as an HTML page.&quot;),
+                     RetDoc (&quot;HTML list of functions&quot;)));
+
+    declareFunction(&quot;helpOnFunctionHTML&quot;, &amp;HelpSystem::helpOnFunctionHTML,
+                    (BodyDoc(&quot;Will return full HTML help on all registered &quot;
+                             &quot;global functions with the given name &quot;),
+                     ArgDoc (&quot;functionname&quot;, 
+                             &quot;The name of the function on which to get help&quot;),
+                     ArgDoc (&quot;arity&quot;, &quot;The number of params&quot;),
+                     RetDoc (&quot;HTML help text for the function&quot;)));
+
+// Classes
+
+    declareFunction(&quot;listClasses&quot;, &amp;HelpSystem::listClasses,
+                    (BodyDoc(&quot;Returns a list of all registered Object classes&quot;),
+                     RetDoc (&quot;vector of class names&quot;)));
+
+    declareFunction(&quot;getClassTree&quot;, &amp;HelpSystem::getClassTree,
+                    (BodyDoc(&quot;Returns a map, mapping all registered &quot;
+                             &quot;Object classnames to their parentclassname&quot;),
+                     RetDoc (&quot;map of class names to class names&quot;)));
+
+    declareFunction(&quot;helpClasses&quot;, &amp;HelpSystem::helpClasses,
+                    (BodyDoc(&quot;Returns a plain text list of all registered Object classes&quot;),
+                     RetDoc (&quot;plain text list of class names&quot;)));
+
+    declareFunction(&quot;helpOnClass&quot;, &amp;HelpSystem::helpOnClass,
+                    (BodyDoc(&quot;Will return full help for &quot;
+                             &quot;the class with the given name&quot;),
+                     ArgDoc (&quot;classname&quot;, 
+                             &quot;The name of the class on which to get help&quot;),
+                     RetDoc (&quot;help text for the class&quot;)));
+
+    declareFunction(&quot;precisOnClass&quot;, &amp;HelpSystem::precisOnClass,
+                    (BodyDoc(&quot;Will return short class descr. and list of build options&quot;),
+                     ArgDoc (&quot;classname&quot;, 
+                             &quot;The name of the class on which to get help&quot;),
+                     RetDoc (&quot;pair of classname and list of options&quot;)));
+
+    // HTML
+    declareFunction(&quot;helpClassesHTML&quot;, &amp;HelpSystem::helpClassesHTML,
+                    (BodyDoc(&quot;Returns a list of all registered Object &quot;
+                             &quot;classes as an HTML page.&quot;),
+                     RetDoc (&quot;HTML list of class names&quot;)));
+
+    declareFunction(&quot;helpOnClassHTML&quot;, &amp;HelpSystem::helpOnClassHTML,
+                    (BodyDoc(&quot;Will return full HTML help for &quot;
+                             &quot;the class with the given name&quot;),
+                     ArgDoc (&quot;classname&quot;, 
+                             &quot;The name of the class on which to get help&quot;),
+                     RetDoc (&quot;HTML help text for the class&quot;)));
+    // Parents
+    declareFunction(&quot;listClassParents&quot;, &amp;HelpSystem::listClassParents,
+                    (BodyDoc(&quot;List of parent classes.&quot;),
+                     ArgDoc (&quot;classname&quot;, 
+                             &quot;The name of the class on which to get parents&quot;),
+                     RetDoc (&quot;vector of parent class names&quot;)));
+
+    declareFunction(&quot;helpClassParents&quot;, &amp;HelpSystem::helpClassParents,
+                    (BodyDoc(&quot;Text list of parent classes.&quot;),
+                     ArgDoc (&quot;classname&quot;, 
+                             &quot;The name of the class on which to get parents&quot;),
+                     RetDoc (&quot;text list of parent class names&quot;)));
+
+    declareFunction(&quot;helpClassParentsHTML&quot;, &amp;HelpSystem::helpClassParentsHTML,
+                    (BodyDoc(&quot;HTML list of parent classes.&quot;),
+                     ArgDoc (&quot;classname&quot;, 
+                             &quot;The name of the class on which to get parents&quot;),
+                     RetDoc (&quot;HTML list of parent class names&quot;)));
+    // Children
+    declareFunction(&quot;listDerivedClasses&quot;, &amp;HelpSystem::listDerivedClasses,
+                    (BodyDoc(&quot;List of derived classes.&quot;),
+                     ArgDoc (&quot;classname&quot;, 
+                             &quot;The name of the class on which to get children&quot;),
+                     RetDoc (&quot;List of derived class names&quot;)));
+
+    declareFunction(&quot;helpDerivedClasses&quot;, &amp;HelpSystem::helpDerivedClasses,
+                    (BodyDoc(&quot;Text list of derived classes.&quot;),
+                     ArgDoc (&quot;classname&quot;, 
+                             &quot;The name of the class on which to get children&quot;),
+                     RetDoc (&quot;Text list of derived class names&quot;)));
+
+    declareFunction(&quot;helpDerivedClassesHTML&quot;, &amp;HelpSystem::helpDerivedClassesHTML,
+                    (BodyDoc(&quot;HTML list of derived classes.&quot;),
+                     ArgDoc (&quot;classname&quot;, 
+                             &quot;The name of the class on which to get children&quot;),
+                     RetDoc (&quot;HTML list of derived class names&quot;)));
+
+// Options
+
+    declareFunction(&quot;listClassOptions&quot;, &amp;HelpSystem::listClassOptions,
+                    (BodyDoc(&quot;Returns a list of all options &quot;
+                             &quot;for the given class.&quot;),
+                     ArgDoc (&quot;classname&quot;, &quot;The name of the class &quot;
+                             &quot;on which to get option help&quot;),
+                     RetDoc (&quot;vector of option names&quot;)));
+
+    declareFunction(&quot;listBuildOptions&quot;, &amp;HelpSystem::listBuildOptions,
+                    (BodyDoc(&quot;Returns a list of build options &quot;
+                             &quot;for the given class.&quot;),
+                     ArgDoc (&quot;classname&quot;, &quot;The name of the class &quot;
+                             &quot;on which to get option help&quot;),
+                     RetDoc (&quot;vector of option names&quot;)));
+
+    declareFunction(&quot;helpOnOption&quot;, &amp;HelpSystem::helpOnOption,
+                    (BodyDoc(&quot;Will return full help for the option with &quot;
+                             &quot;the given name within the given class&quot;),
+                     ArgDoc (&quot;classname&quot;, &quot;The name of the class &quot;
+                             &quot;on which to get option help&quot;),
+                     ArgDoc (&quot;optionname&quot;, 
+                             &quot;The name of the option on which to get help&quot;),
+                     RetDoc (&quot;help text for the option&quot;)));
+    // HTML
+    declareFunction(&quot;helpClassOptionsHTML&quot;, &amp;HelpSystem::helpClassOptionsHTML,
+                    (BodyDoc(&quot;Returns a list of all options &quot;
+                             &quot;for the given class as an HTML page.&quot;),
+                     ArgDoc (&quot;classname&quot;, &quot;The name of the class &quot;
+                             &quot;on which to get option help&quot;),
+                     RetDoc (&quot;HTML list of option names&quot;)));
+
+    declareFunction(&quot;helpOnOptionHTML&quot;, &amp;HelpSystem::helpOnOptionHTML,
+                    (BodyDoc(&quot;Will return full HTML help for the option &quot;
+                             &quot;with the given name within the given class&quot;),
+                     ArgDoc (&quot;classname&quot;, &quot;The name of the class &quot;
+                             &quot;on which to get option help&quot;),
+                     ArgDoc (&quot;optionname&quot;, 
+                             &quot;The name of the option on which to get help&quot;),
+                     RetDoc (&quot;HTML help text for the option&quot;)));
+
+// Methods
+
+    declareFunction(&quot;listMethods&quot;, &amp;HelpSystem::listMethods,
+                    (BodyDoc(&quot;Returns a list of all registered methods &quot;
+                             &quot;for the given class as pairs of (methodname, nargs)&quot;),
+                     ArgDoc (&quot;classname&quot;, 
+                             &quot;The name of the class whose methods you want to list.&quot;),
+                     RetDoc (&quot;vector of method names&quot;)));
+
+    declareFunction(&quot;listMethodPrototypes&quot;, 
+                    &amp;HelpSystem::listMethodPrototypes,
+                    (BodyDoc(&quot;Returns a list of the prototypes of &quot;
+                             &quot;all registered methods for the given class&quot;),
+                     ArgDoc (&quot;classname&quot;, &quot;The name of the class &quot;
+                             &quot;whose method prototypes you want to list.&quot;),
+                     RetDoc (&quot;vector of prototypes as strings&quot;)));
+
+    declareFunction(&quot;helpMethods&quot;, &amp;HelpSystem::helpMethods,
+                    (BodyDoc(&quot;Returns a list of all registered methods &quot;
+                             &quot;for the given class as text.&quot;),
+                     ArgDoc (&quot;classname&quot;, 
+                             &quot;The name of the class whose methods you want to list.&quot;),
+                     RetDoc (&quot;Text list of method names&quot;)));
+
+    declareFunction(&quot;helpOnMethod&quot;, &amp;HelpSystem::helpOnMethod,
+                    (BodyDoc(&quot;Will return full help on all registered &quot;
+                             &quot;methods of the class with the given name&quot;),
+                     ArgDoc (&quot;classname&quot;, &quot;The name of the class&quot;),
+                     ArgDoc (&quot;methodname&quot;, &quot;The name of the method&quot;),
+                     ArgDoc (&quot;arity&quot;, &quot;The number of params&quot;),
+                     RetDoc (&quot;help text&quot;)));
+
+    // HTML
+    declareFunction(&quot;helpMethodsHTML&quot;, &amp;HelpSystem::helpMethodsHTML,
+                    (BodyDoc(&quot;Returns a list of all registered methods &quot;
+                             &quot;for the given class as an HTML page.&quot;),
+                     ArgDoc (&quot;classname&quot;, 
+                             &quot;The name of the class whose methods you want to list.&quot;),
+                     RetDoc (&quot;HTML list of method names&quot;)));
+
+    declareFunction(&quot;helpOnMethodHTML&quot;, &amp;HelpSystem::helpOnMethodHTML,
+                    (BodyDoc(&quot;Will return full help on all registered &quot;
+                             &quot;methods of the class with the given name&quot;),
+                     ArgDoc (&quot;classname&quot;, &quot;The name of the class&quot;),
+                     ArgDoc (&quot;methodname&quot;, &quot;The name of the method&quot;),
+                     ArgDoc (&quot;arity&quot;, &quot;The number of params&quot;),
+                     RetDoc (&quot;help text in HTML&quot;)));
+
+// HTML-only
+
+    declareFunction(&quot;helpIndexHTML&quot;, &amp;HelpSystem::helpIndexHTML,
+                    (BodyDoc(&quot;Returns the global help index in HTML.&quot;),
+                     RetDoc (&quot;HTML global help index&quot;)));
+
+    declareFunction(&quot;setResourcesPathHTML&quot;, 
+                    &amp;HelpSystem::setResourcesPathHTML,
+                    (BodyDoc(&quot;Sets the help resource path &quot;
+                             &quot;for HTML resources.&quot;),
+                     ArgDoc (&quot;path&quot;,&quot;HTML help resource path&quot;)));
+
+    declareFunction(&quot;getResourcesPathHTML&quot;, 
+                    &amp;HelpSystem::getResourcesPathHTML,
+                    (BodyDoc(&quot;Gets the help resource path &quot;
+                             &quot;for HTML resources.&quot;),
+                     RetDoc (&quot;path of HTML resources&quot;)));
+
+END_DECLARE_REMOTE_FUNCTIONS
+
+
+PP&lt;OptionBase&gt; HelpSystem::getOptionByName(const string&amp; classname, 
+                                           const string&amp; optionname)
+{
+    const TypeMapEntry&amp; e= TypeFactory::instance().getTypeMapEntry(classname);
+    OptionList&amp; optlist= (*e.getoptionlist_method)();
+    for(OptionList::iterator it= optlist.begin();
+        it != optlist.end(); ++it)
+        if((*it)-&gt;optionname() == optionname)
+            return *it;
+    return 0;//not found...
+}
+
+
 } // end of namespace PLearn
 
 

Modified: trunk/plearn/base/HelpSystem.h
===================================================================
--- trunk/plearn/base/HelpSystem.h	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/base/HelpSystem.h	2007-04-05 01:35:37 UTC (rev 6834)
@@ -2,6 +2,7 @@
 
 // HelpSystem.h
 // Copyright (c) 2006 Pascal Vincent
+// Copyright (C) 2007 Xavier Saint-Mleux, ApSTAT Technologies, inc.
 
 // Redistribution and use in source and binary forms, with or without
 // modification, are permitted provided that the following conditions are met:
@@ -40,6 +41,7 @@
 #include &lt;vector&gt;
 #include &lt;utility&gt;
 #include &lt;map&gt;
+#include &lt;plearn/base/OptionBase.h&gt;
 
 namespace PLearn {
 using std::string;
@@ -47,66 +49,209 @@
 using std::pair;
 using std::map;
 
-//! Returns a list of all registered global functions as pairs of (funtionname, nargs)
-vector&lt; pair&lt;string, int&gt; &gt; listFunctions();
 
-//! Returns a list of the prototypes of all registered global functions
-vector&lt;string&gt; listFunctionPrototypes();
+struct HelpSystem // more or less a namespace
+{
 
-//! Will return full help on all registered global functions with the given name 
-string helpFunction(const string&amp; functionname);
+    /**
+     * Help on Commands
+     */
 
-//! Returns a list of all registered methods for the given class as pairs of (methodname, nargs)
-vector&lt; pair&lt;string, int&gt; &gt; listMethods(const string&amp; classname);
+    //! Returns a list of all plearn command names
+    static vector&lt;string&gt; listCommands();
 
-//! Returns a list of the prototypes of all registered methods for the given class
-vector&lt;string&gt; listMethodPrototypes(const string&amp; classname);
+    //! Returns a text list of all plearn command names
+    static string helpCommands();
 
-//! Will return full help on all registered methods of the class with the given name 
-string helpMethod(const string&amp; classname, const string&amp; methodname);
+    //! Will return full help on the given command
+    static string helpOnCommand(const string&amp; commandname);
 
-//! Returns a list of all registered Object classes
-vector&lt;string&gt; listClasses();
+    //! Returns a list of all plearn commands as an HTML page
+    static string helpCommandsHTML();
 
-//! Returns a map, mapping all registered Object classnames to their parentclassname
-map&lt;string, string&gt; getClassTree();
+    //! Will return full HTML help on the given command
+    static string helpOnCommandHTML(const string&amp; commandname);
 
-/*
+    /**
+     * Help on Global Functions
+     */
 
-//! Returns a list of all direct subclasses of classname
-//! Throws an exception if classname is not registered.
-vector&lt;string&gt; childrenOf(const string&amp; classname);
+    //! Returns a list of all registered global functions as pairs of (funtionname, nargs)
+    static vector&lt;pair&lt;string, int&gt; &gt; listFunctions();
 
-//! Returns a list of all descendents of the given class
-//! Throws an exception if classname is not registered.
-vector&lt;string&gt; descendantsOf(const string&amp; classname);
+    //! Returns a list of the prototypes of all registered global functions
+    static vector&lt;string&gt; listFunctionPrototypes();
 
-//! Returns the parent class of classname (empty string if no parent)
-//! Throws an exception if classname is not registered.
-string parentOf(const string&amp; classname);
+    //! Returns a list of all registered global functions in plain text
+    static string helpFunctions();
 
-//! Returns the structured FunctionHelp object describing the specified function
-//! Throws an exception if no function is registered with that name and number of arguments
-//FunctionHelp getFunctionDoc(const string&amp; functionname, int nargs);
+    //! Will return full help on all registered global functions with the given name 
+    static string helpOnFunction(const string&amp; functionname, int arity);
 
-//! Returns the structured FunctionHelp object describing the specified method
-//! Throws an exception if classname is not registered or if it has no
-//! registered method with that name and number of arguments.
-//FunctionHelp getMethodDoc(const string&amp; classname, const string&amp; methodname, int nargs);
+    //! Returns a list of all registered global functions as an HTML page
+    static string helpFunctionsHTML();
 
+    //! Will return full help on all registered global functions with
+    //! the given name, as an HTML string.
+    static string helpOnFunctionHTML(const string&amp; functionname, int arity);
 
-//! Returns the list of options
-// vector&lt;string&gt; listClassOptions(const string&amp; classname);
 
-//! Will returns detailed help on registered class with the given name
-//! listing its parent class, and detailed help on all options including inherited ones,
-//! as well as listing all its registered methods.
-string helpClass(const string&amp; classname);
+    /**
+     * Help on Registered Classes
+     */
 
+    //! Returns a list of all registered Object classes
+    static vector&lt;string&gt; listClasses();
 
-*/
+    //! Returns a map, mapping all registered Object classnames to their parentclassname
+    static map&lt;string, string&gt; getClassTree();
 
+    //! Returns a list of all registered Object classes as plain text
+    static string helpClasses();
 
+    //! Will returns detailed help on registered class with the given name
+    //! listing its parent class, and detailed help on all options including inherited ones,
+    //! as well as listing all its registered methods.
+    static string helpOnClass(const string&amp; classname);
+
+    //! Returns a list of all registered Object classes as an HTML page
+    static string helpClassesHTML();
+
+    //! same as helpOnClass, but in HTML
+    static string helpOnClassHTML(const string&amp; classname);
+
+    /* Class Parents */
+
+    //! Returns a list of all parent classes of this class
+    //! list goes from classname::inherited up to Object
+    static vector&lt;string&gt; listClassParents(const string&amp; classname);
+
+    //! Returns a text list of all parent classes of this class
+    //! list goes from Object down to classname
+    static string helpClassParents(const string&amp; classname);
+
+    //! Returns an HTML list of all parent classes of this class
+    //! list goes from Object down to classname
+    static string helpClassParentsHTML(const string&amp; classname);
+
+    /* Derived Classes */
+
+    //! Returns a list of all instantiable classes derived from 'classname'
+    static vector&lt;string&gt; listDerivedClasses(const string&amp; classname);
+
+    //! Returns a text list of all instantiable classes derived from 'classname'
+    static string helpDerivedClasses(const string&amp; classname);
+
+    //! Returns an HTML list of all instantiable classes derived from 'classname'
+    static string helpDerivedClassesHTML(const string&amp; classname);
+
+    //! Returns a pair of class descr. and list of build options
+    static pair&lt;string, vector&lt;string&gt; &gt; precisOnClass(const string&amp; classname);
+
+    /**
+     * Help on Class Options
+     */
+
+     //! Returns the list of all options for the class with the given name
+    static vector&lt;string&gt; listClassOptions(const string&amp; classname);
+
+     //! Returns the list of build options for the class with the given name
+    static vector&lt;string&gt; listBuildOptions(const string&amp; classname);
+
+     //! Returns the list of options for the class with the given name, as text
+    static string helpClassOptions(const string&amp; classname);
+
+    //! Will return full help on the declared option of the class with the given name 
+    static string helpOnOption(const string&amp; classname, const string&amp; optionname);
+
+     //! Returns the list of options for the class with the given name, in HTML
+    static string helpClassOptionsHTML(const string&amp; classname);
+
+    //! Will return full help on the declared option of the class
+    //! with the given name, as an HTML string.
+    static string helpOnOptionHTML(const string&amp; classname, 
+                                   const string&amp; optionname);
+
+    //! Returns the default value for this option, or &quot;?&quot; if 
+    //! it is from an abstract class
+    static string getOptionDefaultVal(const string&amp; classname, 
+                                      const string&amp; optionname);
+
+    //! Returns the class that defines this option, or &quot;&quot; if not known
+    static string getOptionDefiningClass(const string&amp; classname, 
+                                         const string&amp; optionname);
+
+    /**
+     * Help on Class Methods
+     */
+
+    //! Returns a list of all registered methods for the 
+    //! given class as pairs of (methodname, nargs)
+    static vector&lt;pair&lt;string, int&gt; &gt; listMethods(const string&amp; classname);
+
+    //! Returns a list of the prototypes of all registered methods for the given class
+    static vector&lt;string&gt; listMethodPrototypes(const string&amp; classname);
+
+    //! Returns a list of all registered methods for the 
+    //! given class as text
+    static string helpMethods(const string&amp; classname);
+
+    //! Will return full help on the registered method of the class with the 
+    //! given name and arity
+    static string helpOnMethod(const string&amp; classname, 
+                               const string&amp; methodname, int arity= -1);
+
+    //! Returns a list of all registered methods for the 
+    //! given class as an HTML page
+    static string helpMethodsHTML(const string&amp; classname);
+
+    //! Will return full help on the registered method of the class 
+    //! with the given name and arity, as an HTML string.
+    static string helpOnMethodHTML(const string&amp; classname, 
+                                   const string&amp; methodname, int arity= -1);
+
+    /**
+     * HTML Help
+     */
+
+private:
+    //! Directory that holds HTML resources.
+    //! These include: 
+    //! - index.html (optional)
+    //! - help_prolog.html
+    //! - help_epilog.html
+    //! e.g. {PLEARNDIR}/python_modules/plearn/plide/resources
+    static string html_resources_path;
+    
+public:
+    //! Sets the path for resources for HTML help
+    static void setResourcesPathHTML(const string&amp; path)
+    { html_resources_path= path; }
+
+    //! Returns the path for resources for HTML help
+    static string getResourcesPathHTML()
+    { return html_resources_path; }
+
+    //! Returns the global help index as an HTML page
+    static string helpIndexHTML();
+
+    //! Returns the standard heading for HTML help
+    static string helpPrologueHTML(const string&amp; title= 
+                                   &quot;PLearn User-Level Documentation&quot;);
+
+    //! Returns the standard ending for HTML help
+    static string helpEpilogueHTML();
+
+
+
+private:
+    static PP&lt;OptionBase&gt; getOptionByName(const string&amp; classname, 
+                                          const string&amp; optionname);
+
+
+};
+
+
 } // end of namespace PLearn
 
 #endif //!&lt;  HelpSystem_INC_

Modified: trunk/plearn/base/Object.h
===================================================================
--- trunk/plearn/base/Object.h	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/base/Object.h	2007-04-05 01:35:37 UTC (rev 6834)
@@ -174,7 +174,7 @@
         static bool _isa_(const Object* o);                     \
         virtual CLASSTYPE* deepCopy(CopiesMap &amp;copies) const;   \
         static void _static_initialize_();                      \
-        static StaticInitializer _static_initializer_
+        static StaticInitializer _static_initializer_           
 
 #define PLEARN_IMPLEMENT_ABSTRACT_OBJECT(CLASSTYPE, ONELINEDESCR, MULTILINEHELP)                \
         string CLASSTYPE::_classname_()                                                         \

Modified: trunk/plearn/base/TypeFactory.cc
===================================================================
--- trunk/plearn/base/TypeFactory.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/base/TypeFactory.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -114,6 +114,8 @@
 
 //#####  displayObjectHelp  ###################################################
 
+// DEPRECATED: use HelpSystem instead
+/*
 void displayObjectHelp(ostream&amp; out, const string&amp; classname)
 {
     const TypeMap&amp; type_map = TypeFactory::instance().getTypeMap();
@@ -212,9 +214,9 @@
     out &lt;&lt; &quot;\n\n################################################################## \n&quot; &lt;&lt; endl;
 
 }
+*/
 
 
-
 } // end of namespace PLearn
 
 

Modified: trunk/plearn/base/TypeFactory.h
===================================================================
--- trunk/plearn/base/TypeFactory.h	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/base/TypeFactory.h	2007-04-05 01:35:37 UTC (rev 6834)
@@ -180,7 +180,7 @@
 
 
 //! Will display the help message for an object of the given classname
-void displayObjectHelp(ostream&amp; out, const string&amp; classname);
+//void displayObjectHelp(ostream&amp; out, const string&amp; classname); //!&lt; DEPRECATED: use HelpSystem
 
 
 } // end of namespace PLearn

Modified: trunk/plearn/base/test/ObjectGraphIterator/pytest.config
===================================================================
--- trunk/plearn/base/test/ObjectGraphIterator/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/base/test/ObjectGraphIterator/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,10 +98,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn &quot;object=ObjectGraphIteratorTest(save = 0)&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=ObjectGraphIteratorTest(save = 0)\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,

Modified: trunk/plearn/base/test/PP/pytest.config
===================================================================
--- trunk/plearn/base/test/PP/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/base/test/PP/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,10 +98,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn object=&quot;PPTest(save = 0)&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn object=\&quot;PPTest(save = 0)\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,

Modified: trunk/plearn/base/test/pytest.config
===================================================================
--- trunk/plearn/base/test/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/base/test/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -93,16 +93,16 @@
     
 &quot;&quot;&quot;
 Test(
-  name = &quot;PL_assert&quot;,
-  description = &quot;Exercises the PLearn assertion-checking mechanism&quot;,
-  category = &quot;General&quot;,
-  program = Program(
-    name = &quot;assertions&quot;,
-    compiler = &quot;pymake&quot;
-    ),
-  arguments = &quot;&quot;,
-  resources = [ ],
-  precision = 1e-06,
-  pfileprg = None,
-  disabled = False
-  )
+    name = &quot;PL_assert&quot;,
+    description = &quot;Exercises the PLearn assertion-checking mechanism&quot;,
+    category = &quot;General&quot;,
+    program = Program(
+        name = &quot;assertions&quot;,
+        compiler = &quot;pymake&quot;
+        ),
+    arguments = &quot;&quot;,
+    resources = [ ],
+    precision = 1e-06,
+    pfileprg = None,
+    disabled = False
+    )

Modified: trunk/plearn/io/PStream.cc
===================================================================
--- trunk/plearn/io/PStream.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/io/PStream.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -265,6 +265,25 @@
     return oldmode;
 }
 
+
+/////////////
+// readAll //
+/////////////
+
+string PStream::readAll()
+{
+    const int bufsz= 4096;
+    char buf[bufsz];
+    string s= &quot;&quot;;
+    int nread= ptr-&gt;read(buf, bufsz);
+    while(nread &gt; 0)
+    {
+        s.append(buf, nread);
+        nread= ptr-&gt;read(buf, bufsz);
+    }
+    return s;
+}
+
 //////////////////
 // readExpected //
 //////////////////

Modified: trunk/plearn/io/PStream.h
===================================================================
--- trunk/plearn/io/PStream.h	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/io/PStream.h	2007-04-05 01:35:37 UTC (rev 6834)
@@ -339,6 +339,9 @@
         return *this;
     }
 
+    //! Reads ultil eof, returns whole contents as a string
+    string readAll();
+
     //! Reads the next character and launches a PLERROR if it is different from
     //! expect.
     void readExpected(char expect);

Modified: trunk/plearn/io/fileutils.cc
===================================================================
--- trunk/plearn/io/fileutils.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/io/fileutils.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -690,7 +690,7 @@
 /////////////////////////
 // readAndMacroProcess //
 /////////////////////////
-string readAndMacroProcess(PStream&amp; in, map&lt;string, string&gt;&amp; variables)
+string readAndMacroProcess(PStream&amp; in, map&lt;string, string&gt;&amp; variables, bool skip_comments)
 {
     string text; // the processed text to return
     bool inside_a_quoted_string=false; // inside a quoted string we don't skip characters following a #
@@ -702,11 +702,10 @@
         if (last_c!='\\' &amp;&amp; c=='&quot;') // we find either the beginning or end of a quoted string
             inside_a_quoted_string = !inside_a_quoted_string; // flip status
 
-        if(!inside_a_quoted_string &amp;&amp; c=='#')  // It's a comment: skip rest of line
-        {
+        if(!inside_a_quoted_string &amp;&amp; c=='#' &amp;&amp; skip_comments)
+            // It's a comment: skip rest of line
             while(c!=EOF &amp;&amp; c!='\n' &amp;&amp; c!='\r')
                 c = in.get();
-        }
 
         if(c==EOF)
             break;

Modified: trunk/plearn/io/fileutils.h
===================================================================
--- trunk/plearn/io/fileutils.h	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/io/fileutils.h	2007-04-05 01:35:37 UTC (rev 6834)
@@ -204,7 +204,8 @@
 //! entry in the map (the DEFINE macro will be discarded).
 //! Also every $INCLUDE{filepath} will be replaced in place by the text of
 //! the file it includes
-string readAndMacroProcess(PStream&amp; in, map&lt;string, string&gt;&amp; variables);
+string readAndMacroProcess(PStream&amp; in, map&lt;string, string&gt;&amp; variables, 
+                           bool skip_comments= true);
 
 /*! Given a filename, generates the standard PLearn variables FILEPATH,
   DIRPATH, FILENAME, FILEBASE, FILEEXT, DATE, TIME and DATETIME and

Modified: trunk/plearn/io/pl_log.cc
===================================================================
--- trunk/plearn/io/pl_log.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/io/pl_log.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -50,6 +50,7 @@
 #include &lt;plearn/base/stringutils.h&gt;
 #include &lt;plearn/io/StringPStreamBuf.h&gt;
 #include &quot;pl_log.h&quot;
+#include &quot;ServerLogStreamBuf.h&quot;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn/io/pl_log.h
===================================================================
--- trunk/plearn/io/pl_log.h	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/io/pl_log.h	2007-04-05 01:35:37 UTC (rev 6834)
@@ -55,7 +55,6 @@
 
 // From Plearn
 #include &quot;PStream.h&quot;
-#include &quot;ServerLogStreamBuf.h&quot;
 
 namespace PLearn {
 

Modified: trunk/plearn/io/test/pytest.config
===================================================================
--- trunk/plearn/io/test/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/io/test/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -91,10 +99,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn &quot;object=PLLogTest(save = 0)&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=PLLogTest(save = 0)\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,
@@ -107,10 +114,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn &quot;object=PStreamBufTest(save = 0)&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=PStreamBufTest(save = 0)\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,
@@ -123,10 +129,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn &quot;object=PPathTest(save = 0)&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=PPathTest(save = 0)\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,
@@ -139,10 +144,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn &quot;object=TupleTest(save = 0)&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=TupleTest(save = 0)\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,

Modified: trunk/plearn/math/TMat_decl.h
===================================================================
--- trunk/plearn/math/TMat_decl.h	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/math/TMat_decl.h	2007-04-05 01:35:37 UTC (rev 6834)
@@ -633,7 +633,8 @@
     {
 #ifdef BOUNDCHECK
         if(rowstart&lt;0 || newlength&lt;0 || rowstart+newlength&gt;length())
-            PLERROR(&quot;TMat::subMatRows(int rowstart, int newlength) OUT OF BOUNDS&quot;);
+            PLERROR(&quot;TMat::subMatRows(int rowstart, int newlength) OUT OF BOUNDS&quot;
+                    &quot;length=%d, rowstart=%d, newlength=%d&quot;, length(), rowstart, newlength);
 #endif
         TMat&lt;T&gt; subm = *this;
         subm.length_ = newlength;

Modified: trunk/plearn/math/TMat_maths_impl.h
===================================================================
--- trunk/plearn/math/TMat_maths_impl.h	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/math/TMat_maths_impl.h	2007-04-05 01:35:37 UTC (rev 6834)
@@ -1126,6 +1126,7 @@
             o[i] = - v[i];
         return opposite;
     }
+    return TVec&lt;T&gt;();
 }
 
 template&lt;class T&gt;

Modified: trunk/plearn/math/test/PentadiagonalSolveInPlace/pytest.config
===================================================================
--- trunk/plearn/math/test/PentadiagonalSolveInPlace/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/math/test/PentadiagonalSolveInPlace/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,10 +98,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn &quot;object=PentaTest(save = 0)&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=PentaTest(save = 0)\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,

Modified: trunk/plearn/math/test/TMat/pytest.config
===================================================================
--- trunk/plearn/math/test/TMat/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/math/test/TMat/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,8 +98,7 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
     arguments = &quot;tmat_test.pyplearn&quot;,
     resources = [ &quot;tmat_test.pyplearn&quot; ],

Modified: trunk/plearn/math/test/VecStatsCollector/pytest.config
===================================================================
--- trunk/plearn/math/test/VecStatsCollector/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/math/test/VecStatsCollector/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -100,7 +100,7 @@
         name = &quot;plearn_tests&quot;,
         compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn object=&quot;RemoveObservationTest(save=0)&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn object=\&quot;RemoveObservationTest(save=0)\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,
@@ -115,8 +115,7 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
     arguments = &quot;constant_regressor.pyplearn&quot;,
     resources = [ &quot;constant_regressor.pyplearn&quot; ],

Modified: trunk/plearn/math/test/pl_math/pytest.config
===================================================================
--- trunk/plearn/math/test/pl_math/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/math/test/pl_math/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,10 +98,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn &quot;object=PLMathTest()&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=PLMathTest()\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,

Modified: trunk/plearn/misc/PLearnServer.cc
===================================================================
--- trunk/plearn/misc/PLearnServer.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/misc/PLearnServer.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -51,8 +51,8 @@
 #include &lt;plearn/io/load_and_save.h&gt;
 #include &lt;plearn/io/pl_log.h&gt;
 #include &lt;plearn/math/random.h&gt;
-
 #include &lt;plearn/io/PyPLearnScript.h&gt; // For smartLoadObject
+#include &lt;plearn/io/ServerLogStreamBuf.h&gt; 
 
 namespace PLearn {
 using namespace std;
@@ -102,11 +102,16 @@
     getInstance()-&gt;io.implicit_storage = impl_stor;
 }
 
-void PLearnServer::setVerbosity(int verbosity)
+void PLearnServer::loggingControl(int vlevel, TVec&lt;string&gt; modules)
 {
-    PL_Log::instance().verbosity(verbosity);
+    PL_Log::instance().verbosity(vlevel);
+    PL_Log::instance().enableNamedLogging(modules);
 }
 
+void PLearnServer::setOptionLevel(const OptionBase::OptionLevel&amp; level)
+{
+    OptionBase::setCurrentOptionLevel(level);
+}
 
 BEGIN_DECLARE_REMOTE_FUNCTIONS
 
@@ -124,10 +129,15 @@
                 (BodyDoc(&quot;change the implicit_storage mode of the io of the PLearnServer instance.\n&quot;),
                  ArgDoc (&quot;impl_stor&quot;, &quot;Whether or not to use implicit_storage&quot;)));
 
-declareFunction(&quot;setVerbosity&quot;, &amp;PLearnServer::setVerbosity,
-                (BodyDoc(&quot;change the verbosity for logs of the PLearnServer instance.\n&quot;),
-                 ArgDoc (&quot;verbosity&quot;, &quot;verbosity level&quot;)));
+declareFunction(&quot;loggingControl&quot;, &amp;PLearnServer::loggingControl,
+                (BodyDoc(&quot;Set current logging level and modules.\n&quot;),
+                 ArgDoc (&quot;vlevel&quot;,&quot;the verbosity level&quot;),
+                 ArgDoc (&quot;modules&quot;,&quot;list of modules names to log&quot;)));
 
+declareFunction(&quot;setOptionLevel&quot;, &amp;PLearnServer::setOptionLevel,
+                (BodyDoc(&quot;Set current option level.\n&quot;),
+                 ArgDoc (&quot;level&quot;,&quot;option level&quot;)));
+
 END_DECLARE_REMOTE_FUNCTIONS
 
 
@@ -200,6 +210,7 @@
     io &lt;&lt; endl;
 }
 
+
 bool PLearnServer::run()
 {
     int obj_id;
@@ -219,8 +230,8 @@
     // forward pout&amp;perr to client
     PStream orig_pout= pout;
     PStream orig_perr= perr;
-    pout= new ServerLogStreamBuf(io, &quot;pout&quot;);
-    perr= new ServerLogStreamBuf(io, &quot;perr&quot;);
+    pout= new ServerLogStreamBuf(io, &quot;pout&quot;, VLEVEL_NORMAL);
+    perr= new ServerLogStreamBuf(io, &quot;perr&quot;, VLEVEL_NORMAL);
 
     DBG_LOG &lt;&lt; &quot;ENTERING PLearnServer::run()&quot; &lt;&lt; endl;
 
@@ -315,6 +326,7 @@
                 DBG_LOG &lt;&lt; &quot;  ojbj_id = &quot; &lt;&lt; obj_id &lt;&lt; endl;
                 found = objmap.find(obj_id);
                 DBG_LOG &lt;&lt; &quot;objmap= &quot; &lt;&lt; objmap &lt;&lt; endl;
+                DBG_LOG &lt;&lt; &quot;cmo= &quot; &lt;&lt; io.copies_map_out &lt;&lt; endl;
                 if(found == objmap.end()) // unexistant obj_id
                     PLERROR(&quot;Calling a method on a non-existing object&quot;);
                 else 

Modified: trunk/plearn/misc/PLearnServer.h
===================================================================
--- trunk/plearn/misc/PLearnServer.h	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/misc/PLearnServer.h	2007-04-05 01:35:37 UTC (rev 6834)
@@ -98,8 +98,12 @@
     //! change the implicit_storage mode of the io of the PLearnServer instance.
     static void implicit_storage(bool impl_stor);
 
-    static void setVerbosity(int verbosity);
+    //! Set current logging level and modules to log
+    static void loggingControl(int vlevel, TVec&lt;string&gt; modules);
 
+    //! Set current option level
+    static void setOptionLevel(const OptionBase::OptionLevel&amp; level);
+
 };
 
 

Modified: trunk/plearn/misc/PLearnService.cc
===================================================================
--- trunk/plearn/misc/PLearnService.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/misc/PLearnService.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -127,7 +127,9 @@
 
         reserved_servers.insert(serv);
         serv-&gt;getResults();
-        serv-&gt;callFunction(&quot;setVerbosity&quot;, PL_Log::instance().verbosity());
+        serv-&gt;callFunction(&quot;loggingControl&quot;, 
+                           PL_Log::instance().verbosity(),
+                           PL_Log::instance().namedLogging());
         serv-&gt;getResults();
         reserved_servers.erase(serv);
         available_servers.push(serv);
@@ -375,7 +377,7 @@
 PLearnService::~PLearnService()
 {
     if(reserved_servers.size() != 0)
-        PLERROR(&quot;PLearnService::~PLearnService : some servers are still reserved; free them first.&quot;);
+        PLWARNING(&quot;PLearnService::~PLearnService : some servers are still reserved; free them first.&quot;);
 
     TVec&lt;PP&lt;RemotePLearnServer&gt; &gt; servers(available_servers.length());
     servers &lt;&lt; available_servers;

Modified: trunk/plearn/misc/PLearnService.h
===================================================================
--- trunk/plearn/misc/PLearnService.h	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/misc/PLearnService.h	2007-04-05 01:35:37 UTC (rev 6834)
@@ -133,6 +133,8 @@
                            log_callback_t the_log_callback = log_callback,
                            progress_callback_t the_progress_callback = progress_callback);
     
+    static pair&lt;string, int&gt; getId(RemotePLearnServer* server) { return servers_ids[server]; }
+
     ~PLearnService();
 };
 

Modified: trunk/plearn/misc/RemotePLearnServer.cc
===================================================================
--- trunk/plearn/misc/RemotePLearnServer.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/misc/RemotePLearnServer.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -204,16 +204,6 @@
 {
     deleteAllObjectsAsync();
     getResults();
-/*
-    if(io)
-    {
-        io.write(&quot;!Z &quot;); 
-        io &lt;&lt; endl;
-        expectResults(0);
-    }
-    else
-        DBG_LOG &lt;&lt; &quot;in RemotePLearnServer::deleteAllObjects() : stream not good.&quot; &lt;&lt; endl;
-*/
 }
 
 void RemotePLearnServer::deleteAllObjectsAsync()
@@ -252,7 +242,11 @@
         break;
     case 'E':
         io &gt;&gt; msg;
-        PLERROR(msg.c_str());
+        {
+            pair&lt;string, int&gt; id= PLearnService::getId(this);
+            PLERROR(&quot;From server %s %d : %s&quot;, id.first.c_str(), id.second, 
+                    msg.c_str());
+        }
         break;
     default:
         PLERROR(&quot;RemotePLearnServer: expected R (return command), but read %c ????&quot;,command);

Modified: trunk/plearn/misc/test/pytest.config
===================================================================
--- trunk/plearn/misc/test/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/misc/test/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,10 +98,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn &quot;object=HeapTest(save = 0)&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=HeapTest(save = 0)\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,

Modified: trunk/plearn/misc/vmatmain.cc
===================================================================
--- trunk/plearn/misc/vmatmain.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/misc/vmatmain.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -56,6 +56,7 @@
 #include &lt;plearn/db/getDataSet.h&gt;
 #include &lt;plearn/display/Gnuplot.h&gt;
 #include &lt;plearn/io/openFile.h&gt;
+#include &lt;plearn/base/HelpSystem.h&gt;
 
 namespace PLearn {
 using namespace std;
@@ -490,8 +491,9 @@
             &quot;all matrix file formats. Type 'vmat help dataset' to see what other\n&quot;
             &quot;&lt;dataset&gt; strings are available.&quot; &lt;&lt; endl;
 #endif
-
-        PLearnCommandRegistry::help(&quot;vmat&quot;, cout);
+        
+        //PLearnCommandRegistry::help(&quot;vmat&quot;, cout);
+        pout &lt;&lt; HelpSystem::helpOnCommand(&quot;vmat&quot;) &lt;&lt; flush;
         exit(0);
     }
 

Modified: trunk/plearn/opt/test/pytest.config
===================================================================
--- trunk/plearn/opt/test/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/opt/test/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,8 +98,7 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
     arguments = &quot;--enable-logging ConjGradientOptimizer conjgradientoptimizer_test.plearn&quot;,
     resources = [ &quot;conjgradientoptimizer_test.plearn&quot; ],
@@ -106,17 +113,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn ' +\
-                '&quot;object=ConjRosenbrock('                       +\
-                '    D=2,opt='                                  +\
-                '    ConjGradientOptimizer(nstages     = 12,'   +\
-                '                          sigma       = 0.1,'  +\
-                '                          rho         = 0.05,' +\
-                '                          slope_ratio = 10,'   +\
-                '                          verbosity   = 1))&quot;'  ,
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=ConjRosenbrock(    D=2,opt=    ConjGradientOptimizer(nstages     = 12,                          sigma       = 0.1,                          rho         = 0.05,                          slope_ratio = 10,                          verbosity   = 1))\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,
@@ -129,20 +128,11 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn ' +\
-                '&quot;object=ConjRosenbrock('                       +\
-                '    D=100,opt='                                +\
-                '    ConjGradientOptimizer(nstages     = 12,'   +\
-                '                          sigma       = 0.1,'  +\
-                '                          rho         = 0.05,' +\
-                '                          slope_ratio = 10,'   +\
-                '                          verbosity   = 1))&quot;'  ,
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=ConjRosenbrock(    D=100,opt=    ConjGradientOptimizer(nstages     = 12,                          sigma       = 0.1,                          rho         = 0.05,                          slope_ratio = 10,                          verbosity   = 1))\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,
     disabled = False
     )
-

Modified: trunk/plearn/python/PythonCodeSnippet.cc
===================================================================
--- trunk/plearn/python/PythonCodeSnippet.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/python/PythonCodeSnippet.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -473,6 +473,40 @@
     PythonGlobalInterpreterLock gil;         // For thread-safety
     if (PyErr_Occurred()) {
         if (m_remap_python_exceptions) {
+
+            // format using cgitb, throw as PythonError (PLearnError)
+            PyObject *exception, *v, *traceback;
+            PyErr_Fetch(&amp;exception, &amp;v, &amp;traceback);
+            PyErr_NormalizeException(&amp;exception, &amp;v, &amp;traceback);
+            
+            //PyObject* tbstr= PyString_FromString(&quot;cgitb&quot;);
+            PyObject* tbstr= PyString_FromString(&quot;plearn.utilities.pltraceback&quot;);
+            PyObject* tbmod= PyImport_Import(tbstr);
+            Py_XDECREF(tbstr);
+            if(!tbmod)
+                throw PythonException(&quot;PythonCodeSnippet::handlePythonErrors : &quot;
+                                      &quot;Unable to import cgitb module.&quot;);
+            PyObject* tbdict= PyModule_GetDict(tbmod);
+            Py_XDECREF(tbmod);
+            PyObject* formatFunc= PyDict_GetItemString(tbdict, &quot;text&quot;);
+            if(!formatFunc)
+                throw PythonException(&quot;PythonCodeSnippet::handlePythonErrors : &quot;
+                                      &quot;Can't find cgitb.text&quot;);
+            PyObject* args= Py_BuildValue(&quot;((OOO))&quot;, exception, v, traceback);
+            if(!args)
+                throw PythonException(&quot;PythonCodeSnippet::handlePythonErrors : &quot;
+                                      &quot;Can't build args for cgitb.text&quot;);
+            PyObject* pystr= PyObject_CallObject(formatFunc, args);
+            Py_XDECREF(args);
+            if(!pystr)
+                throw PythonException(&quot;PythonCodeSnippet::handlePythonErrors : &quot;
+                                      &quot;call to cgitb.text failed&quot;);
+            string str= PyString_AsString(pystr);
+            Py_XDECREF(pystr);
+            
+            throw PythonException(str);
+
+/*
             PyObject *ptype = 0, *pvalue = 0, *ptraceback = 0;
             PyErr_Fetch(&amp;ptype, &amp;pvalue, &amp;ptraceback);
 
@@ -491,8 +525,14 @@
                 msg += string(&quot;\nException Type: &quot;) + PyString_AsString(ptype_str);
             if (pvalue_str)
                 msg += string(&quot;\nException Value: &quot;) + PyString_AsString(pvalue_str);
+            char* ptraceback_as_str= 0;
             if (ptraceback_str)
-                msg += string(&quot;\nTraceback: &quot;) + PyString_AsString(ptraceback_str);
+            {
+                ptraceback_as_str= PyTraceback_AsString(ptraceback_str);
+                //msg += string(&quot;\nTraceback: &quot;) + PyString_AsString(ptraceback_str);
+                msg += string(&quot;\nTraceback: &quot;) + ptraceback_as_str;
+                PyMem_Free(ptraceback_as_str);
+            }
 
             Py_XDECREF(ptype);
             Py_XDECREF(pvalue);
@@ -502,6 +542,7 @@
             Py_XDECREF(ptraceback_str);
 
             throw PythonException(msg);
+*/
         }
         else {
             PyErr_Print();

Modified: trunk/plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results/RUN.log
===================================================================
--- trunk/plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results/RUN.log	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results/RUN.log	2007-04-05 01:35:37 UTC (rev 6834)
@@ -16,10 +16,31 @@
 Setting the string:   'This string should survive within the Python environment'
 Read back the string: 'This string should survive within the Python environment'
 Trying to read back from second snippet:
-Caught Python Exception: 'Encountered Python Exception
-Exception Type: exceptions.NameError
-Exception Value: global name 'buf' is not defined
-Traceback: &lt;traceback object at 0x[memory_address]&gt;'
+Caught Python Exception: 'NameError
+Python 2.3.5: /usr/bin/python
+
+
+A problem occurred in a Python script.  Here is the sequence of
+function calls leading up to the error, in the order they occurred.
+
+ &lt;string&gt; in get_value()
+
+NameError: global name 'buf' is not defined
+    __doc__ = 'Name not found globally.'
+    __getitem__ = &lt;bound method NameError.__getitem__ of &lt;exceptions.NameError instance&gt;&gt;
+    __init__ = &lt;bound method NameError.__init__ of &lt;exceptions.NameError instance&gt;&gt;
+    __module__ = 'exceptions'
+    __str__ = &lt;bound method NameError.__str__ of &lt;exceptions.NameError instance&gt;&gt;
+    args = (&quot;global name 'buf' is not defined&quot;,)
+
+The above is a description of an error in a Python program.  Here is
+the original traceback:
+
+Traceback (most recent call last):
+  File &quot;&lt;string&gt;&quot;, line 12, in get_value
+NameError: global name 'buf' is not defined
+
+'
 Associated 'some_global_map' with: {Oui: 16, bon: 512, est: 64, et: 256, il: 32, juste: 128}
 Read back from Python environment: {Oui: 16, bon: 512, est: 64, et: 256, il: 32, juste: 128}
 Printing some_global_map within Python: {'Oui': 16L, 'est': 64L, 'juste': 128L, 'il': 32L, 'bon': 512L, 'et': 256L}

Modified: trunk/plearn/python/test/pytest.config
===================================================================
--- trunk/plearn/python/test/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/python/test/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,10 +98,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn &quot;object=BasicIdentityCallsTest(save = 0)&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=BasicIdentityCallsTest(save = 0)\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,
@@ -106,10 +113,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn &quot;object=InterfunctionXchgTest(save = 0)&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=InterfunctionXchgTest(save = 0)\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,
@@ -122,10 +128,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn &quot;object=MemoryStressTest(save = 0)&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=MemoryStressTest(save = 0)\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,
@@ -153,10 +158,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn &quot;object=InjectionTest(save = 0)&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=InjectionTest(save = 0)\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,
@@ -169,11 +173,10 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'vmat cat test_python_vmatrix.pymat',
-    resources = [ 'test_python_vmatrix.pymat' ],
+    arguments = &quot;vmat cat test_python_vmatrix.pymat&quot;,
+    resources = [ &quot;test_python_vmatrix.pymat&quot; ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,
     disabled = False

Modified: trunk/plearn/var/test/pytest.config
===================================================================
--- trunk/plearn/var/test/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/var/test/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,10 +98,9 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
-    arguments = 'PLEARNDIR:scripts/command_line_object.plearn &quot;object=VarUtilsTest()&quot;',
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=VarUtilsTest()\&quot;&quot;,
     resources = [ ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,

Modified: trunk/plearn/vmat/BootstrapSplitter.cc
===================================================================
--- trunk/plearn/vmat/BootstrapSplitter.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/vmat/BootstrapSplitter.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -104,8 +104,8 @@
             // Note: indices in the bootstrapped sets are sorted, so that
             // access may be faster (e.g. when reading large data from disk).
             bootstrapped_sets(i,0) = 
-                new BootstrapVMatrix(dataset, frac, vmat_rgen, false,
-                                     allow_repetitions);
+                new BootstrapVMatrix(dataset,frac,vmat_rgen, 
+                                     false, allow_repetitions);
         }
     } else {
         bootstrapped_sets.resize(0,0);

Modified: trunk/plearn/vmat/EncodedVMatrix.cc
===================================================================
--- trunk/plearn/vmat/EncodedVMatrix.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/vmat/EncodedVMatrix.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -152,7 +152,6 @@
 /////////////////////////////////
 void EncodedVMatrix::makeDeepCopyFromShallowCopy(CopiesMap&amp; copies)
 {
-    PLERROR(&quot;EncodedVMatrix::makeDeepCopyFromShallowCopy fully implemented?&quot;);
     inherited::makeDeepCopyFromShallowCopy(copies);
     deepCopyField(encodings, copies);
     deepCopyField(defaults, copies);

Modified: trunk/plearn/vmat/VMatLanguage.cc
===================================================================
--- trunk/plearn/vmat/VMatLanguage.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/vmat/VMatLanguage.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -48,6 +48,7 @@
 #include &lt;plearn/io/fileutils.h&gt;
 #include &lt;plearn/io/openFile.h&gt;
 #include &lt;plearn/misc/Calendar.h&gt;
+#include &lt;plearn/math/pl_erf.h&gt;
 
 namespace PLearn {
 using namespace std;
@@ -186,7 +187,8 @@
                         &quot; _ sumabs         : v0 v1 v2 ... vn  --&gt;  sum_i |vi|\n&quot;
                         &quot;                    (no pop, and starts from the beginning of the stack)\n&quot;
                         &quot; _ varproduct     : a0 a1 ... an n+1 b0 b1 ... bm m+1 ... num_vars -&gt; res0 ...&quot;
-                        &quot;                    (product of encoded variables)&quot;
+                        &quot;                    (product of encoded variables)\n&quot;
+                        &quot; _ erf            : a     --&gt;  erf(a)    ; the error function erf\n&quot;
     );
 
 //////////////////
@@ -890,6 +892,7 @@
         opcodes[&quot;cos&quot;]  = 63;   // a -&gt; cos(a)
         opcodes[&quot;varproduct&quot;] = 64; // a0 a1 ... an n+1 b0 b1 ... bm m+1 ... num_vars -&gt; res0 ... (product of encoded variables)
         opcodes[&quot;thermometer&quot;] = 65; // index nclasses -&gt; thermometer encoding
+        opcodes[&quot;erf&quot;] = 66;
     }
 }
 
@@ -1347,6 +1350,9 @@
             
             break;
         }        
+        case 66: // erf
+            pstack.push(pl_erf(pstack.pop()));
+            break;
         default:
             PLASSERT_MSG(false, &quot;BUG IN VMatLanguage::run while running program: unexpected opcode: &quot; +
                          tostring(op));

Modified: trunk/plearn/vmat/test/pytest.config
===================================================================
--- trunk/plearn/vmat/test/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn/vmat/test/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -197,9 +197,6 @@
     disabled = False
     )
 
-# This test will fail if the VMat specialization of the diff function
-# (currently found in &lt;plearn/base/diff.h&gt;) does not function properly.
-# In particular, this is currently the case under Visual C++.
 Test(
     name = &quot;PL_diff_VMat&quot;,
     description = &quot;Tests the diff function to compare VMat options.&quot;,

Modified: trunk/plearn_learners/classifiers/test/KNNClassifier/pytest.config
===================================================================
--- trunk/plearn_learners/classifiers/test/KNNClassifier/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/classifiers/test/KNNClassifier/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,8 +98,7 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
     arguments = &quot;knn_classifier.pyplearn kernel=GaussianKernel sigma=1 output=tester&quot;,
     resources = [ &quot;knn_classifier.pyplearn&quot; ],
@@ -106,8 +113,7 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
     arguments = &quot;knn_classifier.pyplearn kernel=GaussianKernel sigma=3 output=tester&quot;,
     resources = [ &quot;knn_classifier.pyplearn&quot; ],
@@ -122,8 +128,7 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
     arguments = &quot;knn_classifier.pyplearn kernel=Constant output=grapher&quot;,
     resources = [ &quot;knn_classifier.pyplearn&quot; ],

Modified: trunk/plearn_learners/distributions/test/pytest.config
===================================================================
--- trunk/plearn_learners/distributions/test/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/distributions/test/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -189,14 +197,6 @@
     disabled = False
     )
 
-
-# The following test fails at ApSTAT with a crash, even with Boost 1.33.1. Maybe a gcc-3.3 compiler bug being tickled?
-# Here is the backtrace:
-#
-# #0  0x0874cc4f in std::list&lt;boost::detail::sep_&lt;unsigned int, boost::property&lt;boost::edge_bundle_t, PLearn::MissingFlag, boost::no_property&gt; &gt;, std::allocator&lt;boost::detail::sep_&lt;unsigned int, boost::property&lt;boost::edge_bundle_t, PLearn::MissingFlag, boost::no_property&gt; &gt; &gt; &gt;::begin (this=0x9415c68) at stl_list.h:571
-# #1  0x08748199 in out_edges&lt;boost::detail::adj_list_gen&lt;boost::adjacency_list&lt;boost::listS, boost::vecS, boost::directedS, PLearn::NoProperty, PLearn::MissingFlag, boost::no_property, boost::listS&gt;, boost::vecS, boost::listS, boost::directedS, boost::property&lt;boost::vertex_bundle_t, PLearn::NoProperty, boost::no_property&gt;, boost::property&lt;boost::edge_bundle_t, PLearn::MissingFlag, boost::no_property&gt;, boost::no_property, boost::listS&gt;::config, boost::directed_graph_helper&lt;boost::detail::adj_list_gen&lt;boost::adjacency_list&lt;boost::listS, boost::vecS, boost::directedS, PLearn::NoProperty, PLearn::MissingFlag, boost::no_property, boost::listS&gt;, boost::vecS, boost::listS, boost::directedS, boost::property&lt;boost::vertex_bundle_t, PLearn::NoProperty, boost::no_property&gt;, boost::property&lt;boost::edge_bundle_t, PLearn::MissingFlag, boost::no_property&gt;, boost::no_property, boost::listS&gt;::config&gt; &gt; (u=4, g_=@0xbfbf1f40) at adjacency_list.hpp:1510
-# #2  0x08741ec9 in PLearn::GaussMix::train (this=0x942dd18)
-#     at /home/chrish/PLearn/plearn_learners/distributions/GaussMix.cc:2859
 Test(
     name = &quot;PL_GaussMix_General_Missing&quot;,
     description = &quot;Test training of mixtures of Gaussians of general type with missing values&quot;,

Modified: trunk/plearn_learners/generic/PLearner.cc
===================================================================
--- trunk/plearn_learners/generic/PLearner.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/generic/PLearner.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -810,14 +810,20 @@
         costs.fill(-1);
         test_stats-&gt;update(costs);
     }
+
+
+    PP&lt;ProgressBar&gt; pb;
+    if (report_progress) 
+        pb = new ProgressBar(&quot;Testing learner&quot;, len);
+
 #ifndef BUGGED_SERVER
     PLearnService&amp; service(PLearnService::instance());
 
     //DUMMY: need to find a better way to calc. nservers -xsm
-    const int chunksize= 10000;//nb. rows in each chunk sent to a remote server
-    const int chunks_per_server= 10;//ideal nb. chunks per server
+    const int chunksize= 2500;//nb. rows in each chunk sent to a remote server
+    const int chunks_per_server= 3;//ideal nb. chunks per server
     int nservers= min(len/(chunks_per_server*chunksize), service.availableServers());
-
+    
     if(nservers &gt; 1 &amp;&amp; parallelize_here &amp;&amp; !isStatefulLearner())
     {// parallel test
         CopiesMap copies;
@@ -830,9 +836,15 @@
         map&lt;PP&lt;RemotePLearnServer&gt;, int&gt; learners_ids;
         map&lt;PP&lt;RemotePLearnServer&gt;, int&gt; chunknums;
         map&lt;int, PP&lt;VecStatsCollector&gt; &gt; vscs;
+        map&lt;PP&lt;RemotePLearnServer&gt;, int&gt; chunkszs;
+        int rowsdone= 0;
 
+        bool rep_prog= report_progress;
+        const_cast&lt;bool&amp;&gt;(report_progress)= false;//servers dont report progress
         for(int i= 0; i &lt; nservers; ++i)
             servers[i]-&gt;newObjectAsync(*this);
+        const_cast&lt;bool&amp;&gt;(report_progress)= rep_prog;
+
         while(nservers &gt; 0)
         {
             PP&lt;RemotePLearnServer&gt; s= service.waitForResult();
@@ -845,6 +857,7 @@
                     s-&gt;getResults(id);
                     learners_ids[s]= id;
                     int clen= min(chunksize, testset.length()-curpos);
+                    chunkszs[s]= clen;
                     VMat sts= new RowsSubVMatrix(testset, curpos, clen);
                     if(master_sends_testset_rows)
                         sts= new MemoryVMatrix(sts.toMat());
@@ -864,6 +877,7 @@
                 {
                     /* step 4 (once per slave) */
                     s-&gt;getResults(); // learner deleted
+                    s-&gt;unlink(testset);
                     service.freeServer(s);
                     --nservers;
                 }
@@ -875,11 +889,15 @@
 
                 s-&gt;getResults(vsc, chunkout, chunkcosts);
 
+                rowsdone+= chunkszs[s];
+                if(report_progress) pb-&gt;update(rowsdone);
+
                 int chunknum= chunknums[s];
                 if(curpos &lt; len) // more chunks to do, assign one to this server
                 {
                     /* step 2 (repeat as needed) */
                     int clen= min(chunksize, testset.length()-curpos);
+                    chunkszs[s]= clen;
                     VMat sts= new RowsSubVMatrix(testset, curpos, clen);
                     if(master_sends_testset_rows)
                         sts= new MemoryVMatrix(sts.toMat());
@@ -922,9 +940,7 @@
     else // Sequential test 
     {
 #endif
-        PP&lt;ProgressBar&gt; pb;
-        if (report_progress) 
-            pb = new ProgressBar(&quot;Testing learner&quot;, len);
+
         for (int i = 0; i &lt; len; i++)
         {
             testset.getExample(i, input, target, weight);

Modified: trunk/plearn_learners/generic/VPLCombinedLearner.cc
===================================================================
--- trunk/plearn_learners/generic/VPLCombinedLearner.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/generic/VPLCombinedLearner.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -341,10 +341,8 @@
     output.resize(outputsize());
     costs.resize(nTestCosts());
 
-    int ilen = input.length();
-    int tlen = target.length();
-    PLASSERT(ilen==inputsize());
-    PLASSERT(tlen==targetsize());
+    PLASSERT(input.length()==inputsize());
+    PLASSERT(target.length()==targetsize());
 
     output.resize(outputsize());
     int nlearners = sublearners_.length();    

Modified: trunk/plearn_learners/generic/VPLPreprocessedLearner2.cc
===================================================================
--- trunk/plearn_learners/generic/VPLPreprocessedLearner2.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/generic/VPLPreprocessedLearner2.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -482,10 +482,8 @@
     }
 
     PLASSERT( learner_ );
-    int ilen = input.length();
-    int tlen = target.length();
-    PLASSERT(ilen==inputsize());
-    PLASSERT(tlen==targetsize());
+    PLASSERT(input.length()==inputsize());
+    PLASSERT(target.length()==targetsize());
 
     Vec newinput = input;
     if(!input_prg.empty())//input_prg_)

Modified: trunk/plearn_learners/generic/test/SimpleNet/pytest.config
===================================================================
--- trunk/plearn_learners/generic/test/SimpleNet/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/generic/test/SimpleNet/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):

Modified: trunk/plearn_learners/meta/BaggingLearner.cc
===================================================================
--- trunk/plearn_learners/meta/BaggingLearner.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/meta/BaggingLearner.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -38,6 +38,11 @@
 
 
 #include &quot;BaggingLearner.h&quot;
+#include &lt;plearn/base/tostring.h&gt;
+#include &lt;plearn/base/ProgressBar.h&gt;
+#include &lt;plearn/misc/PLearnService.h&gt;
+#include &lt;plearn/misc/RemotePLearnServer.h&gt;
+#include &lt;plearn/vmat/MemoryVMatrix.h&gt;
 
 namespace PLearn {
 using namespace std;
@@ -49,10 +54,14 @@
 
 BaggingLearner::BaggingLearner(PP&lt;Splitter&gt; splitter_, 
                                PP&lt;PLearner&gt; template_learner_,
-                               char reduce_func_)
+                               TVec&lt;string&gt; stats_,
+                               int exclude_extremes_,
+                               bool output_sub_outputs_)
     :splitter(splitter_),
      template_learner(template_learner_),
-     reduce_func(reduce_func_)
+     stats(stats_),
+     exclude_extremes(exclude_extremes_),
+     output_sub_outputs(output_sub_outputs_)
 {
 }
 
@@ -68,16 +77,24 @@
                   &quot;Template for all sub-learners; deep-copied once for each bag&quot;,
                   &quot;&quot;, OptionBase::basic_level);
 
-    declareOption(ol, &quot;reduce_func&quot;, &amp;BaggingLearner::reduce_func,
+    declareOption(ol, &quot;stats&quot;, &amp;BaggingLearner::stats,
                   OptionBase::buildoption,
-                  &quot;Function used to combine outputs from all learners.\n&quot;
+                  &quot;Functions used to combine outputs from all learners.\n&quot;
                   &quot;\t- 'A' = Average\n&quot;,
                   &quot;&quot;, OptionBase::basic_level);
 
+    declareOption(ol, &quot;exclude_extremes&quot;, &amp;BaggingLearner::exclude_extremes,
+                  OptionBase::buildoption,
+                  &quot;If &gt;0, sub-learners outputs are sorted and the exclude_extremes &quot;
+                  &quot;highest and lowest are excluded&quot;);
+                  
+    declareOption(ol, &quot;output_sub_outputs&quot;, &amp;BaggingLearner::output_sub_outputs,
+                  OptionBase::buildoption,
+                  &quot;Wether computeOutput should append sub-learners outputs to output.&quot;);
+                  
     declareOption(ol, &quot;learners&quot;, &amp;BaggingLearner::learners,
                   OptionBase::learntoption,
-                  &quot;Trained sub-learners&quot;,
-                  &quot;&quot;, OptionBase::basic_level);
+                  &quot;Trained sub-learners&quot;);
 
     // Now call the parent class' declareOptions
     inherited::declareOptions(ol);
@@ -107,8 +124,13 @@
 }
 
 int BaggingLearner::outputsize() const
-{
-    return template_learner-&gt;outputsize();
+{ 
+    PLASSERT(template_learner);
+    PLASSERT(splitter);
+    int sz= template_learner-&gt;outputsize() * stats.length(); 
+    if(output_sub_outputs)
+        sz+= template_learner-&gt;outputsize() * splitter-&gt;nsplits();
+    return sz;
 }
 
 void BaggingLearner::forget()
@@ -145,15 +167,94 @@
         {
             CopiesMap c;
             learners[i]= template_learner-&gt;deepCopy(c);
+            learners[i]-&gt;report_progress= false;
         }
     }
 
+    PP&lt;ProgressBar&gt; pb= 0;
+    if(report_progress)
+        pb= new ProgressBar(&quot;BaggingLearner::train&quot;,nbags);
+
+    PLearnService&amp; service(PLearnService::instance());
+    int nservers= min(nbags, service.availableServers());
+
+    if(nservers &gt; 1 &amp;&amp; parallelize_here)//parallel train
+    {
+        TVec&lt;PP&lt;RemotePLearnServer&gt; &gt; servers= service.reserveServers(nservers);
+        nservers= servers.length();
+
+        map&lt;PP&lt;RemotePLearnServer&gt;, int&gt; learners_ids;
+        map&lt;PP&lt;RemotePLearnServer&gt;, int&gt; bagnums;
+        map&lt;PP&lt;RemotePLearnServer&gt;, int&gt; step;
+
+        for(int i= 0; i &lt; nservers; ++i)
+        {
+            RemotePLearnServer* s= servers[i];
+            int id= s-&gt;newObject(*learners[i]);
+            VMat sts= splitter-&gt;getSplit(i)[0];
+            if(master_sends_testset_rows)
+                sts= new MemoryVMatrix(sts.toMat());
+            s-&gt;callMethod(id, &quot;setTrainingSet&quot;, sts, true);
+            learners_ids[s]= id;
+            bagnums[s]= i;
+            step[s]= 1;
+        }
+
+        int lastbag= nservers-1;
+        int ndone= 0;
+
+        while(nservers &gt; 0)
+        {
+            PP&lt;RemotePLearnServer&gt; s= service.waitForResult();
+            switch(step[s])
+            {
+            case 1: 
+                DBG_LOG &lt;&lt; &quot;** get setTrainingSet result&quot; &lt;&lt; endl;
+                s-&gt;getResults();//from setTrainingSet
+                s-&gt;callMethod(learners_ids[s], &quot;train&quot;);
+                step[s]= 2;
+                break;
+            case 2:
+                DBG_LOG &lt;&lt; &quot;** get train result&quot; &lt;&lt; endl;
+                s-&gt;getResults();//from train
+                if(pb) pb-&gt;update(++ndone);
+                s-&gt;callMethod(learners_ids[s], &quot;getObject&quot;);
+                step[s]= 3;
+                break;
+            case 3:
+                DBG_LOG &lt;&lt; &quot;** get getObject result&quot; &lt;&lt; endl;
+                s-&gt;getResults(learners[bagnums[s]]);//from getObject
+                s-&gt;deleteObject(learners_ids[s]);
+                if(++lastbag &lt; nbags)
+                {
+                    int id= s-&gt;newObject(*learners[lastbag]);
+                    VMat sts= splitter-&gt;getSplit(lastbag)[0];
+                    if(master_sends_testset_rows)
+                        sts= new MemoryVMatrix(sts.toMat());
+                    s-&gt;callMethod(id, &quot;setTrainingSet&quot;, sts, true);
+                    learners_ids[s]= id;
+                    bagnums[s]= lastbag;
+                    step[s]= 1;
+                }
+                else
+                {
+                    service.freeServer(s);
+                    --nservers;
+                }
+                break;
+            }
+        }
+
+        return; // avoid extra indentation
+    }
+
     // sequential train
     for(int i= 0; i &lt; nbags; ++i)
     {
         PP&lt;PLearner&gt; l = learners[i];
         l-&gt;setTrainingSet(splitter-&gt;getSplit(i)[0]);
         l-&gt;train();
+        if(pb) pb-&gt;update(i);
     }
 
     stage++;
@@ -164,60 +265,94 @@
 {
     int nout = outputsize();
     output.resize(nout);
-    output.fill(0.);
     int nlearners= learners.size();
-    static TVec&lt;Vec&gt; learners_outputs(nlearners);//don't realloc every time
+    PLASSERT(template_learner);
+    int sub_nout = template_learner-&gt;outputsize();
+    learners_outputs.resize(nlearners, sub_nout);
 
+    last_test_input.resize(input.size());
+    last_test_input &lt;&lt; input;//save it, to test in computeCostsFromOutputs
+
     for(int i= 0; i &lt; nlearners; ++i)
-        learners[i]-&gt;computeOutput(input, learners_outputs[i]);
+    {
+        Vec outp= learners_outputs(i);
+        learners[i]-&gt;computeOutput(input, outp);
+    }
 
-    switch(reduce_func)
+    if(exclude_extremes &gt; 0)
     {
-    case 'A':
-        for(int i= 0; i &lt; nlearners; ++i)
-            for(int j= 0; j &lt; nout; ++j)
-                output[j]+= learners_outputs[i][j];
-        for(int j= 0; j &lt; nout; ++j)
-            output[j]/= nlearners;
-        break;
-    default:
-        PLERROR(&quot;BaggingLearner::computeOutput : reduce_func '%c' unknown.&quot;,
-                reduce_func);
+        outputs.resize(nlearners, sub_nout);
+        outputs &lt;&lt; learners_outputs;
+        //exclude highest and lowest n predictions for each output
+        int nexcl= 2*exclude_extremes;
+        if(nlearners &lt;= nexcl)
+            PLERROR(&quot;BaggingLearner::computeOutput : Cannot exclude all outputs! &quot;
+                    &quot;nlearners=%d, exclude_extremes=%d&quot;,nlearners,exclude_extremes);
+        // sort all in place, one output at a time
+        for(int j= 0; j &lt; sub_nout; ++j)
+            sortElements(outputs.column(j).toVec());
+        // exclude from both ends
+        outputs= outputs.subMatRows(exclude_extremes, outputs.length()-nexcl);
+        nlearners-= nexcl;
     }
+    else 
+        outputs= learners_outputs;
+
+    stcol.forget();
+    for(int i= 0; i &lt; outputs.length(); ++i)
+        stcol.update(outputs(i));
+    
+    int i= 0;
+    for(int j= 0; j &lt; stcol.size(); ++j)
+        for(TVec&lt;string&gt;::iterator it= stats.begin();
+            it != stats.end(); ++it)
+            output[i++]= stcol.getStats(j).getStat(*it);
+
+    if(output_sub_outputs)
+        for(int j= 0; j &lt; nlearners; ++j)
+            for(int k= 0; k &lt; sub_nout; ++k)
+                output[i++]= learners_outputs(j,k);
 }
 
 void BaggingLearner::computeCostsFromOutputs(const Vec&amp; input, const Vec&amp; output,
-                                           const Vec&amp; target, Vec&amp; costs) const
+                                             const Vec&amp; target, Vec&amp; costs) const
 {
-    // FIXME: for now, costs are the average of underlying learners' costs
-    //        BUT the name of those costs is the same... (misleading)
+    if(input != last_test_input)
+        PLERROR(&quot;BaggingLearner::computeCostsFromOutputs has to be called &quot;
+                &quot;right after computeOutput, with the same input.&quot;);
+    
     int nlearners= learners.size();
-    TVec&lt;Vec&gt; learners_costs(nlearners);
-    int ncosts= nTestCosts();
-    costs.resize(ncosts);
-    costs.fill(0.);
+    costs.resize(nTestCosts());
+    int k= 0;
     for(int i= 0; i &lt; nlearners; ++i)
-        learners[i]-&gt;computeCostsFromOutputs(input, output, target, 
-                                             learners_costs[i]);
-    for(int i= 0; i &lt; nlearners; ++i)
-        for(int j= 0; j &lt; ncosts; ++j)
-            costs[j]+= learners_costs[i][j];
-    for(int i= 0; i &lt; ncosts; ++i)
-        costs[i]/= nlearners;
+    {
+        Vec subcosts;
+        learners[i]-&gt;computeCostsFromOutputs(input, learners_outputs(i),
+                                             target, subcosts);
+        for(int j= 0; j &lt; subcosts.length(); ++j)
+            costs[k++]= subcosts[j];
+    }
+
 }
 
 TVec&lt;string&gt; BaggingLearner::getTestCostNames() const
 {
+    PLASSERT(splitter);
     PLASSERT(template_learner);
-    PLWARNING(&quot;BaggingLearner::getTestCostNames() : the test costs are actually the mean of test costs for all learners (bags).&quot;);
-    return template_learner-&gt;getTestCostNames();
+    int nbags= splitter-&gt;nsplits();
+    TVec&lt;string&gt; subcosts= template_learner-&gt;getTestCostNames();
+    TVec&lt;string&gt; costnames(nTestCosts());
+    int nsubcosts= subcosts.length();
+    int k= 0;
+    for(int i= 0; i &lt; nbags; ++i)
+        for(int j= 0; j &lt; nsubcosts; ++j)
+            costnames[k++]= string(&quot;learner&quot;)+tostring(i)+&quot;.&quot;+subcosts[j];
+    return costnames;
 }
 
 TVec&lt;string&gt; BaggingLearner::getTrainCostNames() const
 {
-    PLASSERT(template_learner);
-    PLWARNING(&quot;BaggingLearner::getTrainCostNames() : the train costs are actually the mean of train costs for all learners (bags).&quot;);
-    return template_learner-&gt;getTrainCostNames();
+    return TVec&lt;string&gt;(); // for now
 }
 
 ////////////////
@@ -225,8 +360,9 @@
 ////////////////
 int BaggingLearner::nTestCosts() const
 {
+    PLASSERT(splitter);
     PLASSERT(template_learner);
-    return template_learner-&gt;nTestCosts();
+    return splitter-&gt;nsplits()*template_learner-&gt;nTestCosts();
 }
 
 /////////////////
@@ -234,8 +370,7 @@
 /////////////////
 int BaggingLearner::nTrainCosts() const
 {
-    PLASSERT(template_learner);
-    return template_learner-&gt;nTrainCosts();
+    return 0;
 }
 
 ////////////////////////
@@ -265,7 +400,25 @@
     inherited::setTrainingSet(training_set, call_forget);
 }
 
+TVec&lt;string&gt; BaggingLearner::getOutputNames() const
+{
+    PLASSERT(template_learner);
+    PLASSERT(splitter);
+    TVec&lt;string&gt; suboutputnames= template_learner-&gt;getOutputNames();
+    TVec&lt;string&gt; outputnames= addStatNames(suboutputnames);
+    if(output_sub_outputs)
+    {
+        int nbags= splitter-&gt;nsplits();
+        int nsout= suboutputnames.length();
+        for(int i= 0; i &lt; nbags; ++i)
+            for(int j= 0; j &lt; nsout; ++j)
+                outputnames.append(string(&quot;learner&quot;)+tostring(i)+&quot;.&quot;+suboutputnames[j]);
+    }
+    return outputnames;
+}
 
+
+
 } // end of namespace PLearn
 
 

Modified: trunk/plearn_learners/meta/BaggingLearner.h
===================================================================
--- trunk/plearn_learners/meta/BaggingLearner.h	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/meta/BaggingLearner.h	2007-04-05 01:35:37 UTC (rev 6834)
@@ -57,15 +57,23 @@
 
     PP&lt;Splitter&gt; splitter; //!&lt; splitter used to get bags(=splits)
     PP&lt;PLearner&gt; template_learner; //!&lt; to deep-copy once for each bag
-    char reduce_func; //!&lt; function used to combine outputs from all learners
-    
+    //! functions used to combine outputs from all learners
+    TVec&lt;string&gt; stats;
+    //! for computeOutput: remove the highest and lowest 
+    //! outputs before averaging (nb. to exclude at each end)
+    int exclude_extremes; 
+    //! Wether computeOutput should append sub-learners outputs to output.
+    bool output_sub_outputs;
+
 public:
     //#####  Public Member Functions  #########################################
 
     //! Default constructor
     BaggingLearner(PP&lt;Splitter&gt; splitter_= 0, 
                    PP&lt;PLearner&gt; template_learner_= 0,
-                   char reduce_func_= 'A');
+                   TVec&lt;string&gt; stats_= TVec&lt;string&gt;(1,&quot;E&quot;),
+                   int exclude_extremes_= 0,
+                   bool output_sub_outputs_= false);
 
     //#####  PLearner Member Functions  #######################################
     virtual int outputsize() const;
@@ -90,6 +98,8 @@
 
     virtual void setTrainingSet(VMat training_set, bool call_forget=true);
 
+    virtual TVec&lt;string&gt; getOutputNames() const;
+
     //#####  PLearn::Object Protocol  #########################################
     PLEARN_DECLARE_OBJECT(BaggingLearner);
 
@@ -115,7 +125,25 @@
 private:
     //#####  Private Data Members  ############################################
 
-    // The rest of the private stuff goes here
+protected:
+    mutable VecStatsCollector stcol;
+    mutable Mat learners_outputs;
+    mutable Mat outputs;
+    mutable Vec learner_costs;
+    mutable Vec last_test_input;
+
+
+    TVec&lt;string&gt; addStatNames(const TVec&lt;string&gt;&amp; names) const
+    {
+        TVec&lt;string&gt; outputnames;
+        for(TVec&lt;string&gt;::iterator it= names.begin(); it != names.end(); ++it)
+            for(TVec&lt;string&gt;::const_iterator jt= stats.begin();
+                jt != stats.end(); ++jt)
+                outputnames.push_back(*jt + '[' + *it + ']');
+        return outputnames;
+    }
+
+
 };
 
 // Declares a few other classes and functions related to this class

Modified: trunk/plearn_learners/regressors/LinearRegressor.cc
===================================================================
--- trunk/plearn_learners/regressors/LinearRegressor.cc	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/regressors/LinearRegressor.cc	2007-04-05 01:35:37 UTC (rev 6834)
@@ -260,7 +260,8 @@
                              weight_decay, weights, 
                              !recompute_XXXY, XtX, XtY,
                              sum_squared_y, outputwise_sum_squared_Y,
-                             true, verbosity, cholesky, include_bias?1:0);
+                             true, report_progress?verbosity:0, 
+                             cholesky, include_bias?1:0);
     }
     else if (train_set-&gt;weightsize()==1)
     {
@@ -269,7 +270,8 @@
                                      train_set.subMatColumns(inputsize()+targetsize(),1),
                                      weight_decay, weights,
                                      !recompute_XXXY, XtX, XtY, sum_squared_y, outputwise_sum_squared_Y,
-                                     sum_gammas, true, verbosity, cholesky, include_bias?1:0);
+                                     sum_gammas, true, report_progress?verbosity:0, 
+                                     cholesky, include_bias?1:0);
     }
     else
         PLERROR(&quot;LinearRegressor: expected dataset's weightsize to be either 1 or 0, got %d\n&quot;,

Modified: trunk/plearn_learners/regressors/test/GaussianProcessRegressor/pytest.config
===================================================================
--- trunk/plearn_learners/regressors/test/GaussianProcessRegressor/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/regressors/test/GaussianProcessRegressor/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -101,7 +101,10 @@
         compiler = &quot;pymake&quot;
         ),
     arguments = &quot;server &lt; INPUTS_GPR&quot;,
-    resources = [ &quot;INPUTS_GPR&quot;, &quot;learner_hyperopt.plearn&quot; ],
+    resources = [
+        &quot;INPUTS_GPR&quot;,
+        &quot;learner_hyperopt.plearn&quot;
+        ],
     precision = 1e-06,
     pfileprg = &quot;__program__&quot;,
     disabled = False

Modified: trunk/plearn_learners/regressors/test/KernelRidgeRegressor/pytest.config
===================================================================
--- trunk/plearn_learners/regressors/test/KernelRidgeRegressor/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/regressors/test/KernelRidgeRegressor/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,8 +98,7 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
     arguments = &quot;kernel_ridge_regressor.pyplearn&quot;,
     resources = [ &quot;kernel_ridge_regressor.pyplearn&quot; ],
@@ -106,8 +113,7 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
     arguments = &quot;kernel_ridge_hyper_regressor.pyplearn&quot;,
     resources = [ &quot;kernel_ridge_hyper_regressor.pyplearn&quot; ],

Modified: trunk/plearn_learners/regressors/test/LinearRegressor/pytest.config
===================================================================
--- trunk/plearn_learners/regressors/test/LinearRegressor/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/regressors/test/LinearRegressor/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,8 +98,7 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
     arguments = &quot;linear_regressor.pyplearn&quot;,
     resources = [ &quot;linear_regressor.pyplearn&quot; ],

Modified: trunk/plearn_learners/regressors/test/PLS/pytest.config
===================================================================
--- trunk/plearn_learners/regressors/test/PLS/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/regressors/test/PLS/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,8 +98,7 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
     arguments = &quot;PL_pls.plearn&quot;,
     resources = [ &quot;PL_pls.plearn&quot; ],

Modified: trunk/plearn_learners/regressors/test/StackedPCARegression/pytest.config
===================================================================
--- trunk/plearn_learners/regressors/test/StackedPCARegression/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/regressors/test/StackedPCARegression/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):
@@ -90,8 +98,7 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
     arguments = &quot;stacked_pca_regression.pyplearn&quot;,
     resources = [ &quot;stacked_pca_regression.pyplearn&quot; ],
@@ -106,8 +113,7 @@
     category = &quot;General&quot;,
     program = Program(
         name = &quot;plearn_tests&quot;,
-        compiler = &quot;pymake&quot;,
-        compile_options = &quot;&quot;
+        compiler = &quot;pymake&quot;
         ),
     arguments = &quot;linear_regressor.pyplearn&quot;,
     resources = [ &quot;linear_regressor.pyplearn&quot; ],

Modified: trunk/plearn_learners/unsupervised/test/pytest.config
===================================================================
--- trunk/plearn_learners/unsupervised/test/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/plearn_learners/unsupervised/test/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):

Modified: trunk/python_modules/plearn/math/test/pytest.config
===================================================================
--- trunk/python_modules/plearn/math/test/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/python_modules/plearn/math/test/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -41,11 +41,12 @@
     3) Call 'which PRGNAME'
     4) Fail
     
-    Compilable program should provided the keyword argument 'compiler'
+    Compilable program should provide the keyword argument 'compiler'
     mapping to a string interpreted as the compiler name (e.g.
-    &quot;compiler = 'pymake'&quot;). Arguments to be forwarded to the compiler can be
-    provided as a string through the 'compile_options' keyword argument.
-      @type(program):
+    &quot;compiler = 'pymake'&quot;). If no compiler is provided while the program is
+    believed to be compilable, 'pymake' will be assigned by
+    default. Arguments to be forwarded to the compiler can be provided as a
+    string through the 'compile_options' keyword argument. @type program:
     Program
     
       @ivar(arguments):
@@ -78,6 +79,13 @@
       - A Program (see 'program' option) instance
       - None: if you are sure no files are to be compared.
     
+      @ivar(ignored_files_re):
+    Default behaviour of a test is to compare all
+    files created by running the test. In some case, one may prefer some of
+    these files to be ignored.
+      @type(ignored_files_re):
+    list of regular expressions
+    
       @ivar(disabled):
     If true, the test will not be ran.
       @type(disabled):

Modified: trunk/python_modules/plearn/parallel/dispatch.py
===================================================================
--- trunk/python_modules/plearn/parallel/dispatch.py	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/python_modules/plearn/parallel/dispatch.py	2007-04-05 01:35:37 UTC (rev 6834)
@@ -43,12 +43,12 @@
 # than once: use the MAX_LOADAVG map to allow for higher maximum load
 # average than the default of 2.
 SSH_MACHINES_MAP = { 'apstat.com': [ 'embla',
+                                     'valhalla',
                                      'inari', 
                                      'kamado',
                                      'loki',
                                      'odin',
                                      'midgard',
-                                     'valhalla',
                                      'vili'
                                      ],
 
@@ -59,8 +59,8 @@
                      }
 
 # To override the default of 1
-MAX_LOADAVG = { 'inari'  : 4 ,
-                'kamado' : 4 }
+MAX_LOADAVG = { 'inari'     : 4 ,
+                'kamado'    : 4 }
 
 # Do not perform a new query for the loadavg until recently launched
 # processes are likely to have started. 
@@ -338,7 +338,7 @@
             except Exception:
                 continue # Machine is rebooting, shut down, ...
 
-            max_loadavg = MAX_LOADAVG.get(m, cls._max_load)
+            max_loadavg = MAX_LOADAVG.get(m, 1.)*cls._max_load
             #print &quot;Load %f / %f&quot;%(loadavg, max_loadavg)
             if loadavg &lt; max_loadavg:
                 # Register the load average *plus* one, taking in account

Modified: trunk/python_modules/plearn/plide/plide.py
===================================================================
--- trunk/python_modules/plearn/plide/plide.py	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/python_modules/plearn/plide/plide.py	2007-04-05 01:35:37 UTC (rev 6834)
@@ -98,7 +98,7 @@
 
     PlideVersion = &quot;0.01&quot;
 
-    def __init__( self, *args, **kwargs ):
+    def __init__( self, streams_to_watch= {}, *args, **kwargs ):
         GladeAppWindow.__init__(self, gladeFile())
 
         ## Forward injected to imported Plide modules
@@ -119,7 +119,7 @@
         welcome_text = kwargs.get(&quot;welcome_text&quot;,
                                   &quot;&lt;b&gt;Welcome to Plide %s!&lt;/b&gt;&quot; % self.PlideVersion)
         self.status_display(welcome_text, has_markup=True)
-        self.setup_stdouterr_redirect()
+        self.setup_stdouterr_redirect(streams_to_watch)
         
         ## Set up help system
         injected.helpResourcesPath(helpResourcesPath())
@@ -164,7 +164,7 @@
             if help_context:
                 self.help_viewer.display_page(help_context)
             
-    def setup_stdouterr_redirect( self ):
+    def setup_stdouterr_redirect( self, streams_to_watch= {} ):
         &quot;&quot;&quot;Redirect standard output and error to be sent to the log pane
         instead of the console.
         &quot;&quot;&quot;
@@ -193,18 +193,21 @@
         fcntl.fcntl(self.stdout_read, fcntl.F_SETFL, out_flags | os.O_NONBLOCK)
         fcntl.fcntl(self.stderr_read, fcntl.F_SETFL, err_flags | os.O_NONBLOCK)
 
+        streams_to_watch.update({ self.stdout_read:'stdout',
+                                  self.stderr_read:'stderr' })
+
         def callback( fd, cb_condition ):
             # print &gt;&gt;raw_stderr, &quot;log_updater: got stuff on fd&quot;, fd, \
             #       &quot;with condition&quot;, cb_condition
             raw_stderr.flush()
             data = os.read(fd,65536)
 
-            kind = { self.stdout_read:'stdout', self.stderr_read:'stderr' }.get(fd,'')
+            kind = streams_to_watch.get(fd,'')
             self.log_display(data, kind)
             return True                 # Ensure it's called again!
         
-        gobject.io_add_watch(self.stdout_read, gobject.IO_IN, callback)
-        gobject.io_add_watch(self.stderr_read, gobject.IO_IN, callback)
+        for s in streams_to_watch:
+            gobject.io_add_watch(s, gobject.IO_IN, callback)
 
     def setup_statusbar( self ):
         &quot;&quot;&quot;Arrange the status bar area to contain both a status line and a progress bar.
@@ -651,7 +654,7 @@
                 options_holder.pyplearn_actualize()
             else:
                 ## FIXME: Generate a brand-new expdir (minor hack)
-                plargs._parse_([&quot;expdir=&quot;+generateExpdir()])
+                plargs.parse([&quot;expdir=&quot;+generateExpdir()])
                 
             expdir = plargs.expdir
             plearn_script = eval('str(PyPLearnScript( main() ))', script_env)
@@ -844,9 +847,9 @@
 #global plide_main_window
 plide_main_window = None
 
-def StartPlide(argv = []):
+def StartPlide(argv = [], streams_to_watch= {}):
     global plide_main_window
-    plide_main_window = PlideMain()
+    plide_main_window = PlideMain(streams_to_watch)
 
     ## Consider each file passed as command-line argument and create a tab
     ## to view it.
@@ -909,15 +912,43 @@
 
 #####  Standalone Running  ##################################################
 
+from plearn.io.server import *
+
+class Poubelle(RemotePLearnServer):
+    &quot;&quot;&quot;
+    Patch to test standalone running while 'slave' mode still exists.
+    &quot;&quot;&quot;
+    def __init__(self):
+        command= 'plearn server'
+        self.errstm= None
+        try:
+            from subprocess import Popen, PIPE
+            p= Popen([command], shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE, close_fds=True)
+            (to_server, from_server, child_pid) = (p.stdin, p.stdout, p.pid)
+            self.errstm= p.stderr
+        except:
+            to_server, from_server = os.popen2(command, 'b')
+            child_pid = -1
+        RemotePLearnServer.__init__(self,from_server, to_server, pid=child_pid)
+
+
+    def getAllClassnames(self): return self.listClasses()
+    def helpResourcesPath(self,path): return self.setResourcesPathHTML(path)
+    def helpIndex(self): return self.helpIndexHTML()
+    def helpClasses(self): return self.helpClassesHTML()
+    def helpCommands(self): return self.helpCommandsHTML()
+    def helpOnCommand(self, command): return self.helpOnCommandHTML(command)
+    def helpOnClass(self, classname): return self.helpOnClassHTML(classname)
+
 if __name__ == &quot;__main__&quot;:
-    class Poubelle:
-        def __getattr__(self, attr): return None
+    #class Poubelle:
+    #    def __getattr__(self, attr): return None
 
     global plide_main_window
     global injected
     injected = Poubelle()
     
-    StartPlide()
+    StartPlide(streams_to_watch= {injected.errstm.fileno(): 'injected-stderr'})
     # print &gt;&gt;sys.stderr, &quot;Random stuff to stderr&quot;
     # print &gt;&gt;sys.stdout, &quot;Random stuff to stdout&quot;
     # sys.stderr.flush()

Modified: trunk/python_modules/plearn/plide/plide_help.py
===================================================================
--- trunk/python_modules/plearn/plide/plide_help.py	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/python_modules/plearn/plide/plide_help.py	2007-04-05 01:35:37 UTC (rev 6834)
@@ -93,7 +93,9 @@
         &quot;&quot;&quot;Callback that's invoked when HTML widget reports that a link has
         been clicked by the user.
         &quot;&quot;&quot;       
+        #self.plide_main.cursor_hourglass()
         self.display_page(uri)
+        #self.plide_main.cursor_normal()
 
     def display_page( self, uri, doc = None ):
         &quot;&quot;&quot;Take the current page to the back list, clear the forward list,
@@ -108,20 +110,24 @@
         self.update_title(title)
 
     def go_back( self, widget ):
+        #self.plide_main.cursor_hourglass()
         if self.back_pages:
             if self.cur_page:
                 self.fwd_pages.append(self.cur_page)
             self.cur_page = self.back_pages.pop()
             title = self.update_doc_from_uri(self.cur_page)
             self.update_title(title)
+        #self.plide_main.cursor_normal()
 
     def go_forward( self, widget ):
+        #self.plide_main.cursor_hourglass()
         if self.fwd_pages:
             if self.cur_page:
                 self.back_pages.append(self.cur_page)
             self.cur_page = self.fwd_pages.pop()
             title = self.update_doc_from_uri(self.cur_page)
             self.update_title(title)
+        #self.plide_main.cursor_normal()
 
     def update_title( self, new_title ):
         &quot;&quot;&quot;Update the title label, and shade/unshade back-forward controls
@@ -137,6 +143,7 @@
         back-forward history or updates to the title.  Return the new page
         title.
         &quot;&quot;&quot;
+      
         if doc is None:
             doc = self.doc
 
@@ -158,14 +165,18 @@
             html  = injected.helpIndex()
             title = &quot;Help Index&quot;
 
-        elif uri == &quot;class_index.html&quot;:
+        elif uri == &quot;class_index.html&quot; or  uri == &quot;classes_index.html&quot;:
             html  = injected.helpClasses()
             title = &quot;Class Index&quot;
 
-        elif uri == &quot;command_index.html&quot;:
+        elif uri == &quot;command_index.html&quot; or uri == &quot;commands_index.html&quot;:
             html  = injected.helpCommands()
             title = &quot;Command Index&quot;
 
+        elif uri == &quot;functions_index.html&quot;:
+            html  = injected.helpFunctionsHTML()
+            title = &quot;Function Index&quot;
+
         elif uri.startswith(&quot;command_&quot;) and uri.endswith(&quot;.html&quot;):
             command = uri[8:-5]         # Drop prefix and suffix
             title   = command + &quot; (command)&quot;

Modified: trunk/python_modules/plearn/plide/plide_options.py
===================================================================
--- trunk/python_modules/plearn/plide/plide_options.py	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/python_modules/plearn/plide/plide_options.py	2007-04-05 01:35:37 UTC (rev 6834)
@@ -109,7 +109,8 @@
         #     plarg_defaults, 'Global Configuration Options'))
 
         ## Look at all options in plargs_namespace
-        for clsname,cls in plargs_namespace._subclasses.iteritems():
+        #for clsname,cls in plargs_namespace._subclasses.iteritems():
+        for clsname,cls in plnamespace._subclasses.iteritems():
             short_doc = toolkit_doc(cls, 0).rstrip('.')
             full_doc  = toolkit_doc(cls, 1, &quot;\n&quot;)
             group = PyPLearnOptionsGroup(clsname, public_members(cls).keys(),
@@ -123,11 +124,11 @@
         handles logging control.
         &quot;&quot;&quot;
         ## Generate a brand-new expdir
-        plargs._parse_([&quot;expdir=&quot;+generateExpdir()])
+        plargs.parse([&quot;expdir=&quot;+generateExpdir()])
         
         ## Apply the manual overrides
         if self.option_overrides:
-            plargs._parse_(self.option_overrides)
+            plargs.parse(self.option_overrides)
 
         verbosity_map = { 0:0, 1:1, 2:5, 3:10, 4:500 }
         verbosity = verbosity_map.get(self.log_verbosity, 5)

Modified: trunk/python_modules/plearn/plide/resources/help_prolog.html
===================================================================
--- trunk/python_modules/plearn/plide/resources/help_prolog.html	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/python_modules/plearn/plide/resources/help_prolog.html	2007-04-05 01:35:37 UTC (rev 6834)
@@ -125,10 +125,14 @@
 
 
 &lt;/style&gt;
-&lt;title&gt;PLearn User-Level Documentation&lt;/title&gt;
+&lt;!-- &lt;title&gt;PLearn User-Level Documentation&lt;/title&gt; --&gt;
+&lt;title&gt;${PAGE_TITLE}&lt;/title&gt;
 &lt;/head&gt;
 &lt;body id=&quot;wrapper&quot;&gt;
 &lt;div class=&quot;topnav&quot;&gt;
-  &lt;a href=&quot;index.html&quot;&gt;Main Index&lt;/a&gt;&lt;a href=&quot;class_index.html&quot;&gt;Class Index&lt;/a&gt;&lt;a href=&quot;command_index.html&quot;&gt;Command Index&lt;/a&gt;
+  &lt;a href=&quot;index.html&quot;&gt;Main Index&lt;/a&gt;
+  &lt;a href=&quot;classes_index.html&quot;&gt;Class Index&lt;/a&gt;
+  &lt;a href=&quot;commands_index.html&quot;&gt;Command Index&lt;/a&gt;
+  &lt;a href=&quot;functions_index.html&quot;&gt;Function Index&lt;/a&gt;
 &lt;/div&gt;
 &lt;!-- &lt;div id=&quot;banner&quot;&gt;&lt;/div&gt; --&gt;
\ No newline at end of file

Modified: trunk/python_modules/plearn/pyplearn/plargs.py
===================================================================
--- trunk/python_modules/plearn/pyplearn/plargs.py	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/python_modules/plearn/pyplearn/plargs.py	2007-04-05 01:35:37 UTC (rev 6834)
@@ -676,8 +676,9 @@
         context = actualContext(plargs)
         for statement in args:
             assert isinstance(statement, str), statement
-            
+
             option, value = statement.split('=', 1)
+
             option = option.strip()
             value  = value.strip()
 

Modified: trunk/python_modules/plearn/pyplearn/pytest.config
===================================================================
--- trunk/python_modules/plearn/pyplearn/pytest.config	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/python_modules/plearn/pyplearn/pytest.config	2007-04-05 01:35:37 UTC (rev 6834)
@@ -144,7 +144,7 @@
     name = &quot;PL_misspelled_plargs&quot;,
     description = &quot;&quot;,
     category = &quot;General&quot;,
-    program = Program(name=&quot;python&quot;),
+    program = Program( name = &quot;python&quot; ),
     arguments = &quot;-c \&quot;from plearn.pyplearn.plargs import test_misspelled_plargs; test_misspelled_plargs()\&quot; &quot;,
     resources = [ ],
     precision = 1e-06,

Added: trunk/python_modules/plearn/utilities/pltraceback.py
===================================================================
--- trunk/python_modules/plearn/utilities/pltraceback.py	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/python_modules/plearn/utilities/pltraceback.py	2007-04-05 01:35:37 UTC (rev 6834)
@@ -0,0 +1,14 @@
+
+# pltraceback.py
+
+&quot;&quot;&quot;
+Traceback text formatting; just use cgitb after replacing some functions...
+&quot;&quot;&quot;
+
+import os.path
+import time
+import cgitb
+
+time.ctime= lambda x: ''
+os.path.abspath= os.path.basename
+text= cgitb.text

Modified: trunk/scripts/xdispatch
===================================================================
--- trunk/scripts/xdispatch	2007-04-04 19:00:14 UTC (rev 6833)
+++ trunk/scripts/xdispatch	2007-04-05 01:35:37 UTC (rev 6834)
@@ -52,6 +52,11 @@
                       dest= &quot;nb_servers&quot;,
                       help='Number of servers to launch (maximum)',
                       default=3)
+
+    parser.add_option('-t', '--nb-servers-per-server', type=&quot;int&quot;,
+                      dest= &quot;nb_servers2&quot;,
+                      help='Number of servers to launch per server (maximum)',
+                      default=1)
    
     (options, args) = parser.parse_args()
 
@@ -66,8 +71,13 @@
             plearn_command= args[0]
             # launch slaves with the desired plearn executable
             for i in xrange(options.nb_servers):
-                launch_server( ['time',plearn_command, 'server', '0'] )
+                if options.nb_servers2 &lt; 2:
+                    launch_server( ['time',plearn_command, 'server', '0'] )
+                else:
+                    launch_server( ['xdispatch', '-s'+str(options.nb_servers2),
+                                    '--', plearn_command, 'server', '0'] )
 
+
             # temp file for the list of slaves (host, port, pid)
             tf, fname= tempfile.mkstemp(suffix= '.plserv', prefix= '.plserv_', dir= '/tmp/')
             for si in Task.getLaunchedServersInfo():


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000282.html">[Plearn-commits] r6833 - trunk/plearn_learners/classifiers
</A></li>
	<LI>Next message: <A HREF="000284.html">[Plearn-commits] r6835 - trunk/plearn/misc
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#283">[ date ]</a>
              <a href="thread.html#283">[ thread ]</a>
              <a href="subject.html#283">[ subject ]</a>
              <a href="author.html#283">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/plearn-commits">More information about the Plearn-commits
mailing list</a><br>
</body></html>
