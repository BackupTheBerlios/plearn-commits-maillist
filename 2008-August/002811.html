<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Plearn-commits] r9372 - trunk/plearn_learners_experimental
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/plearn-commits/2008-August/index.html" >
   <LINK REL="made" HREF="mailto:plearn-commits%40lists.berlios.de?Subject=Re%3A%20%5BPlearn-commits%5D%20r9372%20-%20trunk/plearn_learners_experimental&In-Reply-To=%3C200808151302.m7FD2ekZ016847%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002816.html">
   <LINK REL="Next"  HREF="002821.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Plearn-commits] r9372 - trunk/plearn_learners_experimental</H1>
    <B>larocheh at BerliOS</B> 
    <A HREF="mailto:plearn-commits%40lists.berlios.de?Subject=Re%3A%20%5BPlearn-commits%5D%20r9372%20-%20trunk/plearn_learners_experimental&In-Reply-To=%3C200808151302.m7FD2ekZ016847%40sheep.berlios.de%3E"
       TITLE="[Plearn-commits] r9372 - trunk/plearn_learners_experimental">larocheh at mail.berlios.de
       </A><BR>
    <I>Fri Aug 15 15:02:40 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="002816.html">[Plearn-commits] r9371 - trunk/plearn_learners/regressors
</A></li>
        <LI>Next message: <A HREF="002821.html">[Plearn-commits] r9373 - trunk/plearn/vmat
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2811">[ date ]</a>
              <a href="thread.html#2811">[ thread ]</a>
              <a href="subject.html#2811">[ subject ]</a>
              <a href="author.html#2811">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: larocheh
Date: 2008-08-15 15:02:39 +0200 (Fri, 15 Aug 2008)
New Revision: 9372

Modified:
   trunk/plearn_learners_experimental/PseudolikelihoodRBM.cc
Log:
- Corrected bug with sparse pseudolikelihood (forgot to set input_i)
- Added some (now commented) code to verify the gradient of pseudolikelihood


Modified: trunk/plearn_learners_experimental/PseudolikelihoodRBM.cc
===================================================================
--- trunk/plearn_learners_experimental/PseudolikelihoodRBM.cc	2008-08-14 20:41:39 UTC (rev 9371)
+++ trunk/plearn_learners_experimental/PseudolikelihoodRBM.cc	2008-08-15 13:02:39 UTC (rev 9372)
@@ -1081,6 +1081,7 @@
                 //      p_i = exp(num_pos) / (exp(num_pos) + exp(num_neg))
 
                 Vec hidden_act = hidden_layer-&gt;activation;
+
                 real num_pos_act;
                 real num_neg_act;
                 real num_pos;
@@ -1142,6 +1143,812 @@
                             hidden_layer-&gt;size );
                 }
 
+                //Mat estimated_gradient;
+                //Mat U_estimated_gradient;
+                //{
+                //    real epsilon=1e-5;
+                //    // Empirically estimate gradient
+                //    if( input_is_sparse )
+                //    {
+                //        estimated_gradient.resize(V.length(), V.width());
+                //        U_estimated_gradient.resize(U.length(), U.width() );
+                //
+                //        int i=0;
+                //        pseudolikelihood = 0;
+                //
+                //        // Compute activations
+                //        if( input_is_sparse )
+                //        {
+                //            if( factorized_connection_rank &gt; 0 )
+                //            {
+                //                Vx.clear();
+                //                train_set-&gt;getExtra(stage%nsamples,extra);
+                //                for( int i=0; i&lt;extra.length(); i++ )
+                //                {
+                //                    Vx += V((int)extra[i]);
+                //                    input_is_active[(int)extra[i]] = true;
+                //                }
+                //        
+                //                product(hidden_act,U,Vx);
+                //            }
+                //            else
+                //            {
+                //                hidden_act.clear();
+                //                train_set-&gt;getExtra(stage%nsamples,extra);
+                //                for( int i=0; i&lt;extra.length(); i++ )
+                //                {
+                //                    hidden_act += V((int)extra[i]);
+                //                    input_is_active[(int)extra[i]] = true;
+                //                }
+                //            }
+                //        }
+                //        else
+                //        {
+                //            connection-&gt;setAsDownInput( input );
+                //            hidden_layer-&gt;getAllActivations( 
+                //                (RBMMatrixConnection*) connection );
+                //        }
+                //
+                //        if( targetsize() == 1 )
+                //            productAcc( hidden_layer-&gt;activation,
+                //                        target_connection-&gt;weights,
+                //                        target_one_hot );
+                //        else if( targetsize() &gt; 1 )
+                //            productAcc( hidden_layer-&gt;activation,
+                //                        target_connection-&gt;weights,
+                //                        target );
+                //
+                //        for( int l=0; l&lt;input_layer-&gt;size ; l++ )
+                //        {
+                //            if( n_selected_inputs_pseudolikelihood &lt;= inputsize() &amp;&amp;
+                //                n_selected_inputs_pseudolikelihood &gt; 0 )
+                //            {
+                //                if( l &gt;= n_selected_inputs_pseudolikelihood )
+                //                    break;
+                //                i = input_indices[l];
+                //            }
+                //            else
+                //                i = l;
+                //            
+                //            num_pos_act = input_layer-&gt;bias[i];
+                //            // LATERAL CONNECTIONS CODE HERE!
+                //            num_neg_act = 0;
+                //            if( input_is_sparse )
+                //            {
+                //                hidden_activation_pos_i &lt;&lt; hidden_act;
+                //                hidden_activation_neg_i &lt;&lt; hidden_act;
+                //                if( factorized_connection_rank &gt; 0 )
+                //                    if( input_is_active[i] )
+                //                    {
+                //                        input_i = 1;
+                //                        productScaleAcc( hidden_activation_neg_i,
+                //                                         U, V(i), -1.,1.);
+                //                    }
+                //                    else
+                //                    {
+                //                        input_i = 0;
+                //                        productScaleAcc( hidden_activation_pos_i,
+                //                                         U, V(i), 1.,1.);
+                //                    }
+                //                else
+                //                    if( input_is_active[i] )
+                //                    {
+                //                        input_i = 1;
+                //                        hidden_activation_neg_i -= V(i);
+                //                    }
+                //                    else
+                //                    {
+                //                        input_i = 0;
+                //                        hidden_activation_pos_i += V(i);
+                //                    }
+                //            }
+                //            else
+                //            {
+                //                w = &amp;(connection-&gt;weights(0,i));
+                //                input_i = input[i];
+                //                for( int j=0; j&lt;hidden_layer-&gt;size; j++,w+=m )
+                //                {
+                //                    a_pos_i[j] = a[j] - *w * ( input_i - 1 );
+                //                    a_neg_i[j] = a[j] - *w * input_i;
+                //                }
+                //            }
+                //            num_pos_act -= hidden_layer-&gt;freeEnergyContribution(
+                //                hidden_activation_pos_i);
+                //            num_neg_act -= hidden_layer-&gt;freeEnergyContribution(
+                //                hidden_activation_neg_i);
+                //            //num_pos = safeexp(num_pos_act);
+                //            //num_neg = safeexp(num_neg_act);
+                //            //input_probs_i = num_pos / (num_pos + num_neg);
+                //            if( input_layer-&gt;use_fast_approximations )
+                //                input_probs_i = fastsigmoid(
+                //                    num_pos_act - num_neg_act);
+                //            else
+                //            {
+                //                num_pos = safeexp(num_pos_act);
+                //                num_neg = safeexp(num_neg_act);
+                //                input_probs_i = num_pos / (num_pos + num_neg);
+                //            }
+                //            if( input_layer-&gt;use_fast_approximations )
+                //                pseudolikelihood += tabulated_softplus( 
+                //                    num_pos_act - num_neg_act ) 
+                //                    - input_i * (num_pos_act - num_neg_act);
+                //            else
+                //                pseudolikelihood += softplus( 
+                //                    num_pos_act - num_neg_act ) 
+                //                    - input_i * (num_pos_act - num_neg_act);
+                //
+                //        }
+                //
+                //        estimated_gradient.fill(pseudolikelihood);
+                //
+                //        for( int i1=0; i1&lt;estimated_gradient.length(); i1++)
+                //            for( int j1=0; j1&lt;estimated_gradient.width(); j1++)
+                //            {
+                //                V(i1,j1) += epsilon;
+                //                pseudolikelihood = 0;
+                //
+                //                // Compute activations
+                //                if( input_is_sparse )
+                //                {
+                //                    if( factorized_connection_rank &gt; 0 )
+                //                    {
+                //                        Vx.clear();
+                //                        train_set-&gt;getExtra(stage%nsamples,extra);
+                //                        for( int i=0; i&lt;extra.length(); i++ )
+                //                        {
+                //                            Vx += V((int)extra[i]);
+                //                            input_is_active[(int)extra[i]] = true;
+                //                        }
+                //        
+                //                        product(hidden_act,U,Vx);
+                //                    }
+                //                    else
+                //                    {
+                //                        hidden_act.clear();
+                //                        train_set-&gt;getExtra(stage%nsamples,extra);
+                //                        for( int i=0; i&lt;extra.length(); i++ )
+                //                        {
+                //                            hidden_act += V((int)extra[i]);
+                //                            input_is_active[(int)extra[i]] = true;
+                //                        }
+                //                    }
+                //                }
+                //                else
+                //                {
+                //                    connection-&gt;setAsDownInput( input );
+                //                    hidden_layer-&gt;getAllActivations( 
+                //                        (RBMMatrixConnection*) connection );
+                //                }
+                //
+                //                if( targetsize() == 1 )
+                //                    productAcc( hidden_layer-&gt;activation,
+                //                                target_connection-&gt;weights,
+                //                                target_one_hot );
+                //                else if( targetsize() &gt; 1 )
+                //                    productAcc( hidden_layer-&gt;activation,
+                //                                target_connection-&gt;weights,
+                //                                target );
+                //
+                //                for( int l=0; l&lt;input_layer-&gt;size ; l++ )
+                //                {
+                //                    if( n_selected_inputs_pseudolikelihood &lt;= inputsize() &amp;&amp;
+                //                        n_selected_inputs_pseudolikelihood &gt; 0 )
+                //                    {
+                //                        if( l &gt;= n_selected_inputs_pseudolikelihood )
+                //                            break;
+                //                        i = input_indices[l];
+                //                    }
+                //                    else
+                //                        i = l;
+                //            
+                //                    num_pos_act = input_layer-&gt;bias[i];
+                //                    // LATERAL CONNECTIONS CODE HERE!
+                //                    num_neg_act = 0;
+                //                    if( input_is_sparse )
+                //                    {
+                //                        hidden_activation_pos_i &lt;&lt; hidden_act;
+                //                        hidden_activation_neg_i &lt;&lt; hidden_act;
+                //                        if( factorized_connection_rank &gt; 0 )
+                //                            if( input_is_active[i] )
+                //                            {
+                //                                input_i = 1;
+                //                                productScaleAcc( hidden_activation_neg_i,
+                //                                                 U, V(i), -1.,1.);
+                //                            }
+                //                            else
+                //                            {
+                //                                input_i = 0;
+                //                                productScaleAcc( hidden_activation_pos_i,
+                //                                                 U, V(i), 1.,1.);
+                //                            }
+                //                        else
+                //                            if( input_is_active[i] )
+                //                            {
+                //                                input_i = 1;
+                //                                hidden_activation_neg_i -= V(i);
+                //                            }
+                //                            else
+                //                            {
+                //                                input_i = 0;
+                //                                hidden_activation_pos_i += V(i);
+                //                            }
+                //                    }
+                //                    else
+                //                    {
+                //                        w = &amp;(connection-&gt;weights(0,i));
+                //                        input_i = input[i];
+                //                        for( int j=0; j&lt;hidden_layer-&gt;size; j++,w+=m )
+                //                        {
+                //                            a_pos_i[j] = a[j] - *w * ( input_i - 1 );
+                //                            a_neg_i[j] = a[j] - *w * input_i;
+                //                        }
+                //                    }
+                //                    num_pos_act -= hidden_layer-&gt;freeEnergyContribution(
+                //                        hidden_activation_pos_i);
+                //                    num_neg_act -= hidden_layer-&gt;freeEnergyContribution(
+                //                        hidden_activation_neg_i);
+                //                    //num_pos = safeexp(num_pos_act);
+                //                    //num_neg = safeexp(num_neg_act);
+                //                    //input_probs_i = num_pos / (num_pos + num_neg);
+                //                    if( input_layer-&gt;use_fast_approximations )
+                //                        input_probs_i = fastsigmoid(
+                //                            num_pos_act - num_neg_act);
+                //                    else
+                //                    {
+                //                        num_pos = safeexp(num_pos_act);
+                //                        num_neg = safeexp(num_neg_act);
+                //                        input_probs_i = num_pos / (num_pos + num_neg);
+                //                    }
+                //                    if( input_layer-&gt;use_fast_approximations )
+                //                        pseudolikelihood += tabulated_softplus( 
+                //                            num_pos_act - num_neg_act ) 
+                //                            - input_i * (num_pos_act - num_neg_act);
+                //                    else
+                //                        pseudolikelihood += softplus( 
+                //                            num_pos_act - num_neg_act ) 
+                //                            - input_i * (num_pos_act - num_neg_act);
+                //
+                //                }
+                //                V(i1,j1) -= epsilon;
+                //                estimated_gradient(i1,j1) = (pseudolikelihood - estimated_gradient(i1,j1))
+                //                    / epsilon;
+                //            }
+                //
+                //        if( factorized_connection_rank &gt; 0 )
+                //        {
+                //
+                //        pseudolikelihood = 0;
+                //
+                //        // Compute activations
+                //        if( input_is_sparse )
+                //        {
+                //            if( factorized_connection_rank &gt; 0 )
+                //            {
+                //                Vx.clear();
+                //                train_set-&gt;getExtra(stage%nsamples,extra);
+                //                for( int i=0; i&lt;extra.length(); i++ )
+                //                {
+                //                    Vx += V((int)extra[i]);
+                //                    input_is_active[(int)extra[i]] = true;
+                //                }
+                //        
+                //                product(hidden_act,U,Vx);
+                //            }
+                //            else
+                //            {
+                //                hidden_act.clear();
+                //                train_set-&gt;getExtra(stage%nsamples,extra);
+                //                for( int i=0; i&lt;extra.length(); i++ )
+                //                {
+                //                    hidden_act += V((int)extra[i]);
+                //                    input_is_active[(int)extra[i]] = true;
+                //                }
+                //            }
+                //        }
+                //        else
+                //        {
+                //            connection-&gt;setAsDownInput( input );
+                //            hidden_layer-&gt;getAllActivations( 
+                //                (RBMMatrixConnection*) connection );
+                //        }
+                //
+                //        if( targetsize() == 1 )
+                //            productAcc( hidden_layer-&gt;activation,
+                //                        target_connection-&gt;weights,
+                //                        target_one_hot );
+                //        else if( targetsize() &gt; 1 )
+                //            productAcc( hidden_layer-&gt;activation,
+                //                        target_connection-&gt;weights,
+                //                        target );
+                //
+                //        for( int l=0; l&lt;input_layer-&gt;size ; l++ )
+                //        {
+                //            if( n_selected_inputs_pseudolikelihood &lt;= inputsize() &amp;&amp;
+                //                n_selected_inputs_pseudolikelihood &gt; 0 )
+                //            {
+                //                if( l &gt;= n_selected_inputs_pseudolikelihood )
+                //                    break;
+                //                i = input_indices[l];
+                //            }
+                //            else
+                //                i = l;
+                //            
+                //            num_pos_act = input_layer-&gt;bias[i];
+                //            // LATERAL CONNECTIONS CODE HERE!
+                //            num_neg_act = 0;
+                //            if( input_is_sparse )
+                //            {
+                //                hidden_activation_pos_i &lt;&lt; hidden_act;
+                //                hidden_activation_neg_i &lt;&lt; hidden_act;
+                //                if( factorized_connection_rank &gt; 0 )
+                //                    if( input_is_active[i] )
+                //                    {
+                //                        input_i = 1;
+                //                        productScaleAcc( hidden_activation_neg_i,
+                //                                         U, V(i), -1.,1.);
+                //                    }
+                //                    else
+                //                    {
+                //                        input_i = 0;
+                //                        productScaleAcc( hidden_activation_pos_i,
+                //                                         U, V(i), 1.,1.);
+                //                    }
+                //                else
+                //                    if( input_is_active[i] )
+                //                    {
+                //                        input_i = 1;
+                //                        hidden_activation_neg_i -= V(i);
+                //                    }
+                //                    else
+                //                    {
+                //                        input_i = 0;
+                //                        hidden_activation_pos_i += V(i);
+                //                    }
+                //            }
+                //            else
+                //            {
+                //                w = &amp;(connection-&gt;weights(0,i));
+                //                input_i = input[i];
+                //                for( int j=0; j&lt;hidden_layer-&gt;size; j++,w+=m )
+                //                {
+                //                    a_pos_i[j] = a[j] - *w * ( input_i - 1 );
+                //                    a_neg_i[j] = a[j] - *w * input_i;
+                //                }
+                //            }
+                //            num_pos_act -= hidden_layer-&gt;freeEnergyContribution(
+                //                hidden_activation_pos_i);
+                //            num_neg_act -= hidden_layer-&gt;freeEnergyContribution(
+                //                hidden_activation_neg_i);
+                //            //num_pos = safeexp(num_pos_act);
+                //            //num_neg = safeexp(num_neg_act);
+                //            //input_probs_i = num_pos / (num_pos + num_neg);
+                //            if( input_layer-&gt;use_fast_approximations )
+                //                input_probs_i = fastsigmoid(
+                //                    num_pos_act - num_neg_act);
+                //            else
+                //            {
+                //                num_pos = safeexp(num_pos_act);
+                //                num_neg = safeexp(num_neg_act);
+                //                input_probs_i = num_pos / (num_pos + num_neg);
+                //            }
+                //            if( input_layer-&gt;use_fast_approximations )
+                //                pseudolikelihood += tabulated_softplus( 
+                //                    num_pos_act - num_neg_act ) 
+                //                    - input_i * (num_pos_act - num_neg_act);
+                //            else
+                //                pseudolikelihood += softplus( 
+                //                    num_pos_act - num_neg_act ) 
+                //                    - input_i * (num_pos_act - num_neg_act);
+                //
+                //        }
+                //
+                //        U_estimated_gradient.fill(pseudolikelihood);
+                //
+                //        for( int i1=0; i1&lt;U_estimated_gradient.length(); i1++)
+                //            for( int j1=0; j1&lt;U_estimated_gradient.width(); j1++)
+                //            {
+                //                U(i1,j1) += epsilon;
+                //                pseudolikelihood = 0;
+                //
+                //                // Compute activations
+                //                if( input_is_sparse )
+                //                {
+                //                    if( factorized_connection_rank &gt; 0 )
+                //                    {
+                //                        Vx.clear();
+                //                        train_set-&gt;getExtra(stage%nsamples,extra);
+                //                        for( int i=0; i&lt;extra.length(); i++ )
+                //                        {
+                //                            Vx += V((int)extra[i]);
+                //                            input_is_active[(int)extra[i]] = true;
+                //                        }
+                //        
+                //                        product(hidden_act,U,Vx);
+                //                    }
+                //                    else
+                //                    {
+                //                        hidden_act.clear();
+                //                        train_set-&gt;getExtra(stage%nsamples,extra);
+                //                        for( int i=0; i&lt;extra.length(); i++ )
+                //                        {
+                //                            hidden_act += V((int)extra[i]);
+                //                            input_is_active[(int)extra[i]] = true;
+                //                        }
+                //                    }
+                //                }
+                //                else
+                //                {
+                //                    connection-&gt;setAsDownInput( input );
+                //                    hidden_layer-&gt;getAllActivations( 
+                //                        (RBMMatrixConnection*) connection );
+                //                }
+                //
+                //                if( targetsize() == 1 )
+                //                    productAcc( hidden_layer-&gt;activation,
+                //                                target_connection-&gt;weights,
+                //                                target_one_hot );
+                //                else if( targetsize() &gt; 1 )
+                //                    productAcc( hidden_layer-&gt;activation,
+                //                                target_connection-&gt;weights,
+                //                                target );
+                //
+                //                for( int l=0; l&lt;input_layer-&gt;size ; l++ )
+                //                {
+                //                    if( n_selected_inputs_pseudolikelihood &lt;= inputsize() &amp;&amp;
+                //                        n_selected_inputs_pseudolikelihood &gt; 0 )
+                //                    {
+                //                        if( l &gt;= n_selected_inputs_pseudolikelihood )
+                //                            break;
+                //                        i = input_indices[l];
+                //                    }
+                //                    else
+                //                        i = l;
+                //            
+                //                    num_pos_act = input_layer-&gt;bias[i];
+                //                    // LATERAL CONNECTIONS CODE HERE!
+                //                    num_neg_act = 0;
+                //                    if( input_is_sparse )
+                //                    {
+                //                        hidden_activation_pos_i &lt;&lt; hidden_act;
+                //                        hidden_activation_neg_i &lt;&lt; hidden_act;
+                //                        if( factorized_connection_rank &gt; 0 )
+                //                            if( input_is_active[i] )
+                //                            {
+                //                                input_i = 1;
+                //                                productScaleAcc( hidden_activation_neg_i,
+                //                                                 U, V(i), -1.,1.);
+                //                            }
+                //                            else
+                //                            {
+                //                                input_i = 0;
+                //                                productScaleAcc( hidden_activation_pos_i,
+                //                                                 U, V(i), 1.,1.);
+                //                            }
+                //                        else
+                //                            if( input_is_active[i] )
+                //                            {
+                //                                input_i = 1;
+                //                                hidden_activation_neg_i -= V(i);
+                //                            }
+                //                            else
+                //                            {
+                //                                input_i = 0;
+                //                                hidden_activation_pos_i += V(i);
+                //                            }
+                //                    }
+                //                    else
+                //                    {
+                //                        w = &amp;(connection-&gt;weights(0,i));
+                //                        input_i = input[i];
+                //                        for( int j=0; j&lt;hidden_layer-&gt;size; j++,w+=m )
+                //                        {
+                //                            a_pos_i[j] = a[j] - *w * ( input_i - 1 );
+                //                            a_neg_i[j] = a[j] - *w * input_i;
+                //                        }
+                //                    }
+                //                    num_pos_act -= hidden_layer-&gt;freeEnergyContribution(
+                //                        hidden_activation_pos_i);
+                //                    num_neg_act -= hidden_layer-&gt;freeEnergyContribution(
+                //                        hidden_activation_neg_i);
+                //                    //num_pos = safeexp(num_pos_act);
+                //                    //num_neg = safeexp(num_neg_act);
+                //                    //input_probs_i = num_pos / (num_pos + num_neg);
+                //                    if( input_layer-&gt;use_fast_approximations )
+                //                        input_probs_i = fastsigmoid(
+                //                            num_pos_act - num_neg_act);
+                //                    else
+                //                    {
+                //                        num_pos = safeexp(num_pos_act);
+                //                        num_neg = safeexp(num_neg_act);
+                //                        input_probs_i = num_pos / (num_pos + num_neg);
+                //                    }
+                //                    if( input_layer-&gt;use_fast_approximations )
+                //                        pseudolikelihood += tabulated_softplus( 
+                //                            num_pos_act - num_neg_act ) 
+                //                            - input_i * (num_pos_act - num_neg_act);
+                //                    else
+                //                        pseudolikelihood += softplus( 
+                //                            num_pos_act - num_neg_act ) 
+                //                            - input_i * (num_pos_act - num_neg_act);
+                //
+                //                }
+                //                U(i1,j1) -= epsilon;
+                //                U_estimated_gradient(i1,j1) = (pseudolikelihood - U_estimated_gradient(i1,j1))
+                //                    / epsilon;
+                //            }
+                //
+                //
+                //        }
+                //    }
+                //    else
+                //    {
+                //        estimated_gradient.resize(connection-&gt;up_size, connection-&gt;down_size);
+                //
+                //        int i=0;
+                //        pseudolikelihood = 0;
+                //
+                //        // Compute activations
+                //        if( input_is_sparse )
+                //        {
+                //            if( factorized_connection_rank &gt; 0 )
+                //            {
+                //                Vx.clear();
+                //                train_set-&gt;getExtra(stage%nsamples,extra);
+                //                for( int i=0; i&lt;extra.length(); i++ )
+                //                {
+                //                    Vx += V((int)extra[i]);
+                //                    input_is_active[(int)extra[i]] = true;
+                //                }
+                //        
+                //                product(hidden_act,U,Vx);
+                //            }
+                //            else
+                //            {
+                //                hidden_act.clear();
+                //                train_set-&gt;getExtra(stage%nsamples,extra);
+                //                for( int i=0; i&lt;extra.length(); i++ )
+                //                {
+                //                    hidden_act += V((int)extra[i]);
+                //                    input_is_active[(int)extra[i]] = true;
+                //                }
+                //            }
+                //        }
+                //        else
+                //        {
+                //            connection-&gt;setAsDownInput( input );
+                //            hidden_layer-&gt;getAllActivations( 
+                //                (RBMMatrixConnection*) connection );
+                //        }
+                //
+                //        if( targetsize() == 1 )
+                //            productAcc( hidden_layer-&gt;activation,
+                //                        target_connection-&gt;weights,
+                //                        target_one_hot );
+                //        else if( targetsize() &gt; 1 )
+                //            productAcc( hidden_layer-&gt;activation,
+                //                        target_connection-&gt;weights,
+                //                        target );
+                //
+                //        for( int l=0; l&lt;input_layer-&gt;size ; l++ )
+                //        {
+                //            if( n_selected_inputs_pseudolikelihood &lt;= inputsize() &amp;&amp;
+                //                n_selected_inputs_pseudolikelihood &gt; 0 )
+                //            {
+                //                if( l &gt;= n_selected_inputs_pseudolikelihood )
+                //                    break;
+                //                i = input_indices[l];
+                //            }
+                //            else
+                //                i = l;
+                //            
+                //            num_pos_act = input_layer-&gt;bias[i];
+                //            // LATERAL CONNECTIONS CODE HERE!
+                //            num_neg_act = 0;
+                //            if( input_is_sparse )
+                //            {
+                //                hidden_activation_pos_i &lt;&lt; hidden_act;
+                //                hidden_activation_neg_i &lt;&lt; hidden_act;
+                //                if( factorized_connection_rank &gt; 0 )
+                //                    if( input_is_active[i] )
+                //                    {
+                //                        input_i = 1;
+                //                        productScaleAcc( hidden_activation_neg_i,
+                //                                         U, V(i), -1.,1.);
+                //                    }
+                //                    else
+                //                    {
+                //                        input_i = 0;
+                //                        productScaleAcc( hidden_activation_pos_i,
+                //                                         U, V(i), 1.,1.);
+                //                    }
+                //                else
+                //                    if( input_is_active[i] )
+                //                    {
+                //                        input_i = 1;
+                //                        hidden_activation_neg_i -= V(i);
+                //                    }
+                //                    else
+                //                    {
+                //                        input_i = 0;
+                //                        hidden_activation_pos_i += V(i);
+                //                    }
+                //            }
+                //            else
+                //            {
+                //                w = &amp;(connection-&gt;weights(0,i));
+                //                input_i = input[i];
+                //                for( int j=0; j&lt;hidden_layer-&gt;size; j++,w+=m )
+                //                {
+                //                    a_pos_i[j] = a[j] - *w * ( input_i - 1 );
+                //                    a_neg_i[j] = a[j] - *w * input_i;
+                //                }
+                //            }
+                //            num_pos_act -= hidden_layer-&gt;freeEnergyContribution(
+                //                hidden_activation_pos_i);
+                //            num_neg_act -= hidden_layer-&gt;freeEnergyContribution(
+                //                hidden_activation_neg_i);
+                //            //num_pos = safeexp(num_pos_act);
+                //            //num_neg = safeexp(num_neg_act);
+                //            //input_probs_i = num_pos / (num_pos + num_neg);
+                //            if( input_layer-&gt;use_fast_approximations )
+                //                input_probs_i = fastsigmoid(
+                //                    num_pos_act - num_neg_act);
+                //            else
+                //            {
+                //                num_pos = safeexp(num_pos_act);
+                //                num_neg = safeexp(num_neg_act);
+                //                input_probs_i = num_pos / (num_pos + num_neg);
+                //            }
+                //            if( input_layer-&gt;use_fast_approximations )
+                //                pseudolikelihood += tabulated_softplus( 
+                //                    num_pos_act - num_neg_act ) 
+                //                    - input_i * (num_pos_act - num_neg_act);
+                //            else
+                //                pseudolikelihood += softplus( 
+                //                    num_pos_act - num_neg_act ) 
+                //                    - input_i * (num_pos_act - num_neg_act);
+                //
+                //        }
+                //
+                //        estimated_gradient.fill(pseudolikelihood);
+                //
+                //        for( int i1=0; i1&lt;estimated_gradient.length(); i1++)
+                //            for( int j1=0; j1&lt;estimated_gradient.width(); j1++)
+                //            {
+                //                connection-&gt;weights(i1,j1) += epsilon;
+                //                pseudolikelihood = 0;
+                //
+                //                // Compute activations
+                //                if( input_is_sparse )
+                //                {
+                //                    if( factorized_connection_rank &gt; 0 )
+                //                    {
+                //                        Vx.clear();
+                //                        train_set-&gt;getExtra(stage%nsamples,extra);
+                //                        for( int i=0; i&lt;extra.length(); i++ )
+                //                        {
+                //                            Vx += V((int)extra[i]);
+                //                            input_is_active[(int)extra[i]] = true;
+                //                        }
+                //        
+                //                        product(hidden_act,U,Vx);
+                //                    }
+                //                    else
+                //                    {
+                //                        hidden_act.clear();
+                //                        train_set-&gt;getExtra(stage%nsamples,extra);
+                //                        for( int i=0; i&lt;extra.length(); i++ )
+                //                        {
+                //                            hidden_act += V((int)extra[i]);
+                //                            input_is_active[(int)extra[i]] = true;
+                //                        }
+                //                    }
+                //                }
+                //                else
+                //                {
+                //                    connection-&gt;setAsDownInput( input );
+                //                    hidden_layer-&gt;getAllActivations( 
+                //                        (RBMMatrixConnection*) connection );
+                //                }
+                //
+                //                if( targetsize() == 1 )
+                //                    productAcc( hidden_layer-&gt;activation,
+                //                                target_connection-&gt;weights,
+                //                                target_one_hot );
+                //                else if( targetsize() &gt; 1 )
+                //                    productAcc( hidden_layer-&gt;activation,
+                //                                target_connection-&gt;weights,
+                //                                target );
+                //
+                //                for( int l=0; l&lt;input_layer-&gt;size ; l++ )
+                //                {
+                //                    if( n_selected_inputs_pseudolikelihood &lt;= inputsize() &amp;&amp;
+                //                        n_selected_inputs_pseudolikelihood &gt; 0 )
+                //                    {
+                //                        if( l &gt;= n_selected_inputs_pseudolikelihood )
+                //                            break;
+                //                        i = input_indices[l];
+                //                    }
+                //                    else
+                //                        i = l;
+                //            
+                //                    num_pos_act = input_layer-&gt;bias[i];
+                //                    // LATERAL CONNECTIONS CODE HERE!
+                //                    num_neg_act = 0;
+                //                    if( input_is_sparse )
+                //                    {
+                //                        hidden_activation_pos_i &lt;&lt; hidden_act;
+                //                        hidden_activation_neg_i &lt;&lt; hidden_act;
+                //                        if( factorized_connection_rank &gt; 0 )
+                //                            if( input_is_active[i] )
+                //                            {
+                //                                input_i = 1;
+                //                                productScaleAcc( hidden_activation_neg_i,
+                //                                                 U, V(i), -1.,1.);
+                //                            }
+                //                            else
+                //                            {
+                //                                input_i = 0;
+                //                                productScaleAcc( hidden_activation_pos_i,
+                //                                                 U, V(i), 1.,1.);
+                //                            }
+                //                        else
+                //                            if( input_is_active[i] )
+                //                            {
+                //                                input_i = 1;
+                //                                hidden_activation_neg_i -= V(i);
+                //                            }
+                //                            else
+                //                            {
+                //                                input_i = 0;
+                //                                hidden_activation_pos_i += V(i);
+                //                            }
+                //                    }
+                //                    else
+                //                    {
+                //                        w = &amp;(connection-&gt;weights(0,i));
+                //                        input_i = input[i];
+                //                        for( int j=0; j&lt;hidden_layer-&gt;size; j++,w+=m )
+                //                        {
+                //                            a_pos_i[j] = a[j] - *w * ( input_i - 1 );
+                //                            a_neg_i[j] = a[j] - *w * input_i;
+                //                        }
+                //                    }
+                //                    num_pos_act -= hidden_layer-&gt;freeEnergyContribution(
+                //                        hidden_activation_pos_i);
+                //                    num_neg_act -= hidden_layer-&gt;freeEnergyContribution(
+                //                        hidden_activation_neg_i);
+                //                    //num_pos = safeexp(num_pos_act);
+                //                    //num_neg = safeexp(num_neg_act);
+                //                    //input_probs_i = num_pos / (num_pos + num_neg);
+                //                    if( input_layer-&gt;use_fast_approximations )
+                //                        input_probs_i = fastsigmoid(
+                //                            num_pos_act - num_neg_act);
+                //                    else
+                //                    {
+                //                        num_pos = safeexp(num_pos_act);
+                //                        num_neg = safeexp(num_neg_act);
+                //                        input_probs_i = num_pos / (num_pos + num_neg);
+                //                    }
+                //                    if( input_layer-&gt;use_fast_approximations )
+                //                        pseudolikelihood += tabulated_softplus( 
+                //                            num_pos_act - num_neg_act ) 
+                //                            - input_i * (num_pos_act - num_neg_act);
+                //                    else
+                //                        pseudolikelihood += softplus( 
+                //                            num_pos_act - num_neg_act ) 
+                //                            - input_i * (num_pos_act - num_neg_act);
+                //
+                //                }
+                //                connection-&gt;weights(i1,j1) -= epsilon;
+                //                estimated_gradient(i1,j1) = (pseudolikelihood - estimated_gradient(i1,j1))
+                //                    / epsilon;
+                //            }
+                //
+                //    }
+                //}
+
+
                 // Compute activations
                 if( input_is_sparse )
                 {
@@ -1202,6 +2009,7 @@
                 V_gradients.clear();
 
                 int i=0;
+                pseudolikelihood = 0;
                 for( int l=0; l&lt;input_layer-&gt;size ; l++ )
                 {
                     if( n_selected_inputs_pseudolikelihood &lt;= inputsize() &amp;&amp;
@@ -1223,16 +2031,28 @@
                         hidden_activation_neg_i &lt;&lt; hidden_act;
                         if( factorized_connection_rank &gt; 0 )
                             if( input_is_active[i] )
+                            {
+                                input_i = 1;
                                 productScaleAcc( hidden_activation_neg_i,
                                                 U, V(i), -1.,1.);
+                            }
                             else
+                            {
+                                input_i = 0;
                                 productScaleAcc( hidden_activation_pos_i,
                                                 U, V(i), 1.,1.);
+                            }
                         else
                             if( input_is_active[i] )
+                            {
+                                input_i = 1;
                                 hidden_activation_neg_i -= V(i);
+                            }
                             else
+                            {
+                                input_i = 0;
                                 hidden_activation_pos_i += V(i);
+                            }
                     }
                     else
                     {
@@ -1339,6 +2159,7 @@
 
                 if( input_is_sparse )
                 {
+                    //Mat true_gradient(V.length(), V.width());
                     if( factorized_connection_rank &gt; 0 )
                     {
                         // Factorized connection U update
@@ -1347,6 +2168,12 @@
                                             Vx );
                         multiplyScaledAdd( U_gradient, 1.0, -lr, U );
                         
+                        //real U_cos_ang = dot(U_gradient.toVec(),U_estimated_gradient.toVec())
+                        //    / (norm(U_gradient.toVec()) *norm(U_estimated_gradient.toVec()));
+                        //cout &lt;&lt; &quot;U_cos_ang=&quot; &lt;&lt; U_cos_ang &lt;&lt; endl;
+                        //cout &lt;&lt; &quot;U_ang=&quot; &lt;&lt; acos(U_cos_ang) &lt;&lt; endl;
+
+   
                         // Factorized connection V update
                         transposeProduct( Vx_gradient, U, 
                                           hidden_activation_gradient );
@@ -1354,6 +2181,7 @@
                         {
                             V((int)extra[e]) -= lr * Vx_gradient;
                             input_is_active[(int)extra[e]] = false;
+                            //true_gradient((int)extra[e]) += Vx_gradient;
                         }
                     }
                     else
@@ -1363,6 +2191,7 @@
                         {
                             V((int)extra[e]) -= lr * hidden_activation_gradient;
                             input_is_active[(int)extra[e]] = false;
+                            //true_gradient((int)extra[e]) += hidden_activation_gradient;
                         }
                     }
                     
@@ -1379,15 +2208,27 @@
                             i = l;
                         // Extra V gradients
                         V(i) -= lr * V_gradients(l);
-                        
+                        //true_gradient(i) += V_gradients(l);
+
                         // Input update
                         input_layer-&gt;bias[i] -= lr * input_gradient[i];
                     }
+                    
+                    //real cos_ang = dot(true_gradient.toVec(),estimated_gradient.toVec())
+                    //    / (norm(true_gradient.toVec()) *norm(estimated_gradient.toVec()));
+                    //cout &lt;&lt; &quot;cos_ang=&quot; &lt;&lt; cos_ang &lt;&lt; endl;
+                    //cout &lt;&lt; &quot;ang=&quot; &lt;&lt; acos(cos_ang) &lt;&lt; endl;
+
                 }
                 else
                 {
                     externalProductAcc( connection_gradient, hidden_activation_gradient,
                                         input );
+
+                    //real cos_ang = dot(connection_gradient.toVec(),estimated_gradient.toVec())
+                    //    / (norm(connection_gradient.toVec()) *norm(estimated_gradient.toVec()));
+                    //cout &lt;&lt; &quot;cos_ang=&quot; &lt;&lt; cos_ang &lt;&lt; endl;
+                    //cout &lt;&lt; &quot;ang=&quot; &lt;&lt; acos(cos_ang) &lt;&lt; endl;
                     
                     // Connection weights update
                     multiplyScaledAdd( connection_gradient, 1.0, -lr,


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002816.html">[Plearn-commits] r9371 - trunk/plearn_learners/regressors
</A></li>
	<LI>Next message: <A HREF="002821.html">[Plearn-commits] r9373 - trunk/plearn/vmat
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2811">[ date ]</a>
              <a href="thread.html#2811">[ thread ]</a>
              <a href="subject.html#2811">[ subject ]</a>
              <a href="author.html#2811">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/plearn-commits">More information about the Plearn-commits
mailing list</a><br>
</body></html>
