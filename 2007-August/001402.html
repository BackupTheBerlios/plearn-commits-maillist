<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Plearn-commits] r7954 - in trunk: . plearn/base plearn/io	plearn/python plearn/python/test	plearn/python/test/.pytest/EmbeddedPython_BasicIdentityCalls/expected_results	plearn_learners/distributions/test	python_modules/plearn/analysis python_modules/plearn/io	python_modules/plearn/learners python_modules/plearn/learners/autolr	python_modules/plearn/math python_modules/plearn/math/stats	python_modules/plearn/parallel python_modules/plearn/plotting	python_modules/plearn/pybridge python_modules/plearn/pymake	python_modules/plearn/pyplearn python_modules/plearn/vmat
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/plearn-commits/2007-August/index.html" >
   <LINK REL="made" HREF="mailto:plearn-commits%40lists.berlios.de?Subject=Re%3A%20%5BPlearn-commits%5D%20r7954%20-%20in%20trunk%3A%20.%20plearn/base%20plearn/io%0A%09plearn/python%20plearn/python/test%0A%09plearn/python/test/.pytest/EmbeddedPython_BasicIdentityCalls/expected_results%0A%09plearn_learners/distributions/test%0A%09python_modules/plearn/analysis%20python_modules/plearn/io%0A%09python_modules/plearn/learners%20python_modules/plearn/learners/autolr%0A%09python_modules/plearn/math%20python_modules/plearn/math/stats%0A%09python_modules/plearn/parallel%20python_modules/plearn/plotting%0A%09python_modules/plearn/pybridge%20python_modules/plearn/pymake%0A%09python_modules/plearn/pyplearn%20python_modules/plearn/vmat&In-Reply-To=%3C200708081550.l78FoIrq016867%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001401.html">
   <LINK REL="Next"  HREF="001403.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Plearn-commits] r7954 - in trunk: . plearn/base plearn/io	plearn/python plearn/python/test	plearn/python/test/.pytest/EmbeddedPython_BasicIdentityCalls/expected_results	plearn_learners/distributions/test	python_modules/plearn/analysis python_modules/plearn/io	python_modules/plearn/learners python_modules/plearn/learners/autolr	python_modules/plearn/math python_modules/plearn/math/stats	python_modules/plearn/parallel python_modules/plearn/plotting	python_modules/plearn/pybridge python_modules/plearn/pymake	python_modules/plearn/pyplearn python_modules/plearn/vmat</H1>
    <B>saintmlx at BerliOS</B> 
    <A HREF="mailto:plearn-commits%40lists.berlios.de?Subject=Re%3A%20%5BPlearn-commits%5D%20r7954%20-%20in%20trunk%3A%20.%20plearn/base%20plearn/io%0A%09plearn/python%20plearn/python/test%0A%09plearn/python/test/.pytest/EmbeddedPython_BasicIdentityCalls/expected_results%0A%09plearn_learners/distributions/test%0A%09python_modules/plearn/analysis%20python_modules/plearn/io%0A%09python_modules/plearn/learners%20python_modules/plearn/learners/autolr%0A%09python_modules/plearn/math%20python_modules/plearn/math/stats%0A%09python_modules/plearn/parallel%20python_modules/plearn/plotting%0A%09python_modules/plearn/pybridge%20python_modules/plearn/pymake%0A%09python_modules/plearn/pyplearn%20python_modules/plearn/vmat&In-Reply-To=%3C200708081550.l78FoIrq016867%40sheep.berlios.de%3E"
       TITLE="[Plearn-commits] r7954 - in trunk: . plearn/base plearn/io	plearn/python plearn/python/test	plearn/python/test/.pytest/EmbeddedPython_BasicIdentityCalls/expected_results	plearn_learners/distributions/test	python_modules/plearn/analysis python_modules/plearn/io	python_modules/plearn/learners python_modules/plearn/learners/autolr	python_modules/plearn/math python_modules/plearn/math/stats	python_modules/plearn/parallel python_modules/plearn/plotting	python_modules/plearn/pybridge python_modules/plearn/pymake	python_modules/plearn/pyplearn python_modules/plearn/vmat">saintmlx at mail.berlios.de
       </A><BR>
    <I>Wed Aug  8 17:50:18 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="001401.html">[Plearn-commits] r7953 - trunk/plearn_learners/online
</A></li>
        <LI>Next message: <A HREF="001403.html">[Plearn-commits] r7955 - trunk/scripts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1402">[ date ]</a>
              <a href="thread.html#1402">[ thread ]</a>
              <a href="subject.html#1402">[ subject ]</a>
              <a href="author.html#1402">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: saintmlx
Date: 2007-08-08 17:50:15 +0200 (Wed, 08 Aug 2007)
New Revision: 7954

Modified:
   trunk/plearn/base/Object.cc
   trunk/plearn/base/Object.h
   trunk/plearn/io/PStream.h
   trunk/plearn/python/PythonCodeSnippet.cc
   trunk/plearn/python/PythonExtension.cc
   trunk/plearn/python/PythonIncludes.h
   trunk/plearn/python/PythonObjectWrapper.cc
   trunk/plearn/python/PythonObjectWrapper.h
   trunk/plearn/python/test/.pytest/EmbeddedPython_BasicIdentityCalls/expected_results/RUN.log
   trunk/plearn/python/test/BasicIdentityCallsTest.cc
   trunk/plearn/python/test/MemoryStressTest.cc
   trunk/plearn/python/test/test_python_vmatrix.pymat
   trunk/plearn_learners/distributions/test/gaussian_mixtures_generate.pymat
   trunk/pymake.config.model
   trunk/python_modules/plearn/analysis/experiment_results.py
   trunk/python_modules/plearn/io/serialize.py
   trunk/python_modules/plearn/learners/autolr/__init__.py
   trunk/python_modules/plearn/learners/discr_power_SVM.py
   trunk/python_modules/plearn/math/StatsCollector.py
   trunk/python_modules/plearn/math/arrays.py
   trunk/python_modules/plearn/math/missings_robust_covariance.py
   trunk/python_modules/plearn/math/random_processes.py
   trunk/python_modules/plearn/math/statistical_tools.py
   trunk/python_modules/plearn/math/stats/cvx_utils.py
   trunk/python_modules/plearn/parallel/dispatch.py
   trunk/python_modules/plearn/plotting/__init__.py
   trunk/python_modules/plearn/plotting/netplot.py
   trunk/python_modules/plearn/pybridge/wrapped_plearn_object.py
   trunk/python_modules/plearn/pymake/pymake.py
   trunk/python_modules/plearn/pyplearn/__init__.py
   trunk/python_modules/plearn/pyplearn/plearn_repr.py
   trunk/python_modules/plearn/vmat/PMat.py
   trunk/python_modules/plearn/vmat/readAMat.py
   trunk/python_modules/plearn/vmat/smartReadMat.py
Log:
- convert from numarray to numpy



Modified: trunk/plearn/base/Object.cc
===================================================================
--- trunk/plearn/base/Object.cc	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/plearn/base/Object.cc	2007-08-08 15:50:15 UTC (rev 7954)
@@ -747,7 +747,17 @@
                   (BodyDoc(&quot;Returns the refcount of this PPointable&quot;),
                    RetDoc (&quot;Number of references&quot;)));
 
+    declareMethod(rmm, &quot;deepCopyNoMap&quot;, &amp;Object::deepCopyNoMap,
+                  (BodyDoc(&quot;Returns a deep copy of the object&quot;),
+                   RetDoc (&quot;Deep copy.&quot;)));
 
+    declareMethod(rmm, &quot;pyDeepCopy&quot;, &amp;Object::pyDeepCopy,
+                  (BodyDoc(&quot;Returns a pair containing a deep copy of &quot;
+                           &quot;the object and the updated copies map.&quot;),
+                   ArgDoc (&quot;copies&quot;, &quot;The initial copies map&quot;),
+                   RetDoc (&quot;Deep copy, copies map&quot;)));
+
+
 #ifdef PL_PYTHON_VERSION 
     declareMethod(rmm, &quot;setOptionFromPython&quot;, &amp;Object::setOptionFromPython,
                   (BodyDoc(&quot;Change an option within the object from a PythonObjectWrapper&quot;),
@@ -807,6 +817,21 @@
     PLearn::load(filename, *this);
 }
 
+Object* Object::deepCopyNoMap()
+{
+    CopiesMap cm;
+    return deepCopy(cm);
+}
+
+#ifdef PL_PYTHON_VERSION 
+tuple&lt;Object*, CopiesMap&gt; Object::pyDeepCopy(CopiesMap&amp; copies)
+{
+    Object* o= deepCopy(copies);
+    return make_tuple(o, copies);
+}
+#endif //def PL_PYTHON_VERSION 
+
+
 Object* loadObject(const PPath &amp;filename)
 {
     PStream in = openFile(filename, PStream::plearn_ascii, &quot;r&quot;);

Modified: trunk/plearn/base/Object.h
===================================================================
--- trunk/plearn/base/Object.h	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/plearn/base/Object.h	2007-08-08 15:50:15 UTC (rev 7954)
@@ -937,7 +937,19 @@
      */
     virtual void load(const PPath&amp; filename);
 
+    /**
+     * deepCopyNoMap: same as deepCopy, but starts with an empty CopiesMap
+     * and returns an Object*.
+     */
+    Object* deepCopyNoMap();
 
+#ifdef PL_PYTHON_VERSION 
+    /**
+     * pyDeepCopy: deep copy called from python
+     */
+    tuple&lt;Object*, CopiesMap&gt; pyDeepCopy(CopiesMap&amp; copies);
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     //#####  Protected Member Functions  ######################################
 

Modified: trunk/plearn/io/PStream.h
===================================================================
--- trunk/plearn/io/PStream.h	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/plearn/io/PStream.h	2007-08-08 15:50:15 UTC (rev 7954)
@@ -971,6 +971,17 @@
     in.get(); // eat the '}'
 }
 
+inline PStream&amp; operator&gt;&gt;(PStream&amp; in, CopiesMap&amp;)
+{
+    PLERROR(&quot;PLearn::CopiesMap cannot be serialized.&quot;);
+    return in;
+}
+inline PStream&amp; operator&lt;&lt;(PStream&amp; out, const CopiesMap&amp;)
+{
+    PLERROR(&quot;PLearn::CopiesMap cannot be [un]serialized.&quot;);
+    return out;
+}
+
 template&lt;class Key, class Value, class Compare, class Alloc&gt;
 inline PStream&amp; operator&lt;&lt;(PStream&amp; out,
                            const map&lt;Key, Value, Compare, Alloc&gt;&amp; m)
@@ -1502,7 +1513,6 @@
 operator&lt;&lt;(PStream &amp;out, const set&lt;T&gt; &amp;v)
 { writeSet(out, v); return out; }
 
-
 /// @deprected Use openFile instead.
 class PIFStream: public PStream
 {

Modified: trunk/plearn/python/PythonCodeSnippet.cc
===================================================================
--- trunk/plearn/python/PythonCodeSnippet.cc	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/plearn/python/PythonCodeSnippet.cc	2007-08-08 15:50:15 UTC (rev 7954)
@@ -558,7 +558,7 @@
         if(it == global_map.end())
             PLERROR(&quot;in PythonCodeSnippet::compileGlobalCode : &quot;
                     &quot;plearn.pybridge.pl_global_funcs not present in global env!&quot;);
-        injectPLearnGlobalFunctions(it-&gt;second);//inject in pl_global_funcs module
+        setPythonModuleAndInject(it-&gt;second);
         global_funcs_injected= true;
     }
 

Modified: trunk/plearn/python/PythonExtension.cc
===================================================================
--- trunk/plearn/python/PythonExtension.cc	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/plearn/python/PythonExtension.cc	2007-08-08 15:50:15 UTC (rev 7954)
@@ -123,41 +123,34 @@
 }
 
 
-void injectPLearnClasses(PyObject* injenv)
+void injectPLearnClasses(PyObject* module)
 {
     PythonGlobalInterpreterLock gil;         // For thread-safety
     PythonObjectWrapper::initializePython();
 
-    PyObject* module= 0;
-    if(PyModule_Check(injenv))
-        module= injenv;
-
+    if(!PyModule_Check(module))
+        PLERROR(&quot;In injectPLearnClasses : &quot;
+                &quot;module param. should be a python module.&quot;);
     // import python class for wrapping PLearn objects
     string importcode= &quot;\nfrom plearn.pybridge.wrapped_plearn_object &quot;
         &quot;import *\n&quot;;
-    PyObject* pyenv= PyDict_New();
-    PyDict_SetItemString(pyenv, &quot;__builtins__&quot;, PyEval_GetBuiltins());
-    PyObject* res= PyRun_String(importcode.c_str(), Py_file_input, pyenv, pyenv);
+    PyObject_SetAttrString(module, &quot;__builtins__&quot;, PyEval_GetBuiltins());
+    PyObject* res= PyRun_String(importcode.c_str(), Py_file_input, 
+                                PyModule_GetDict(module), PyModule_GetDict(module));
     if(!res)
     {
-       if(PyErr_Occurred()) PyErr_Print();
-       PLERROR(&quot;in injectPLearnClasses : cannot import plearn.pybridge.wrapped_plearn_object.&quot;);
+        Py_DECREF(module);
+        if(PyErr_Occurred()) PyErr_Print();
+        PLERROR(&quot;in injectPLearnClasses : cannot import plearn.pybridge.wrapped_plearn_object.&quot;);
     }
-
     Py_DECREF(res);
-    if (PyErr_Occurred()) 
-    {
-        Py_DECREF(pyenv);
-        PyErr_Print();
-        PLERROR(&quot;in injectPLearnClasses : error compiling &quot;
-                &quot;WrappedPLearnObject python code.&quot;);
-    }
 
     string wrapper_name= &quot;WrappedPLearnObject&quot;;
     // now find the class in the env.
     typedef map&lt;string, PyObject*&gt; env_t;
     env_t env= PythonObjectWrapper(
-        pyenv, PythonObjectWrapper::transfer_ownership).as&lt;env_t&gt;();
+        PyModule_GetDict(module), 
+        PythonObjectWrapper::transfer_ownership).as&lt;env_t&gt;();
     env_t::iterator clit= env.find(wrapper_name);
     if(clit == env.end())
         PLERROR(&quot;in injectPLearnClasses : &quot;
@@ -178,7 +171,7 @@
     Py_XDECREF(py_funcobj);
     if(!py_funcobj || !py_methobj) 
     {
-        Py_DECREF(pyenv);
+        Py_DECREF(module);
         Py_XDECREF(py_methobj);
         PLERROR(&quot;in injectPLearnClasses : &quot;
                 &quot;can't inject method '%s' (i.e. __del__)&quot;, 
@@ -211,7 +204,7 @@
         Py_XDECREF(py_funcobj);
         if(!py_funcobj || !py_methobj) 
         {
-            Py_DECREF(pyenv);
+            Py_DECREF(module);
             Py_XDECREF(py_methobj);
             PLERROR(&quot;in injectPLearnClasses : &quot;
                     &quot;can't inject method '%s' (i.e. C++'s new)&quot;, 
@@ -223,11 +216,12 @@
         string classmethodname= wrapper_name+&quot;.&quot;+py_method-&gt;ml_name;
         res= PyRun_String((classmethodname
                            +&quot;= classmethod(&quot;+classmethodname+&quot;.im_func)&quot;).c_str(), 
-                          Py_file_input, pyenv, pyenv);
+                          Py_file_input, 
+                          PyModule_GetDict(module), PyModule_GetDict(module));
         Py_DECREF(res);
         if (PyErr_Occurred()) 
         {
-            Py_DECREF(pyenv);
+            Py_DECREF(module);
             PyErr_Print();
             PLERROR(&quot;in injectPLearnClasses : error making &quot;
                     &quot;newCPPObj a classmethod.&quot;);
@@ -268,10 +262,12 @@
             &quot;      cls._refCPPObj(obj)\n&quot;
             &quot;    return obj\n&quot;;
         PyObject* res= PyRun_String(derivcode.c_str(), 
-                                    Py_file_input, pyenv, pyenv);
+                                    Py_file_input, 
+                                    PyModule_GetDict(module), PyModule_GetDict(module));
         Py_XDECREF(res);
         env= PythonObjectWrapper(
-            pyenv, PythonObjectWrapper::transfer_ownership).as&lt;env_t&gt;();
+            PyModule_GetDict(module), 
+            PythonObjectWrapper::transfer_ownership).as&lt;env_t&gt;();
         clit= env.find(pyclassname);
         if(clit == env.end())
             PLERROR(&quot;in injectPLearnClasses : &quot;
@@ -291,7 +287,7 @@
         if(-1==PyObject_SetAttrString(the_pyclass, &quot;_optionnames&quot;, 
                                       PythonObjectWrapper(optionnames).getPyObject()))
         {
-            Py_DECREF(pyenv);
+            Py_DECREF(module);
             if (PyErr_Occurred()) PyErr_Print();
             PLERROR(&quot;in injectPLearnClasses : &quot;
                     &quot;cannot set attr _optionnames for class %s&quot;,
@@ -336,7 +332,7 @@
                 Py_XDECREF(py_funcobj);
                 if(!py_funcobj || !py_methobj) 
                 {
-                    Py_DECREF(pyenv);
+                    Py_DECREF(module);
                     Py_XDECREF(py_methobj);
                     PLERROR(&quot;in injectPLearnClasses : &quot;
                             &quot;can't inject method '%s'&quot;, py_method-&gt;ml_name);

Modified: trunk/plearn/python/PythonIncludes.h
===================================================================
--- trunk/plearn/python/PythonIncludes.h	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/plearn/python/PythonIncludes.h	2007-08-08 15:50:15 UTC (rev 7954)
@@ -74,14 +74,32 @@
 #include &lt;python2.5/Python.h&gt;
 #include &lt;python2.5/compile.h&gt;  // define PyCodeObject
 #include &lt;python2.5/eval.h&gt;     // for accessing PyEval_EvalCode: not included by default
-#include &lt;python2.5/numarray/libnumarray.h&gt;
+#ifdef PL_USE_NUMARRAY
+#  include &lt;python2.5/numarray/libnumarray.h&gt;
+#else
+#  ifdef PL_USE_NUMPY
+#    pragma GCC system_header //suppress all warnings/errors for numpy
+#    include &lt;libnumarray.h&gt;
+#  else
+#    error &quot;should use either NumPy (preferred) or NUMARRAY (deprecated)&quot;
+#  endif //def PL_USE_NUMPY
+#endif //def PL_USE_NUMARRAY
 
 #elif PL_PYTHON_VERSION &gt;= 240
 
 #include &lt;python2.4/Python.h&gt;
 #include &lt;python2.4/compile.h&gt;  // define PyCodeObject
 #include &lt;python2.4/eval.h&gt;     // for accessing PyEval_EvalCode: not included by default
-#include &lt;python2.4/numarray/libnumarray.h&gt;
+#ifdef PL_USE_NUMARRAY
+#  include &lt;python2.4/numarray/libnumarray.h&gt;
+#else
+#  ifdef PL_USE_NUMPY
+#    pragma GCC system_header //suppress all warnings/errors for numpy
+#    include &lt;libnumarray.h&gt;
+#  else
+#    error &quot;should use either NumPy (preferred) or NUMARRAY (deprecated)&quot;
+#  endif //def PL_USE_NUMPY
+#endif //def PL_USE_NUMARRAY
 
 #elif PL_PYTHON_VERSION &gt;= 230
 

Modified: trunk/plearn/python/PythonObjectWrapper.cc
===================================================================
--- trunk/plearn/python/PythonObjectWrapper.cc	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/plearn/python/PythonObjectWrapper.cc	2007-08-08 15:50:15 UTC (rev 7954)
@@ -256,6 +256,36 @@
     return PythonObjectWrapper(pyobj);
 }
 
+CopiesMap ConvertFromPyObject&lt;CopiesMap&gt;::convert(PyObject* pyobj,
+                                                  bool print_traceback)
+{
+    PLASSERT( pyobj );
+    if (! PyDict_Check(pyobj))
+        PLPythonConversionError(&quot;ConvertFromPyObject&lt;CopiesMap&gt;&quot;, 
+                                pyobj, print_traceback);
+#if PL_PYTHON_VERSION&gt;=250
+    Py_ssize_t pos = 0;
+#else
+    int pos = 0;
+#endif
+    CopiesMap copies;
+    PyObject *key, *val;
+    while(PyDict_Next(pyobj, &amp;pos, &amp;key, &amp;val)) 
+    {
+        if(!PyCObject_Check(key))
+            PLPythonConversionError(&quot;ConvertFromPyObject&lt;CopiesMap&gt; &quot;
+                                    &quot;(key is not a cptr)&quot;, 
+                                    key, print_traceback);
+        if(!PyCObject_Check(val))
+            PLPythonConversionError(&quot;ConvertFromPyObject&lt;CopiesMap&gt; &quot;
+                                    &quot;(val is not a cptr)&quot;, 
+                                    val, print_traceback);
+        copies.insert(make_pair(PyCObject_AsVoidPtr(key),
+                                PyCObject_AsVoidPtr(val)));
+    }
+    return copies;
+}
+
 //#####  Constructors+Destructors  ############################################
 PythonObjectWrapper::PythonObjectWrapper(OwnershipMode o,
                                          // unused in this overload
@@ -433,7 +463,8 @@
         PythonObjectWrapper(args).as&lt;TVec&lt;PyObject*&gt; &gt;();
     PyObject* pyo= args_tvec[1];
     Object* o= PythonObjectWrapper(pyo);
-    o-&gt;ref();
+    if(args_tvec.length() &lt; 3 || args_tvec[2]==Py_True)
+        o-&gt;ref();
     //perr &lt;&lt; &quot;ref o-&gt;usage()= &quot; &lt;&lt; o-&gt;usage() &lt;&lt; endl;
     PythonObjectWrapper::m_wrapped_objects[o]= pyo;
     //perr &lt;&lt; &quot;refCPPObj: &quot; &lt;&lt; (void*)o &lt;&lt; &quot; : &quot; &lt;&lt; (void*)pyo &lt;&lt; endl;
@@ -632,6 +663,24 @@
     return pow.m_object;
 }
 
+PyObject* ConvertToPyObject&lt;CopiesMap&gt;::newPyObject(const CopiesMap&amp; copies)
+{
+    PyObject* pyobj= PyDict_New();
+    for(CopiesMap::const_iterator it= copies.begin();
+        it != copies.end(); ++it)
+    {
+        PyObject* key= PyCObject_FromVoidPtr(const_cast&lt;void*&gt;(it-&gt;first), 0);
+        PyObject* val= PyCObject_FromVoidPtr(it-&gt;second, 0);
+        int non_success = PyDict_SetItem(pyobj, key, val);
+        Py_XDECREF(key);
+        Py_XDECREF(val);
+        if(non_success)
+            PLERROR(&quot;ConvertToPyObject&lt;CopiesMap&gt;::newPyObject: cannot insert element &quot;
+                    &quot;into Python dict&quot;);
+    }
+    return pyobj;
+}
+
 PStream&amp; operator&gt;&gt;(PStream&amp; in, PythonObjectWrapper&amp; v)
 {
     PLERROR(&quot;Attempting to read a PythonObjectWrapper from a stream : not supported&quot;);

Modified: trunk/plearn/python/PythonObjectWrapper.h
===================================================================
--- trunk/plearn/python/PythonObjectWrapper.h	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/plearn/python/PythonObjectWrapper.h	2007-08-08 15:50:15 UTC (rev 7954)
@@ -61,6 +61,7 @@
 #include &lt;plearn/base/PMemPool.h&gt;
 #include &lt;plearn/base/TypeTraits.h&gt;
 #include &lt;plearn/base/tuple.h&gt;
+#include &lt;plearn/base/CopiesMap.h&gt;
 
 // from boost
 #include &lt;boost/static_assert.hpp&gt;
@@ -429,7 +430,13 @@
     static std::pair&lt;T,U&gt; convert(PyObject*, bool print_traceback);
 };
 
+template &lt;&gt;
+struct ConvertFromPyObject&lt;CopiesMap&gt;
+{
+    static CopiesMap convert(PyObject*, bool print_traceback);
+};
 
+
 //! Used to convert integer values to python, using PyInt if possible
 template &lt;class I&gt;
 PyObject* integerToPyObject(const I&amp; x)
@@ -628,6 +635,8 @@
 template&lt;&gt; struct ConvertToPyObject&lt;PythonObjectWrapper&gt;
 { static PyObject* newPyObject(const PythonObjectWrapper&amp; pow); };
 
+template&lt;&gt; struct ConvertToPyObject&lt;CopiesMap&gt;
+{ static PyObject* newPyObject(const CopiesMap&amp; copies); };
 
 
 struct PLPyClass
@@ -844,17 +853,14 @@
     static PyMethodDef m_refCPPObj_method_def;
     typedef map&lt;const string, PLPyClass&gt; pypl_classes_t;
     static pypl_classes_t m_pypl_classes;
+    typedef map&lt;const Object*, PyObject*&gt; wrapped_objects_t;
+    static wrapped_objects_t m_wrapped_objects; //!&lt; for wrapped PLearn Objects
 
 protected:
     OwnershipMode m_ownership;               //!&lt; Whether we own the PyObject or not
     PyObject* m_object;
-    
-    typedef map&lt;const Object*, PyObject*&gt; wrapped_objects_t;
 
-    static wrapped_objects_t m_wrapped_objects; //!&lt; for wrapped PLearn Objects
-
     template&lt;class T&gt; friend class ConvertToPyObject;
-    friend void printWrappedObjects();
 };
 
 // Specialization for General T*.  Attempt to cast into Object*.  If that works
@@ -1078,8 +1084,6 @@
     return p;
 }
 
-
-
 //#####  newPyObject Implementations  #########################################
 template&lt;typename T, bool is_enum&gt;
 struct StaticConvertEnumToPyObject

Modified: trunk/plearn/python/test/.pytest/EmbeddedPython_BasicIdentityCalls/expected_results/RUN.log
===================================================================
--- trunk/plearn/python/test/.pytest/EmbeddedPython_BasicIdentityCalls/expected_results/RUN.log	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/plearn/python/test/.pytest/EmbeddedPython_BasicIdentityCalls/expected_results/RUN.log	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,6 +1,7 @@
 Python code to be executed: 
 &gt;&gt;&gt;import sys
-from numarray import *
+#from numarray import *
+from numpy import *
 
 def nullary():
     print &gt;&gt;sys.stderr, 'Called nullary()'
@@ -23,13 +24,15 @@
     return x
 
 def unary_vec(x):
-    assert isinstance(x,numarraycore.NumArray) and len(x.shape) == 1
+    #assert isinstance(x,numarraycore.NumArray) and len(x.shape) == 1
+    assert isinstance(x,ndarray) and len(x.shape) == 1
     return x
 
 def unary_mat(x):
     print &gt;&gt;sys.stderr, 'Called unary_mat with:\n',x
     sys.stderr.flush()
-    assert isinstance(x,numarraycore.NumArray) and len(x.shape) == 2
+    #assert isinstance(x,numarraycore.NumArray) and len(x.shape) == 2
+    assert isinstance(x,ndarray) and len(x.shape) == 2
     return x
 
 def unary_list_str(x):

Modified: trunk/plearn/python/test/BasicIdentityCallsTest.cc
===================================================================
--- trunk/plearn/python/test/BasicIdentityCallsTest.cc	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/plearn/python/test/BasicIdentityCallsTest.cc	2007-08-08 15:50:15 UTC (rev 7954)
@@ -134,7 +134,8 @@
 
 string BasicIdentityCallsTest::python_code =
 &quot;import sys\n&quot;
-&quot;from numarray import *\n&quot;
+&quot;#from numarray import *\n&quot;
+&quot;from numpy import *\n&quot;
 &quot;\n&quot;
 &quot;def nullary():\n&quot;
 &quot;    print &gt;&gt;sys.stderr, 'Called nullary()'\n&quot;
@@ -157,13 +158,15 @@
 &quot;    return x\n&quot;
 &quot;\n&quot;
 &quot;def unary_vec(x):\n&quot;
-&quot;    assert isinstance(x,numarraycore.NumArray) and len(x.shape) == 1\n&quot;
+&quot;    #assert isinstance(x,numarraycore.NumArray) and len(x.shape) == 1\n&quot;
+&quot;    assert isinstance(x,ndarray) and len(x.shape) == 1\n&quot;
 &quot;    return x\n&quot;
 &quot;\n&quot;
 &quot;def unary_mat(x):\n&quot;
 &quot;    print &gt;&gt;sys.stderr, 'Called unary_mat with:\\n',x\n&quot;
 &quot;    sys.stderr.flush()\n&quot;
-&quot;    assert isinstance(x,numarraycore.NumArray) and len(x.shape) == 2\n&quot;
+&quot;    #assert isinstance(x,numarraycore.NumArray) and len(x.shape) == 2\n&quot;
+&quot;    assert isinstance(x,ndarray) and len(x.shape) == 2\n&quot;
 &quot;    return x\n&quot;
 &quot;\n&quot;
 &quot;def unary_list_str(x):\n&quot;

Modified: trunk/plearn/python/test/MemoryStressTest.cc
===================================================================
--- trunk/plearn/python/test/MemoryStressTest.cc	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/plearn/python/test/MemoryStressTest.cc	2007-08-08 15:50:15 UTC (rev 7954)
@@ -135,7 +135,8 @@
 
 string MemoryStressTest::python_code =
 &quot;import sys\n&quot;
-&quot;from numarray import *\n&quot;
+&quot;#from numarray import *\n&quot;
+&quot;from numpy import *\n&quot;
 &quot;\n&quot;
 &quot;def nullary():\n&quot;
 &quot;    pass\n&quot;
@@ -157,11 +158,13 @@
 &quot;    return x\n&quot;
 &quot;\n&quot;
 &quot;def unary_vec(x):\n&quot;
-&quot;    assert isinstance(x,numarraycore.NumArray) and len(x.shape) == 1\n&quot;
+&quot;    #assert isinstance(x,numarraycore.NumArray) and len(x.shape) == 1\n&quot;
+&quot;    assert isinstance(x,ndarray) and len(x.shape) == 1\n&quot;
 &quot;    return x\n&quot;
 &quot;\n&quot;
 &quot;def unary_mat(x):\n&quot;
-&quot;    assert isinstance(x,numarraycore.NumArray) and len(x.shape) == 2\n&quot;
+&quot;    #assert isinstance(x,numarraycore.NumArray) and len(x.shape) == 2\n&quot;
+&quot;    assert isinstance(x,ndarray) and len(x.shape) == 2\n&quot;
 &quot;    return x\n&quot;
 &quot;\n&quot;
 &quot;def unary_list_str(x):\n&quot;

Modified: trunk/plearn/python/test/test_python_vmatrix.pymat
===================================================================
--- trunk/plearn/python/test/test_python_vmatrix.pymat	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/plearn/python/test/test_python_vmatrix.pymat	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,3 +1,5 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 from plearn.pyplearn import *
 
 ### This is an inline Matrix that will be processed (transformed) by the
@@ -20,9 +22,10 @@
 ### indentation-sensitive.
 processing_code = &quot;&quot;&quot;
 import sys
-from numarray import *
+from numpy.numarray import *
 
 def getRow(row_no, source_row):
+    row_no= array([row_no])
     return concatenate((10*row_no, 2*source_row))
 
 def getFieldNames(source_field_names):

Modified: trunk/plearn_learners/distributions/test/gaussian_mixtures_generate.pymat
===================================================================
--- trunk/plearn_learners/distributions/test/gaussian_mixtures_generate.pymat	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/plearn_learners/distributions/test/gaussian_mixtures_generate.pymat	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,7 +1,9 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 # Generate data from Gaussian mixtures.
 # Also test the 'expecation' method.
 
-from numarray        import array
+from numpy.numarray        import array
 from plearn.pyplearn import pl
 
 def diagonal(predictor_size):

Modified: trunk/pymake.config.model
===================================================================
--- trunk/pymake.config.model	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/pymake.config.model	2007-08-08 15:50:15 UTC (rev 7954)
@@ -242,15 +242,58 @@
 
 linkeroptions_tail = ''
 
+
+#####  Global List of pymake Options  #######################################
+
+# List of lists of mutually exclusive pymake options.
+# First option that appears in each group is the default, and is assumed if you
+# do not specify any option from that group.
+options_choices = [
+  [ 'g++', 'g++3', 'g++no-cygwin', 'icc', 'icc8', 'icc9', 'mpi',
+    'purify', 'quantify', 'vc++' ],
+  
+  [ 'dbg', 'opt', 'pintel', 'gprof', 'optdbggprof', 'safegprof',
+    'safeopt', 'safeoptdbg', 'checkopt', 'genericvc++', 'pydbg' ],
+  
+  [ 'double', 'float' ],
+  
+  # [ 'throwerrors', 'exiterrors' ],
+  [ 'autopython', 'python23', 'python24', 'python25', 'nopython' ],
+  
+  [ 'blas', 'noblas' ],
+  [ 'defblas', 'nolibblas', 'p3blas','p4blas','athlonblas','pentiumblas',
+    'mammouthblas', 'veclib', 'scs', 'goto', 'lisa' ],
+  
+  [ 'logging=dbg', 'logging=mand', 'logging=imp', 'logging=normal',
+    'logging=extreme', 'logging=dbg-profile' ],
+
+  [ 'numpy', 'numarray' ]
+
+]
+
 ### Using Python code snippets in C++ code
 ### TODO Using /u/lisa/... is quite ugly. But the PLEARN_LIBDIR ppath may also
 ### be problematic (it should be different depending on the platform) =&gt; must
 ### find a better way to know where to find the libraries.
 ### TODO Should find a way to automatically find python version ?
+
+
+pyver = sys.version.split()[0][0:3]
+pyoption = 'python%s' % pyver.replace('.', '')
+#verify/set optionargs for python and numpy
+python_choices= [x for x in options_choices if 'autopython' in x][0]
+if [x for x in python_choices if x in optionargs]==[]:
+    optionargs.append('autopython')
+numpy_choices= [x for x in options_choices if 'numpy' in x][0]
+if [x for x in numpy_choices if x in optionargs]==[]:
+    optionargs.append('numpy')
+#auto-detected python version, if needed
+if 'autopython' in optionargs:
+    optionargs.remove('autopython')
+    optionargs += [ pyoption ]
+
 if not 'nopython' in optionargs:
     # First find which version of python is installed.
-    pyver = sys.version.split()[0][0:3]
-    pyoption = 'python%s' % pyver.replace('.', '')
     if domain_name.endswith('iro.umontreal.ca'):
         optionargs += [ pyoption ]
         python_version = pyver
@@ -301,15 +344,40 @@
             python_version = pyver
 
         python_lib_root = '/usr/lib'
-        numpy_site_packages = '/usr/lib/python'+python_version+'/site-packages/numarray'
-        numpy_includedirs   = [ '/usr/include/python'+python_version]
+        numpy_site_packages = '-L/usr/lib/python'+python_version+'/site-packages/numarray'
+        python_includedirs   = [ '/usr/include/python'+python_version]
 
+        numpy_includedirs   = python_includedirs
 
+
+    if python_version != pyver:
+        print '*** WARNING: python version mismatch:'
+        print '\tcompiling for python'+python_version+' using python'+pyver
+
+    if 'numpy' in optionargs:
+        try:
+            numpy_numarray_include, numpy_core_include= \
+              os.popen('python' + python_version + ' ' 
+                       + os.path.join( plearndir,'scripts','get_numpy_includes.py'),
+                       'r').read().splitlines()
+            numpy_site_packages= numpy_numarray_include
+            numpy_includedirs= [numpy_site_packages+'/numpy', numpy_core_include] \
+                               + python_includedirs
+        except ValueError:
+            print 'Cannot find numpy include dirs for python'+python_version+'.',
+            print 'Make sure numpy is installed for this version of python'+\
+                  ' or compile using another version of python.'
+            sys.exit()
+
+    numpy_lib= ' -lnumarray '
+    if 'numpy' in optionargs:
+        numpy_lib= '/_capi.so -lutil '
+
     if platform!='darwin':
         optionalLibrary( name = 'python',
                      triggers = '[Pp]ython*',
                      includedirs = numpy_includedirs,
-                     linkeroptions = ( '-L%s -lnumarray ' % numpy_site_packages + 
+                     linkeroptions = ( '%s%s ' % (numpy_site_packages, numpy_lib) + 
                                        '-L%s/python%s/config -lpython%s ' % (python_lib_root, python_version, python_version) +
                                        '-Xlinker -export-dynamic ' + 
                                        '-Xlinker -rpath -Xlinker %s' % numpy_site_packages )
@@ -411,32 +479,6 @@
 linkeroptions_tail += ' -L' + libdir + ' -lm'
 
 
-#####  Global List of pymake Options  #######################################
-
-# List of lists of mutually exclusive pymake options.
-# First option that appears in each group is the default, and is assumed if you
-# do not specify any option from that group.
-options_choices = [
-  [ 'g++', 'g++3', 'g++no-cygwin', 'icc', 'icc8', 'icc9', 'mpi',
-    'purify', 'quantify', 'vc++' ],
-  
-  [ 'dbg', 'opt', 'pintel', 'gprof', 'optdbggprof', 'safegprof',
-    'safeopt', 'safeoptdbg', 'checkopt', 'genericvc++', 'pydbg' ],
-  
-  [ 'double', 'float' ],
-  
-  # [ 'throwerrors', 'exiterrors' ],
-  [ 'python23', 'python24', 'python25', 'nopython' ],
-  
-  [ 'blas', 'noblas' ],
-  [ 'defblas', 'nolibblas', 'p3blas','p4blas','athlonblas','pentiumblas',
-    'mammouthblas', 'veclib', 'scs', 'goto', 'lisa' ],
-  
-  [ 'logging=dbg', 'logging=mand', 'logging=imp', 'logging=normal',
-    'logging=extreme', 'logging=dbg-profile' ]
-
-]
-
 #####  Compiler-Related Options  ############################################
 
 if target_platform=='linux-i386':
@@ -621,6 +663,11 @@
 
 #####  Python version  ######################################################
 
+
+# pymakeOption( name = 'autopython',
+#               description = 'auto-detect python version',
+#               cpp_definitions = ['PL_PYTHON_VERSION='+str(int(float(pyver)*100))])
+
 pymakeOption( name = 'python23',
               description = 'the installed version of python is 2.3.X',
               cpp_definitions = ['PL_PYTHON_VERSION=230'])
@@ -760,6 +807,18 @@
 
 cpp_variables += ['PL_LOG_VERBOSITY', 'PL_PROFILE']
 
+
+#####  Python NUMARRAY vs NumPy  ########################################
+
+pymakeOption( name = 'numarray',
+              description = 'use numarray arrays',
+              cpp_definitions = ['PL_USE_NUMARRAY'] )
+pymakeOption( name = 'numpy',
+              description = 'use numpy arrays',
+              cpp_definitions = ['PL_USE_NUMPY'] )
+
+cpp_variables += ['PL_USE_NUMARRAY', 'PL_USE_NUMPY']
+
 #####  Network Setup  #######################################################
 
 # nprocesses_on_localhost = 1

Modified: trunk/python_modules/plearn/analysis/experiment_results.py
===================================================================
--- trunk/python_modules/plearn/analysis/experiment_results.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/analysis/experiment_results.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -28,9 +28,9 @@
 #
 #  This file is part of the PLearn library. For more information on the PLearn
 #  library, go to the PLearn Web site at www.plearn.org
-import sys, os, os.path, glob, fnmatch, csv, numarray
+import sys, os, os.path, glob, fnmatch, csv, numpy.numarray
 
-import os, glob, fnmatch, numarray
+import os, glob, fnmatch, numpy.numarray
 from plearn.vmat.PMat          import PMat
 from plearn.vmat.smartReadMat  import smartReadMat
 from plearn.utilities.moresh   import relative_path

Modified: trunk/python_modules/plearn/io/serialize.py
===================================================================
--- trunk/python_modules/plearn/io/serialize.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/io/serialize.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,3 +1,5 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 # serialize.py
 # Copyright (C) 2005, 2006 Pascal Vincent, Christian Dorion
 #
@@ -36,7 +38,7 @@
 Streams are built using the File objects' specifications
 &quot;&quot;&quot;
 import logging, sys, string
-import numarray
+import numpy.numarray as numarray
 from plearn.pyplearn import pl
 from plearn.pyplearn.plearn_repr import plearn_repr, clear_ref_map
 import plearn.utilities.pl_struct as struct  ## corrige un bug dans struct
@@ -334,7 +336,7 @@
         ar = numarray.fromstring(data, atype, shape)
         
         if sys.byteorder!=endianness:
-            ar.byteswap()
+            ar.byteswap(True)
 
         if self.return_lists:
             ar = ar.tolist()

Modified: trunk/python_modules/plearn/learners/autolr/__init__.py
===================================================================
--- trunk/python_modules/plearn/learners/autolr/__init__.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/learners/autolr/__init__.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,5 +1,7 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 from math import *
-from numarray import *
+from numpy.numarray import *
 from plearn import *
 from plearn.bridge import *
 from threading import *
@@ -697,3 +699,4 @@
             # (i.e. stage of best error found)
             (best_early_stop,best_early_stop_candidate,best_early_stop_epoch))
 
+import numpy.numarray as numarray

Modified: trunk/python_modules/plearn/learners/discr_power_SVM.py
===================================================================
--- trunk/python_modules/plearn/learners/discr_power_SVM.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/learners/discr_power_SVM.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,5 +1,7 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 import sys, os, time
-#from numarray import *
+#from numpy.numarray import *
 from math import *
 from libsvm import *
 

Modified: trunk/python_modules/plearn/math/StatsCollector.py
===================================================================
--- trunk/python_modules/plearn/math/StatsCollector.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/math/StatsCollector.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,3 +1,5 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 # readMMat.py
 # Copyright (C) 2006 by Nicolas Chapados
 #
@@ -33,12 +35,12 @@
 # Author: Nicolas Chapados
 
 import os, sys
-import numarray.ieeespecial        as  ieee
-from   plearn.math import isNaN
-from   numarray    import array    as  normal_array
-from   numarray    import sometrue as  normal_sometrue
-from   numarray    import zeros, matrixmultiply, transpose
-from   numarray.ma import *                         # masked array
+from numpy import isnan
+from   numpy.numarray    import array    as  normal_array
+from   numpy.numarray    import sometrue as  normal_sometrue
+from   numpy.numarray    import zeros, matrixmultiply, transpose
+#from   numpy.numarray.ma import *                         # masked array
+from   numpy.numarray.ma import masked_array, argmin, argmax, array, nonzero, outerproduct, diagonal, sqrt, sum
 from   fpconst     import NegInf, PosInf
 
 from   plearn.utilities import ppath
@@ -49,7 +51,7 @@
     If 'pretty' is set to False, the output will not be so nice, but at least
     will not cause test failures due to a zero test blank tolerance.
     &quot;&quot;&quot;
-    (length, width) = shape(m)
+    (length, width) = m.shape #shape(m)
     assert length == len(rownames)
     assert width  == len(colnames)
     leftlen  = max([len(x) for x in rownames])
@@ -113,15 +115,15 @@
         assume that all observations have the same weight.
         Properly handle missing values.
         &quot;&quot;&quot;
-        assert self.width() == shape(arr)[1]
+        assert self.width() == arr.shape[1] #shape(arr)[1]
         i = 0
 
         ## Update number of elements counters
-        (length,width)= shape(arr)
-        initial_n     = self.n[:]          # Keep old n for argmin/argmax
+        (length,width)= arr.shape #shape(arr)
+        initial_n     = self.n.copy()#self.n[:]          # Keep old n for argmin/argmax
         n             = zeros(width) + length
-        missings      = isNaN(arr)
-        nnan          = sum(missings)
+        missings      = isnan(arr)
+        nnan          = sum(missings,0)
         self.n       += n
         self.nnan    += nnan
         self.nnonnan += n - nnan
@@ -129,12 +131,12 @@
         ## Create masked version of arr and update accumulators
         ma = masked_array(arr, mask=missings)        # Here, mask missings only
         arr_nomissings = arr[~normal_sometrue(missings,1)]  # Here, strip missing rows
-        self.sum     = self.sum + sum(ma)            # += does not work...
-        self.sum_ssq = self.sum_ssq + sum(ma*ma)     # += does not work...
+        self.sum     = self.sum + sum(ma,0)            # += does not work...
+        self.sum_ssq = self.sum_ssq + sum(ma*ma,0)     # += does not work...
         self.sum_xxt = self.sum_xxt + matrixmultiply(transpose(arr_nomissings),
                                                      arr_nomissings)
-        self.sum_nomi= self.sum_nomi + sum(arr_nomissings)
-        self.nxxt   += shape(arr_nomissings)[0]
+        self.sum_nomi= self.sum_nomi + sum(arr_nomissings,0)
+        self.nxxt   += arr_nomissings.shape[0] #shape(arr_nomissings)[0]
 
         ## Update (arg)min / make sure old argmin is kept if not updated
         ma_argmin  = argmin(ma,0)
@@ -194,7 +196,7 @@
         If 'pretty' is set to False, the output will not be so nice, but at least
         will not cause test failures due to a zero test blank tolerance.
         &quot;&quot;&quot;
-        if len(nonzero(self.nnonnan)) != len(self.nnonnan):
+        if len(nonzero(self.nnonnan)[0]) != len(self.nnonnan):
             print &gt;&gt;os, &quot;One or more columns in StatsCollector does not contain any data&quot;
             return                      # Nothing accumulated yet
         
@@ -203,7 +205,9 @@
               &quot;V&quot;      , &quot;STDDEV&quot;   , &quot;STDERR&quot;      , &quot;SUM&quot; ,
               &quot;SUMSQ&quot;  , &quot;MIN&quot;      , &quot;ARGMIN&quot;      , &quot;MAX&quot; ,  &quot;ARGMAX&quot; ]
 
+        
         m = array([[stats[k][i] for i in range(self.width())] for k in sk])
+
         _printMatrix(m, sk, self.fieldnames, os, pretty)
         
         print &quot;\nCovariance Matrix:&quot;

Modified: trunk/python_modules/plearn/math/arrays.py
===================================================================
--- trunk/python_modules/plearn/math/arrays.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/math/arrays.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,3 +1,5 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 # arrays.py
 # Copyright (C) 2005,2006 Christian Dorion
 #
@@ -30,10 +32,13 @@
 #  library, go to the PLearn Web site at www.plearn.org
 
 # Author: Christian Dorion
+import numpy.numarray as numarray
 from math import *
-from numarray import *
-from numarray.linear_algebra import inverse as __numarray_inverse
-from numarray.linear_algebra import determinant
+from numpy.numarray import *
+from numpy.numarray.linear_algebra import inverse as __numarray_inverse
+from numpy.numarray.linear_algebra import determinant
+from numpy import *
+import numpy.numarray as ufunc #most ufuncs are part of the numpy module
 
 def _2D_shape(M):
     if len(M.shape)==1:
@@ -81,7 +86,7 @@
             K[i*l2:(i+1)*l2, j*w2:(j+1)*w2] = M1[i,j] * m2
 
     if w1==1 and w2==1:
-        K = K.getflat()
+        K = K.ravel()
     return K
 
 def lag(series, k=1, fill=(lambda shape : array([]))):
@@ -110,7 +115,7 @@
     assert len(shp)==2
     length = shp[0]*shp[1]
 
-    mat.setshape((length,))
+    mat.shape = (length,)
     return shp
 
 def mmult(*args):
@@ -176,7 +181,7 @@
     &quot;&quot;&quot;Returns a diagonal matrix with elements in 'a' on the diagonal.&quot;&quot;&quot;
     assert len(a.shape)==1
     n = len(a)
-    A = zeros(shape=(n,n), type=a.type())
+    A = zeros(shape=(n,n), type=numarray.typefrom(a))
     for i in range(n):
         A[i,i] = a[i]
     return A
@@ -195,17 +200,17 @@
     f = ravel(f)
     if len(f)==0:
         return False
-    f = choose(isNaN(f), (0, 1))
+    f = choose(isnan(f), (0, 1))
     return sum(f)
     
 def isNaN(f):
     &quot;&quot;&quot;Return 1 where f contains NaN values, 0 elsewhere.&quot;&quot;&quot;
-    from numarray import ieeespecial
+    import numpy as ieeespecial
     return ieeespecial.mask(f, ieeespecial.NAN)
 
 def isNotNaN(f):
     &quot;&quot;&quot;Return 0 where f contains NaN values, 1 elsewhere.&quot;&quot;&quot;
-    return ufunc.equal(isNaN(f), 0.0)
+    return ufunc.equal(isnan(f), 0.0)
 
 def replace_nans(a, repl_with=0.0):
     return choose(isNotNaN(a), (repl_with, a))
@@ -231,11 +236,11 @@
     
     print fast_softmax([ 0, 0, 100 ])
     print
-    print isNaN(float('NaN'))
-    print isNaN(2.0)
-    print isNaN([1.0, float('NaN'), 3.0])
+    print isnan(float('NaN'))
+    print isnan(2.0)
+    print isnan([1.0, float('NaN'), 3.0])
     print hasNaN([1.0, float('NaN'), 3.0])
-    print isNaN([1.0, 2.0, 3.0])
+    print isnan([1.0, 2.0, 3.0])
     print hasNaN([1.0, 2.0, 3.0])
     print
 
@@ -266,7 +271,7 @@
     print a
     a_shape = matrix2vector(a)
     print a
-    a.setshape(a_shape)
+    a.shape = a_shape
     print a
     
     

Modified: trunk/python_modules/plearn/math/missings_robust_covariance.py
===================================================================
--- trunk/python_modules/plearn/math/missings_robust_covariance.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/math/missings_robust_covariance.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,3 +1,5 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 # missings_robust_covariance
 # Copyright (C) 2007 by Nicolas Chapados
 #
@@ -35,7 +37,7 @@
 
 import sys
 from fpconst     import NaN
-from numarray.ma import *
+from numpy.numarray.ma import *
 from plearn.math import isNaN
 
 def missingsRobustCovariance(arr, unbiased=False, epsilon=1e-8):
@@ -57,7 +59,7 @@
     the diagonal.
     &quot;&quot;&quot;
     ## Second-order statistics
-    mask   = isNaN(arr)
+    mask   = isnan(arr)
     arr_ma = array(arr, mask=mask)
     count  = array(1 - mask)
 

Modified: trunk/python_modules/plearn/math/random_processes.py
===================================================================
--- trunk/python_modules/plearn/math/random_processes.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/math/random_processes.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,7 +1,9 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 #!/usr/bin/env python
 from math import ceil, floor
-from numarray import *
-from numarray.random_array import normal
+from numpy.numarray import *
+from numpy.numarray.random_array import normal
 
 #####  Utility Functions  ###################################################
 #####    Instanciate the process' class and extract the process          ####

Modified: trunk/python_modules/plearn/math/statistical_tools.py
===================================================================
--- trunk/python_modules/plearn/math/statistical_tools.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/math/statistical_tools.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,3 +1,5 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 # statistical_tools.py
 # Copyright (C) 2006 Christian Dorion
 #
@@ -345,11 +347,11 @@
 
     # for convenience...
     if K==1:
-        beta = beta.getflat()
+        beta = beta.ravel()
     if N==1:
         alpha   = alpha.  getflat()
         beta    = beta.   getflat()
-        epsilon = epsilon.getflat()
+        epsilon = epsilon.ravel()
         
     return alpha, beta, epsilon, sigma
 
@@ -376,7 +378,7 @@
 
     print
     if K==1:
-        X = X.getflat()
+        X = X.ravel()
     scipy = stats.linregress(X, Y)    
     print &quot;Beta SciPy (with intercept %s):&quot;%scipy[1],
     print scipy[0], &quot;(%.3f)&quot;%matrix_distance(array(scipy[0]),beta)
@@ -410,7 +412,7 @@
     __delattr__ = dict.__delitem__
 
 if __name__ == &quot;__main__&quot;:        
-    from numarray.random_array import seed, random, normal
+    from numpy.numarray.random_array import seed, random, normal
     seed(02, 25)
     
     # Setting the problem

Modified: trunk/python_modules/plearn/math/stats/cvx_utils.py
===================================================================
--- trunk/python_modules/plearn/math/stats/cvx_utils.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/math/stats/cvx_utils.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,3 +1,5 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 # cvx_utils.py
 # Copyright (C) 2007 Christian Dorion
 #
@@ -33,7 +35,7 @@
 # Author: Christian Dorion
 &quot;&quot;&quot;Provides functions to use CVX transparently where NumPy or NumArray is the standard.&quot;&quot;&quot;
 import numpy
-import numarray 
+import numpy.numarray as numarray
 from cvxopt import base as cvx
 
 

Modified: trunk/python_modules/plearn/parallel/dispatch.py
===================================================================
--- trunk/python_modules/plearn/parallel/dispatch.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/parallel/dispatch.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -179,14 +179,19 @@
         &quot;&quot;&quot;
         got_info= False
         while not got_info:
-            s= child_fd.readline()
-            if s=='':
-                print &quot;Cannot get info from server!&quot;
-                sys.exit()
-            ss= s.split(' ')
-            if ss[0] == &quot;PLEARN_SERVER_TCP&quot;:
-                info= (ss[1], int(ss[2]), int(ss[3]))
-                got_info= True
+            try:
+                s= child_fd.readline()
+                if s=='':
+                    print &quot;Cannot get info from server!&quot;
+                    sys.exit()
+                ss= s.split(' ')
+                if ss[0] == &quot;PLEARN_SERVER_TCP&quot;:
+                    info= (ss[1], int(ss[2]), int(ss[3]))
+                    got_info= True
+            except IOError:
+                print '.',
+                time.sleep(1)
+                
         cls._launched_servers_info+= [info]
         return info
     getLaunchedServerInfo= classmethod(getLaunchedServerInfo)

Modified: trunk/python_modules/plearn/plotting/__init__.py
===================================================================
--- trunk/python_modules/plearn/plotting/__init__.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/plotting/__init__.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,3 +1,5 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 # plotting.py
 # Copyright (C) 2005 Pascal Vincent
 #
@@ -33,8 +35,7 @@
 # Author: Pascal Vincent
 
 # from array import *
-import numarray
-
+import numpy.numarray as numarray
 import string
 import matplotlib
 # matplotlib.interactive(True)
@@ -42,7 +43,7 @@
 #matplotlib.use('GTK')
   
 from pylab import *
-from numarray import *
+from numpy.numarray import *
 from mayavi.tools import imv
 
 from plearn.vmat.PMat import *

Modified: trunk/python_modules/plearn/plotting/netplot.py
===================================================================
--- trunk/python_modules/plearn/plotting/netplot.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/plotting/netplot.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,5 +1,5 @@
 from pylab import *
-from numarray import *
+from numpy.numarray import *
 
 
 #################

Modified: trunk/python_modules/plearn/pybridge/wrapped_plearn_object.py
===================================================================
--- trunk/python_modules/plearn/pybridge/wrapped_plearn_object.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/pybridge/wrapped_plearn_object.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -69,18 +69,31 @@
                                    + repr(self))
         
     def __del__(self):
-        #from plearn import pyext
-        #print 'del',type(self),self._cptr
-        #pyext.printWrappedObjects()
-        self._unref()
-        #pyext.printWrappedObjects()
+        if hasattr(self, '_cptr'):
+            self._unref()
 
     def __repr__(self):
         return self.asString() #PLearn repr. for now
 
-#from numpy.numarray import *
-from numarray import *
+    def __deepcopy__(self, memo= None):
+        if not memo: memo= {}
+        if 'PLearnCopiesMap' not in memo:
+            memo['PLearnCopiesMap']= {}
+        plnewone, memo['PLearnCopiesMap']= \
+            self.pyDeepCopy(memo['PLearnCopiesMap'])
+        newone= self.__class__(_cptr= plnewone._cptr)
+        memo[id(self)]= newone
+        del plnewone._cptr
+        newone._refCPPObj(newone, False)
+        for k in self.__dict__:
+            if k != '_cptr':
+                newone.__dict__[k]= \
+                    copy.deepcopy(self.__dict__[k], memo)
+        return newone
 
+
+from numpy.numarray import *
+
 class WrappedPLearnVMat(WrappedPLearnObject):
     def __init__(self, cptr):
         WrappedPLearnObject.__init__(self, cptr)

Modified: trunk/python_modules/plearn/pymake/pymake.py
===================================================================
--- trunk/python_modules/plearn/pymake/pymake.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/pymake/pymake.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -2731,6 +2731,7 @@
         (list_of_hosts, nice_values) = get_list_of_hosts()
 
 
+
     ######  The compilation and linking
 
     for target in otherargs:

Modified: trunk/python_modules/plearn/pyplearn/__init__.py
===================================================================
--- trunk/python_modules/plearn/pyplearn/__init__.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/pyplearn/__init__.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,3 +1,5 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 # pyplearn/__init__.py
 # Copyright (C) 2004-2006 Christian Dorion
 #
@@ -165,8 +167,7 @@
     @returns: PyPLearn's TMat representation
     @rtype: A numarray or L{ __TMat} wrapper
     &quot;&quot;&quot;
-    import numarray
-    
+    import numpy.numarray as numarray
     nargs   = len(args)
     is_real = lambda r: isinstance( r, int   ) or isinstance( r, float )
 

Modified: trunk/python_modules/plearn/pyplearn/plearn_repr.py
===================================================================
--- trunk/python_modules/plearn/pyplearn/plearn_repr.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/pyplearn/plearn_repr.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,3 +1,5 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 # plearn_repr.py
 # Copyright (C) 2005, 2006 Christian Dorion
 #
@@ -38,9 +40,11 @@
 from plearn.utilities.Bindings import Bindings
 
 try:
-    import numarray
+    #import numpy.numarray as numarray
+    import numpy
 except ImportError:
-    numarray = None
+    #numarray = None
+    numpy = None
 
 #
 #  Deprecated functions
@@ -280,8 +284,9 @@
 ##             return '(' + ', '.join( [ inner_repr(elem, indent_level+1) for elem in obj] ) + ') '
 
     # Stands for TMat&lt;real&gt;
-    elif numarray is not None and isinstance( obj, numarray.numarraycore.NumArray ):
-        shape = obj.getshape()
+    #elif numarray is not None and isinstance( obj, numarray.numarraycore.NumArray ):
+    elif numpy is not None and isinstance( obj, numpy.ndarray ):
+        shape = obj.shape
         if len(shape) == 1:
             listrepr = [ elem for elem in obj ]
             return &quot;%d %s&quot; % ( shape[0], inner_repr(listrepr, indent_level+1) )
@@ -290,6 +295,7 @@
             l,w = shape
             listrepr = []
             # we do this explicit for due to a numarray bug for 0x0 matrices...
+            # N.B. is this still true w/ numpy?
             for i in xrange(l):
                 row = obj[i]
                 for elem in row:
@@ -297,7 +303,8 @@
             # listrepr = [ f for row in obj for f in row ]
             return &quot;%d %d %s&quot; % ( l, w, inner_repr(listrepr, indent_level+1) )
 
-        raise ValueError( &quot;Only numarrays of dimension 1 and 2 are understood by plearn_repr.&quot; )
+        #raise ValueError( &quot;Only numarrays of dimension 1 and 2 are understood by plearn_repr.&quot; )
+        raise ValueError( &quot;Only NumPy arrays of dimension 1 and 2 are understood by plearn_repr.&quot; )
             
     
     elif obj is None:
@@ -346,7 +353,8 @@
 
     toplevel2 = pl.TopLevel( name = &quot;Embedded&quot;, embedded = toplevel,
                              some_dict = { &quot;a&quot; : 1, &quot;b&quot; : 2 },
-                             some_mat  = numarray.array([[1,2], [3, 4]])
+                             #some_mat  = numarray.array([[1,2], [3, 4]])
+                             some_mat  = numpy.array([[1,2], [3, 4]])
                              )
     print toplevel2 
 

Modified: trunk/python_modules/plearn/vmat/PMat.py
===================================================================
--- trunk/python_modules/plearn/vmat/PMat.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/vmat/PMat.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,3 +1,5 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 # PMat.py
 # Copyright (C) 2005 Pascal Vincent
 #
@@ -32,7 +34,8 @@
 
 # Author: Pascal Vincent
 
-import numarray, sys, os, os.path
+#import numarray, sys, os, os.path
+import numpy.numarray, sys, os, os.path
 pyplearn_import_failed = False
 try:
     from plearn.pyplearn.plearn_repr import plearn_repr, format_list_elements
@@ -51,7 +54,7 @@
     else:
         indices = list( cols )            
 
-    return numarray.take(a, indices, axis=1)
+    return numpy.numarray.take(a, indices, axis=1)
 
 def load_pmat_as_array(fname):
     s = file(fname,'rb').read()
@@ -75,15 +78,15 @@
 
     l = int(l)
     w = int(w)
-    X = numarray.fromstring(datastr,elemtype, shape=(l,w) )
+    X = numpy.numarray.fromstring(datastr,elemtype, shape=(l,w) )
     if byteorder!=sys.byteorder:
-        X.byteswap()
+        X.byteswap(True)
     return X
 
 def save_array_as_pmat( fname, ar, fieldnames=[] ):
     s = file(fname,'wb')
     
-    length, width = ar.getshape()
+    length, width = ar.shape
     if fieldnames:
         assert len(fieldnames) == width
         metadatadir = fname+'.metadata'
@@ -96,16 +99,16 @@
         f.close()
     
     header = 'MATRIX ' + str(length) + ' ' + str(width) + ' '
-    if ar.typecode()=='d':
+    if ar.dtype.char=='d':
         header += 'DOUBLE '
         elemsize = 8
 
-    elif ar.typecode()=='f':
+    elif ar.dtype.char=='f':
         header += 'FLOAT '
         elemsize = 4
 
     else:
-        raise TypeError('Unsupported typecode: %s' % ar.typecode())
+        raise TypeError('Unsupported typecode: %s' % ar.dtype.char)
 
     rowsize = elemsize*width
 
@@ -181,7 +184,7 @@
             assert len(key) == 2
             rows = self.__getitem__( key[0] )
 
-            shape = rows.getshape()                       
+            shape = rows.shape                       
             if len(shape) == 1:
                 return rows[ key[1] ]
 
@@ -254,7 +257,7 @@
             raise ValueError(&quot;Currently only supported openmodes are 'r', 'w' and 'a': &quot;+repr(openmode)+&quot; is not supported&quot;)
 
         if array is not None:
-            shape  = array.getshape()
+            shape  = array.shape
             if len(shape) == 1:
                 row_format = lambda r: [ r ]
             elif len(shape) == 2:
@@ -344,9 +347,9 @@
             raise IndexError('PMat index out of range')
         self.f.seek(64+i*self.rowsize)
         data = self.f.read(self.rowsize)
-        ar = numarray.fromstring(data, self.elemtype, (self.width,))
+        ar = numpy.numarray.fromstring(data, self.elemtype, (self.width,))
         if self.swap_bytes:
-            ar.byteswap()
+            ar.byteswap(True)
         return ar
 
     def getRows(self,i,l):
@@ -354,9 +357,9 @@
             raise IndexError('PMat index out of range')
         self.f.seek(64+i*self.rowsize)
         data = self.f.read(l*self.rowsize)
-        ar = numarray.fromstring(data, self.elemtype, (l,self.width))
+        ar = numpy.numarray.fromstring(data, self.elemtype, (l,self.width))
         if self.swap_bytes:
-            ar.byteswap()
+            ar.byteswap(True)
         return ar
 
     def putRow(self,i,row):
@@ -367,10 +370,10 @@
         if i&lt;0 or i&gt;=self.length:
             raise IndexError
         if self.swap_bytes: # must make a copy and swap bytes
-            ar = numarray.numarray(row,type=self.elemtype)
-            ar.byteswap()
+            ar = numpy.numarray.numarray(row,type=self.elemtype)
+            ar.byteswap(True)
         else: # asarray makes a copy if not already a numarray of the right type
-            ar = numarray.asarray(row,type=self.elemtype)
+            ar = numpy.numarray.asarray(row,type=self.elemtype)
         self.f.seek(64+i*self.rowsize)
         self.f.write(ar.tostring())
 
@@ -378,10 +381,10 @@
         if len(row)!=self.width:
             raise TypeError('length of row ('+str(len(row))+ ') differs from matrix width ('+str(self.width)+')')
         if self.swap_bytes: # must make a copy and swap bytes
-            ar = numarray.numarray(row,type=self.elemtype)
-            ar.byteswap()
+            ar = numpy.numarray.numarray(row,type=self.elemtype)
+            ar.byteswap(True)
         else: # asarray makes a copy if not already a numarray of the right type
-            ar = numarray.asarray(row,type=self.elemtype)
+            ar = numpy.numarray.asarray(row,type=self.elemtype)
 
         self.f.seek(64+self.length*self.rowsize)
         self.f.write(ar.tostring())

Modified: trunk/python_modules/plearn/vmat/readAMat.py
===================================================================
--- trunk/python_modules/plearn/vmat/readAMat.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/vmat/readAMat.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -1,3 +1,5 @@
+## Automatically adapted for numpy.numarray Jun 13, 2007 by python_numarray_to_numpy (-xsm)
+
 # readMMat.py
 # Copyright (C) 2006 by Nicolas Chapados
 #
@@ -32,7 +34,7 @@
 
 # Author: Nicolas Chapados
 
-from numarray import array
+from numpy.numarray import array
 import fpconst
 
 def safefloat(str):

Modified: trunk/python_modules/plearn/vmat/smartReadMat.py
===================================================================
--- trunk/python_modules/plearn/vmat/smartReadMat.py	2007-08-08 15:01:47 UTC (rev 7953)
+++ trunk/python_modules/plearn/vmat/smartReadMat.py	2007-08-08 15:50:15 UTC (rev 7954)
@@ -33,7 +33,7 @@
 # Author: Nicolas Chapados
 
 import csv
-import numarray
+import numpy.numarray
 
 from plearn.vmat.PMat import PMat
 from plearn.vmat.readAMat import readAMat
@@ -162,7 +162,7 @@
         csv_reader = csv.reader(f)
         if has_header:
             fieldnames = csv_reader.next()
-        arr = numarray.array([[float(value) for value in fields] for fields in csv_reader])
+        arr = numpy.numarray.array([[float(value) for value in fields] for fields in csv_reader])
         if not has_header:
             # Generate fake fieldnames
             fieldnames = ['field%d' % (i + 1) for i in range(arr.shape[1])]


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001401.html">[Plearn-commits] r7953 - trunk/plearn_learners/online
</A></li>
	<LI>Next message: <A HREF="001403.html">[Plearn-commits] r7955 - trunk/scripts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1402">[ date ]</a>
              <a href="thread.html#1402">[ thread ]</a>
              <a href="subject.html#1402">[ subject ]</a>
              <a href="author.html#1402">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/plearn-commits">More information about the Plearn-commits
mailing list</a><br>
</body></html>
