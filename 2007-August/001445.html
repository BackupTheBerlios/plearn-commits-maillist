<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Plearn-commits] r7997 - in trunk/plearn: base python
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/plearn-commits/2007-August/index.html" >
   <LINK REL="made" HREF="mailto:plearn-commits%40lists.berlios.de?Subject=Re%3A%20%5BPlearn-commits%5D%20r7997%20-%20in%20trunk/plearn%3A%20base%20python&In-Reply-To=%3C200708152154.l7FLsKO8012255%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001444.html">
   <LINK REL="Next"  HREF="001446.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Plearn-commits] r7997 - in trunk/plearn: base python</H1>
    <B>saintmlx at BerliOS</B> 
    <A HREF="mailto:plearn-commits%40lists.berlios.de?Subject=Re%3A%20%5BPlearn-commits%5D%20r7997%20-%20in%20trunk/plearn%3A%20base%20python&In-Reply-To=%3C200708152154.l7FLsKO8012255%40sheep.berlios.de%3E"
       TITLE="[Plearn-commits] r7997 - in trunk/plearn: base python">saintmlx at mail.berlios.de
       </A><BR>
    <I>Wed Aug 15 23:54:20 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="001444.html">[Plearn-commits] r7996 - trunk/plearn_learners/generic
</A></li>
        <LI>Next message: <A HREF="001446.html">[Plearn-commits] r7998 - trunk/plearn_learners_experimental
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1445">[ date ]</a>
              <a href="thread.html#1445">[ thread ]</a>
              <a href="subject.html#1445">[ subject ]</a>
              <a href="author.html#1445">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: saintmlx
Date: 2007-08-15 23:54:18 +0200 (Wed, 15 Aug 2007)
New Revision: 7997

Modified:
   trunk/plearn/base/RemoteDeclareMethod.h
   trunk/plearn/base/RemoteMethodMap.cc
   trunk/plearn/base/RemoteMethodMap.h
   trunk/plearn/base/RemoteTrampoline.cc
   trunk/plearn/base/RemoteTrampoline.h
   trunk/plearn/python/PythonCodeSnippet.cc
   trunk/plearn/python/PythonCodeSnippet.h
   trunk/plearn/python/PythonExtension.cc
   trunk/plearn/python/PythonObjectWrapper.cc
   trunk/plearn/python/PythonObjectWrapper.h
Log:
- added flags to RemoteTrampolines
- 'nopython' flag for trampolines, to avoid injecting some functions into python
- allow construction of PythonCodeSnippets from already existing python instances (no code)



Modified: trunk/plearn/base/RemoteDeclareMethod.h
===================================================================
--- trunk/plearn/base/RemoteDeclareMethod.h	2007-08-15 20:41:34 UTC (rev 7996)
+++ trunk/plearn/base/RemoteDeclareMethod.h	2007-08-15 21:54:18 UTC (rev 7997)
@@ -70,12 +70,13 @@
 template &lt;class R&gt;
 inline void declareFunction(const string&amp; funcname,
                             R (*func)(),
-                            const RemoteMethodDoc&amp; doc)
+                            const RemoteMethodDoc&amp; doc,
+                            const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     RemoteMethodMap&amp; rmm = getGlobalFunctionMap();
     typedef FRemoteTrampoline_0&lt;R&gt; Trampoline;
     rmm.insert(funcname, Trampoline::expected_nargs,
-               new Trampoline(funcname, doc, func));
+               new Trampoline(funcname, doc, func, flgs));
 }
 
 
@@ -84,12 +85,13 @@
 template &lt;class R, class A1&gt;
 inline void declareFunction(const string&amp; funcname,
                             R (*func)(A1),
-                            const RemoteMethodDoc&amp; doc)
+                            const RemoteMethodDoc&amp; doc,
+                            const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     RemoteMethodMap&amp; rmm = getGlobalFunctionMap();
     typedef FRemoteTrampoline_1&lt;R,A1&gt; Trampoline;
     rmm.insert(funcname, Trampoline::expected_nargs,
-               new Trampoline(funcname, doc, func));
+               new Trampoline(funcname, doc, func, flgs));
 }
 
 
@@ -98,12 +100,13 @@
 template &lt;class R, class A1, class A2&gt;
 inline void declareFunction(const string&amp; funcname,
                             R (*func)(A1,A2),
-                            const RemoteMethodDoc&amp; doc)
+                            const RemoteMethodDoc&amp; doc,
+                            const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     RemoteMethodMap&amp; rmm = getGlobalFunctionMap();
     typedef FRemoteTrampoline_2&lt;R,A1,A2&gt; Trampoline;
     rmm.insert(funcname, Trampoline::expected_nargs,
-               new Trampoline(funcname, doc, func));
+               new Trampoline(funcname, doc, func, flgs));
 }
 
 
@@ -112,12 +115,13 @@
 template &lt;class R, class A1, class A2, class A3&gt;
 inline void declareFunction(const string&amp; funcname,
                             R (*func)(A1,A2,A3),
-                            const RemoteMethodDoc&amp; doc)
+                            const RemoteMethodDoc&amp; doc,
+                            const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     RemoteMethodMap&amp; rmm = getGlobalFunctionMap();
     typedef FRemoteTrampoline_3&lt;R,A1,A2,A3&gt; Trampoline;
     rmm.insert(funcname, Trampoline::expected_nargs,
-               new Trampoline(funcname, doc, func));
+               new Trampoline(funcname, doc, func, flgs));
 }
 
 
@@ -126,12 +130,13 @@
 template &lt;class R, class A1, class A2, class A3, class A4&gt;
 inline void declareFunction(const string&amp; funcname,
                             R (*func)(A1,A2,A3,A4),
-                            const RemoteMethodDoc&amp; doc)
+                            const RemoteMethodDoc&amp; doc,
+                            const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     RemoteMethodMap&amp; rmm = getGlobalFunctionMap();
     typedef FRemoteTrampoline_4&lt;R,A1,A2,A3,A4&gt; Trampoline;
     rmm.insert(funcname, Trampoline::expected_nargs,
-               new Trampoline(funcname, doc, func));
+               new Trampoline(funcname, doc, func, flgs));
 }
 
 //#####  5 Arguments  #########################################################
@@ -139,12 +144,13 @@
 template &lt;class R, class A1, class A2, class A3, class A4, class A5&gt;
 inline void declareFunction(const string&amp; funcname,
                             R (*func)(A1,A2,A3,A4,A5),
-                            const RemoteMethodDoc&amp; doc)
+                            const RemoteMethodDoc&amp; doc,
+                            const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     RemoteMethodMap&amp; rmm = getGlobalFunctionMap();
     typedef FRemoteTrampoline_5&lt;R,A1,A2,A3,A4,A5&gt; Trampoline;
     rmm.insert(funcname, Trampoline::expected_nargs,
-               new Trampoline(funcname, doc, func));
+               new Trampoline(funcname, doc, func, flgs));
 }
 
 //#####  6 Arguments  #########################################################
@@ -152,12 +158,13 @@
 template &lt;class R, class A1, class A2, class A3, class A4, class A5, class A6&gt;
 inline void declareFunction(const string&amp; funcname,
                             R (*func)(A1,A2,A3,A4,A5,A6),
-                            const RemoteMethodDoc&amp; doc)
+                            const RemoteMethodDoc&amp; doc,
+                            const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     RemoteMethodMap&amp; rmm = getGlobalFunctionMap();
     typedef FRemoteTrampoline_6&lt;R,A1,A2,A3,A4,A5,A6&gt; Trampoline;
     rmm.insert(funcname, Trampoline::expected_nargs,
-               new Trampoline(funcname, doc, func));
+               new Trampoline(funcname, doc, func, flgs));
 }
 
 
@@ -171,11 +178,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)(),
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_0&lt;T,R&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 // Const method
@@ -183,11 +191,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)() const,
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_0&lt;T,R&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 
@@ -198,11 +207,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)(A1),
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_1&lt;T,R,A1&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 // Const method
@@ -210,11 +220,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)(A1) const,
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_1&lt;T,R,A1&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 
@@ -225,11 +236,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)(A1,A2),
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_2&lt;T,R,A1,A2&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 // Const method
@@ -237,11 +249,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)(A1,A2) const,
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_2&lt;T,R,A1,A2&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 
@@ -252,11 +265,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)(A1,A2,A3),
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_3&lt;T,R,A1,A2,A3&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 // Const method
@@ -264,11 +278,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)(A1,A2,A3) const,
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_3&lt;T,R,A1,A2,A3&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 
@@ -279,11 +294,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)(A1,A2,A3,A4),
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_4&lt;T,R,A1,A2,A3,A4&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 // Const method
@@ -291,11 +307,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)(A1,A2,A3,A4) const,
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_4&lt;T,R,A1,A2,A3,A4&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 
@@ -306,11 +323,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)(A1,A2,A3,A4,A5),
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_5&lt;T,R,A1,A2,A3,A4,A5&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 // Const method
@@ -318,11 +336,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)(A1,A2,A3,A4,A5) const,
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_5&lt;T,R,A1,A2,A3,A4,A5&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 
@@ -333,11 +352,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)(A1,A2,A3,A4,A5,A6),
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_6&lt;T,R,A1,A2,A3,A4,A5,A6&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 // Const method
@@ -345,11 +365,12 @@
 inline void declareMethod(RemoteMethodMap&amp; rmm,
                           const string&amp; methodname,
                           R (T::*method)(A1,A2,A3,A4,A5,A6) const,
-                          const RemoteMethodDoc&amp; doc)
+                          const RemoteMethodDoc&amp; doc,
+                          const RemoteTrampoline::flag_t&amp; flgs= 0)
 {
     typedef RemoteTrampoline_6&lt;T,R,A1,A2,A3,A4,A5,A6&gt; Trampoline;
     rmm.insert(methodname, Trampoline::expected_nargs,
-               new Trampoline(methodname, doc, METHOD_UNCONST(method)));
+               new Trampoline(methodname, doc, METHOD_UNCONST(method), flgs));
 }
 
 

Modified: trunk/plearn/base/RemoteMethodMap.cc
===================================================================
--- trunk/plearn/base/RemoteMethodMap.cc	2007-08-15 20:41:34 UTC (rev 7996)
+++ trunk/plearn/base/RemoteMethodMap.cc	2007-08-15 21:54:18 UTC (rev 7997)
@@ -41,7 +41,6 @@
 namespace PLearn {
 using namespace std;
 
-
 //#####  RemoteMethodMap Implementation  ######################################
 
 RemoteMethodMap::~RemoteMethodMap()
@@ -117,7 +116,6 @@
     return txt;
 }
 
-
 } // end of namespace PLearn
 
 

Modified: trunk/plearn/base/RemoteMethodMap.h
===================================================================
--- trunk/plearn/base/RemoteMethodMap.h	2007-08-15 20:41:34 UTC (rev 7996)
+++ trunk/plearn/base/RemoteMethodMap.h	2007-08-15 21:54:18 UTC (rev 7997)
@@ -155,7 +155,7 @@
     //! registered methods with that name (whatever their arity),
     //! or return the string &quot;** No method named ... **&quot;
     string getMethodHelpText(const string&amp; methodname, int arity=-1) const;
-    
+
     //! Get the method map itself
     const MethodMap&amp; getMap() const
     { return m_methods; }

Modified: trunk/plearn/base/RemoteTrampoline.cc
===================================================================
--- trunk/plearn/base/RemoteTrampoline.cc	2007-08-15 20:41:34 UTC (rev 7996)
+++ trunk/plearn/base/RemoteTrampoline.cc	2007-08-15 21:54:18 UTC (rev 7997)
@@ -44,6 +44,8 @@
 
 //#####  RemoteTrampoline  ####################################################
 
+const RemoteTrampoline::flag_t RemoteTrampoline::nopython= 1;
+
 void RemoteTrampoline::checkNargs(int nargs, int expected_nargs) const
 {
     if (nargs != expected_nargs)

Modified: trunk/plearn/base/RemoteTrampoline.h
===================================================================
--- trunk/plearn/base/RemoteTrampoline.h	2007-08-15 20:41:34 UTC (rev 7996)
+++ trunk/plearn/base/RemoteTrampoline.h	2007-08-15 21:54:18 UTC (rev 7997)
@@ -105,10 +105,17 @@
  */
 struct RemoteTrampoline : public PPointable
 {
+    //! type for remote method flags
+    typedef unsigned int flag_t;
+    //! nopython flag: do not inject this method in python
+    static const flag_t nopython;
+
     //! Constructor takes the methodname and some documentation.
-    RemoteTrampoline(const string&amp; methodname, const RemoteMethodDoc&amp; doc)
+    RemoteTrampoline(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
+                     const flag_t&amp; flgs= 0)
         : m_methodname(methodname),
-          m_documentation(doc)
+          m_documentation(doc),
+          m_flags(flgs)
     {
         m_documentation.setName(methodname);
         m_documentation.checkConsistency();
@@ -119,6 +126,9 @@
     {
         return m_documentation;
     }
+
+    //! Flags accessor
+    const flag_t&amp; flags() const { return m_flags; }
     
     /**
      *  Perform the act of binding arguments on a stream with an object
@@ -225,6 +235,9 @@
 
     //! Documentation associated with the method
     RemoteMethodDoc m_documentation;
+
+    //! Flags associated with this method
+    flag_t m_flags;
 };
 
 //#####  Zero Arguments  ######################################################
@@ -240,9 +253,10 @@
     typedef R (T::*MethodType)();
     
     RemoteTrampoline_0(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
-                                 RTYPE_DOC(R))),
+                                 RTYPE_DOC(R)),
+                    flgs),
           m_method(m)
     { }
 
@@ -277,9 +291,10 @@
     typedef void (T::*MethodType)();
     
     RemoteTrampoline_0(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
-                                 RTYPE_DOC(void))),
+                                 RTYPE_DOC(void)),
+                    flgs),
           m_method(m)
     { }
 
@@ -317,10 +332,11 @@
     typedef R (T::*MethodType)(A1);
     
     RemoteTrampoline_1(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
                                  RTYPE_DOC(R),
-                                 ATYPE_DOC(A1))),
+                                 ATYPE_DOC(A1)),
+                    flgs),
           m_method(m)
     { }
 
@@ -357,10 +373,11 @@
     typedef void (T::*MethodType)(A1);
     
     RemoteTrampoline_1(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
                                  RTYPE_DOC(void),
-                                 ATYPE_DOC(A1))),
+                                 ATYPE_DOC(A1)),
+                    flgs),
           m_method(m)
     { }
 
@@ -400,10 +417,11 @@
     typedef R (T::*MethodType)(A1,A2);
     
     RemoteTrampoline_2(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
                                  RTYPE_DOC(R),
-                                 ATYPE_DOC(A1), ATYPE_DOC(A2))),
+                                 ATYPE_DOC(A1), ATYPE_DOC(A2)),
+                    flgs),
           m_method(m)
     { }
 
@@ -442,10 +460,11 @@
     typedef void (T::*MethodType)(A1,A2);
     
     RemoteTrampoline_2(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
                                  RTYPE_DOC(void),
-                                 ATYPE_DOC(A1), ATYPE_DOC(A2))),
+                                 ATYPE_DOC(A1), ATYPE_DOC(A2)),
+                    flgs),
           m_method(m)
     { }
 
@@ -487,10 +506,11 @@
     typedef R (T::*MethodType)(A1,A2,A3);
     
     RemoteTrampoline_3(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
                                  RTYPE_DOC(R),
-                                 ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3))),
+                                 ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3)),
+                    flgs),
           m_method(m)
     { }
 
@@ -531,10 +551,11 @@
     typedef void (T::*MethodType)(A1,A2,A3);
     
     RemoteTrampoline_3(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
                                  RTYPE_DOC(void),
-                                 ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3))),
+                                 ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3)),
+                    flgs),
           m_method(m)
     { }
 
@@ -578,11 +599,12 @@
     typedef R (T::*MethodType)(A1,A2,A3,A4);
     
     RemoteTrampoline_4(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
                                  RTYPE_DOC(R),
                                  ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3),
-                                 ATYPE_DOC(A4))),
+                                 ATYPE_DOC(A4)),
+                    flgs),
           m_method(m)
     { }
 
@@ -625,11 +647,12 @@
     typedef void (T::*MethodType)(A1,A2,A3,A4);
     
     RemoteTrampoline_4(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
                                  RTYPE_DOC(void),
                                  ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3),
-                                 ATYPE_DOC(A4))),
+                                 ATYPE_DOC(A4)),
+                    flgs),
           m_method(m)
     { }
 
@@ -675,11 +698,12 @@
     typedef R (T::*MethodType)(A1,A2,A3,A4,A5);
     
     RemoteTrampoline_5(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
                                  RTYPE_DOC(R),
                                  ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3),
-                                 ATYPE_DOC(A4), ATYPE_DOC(A5))),
+                                 ATYPE_DOC(A4), ATYPE_DOC(A5)),
+                    flgs),
           m_method(m)
     { }
 
@@ -724,11 +748,12 @@
     typedef void (T::*MethodType)(A1,A2,A3,A4,A5);
     
     RemoteTrampoline_5(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
                                  RTYPE_DOC(void),
                                  ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3),
-                                 ATYPE_DOC(A4), ATYPE_DOC(A5))),
+                                 ATYPE_DOC(A4), ATYPE_DOC(A5)),
+                    flgs),
           m_method(m)
     { }
 
@@ -776,11 +801,12 @@
     typedef R (T::*MethodType)(A1,A2,A3,A4,A5,A6);
     
     RemoteTrampoline_6(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
                                  RTYPE_DOC(R),
                                  ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3),
-                                 ATYPE_DOC(A4), ATYPE_DOC(A5), ATYPE_DOC(A6))),
+                                 ATYPE_DOC(A4), ATYPE_DOC(A5), ATYPE_DOC(A6)),
+                    flgs),
           m_method(m)
     { }
 
@@ -827,11 +853,12 @@
     typedef void (T::*MethodType)(A1,A2,A3,A4,A5,A6);
     
     RemoteTrampoline_6(const string&amp; methodname, const RemoteMethodDoc&amp; doc,
-                       MethodType m)
+                       MethodType m, const flag_t&amp; flgs= 0)
         : inherited(methodname, (doc,
                                  RTYPE_DOC(void),
                                  ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3),
-                                 ATYPE_DOC(A4), ATYPE_DOC(A5), ATYPE_DOC(A6))),
+                                 ATYPE_DOC(A4), ATYPE_DOC(A5), ATYPE_DOC(A6)),
+                    flgs),
           m_method(m)
     { }
 
@@ -888,9 +915,10 @@
     typedef R (*FunctionType)();
     
     FRemoteTrampoline_0(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
+                       FunctionType m, const flag_t&amp; flgs= 0)
         : inherited(functionname, (doc,
-                                 RTYPE_DOC(R))),
+                                 RTYPE_DOC(R)),
+                    flgs),
           m_function(m)
     { }
 
@@ -926,8 +954,8 @@
     typedef void (*FunctionType)();
     
     FRemoteTrampoline_0(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
-        : inherited(functionname, (doc, RetTypeDoc(&quot;void&quot;))),
+                       FunctionType m, const flag_t&amp; flgs= 0)
+        : inherited(functionname, (doc, RetTypeDoc(&quot;void&quot;)), flgs),
           m_function(m)
     { }
 
@@ -966,10 +994,11 @@
     typedef R (*FunctionType)(A1);
     
     FRemoteTrampoline_1(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
+                       FunctionType m, const flag_t&amp; flgs= 0)
         : inherited(functionname, (doc,
                                  RTYPE_DOC(R),
-                                 ATYPE_DOC(A1))),
+                                 ATYPE_DOC(A1)),
+                    flgs),
           m_function(m)
     { }
 
@@ -1007,10 +1036,11 @@
     typedef void (*FunctionType)(A1);
     
     FRemoteTrampoline_1(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
+                       FunctionType m, const flag_t&amp; flgs= 0)
         : inherited(functionname, (doc,
                                  RTYPE_DOC(void),
-                                 ATYPE_DOC(A1))),
+                                 ATYPE_DOC(A1)),
+                    flgs),
           m_function(m)
     { }
 
@@ -1051,10 +1081,11 @@
     typedef R (*FunctionType)(A1,A2);
     
     FRemoteTrampoline_2(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
+                       FunctionType m, const flag_t&amp; flgs= 0)
         : inherited(functionname, (doc,
                                  RTYPE_DOC(R),
-                                 ATYPE_DOC(A1), ATYPE_DOC(A2))),
+                                 ATYPE_DOC(A1), ATYPE_DOC(A2)),
+                    flgs),
           m_function(m)
     { }
 
@@ -1094,10 +1125,11 @@
     typedef void (*FunctionType)(A1,A2);
     
     FRemoteTrampoline_2(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
+                       FunctionType m, const flag_t&amp; flgs= 0)
         : inherited(functionname, (doc,
                                  RTYPE_DOC(void),
-                                 ATYPE_DOC(A1), ATYPE_DOC(A2))),
+                                 ATYPE_DOC(A1), ATYPE_DOC(A2)),
+                    flgs),
           m_function(m)
     { }
 
@@ -1140,10 +1172,11 @@
     typedef R (*FunctionType)(A1,A2,A3);
     
     FRemoteTrampoline_3(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
+                       FunctionType m, const flag_t&amp; flgs= 0)
         : inherited(functionname, (doc,
                                  RTYPE_DOC(R),
-                                 ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3))),
+                                 ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3)),
+                    flgs),
           m_function(m)
     { }
 
@@ -1185,10 +1218,11 @@
     typedef void (*FunctionType)(A1,A2,A3);
     
     FRemoteTrampoline_3(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
+                        FunctionType m, const flag_t&amp; flgs= 0)
         : inherited(functionname, (doc,
                                  RTYPE_DOC(void),
-                                 ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3))),
+                                 ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3)),
+                    flgs),
           m_function(m)
     { }
 
@@ -1233,11 +1267,12 @@
     typedef R (*FunctionType)(A1,A2,A3,A4);
     
     FRemoteTrampoline_4(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
+                       FunctionType m, const flag_t&amp; flgs= 0)
         : inherited(functionname, (doc,
                                  RTYPE_DOC(R),
                                  ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3),
-                                 ATYPE_DOC(A4))),
+                                 ATYPE_DOC(A4)),
+                    flgs),
           m_function(m)
     { }
 
@@ -1281,11 +1316,12 @@
     typedef void (*FunctionType)(A1,A2,A3,A4);
     
     FRemoteTrampoline_4(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
+                       FunctionType m, const flag_t&amp; flgs= 0)
         : inherited(functionname, (doc,
                                  RTYPE_DOC(void),
                                  ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3),
-                                 ATYPE_DOC(A4))),
+                                 ATYPE_DOC(A4)),
+                    flgs),
           m_function(m)
     { }
 
@@ -1332,11 +1368,12 @@
     typedef R (*FunctionType)(A1,A2,A3,A4,A5);
     
     FRemoteTrampoline_5(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
+                        FunctionType m, const flag_t&amp; flgs= 0)
         : inherited(functionname, (doc,
                                  RTYPE_DOC(R),
                                  ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3),
-                                 ATYPE_DOC(A4), ATYPE_DOC(A5))),
+                                 ATYPE_DOC(A4), ATYPE_DOC(A5)),
+                    flgs),
           m_function(m)
     { }
 
@@ -1382,11 +1419,12 @@
     typedef void (*FunctionType)(A1,A2,A3,A4,A5);
     
     FRemoteTrampoline_5(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
+                        FunctionType m, const flag_t&amp; flgs= 0)
         : inherited(functionname, (doc,
                                  RTYPE_DOC(void),
                                  ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3),
-                                 ATYPE_DOC(A4), ATYPE_DOC(A5))),
+                                 ATYPE_DOC(A4), ATYPE_DOC(A5)),
+                    flgs),
           m_function(m)
     { }
 
@@ -1435,11 +1473,12 @@
     typedef R (*FunctionType)(A1,A2,A3,A4,A5,A6);
     
     FRemoteTrampoline_6(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
+                        FunctionType m, const flag_t&amp; flgs= 0)
         : inherited(functionname, (doc,
                                  RTYPE_DOC(R),
                                  ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3),
-                                 ATYPE_DOC(A4), ATYPE_DOC(A5), ATYPE_DOC(A6))),
+                                 ATYPE_DOC(A4), ATYPE_DOC(A5), ATYPE_DOC(A6)),
+                    flgs),
           m_function(m)
     { }
 
@@ -1487,11 +1526,12 @@
     typedef void (*FunctionType)(A1,A2,A3,A4,A5,A6);
     
     FRemoteTrampoline_6(const string&amp; functionname, const RemoteMethodDoc&amp; doc,
-                       FunctionType m)
+                        FunctionType m, const flag_t&amp; flgs= 0)
         : inherited(functionname, (doc,
                                  RTYPE_DOC(void),
                                  ATYPE_DOC(A1), ATYPE_DOC(A2), ATYPE_DOC(A3),
-                                 ATYPE_DOC(A4), ATYPE_DOC(A5), ATYPE_DOC(A6))),
+                                 ATYPE_DOC(A4), ATYPE_DOC(A5), ATYPE_DOC(A6)),
+                    flgs),
           m_function(m)
     { }
 

Modified: trunk/plearn/python/PythonCodeSnippet.cc
===================================================================
--- trunk/plearn/python/PythonCodeSnippet.cc	2007-08-15 20:41:34 UTC (rev 7996)
+++ trunk/plearn/python/PythonCodeSnippet.cc	2007-08-15 21:54:18 UTC (rev 7997)
@@ -123,6 +123,23 @@
 }
 
 
+PythonCodeSnippet::PythonCodeSnippet(const PythonObjectWrapper&amp; instance,
+                                     bool remap_python_exceptions)
+    : inherited(),
+      m_code(&quot;&quot;),
+      m_remap_python_exceptions(remap_python_exceptions),
+      m_instance_params(),
+      m_instance(instance),
+      m_handle(this),
+      m_compiled_code(),
+      m_injected_functions(4),
+      m_python_methods(4)
+{
+    PyObject* compiled_code= 
+        PyObject_GetAttrString(m_instance.getPyObject(), &quot;__dict__&quot;);
+    m_compiled_code= PythonObjectWrapper(compiled_code, PythonObjectWrapper::transfer_ownership);
+    // NOTE: build() not called
+}
 
 void PythonCodeSnippet::declareOptions(OptionList&amp; ol)
 {
@@ -179,7 +196,8 @@
         sprintf(set_current_snippet, SetCurrentSnippetVar, m_handle);
         m_compiled_code = compileGlobalCode(InjectSetupSnippet+
                                             string(set_current_snippet)+m_code);
-        resetCurrentSnippet();
+        if(m_instance.isNull())
+            resetCurrentSnippet();
     }
 
     // Forget about injected functions
@@ -214,8 +232,13 @@
 PythonCodeSnippet::getGlobalObject(const string&amp; object_name) const
 {
     PythonGlobalInterpreterLock gil;         // For thread-safety
-    PyObject* pyobj = PyDict_GetItemString(m_compiled_code.getPyObject(),
-                                           object_name.c_str());
+    PyObject* pyobj;
+    if(!m_instance.isNull())
+        pyobj= PyObject_GetAttrString(m_instance.getPyObject(),
+                                      const_cast&lt;char*&gt;(object_name.c_str()));
+    else
+        pyobj= PyDict_GetItemString(m_compiled_code.getPyObject(),
+                                    object_name.c_str());
     if (pyobj) {
         // pyobj == borrowed reference
         // Increment refcount to keep long-lived reference
@@ -232,7 +255,11 @@
 
     // Note that PyDict_SetItemString increments the reference count for us
     int non_success = 0;
-    if (! pow.isNull())
+    if(!m_instance.isNull())
+        non_success= PyObject_SetAttrString(m_instance.getPyObject(),
+                                            const_cast&lt;char*&gt;(object_name.c_str()),
+                                            pow.getPyObject());
+    else if (! pow.isNull())
         non_success = PyDict_SetItemString(m_compiled_code.getPyObject(),
                                            object_name.c_str(),
                                            pow.getPyObject());
@@ -301,7 +328,8 @@
 
     PyObject* return_value = 0;
     if (pFunc &amp;&amp; PyCallable_Check(pFunc)) {
-        setCurrentSnippet(m_handle);
+        if(!instance_method)
+            setCurrentSnippet(m_handle);
 
         return_value = PyObject_CallObject(pFunc, NULL);
         if (! return_value)
@@ -313,7 +341,8 @@
                                + &quot;' with no params.&quot;);
         }
 
-        resetCurrentSnippet();
+        if(!instance_method)
+            resetCurrentSnippet();
     }
     else
     {
@@ -357,7 +386,8 @@
 
     PyObject* return_value = 0;
     if (pFunc &amp;&amp; PyCallable_Check(pFunc)) {
-        setCurrentSnippet(m_handle);
+        if(!instance_method)
+            setCurrentSnippet(m_handle);
 
         // Create argument tuple.  Warning: PyTuple_SetItem STEALS references.
         PyObject* pArgs = PyTuple_New(args.size());
@@ -380,7 +410,8 @@
                                + tostring(args.length())
                                + &quot; params.&quot;);
         }
-        resetCurrentSnippet();
+        if(!instance_method)
+            resetCurrentSnippet();
     }
     else
     {
@@ -678,7 +709,8 @@
         Py_XDECREF(m_compiled_code.getPyObject());
         PyErr_Print();
         PLERROR(&quot;PythonCodeSnippet::setCurrentSnippet: error compiling &quot;
-                &quot;Python code contained in the 'SetCurrentSnippetVar'.&quot;);
+                &quot;Python code contained in the 'SetCurrentSnippetVar'.&quot;
+                &quot;\n\t'%s'&quot;, set_current_snippet);
     }
 }
 

Modified: trunk/plearn/python/PythonCodeSnippet.h
===================================================================
--- trunk/plearn/python/PythonCodeSnippet.h	2007-08-15 20:41:34 UTC (rev 7996)
+++ trunk/plearn/python/PythonCodeSnippet.h	2007-08-15 21:54:18 UTC (rev 7997)
@@ -160,6 +160,9 @@
     PythonCodeSnippet(const string&amp; code = &quot;&quot;,
                       bool remap_python_exceptions = false);
 
+    PythonCodeSnippet(const PythonObjectWrapper&amp; instance,
+                      bool remap_python_exceptions = false);
+
     //! Default copy ctor, assignment op, dtor
 
 
@@ -373,44 +376,6 @@
     TVec&lt;PythonObjectWrapper&gt; args(1);
     args[0]= PythonObjectWrapper(arg1);
     return invoke(function_name, args);
-/*
-
-    PythonGlobalInterpreterLock gil;         // For thread-safety
-    PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
-                                           function_name);
-    // pFunc: Borrowed reference
-
-    PyObject* return_value = 0;
-    if (pFunc &amp;&amp; PyCallable_Check(pFunc)) {
-        setCurrentSnippet(m_handle);
-
-        // Create argument tuple.  Warning: PyTuple_SetItem STEALS references.
-        PyObject* pArgs = PyTuple_New(1);
-        PyObject* py_arg1 = PythonObjectWrapper::newPyObject(arg1);
-
-        if (! (py_arg1)) {
-            Py_XDECREF(py_arg1);
-            PLERROR(&quot;PythonCodeSnippet::invoke: error during argument conversion &quot;
-                    &quot;from C++ to Python for function '%s'&quot;, function_name);
-        }
-
-        PyTuple_SetItem(pArgs, 0, py_arg1);
-
-        return_value = PyObject_CallObject(pFunc, pArgs);
-
-        Py_XDECREF(pArgs);
-        if (! return_value)
-            handlePythonErrors();
-
-        resetCurrentSnippet();
-    }
-    else {
-        PLERROR(&quot;PythonCodeSnippet::invoke: cannot call function '%s'&quot;,
-                function_name);
-    }
-
-    return PythonObjectWrapper(return_value);
-*/
 }
 
 
@@ -424,45 +389,6 @@
     args[0]= PythonObjectWrapper(arg1);
     args[1]= PythonObjectWrapper(arg2);
     return invoke(function_name, args);
-/*
-    PythonGlobalInterpreterLock gil;         // For thread-safety
-    PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
-                                           function_name);
-    // pFunc: Borrowed reference
-
-    PyObject* return_value = 0;
-    if (pFunc &amp;&amp; PyCallable_Check(pFunc)) {
-        setCurrentSnippet(m_handle);
-
-        // Create argument tuple.  Warning: PyTuple_SetItem STEALS references.
-        PyObject* pArgs = PyTuple_New(2);
-        PyObject* py_arg1 = PythonObjectWrapper::newPyObject(arg1);
-        PyObject* py_arg2 = PythonObjectWrapper::newPyObject(arg2);
-
-        if (! (py_arg1 &amp;&amp; py_arg2)) {
-            Py_XDECREF(py_arg1);
-            Py_XDECREF(py_arg2);
-            PLERROR(&quot;PythonCodeSnippet::invoke: error during argument conversion &quot;
-                    &quot;from C++ to Python for function '%s'&quot;, function_name);
-        }
-
-        PyTuple_SetItem(pArgs, 0, py_arg1);
-        PyTuple_SetItem(pArgs, 1, py_arg2);
-
-        return_value = PyObject_CallObject(pFunc, pArgs);
-
-        Py_XDECREF(pArgs);
-        if (! return_value)
-            handlePythonErrors();
-
-        resetCurrentSnippet();
-    }
-    else
-        PLERROR(&quot;PythonCodeSnippet::invoke: cannot invoke function '%s'&quot;,
-                function_name);
-
-    return PythonObjectWrapper(return_value);
-*/
 }
 
 
@@ -478,49 +404,6 @@
     args[1]= PythonObjectWrapper(arg2);
     args[2]= PythonObjectWrapper(arg3);
     return invoke(function_name, args);
-
-/*
-    PythonGlobalInterpreterLock gil;         // For thread-safety
-    PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
-                                           function_name);
-    // pFunc: Borrowed reference
-
-    PyObject* return_value = 0;
-    if (pFunc &amp;&amp; PyCallable_Check(pFunc)) {
-        setCurrentSnippet(m_handle);
-
-        // Create argument tuple.  Warning: PyTuple_SetItem STEALS references.
-        PyObject* pArgs = PyTuple_New(3);
-        PyObject* py_arg1 = PythonObjectWrapper::newPyObject(arg1);
-        PyObject* py_arg2 = PythonObjectWrapper::newPyObject(arg2);
-        PyObject* py_arg3 = PythonObjectWrapper::newPyObject(arg3);
-
-        if (! (py_arg1 &amp;&amp; py_arg2 &amp;&amp; py_arg3)) {
-            Py_XDECREF(py_arg1);
-            Py_XDECREF(py_arg2);
-            Py_XDECREF(py_arg3);
-            PLERROR(&quot;PythonCodeSnippet::invoke: error during argument conversion &quot;
-                    &quot;from C++ to Python for function '%s'&quot;, function_name);
-        }
-
-        PyTuple_SetItem(pArgs, 0, py_arg1);
-        PyTuple_SetItem(pArgs, 1, py_arg2);
-        PyTuple_SetItem(pArgs, 2, py_arg3);
-
-        return_value = PyObject_CallObject(pFunc, pArgs);
-
-        Py_XDECREF(pArgs);
-        if (! return_value)
-            handlePythonErrors();
-
-        resetCurrentSnippet();
-    }
-    else
-        PLERROR(&quot;PythonCodeSnippet::invoke: cannot call function '%s'&quot;,
-                function_name);
-
-    return PythonObjectWrapper(return_value);
-*/
 }
 
 
@@ -538,51 +421,6 @@
     args[2]= PythonObjectWrapper(arg3);
     args[3]= PythonObjectWrapper(arg4);
     return invoke(function_name, args);
-/*
-    PythonGlobalInterpreterLock gil;         // For thread-safety
-    PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
-                                           function_name);
-    // pFunc: Borrowed reference
-
-    PyObject* return_value = 0;
-    if (pFunc &amp;&amp; PyCallable_Check(pFunc)) {
-        setCurrentSnippet(m_handle);
-
-        // Create argument tuple.  Warning: PyTuple_SetItem STEALS references.
-        PyObject* pArgs = PyTuple_New(4);
-        PyObject* py_arg1 = PythonObjectWrapper::newPyObject(arg1);
-        PyObject* py_arg2 = PythonObjectWrapper::newPyObject(arg2);
-        PyObject* py_arg3 = PythonObjectWrapper::newPyObject(arg3);
-        PyObject* py_arg4 = PythonObjectWrapper::newPyObject(arg4);
-
-        if (! (py_arg1 &amp;&amp; py_arg2 &amp;&amp; py_arg3 &amp;&amp; py_arg4)) {
-            Py_XDECREF(py_arg1);
-            Py_XDECREF(py_arg2);
-            Py_XDECREF(py_arg3);
-            Py_XDECREF(py_arg4);
-            PLERROR(&quot;PythonCodeSnippet::invoke: error during argument conversion &quot;
-                    &quot;from C++ to Python for function '%s'&quot;, function_name);
-        }
-
-        PyTuple_SetItem(pArgs, 0, py_arg1);
-        PyTuple_SetItem(pArgs, 1, py_arg2);
-        PyTuple_SetItem(pArgs, 2, py_arg3);
-        PyTuple_SetItem(pArgs, 3, py_arg4);
-
-        return_value = PyObject_CallObject(pFunc, pArgs);
-
-        Py_XDECREF(pArgs);
-        if (! return_value)
-            handlePythonErrors();
-
-        resetCurrentSnippet();
-    }
-    else
-        PLERROR(&quot;PythonCodeSnippet::invoke: cannot call function '%s'&quot;,
-                function_name);
-
-    return PythonObjectWrapper(return_value);
-*/
 }
 
 template &lt;class T, class U, class V, class W, class X&gt;
@@ -601,54 +439,6 @@
     args[3]= PythonObjectWrapper(arg4);
     args[4]= PythonObjectWrapper(arg5);
     return invoke(function_name, args);
-/*
-    PythonGlobalInterpreterLock gil;         // For thread-safety
-    PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
-                                           function_name);
-    // pFunc: Borrowed reference
-
-    PyObject* return_value = 0;
-    if (pFunc &amp;&amp; PyCallable_Check(pFunc)) {
-        setCurrentSnippet(m_handle);
-
-        // Create argument tuple.  Warning: PyTuple_SetItem STEALS references.
-        PyObject* pArgs = PyTuple_New(5);
-        PyObject* py_arg1 = PythonObjectWrapper::newPyObject(arg1);
-        PyObject* py_arg2 = PythonObjectWrapper::newPyObject(arg2);
-        PyObject* py_arg3 = PythonObjectWrapper::newPyObject(arg3);
-        PyObject* py_arg4 = PythonObjectWrapper::newPyObject(arg4);
-        PyObject* py_arg5 = PythonObjectWrapper::newPyObject(arg5);
-
-        if (! (py_arg1 &amp;&amp; py_arg2 &amp;&amp; py_arg3 &amp;&amp; py_arg4 &amp;&amp; py_arg5)) {
-            Py_XDECREF(py_arg1);
-            Py_XDECREF(py_arg2);
-            Py_XDECREF(py_arg3);
-            Py_XDECREF(py_arg4);
-            Py_XDECREF(py_arg5);
-            PLERROR(&quot;PythonCodeSnippet::invoke: error during argument conversion &quot;
-                    &quot;from C++ to Python for function '%s'&quot;, function_name);
-        }
-
-        PyTuple_SetItem(pArgs, 0, py_arg1);
-        PyTuple_SetItem(pArgs, 1, py_arg2);
-        PyTuple_SetItem(pArgs, 2, py_arg3);
-        PyTuple_SetItem(pArgs, 3, py_arg4);
-        PyTuple_SetItem(pArgs, 4, py_arg5);
-
-        return_value = PyObject_CallObject(pFunc, pArgs);
-
-        Py_XDECREF(pArgs);
-        if (! return_value)
-            handlePythonErrors();
-
-        resetCurrentSnippet();
-    }
-    else
-        PLERROR(&quot;PythonCodeSnippet::invoke: cannot call function '%s'&quot;,
-                function_name);
-
-    return PythonObjectWrapper(return_value);
-*/
 }
 
 template &lt;class T, class U, class V, class W, class X, class Y&gt;
@@ -669,58 +459,6 @@
     args[4]= PythonObjectWrapper(arg5);
     args[5]= PythonObjectWrapper(arg6);
     return invoke(function_name, args);
-/*
-    PythonGlobalInterpreterLock gil;         // For thread-safety
-    PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
-                                           function_name);
-    // pFunc: Borrowed reference
-
-    PyObject* return_value = 0;
-    if (pFunc &amp;&amp; PyCallable_Check(pFunc)) {
-        setCurrentSnippet(m_handle);
-
-        // Create argument tuple.  Warning: PyTuple_SetItem STEALS references.
-        PyObject* pArgs = PyTuple_New(6);
-        PyObject* py_arg1 = PythonObjectWrapper::newPyObject(arg1);
-        PyObject* py_arg2 = PythonObjectWrapper::newPyObject(arg2);
-        PyObject* py_arg3 = PythonObjectWrapper::newPyObject(arg3);
-        PyObject* py_arg4 = PythonObjectWrapper::newPyObject(arg4);
-        PyObject* py_arg5 = PythonObjectWrapper::newPyObject(arg5);
-        PyObject* py_arg6 = PythonObjectWrapper::newPyObject(arg6);
-
-        if (! (py_arg1 &amp;&amp; py_arg2 &amp;&amp; py_arg3 &amp;&amp; py_arg4 &amp;&amp; py_arg5 &amp;&amp;
-               py_arg6 )) {
-            Py_XDECREF(py_arg1);
-            Py_XDECREF(py_arg2);
-            Py_XDECREF(py_arg3);
-            Py_XDECREF(py_arg4);
-            Py_XDECREF(py_arg5);
-            Py_XDECREF(py_arg6);
-            PLERROR(&quot;PythonCodeSnippet::invoke: error during argument conversion &quot;
-                    &quot;from C++ to Python for function '%s'&quot;, function_name);
-        }
-
-        PyTuple_SetItem(pArgs, 0, py_arg1);
-        PyTuple_SetItem(pArgs, 1, py_arg2);
-        PyTuple_SetItem(pArgs, 2, py_arg3);
-        PyTuple_SetItem(pArgs, 3, py_arg4);
-        PyTuple_SetItem(pArgs, 4, py_arg5);
-        PyTuple_SetItem(pArgs, 5, py_arg6);
-
-        return_value = PyObject_CallObject(pFunc, pArgs);
-
-        Py_XDECREF(pArgs);
-        if (! return_value)
-            handlePythonErrors();
-
-        resetCurrentSnippet();
-    }
-    else
-        PLERROR(&quot;PythonCodeSnippet::invoke: cannot call function '%s'&quot;,
-                function_name);
-
-    return PythonObjectWrapper(return_value);
-*/
 }
 
 
@@ -744,61 +482,6 @@
     args[5]= PythonObjectWrapper(arg6);
     args[6]= PythonObjectWrapper(arg7);
     return invoke(function_name, args);
-/*
-    PythonGlobalInterpreterLock gil;         // For thread-safety
-    PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
-                                           function_name);
-    // pFunc: Borrowed reference
-
-    PyObject* return_value = 0;
-    if (pFunc &amp;&amp; PyCallable_Check(pFunc)) {
-        setCurrentSnippet(m_handle);
-
-        // Create argument tuple.  Warning: PyTuple_SetItem STEALS references.
-        PyObject* pArgs = PyTuple_New(7);
-        PyObject* py_arg1 = PythonObjectWrapper::newPyObject(arg1);
-        PyObject* py_arg2 = PythonObjectWrapper::newPyObject(arg2);
-        PyObject* py_arg3 = PythonObjectWrapper::newPyObject(arg3);
-        PyObject* py_arg4 = PythonObjectWrapper::newPyObject(arg4);
-        PyObject* py_arg5 = PythonObjectWrapper::newPyObject(arg5);
-        PyObject* py_arg6 = PythonObjectWrapper::newPyObject(arg6);
-        PyObject* py_arg7 = PythonObjectWrapper::newPyObject(arg7);
-
-        if (! (py_arg1 &amp;&amp; py_arg2 &amp;&amp; py_arg3 &amp;&amp; py_arg4 &amp;&amp; py_arg5 &amp;&amp;
-               py_arg6 &amp;&amp; py_arg7 )) {
-            Py_XDECREF(py_arg1);
-            Py_XDECREF(py_arg2);
-            Py_XDECREF(py_arg3);
-            Py_XDECREF(py_arg4);
-            Py_XDECREF(py_arg5);
-            Py_XDECREF(py_arg6);
-            Py_XDECREF(py_arg7);
-            PLERROR(&quot;PythonCodeSnippet::invoke: error during argument conversion &quot;
-                    &quot;from C++ to Python for function '%s'&quot;, function_name);
-        }
-
-        PyTuple_SetItem(pArgs, 0, py_arg1);
-        PyTuple_SetItem(pArgs, 1, py_arg2);
-        PyTuple_SetItem(pArgs, 2, py_arg3);
-        PyTuple_SetItem(pArgs, 3, py_arg4);
-        PyTuple_SetItem(pArgs, 4, py_arg5);
-        PyTuple_SetItem(pArgs, 5, py_arg6);
-        PyTuple_SetItem(pArgs, 6, py_arg7);
-
-        return_value = PyObject_CallObject(pFunc, pArgs);
-
-        Py_XDECREF(pArgs);
-        if (! return_value)
-            handlePythonErrors();
-
-        resetCurrentSnippet();
-    }
-    else
-        PLERROR(&quot;PythonCodeSnippet::invoke: cannot call function '%s'&quot;,
-                function_name);
-
-    return PythonObjectWrapper(return_value);
-*/
 }
 
 

Modified: trunk/plearn/python/PythonExtension.cc
===================================================================
--- trunk/plearn/python/PythonExtension.cc	2007-08-15 20:41:34 UTC (rev 7996)
+++ trunk/plearn/python/PythonExtension.cc	2007-08-15 21:54:18 UTC (rev 7997)
@@ -304,11 +304,17 @@
         TVec&lt;string&gt;&amp; methods_help= 
             PythonObjectWrapper::m_pypl_classes.find(classname)-&gt;second.methods_help;
 
+        set&lt;pair&lt;string, int&gt; &gt; methods_done;
         while(methods)
         {
             for(RemoteMethodMap::MethodMap::const_iterator it= methods-&gt;begin();
                 it != methods-&gt;end(); ++it)
             {
+                //skip methods already injected, or not to inject
+                if(methods_done.find(it-&gt;first) != methods_done.end()) continue;
+                methods_done.insert(it-&gt;first);
+                if(it-&gt;second-&gt;flags() &amp; RemoteTrampoline::nopython) continue;
+
                 //get the RemoteTrampoline
                 PyObject* tramp= PyCObject_FromVoidPtr(it-&gt;second, NULL);
             

Modified: trunk/plearn/python/PythonObjectWrapper.cc
===================================================================
--- trunk/plearn/python/PythonObjectWrapper.cc	2007-08-15 20:41:34 UTC (rev 7996)
+++ trunk/plearn/python/PythonObjectWrapper.cc	2007-08-15 21:54:18 UTC (rev 7997)
@@ -683,10 +683,87 @@
 
 PStream&amp; operator&gt;&gt;(PStream&amp; in, PythonObjectWrapper&amp; v)
 {
-    PLERROR(&quot;Attempting to read a PythonObjectWrapper from a stream : not supported&quot;);
+    PLERROR(&quot;operator&gt;&gt;(PStream&amp;, PythonObjectWrapper&amp;) : &quot;
+            &quot;not supported (yet).&quot;);
+/*
+    string s;
+    in &gt;&gt; s;
+    string sub= &quot;PythonObjectWrapper(ownership=&quot;;
+    if(s.substr(0,sub.length()) != sub)
+        PLERROR(&quot;in operator&gt;&gt;(PStream&amp; in, PythonObjectWrapper&amp; v) : &quot;
+                &quot;expected '%s' but got '%s'.&quot;,
+                sub.c_str(), s.c_str());
+    s= s.substr(sub.length());
+    v.m_ownership= static_cast&lt;PythonObjectWrapper::OwnershipMode&gt;(s[0]-'0');
+    s= s.substr(1);
+    sub= &quot;, object=&quot;;
+    if(s.substr(0,sub.length()) != sub)
+        PLERROR(&quot;in operator&gt;&gt;(PStream&amp; in, PythonObjectWrapper&amp; v) : &quot;
+                &quot;expected '%s' but got '%s'.&quot;,
+                sub.c_str(), s.c_str());
+    s= s.substr(sub.length());
+    PStream sin= openString(s, PStream::plearn_ascii, &quot;r&quot;);
+    string pickle;
+    sin &gt;&gt; pickle;
+
+    PyObject* pypickle= PyString_FromString(pickle.c_str());
+    PyObject* env= PyDict_New();
+    if(0 != PyDict_SetItemString(env, &quot;__builtins__&quot;, PyEval_GetBuiltins()))
+        PLERROR(&quot;in operator&gt;&gt;(PStream&amp;, PythonObjectWrapper&amp; v) : &quot;
+                &quot;cannot insert builtins in env.&quot;);
+    if(0 != PyDict_SetItemString(env, &quot;the_pickle&quot;, pypickle))
+        PLERROR(&quot;in operator&gt;&gt;(PStream&amp;, PythonObjectWrapper&amp; v) : &quot;
+                &quot;cannot insert the_pickle in env.&quot;);
+    Py_DECREF(pypickle);
+    PyObject* res= PyRun_String(&quot;\nfrom cPickle import *\nresult= loads(the_pickle)\n&quot;, 
+                                Py_file_input, env, env);
+    if(!res)
+    {
+        Py_DECREF(env);
+        if(PyErr_Occurred()) PyErr_Print();
+        PLERROR(&quot;in operator&lt;&lt;(PStream&amp;, const PythonObjectWrapper&amp; v) : &quot;
+                &quot;cannot unpickle python object '%s'.&quot;,pickle.c_str());
+    }
+    Py_DECREF(res);
+    v.m_object= 
+        PythonObjectWrapper(env).as&lt;std::map&lt;string, PyObject*&gt; &gt;()[&quot;result&quot;];
+    Py_INCREF(v.m_object);
+    Py_DECREF(env);
+*/
     return in;
 }
 
+PStream&amp; operator&lt;&lt;(PStream&amp; out, const PythonObjectWrapper&amp; v)
+{
+    PLERROR(&quot;operator&lt;&lt;(PStream&amp;, const PythonObjectWrapper&amp;) : &quot;
+            &quot;not supported (yet).&quot;);
+/*
+    PyObject* env= PyDict_New();
+    if(0 != PyDict_SetItemString(env, &quot;__builtins__&quot;, PyEval_GetBuiltins()))
+        PLERROR(&quot;in operator&lt;&lt;(PStream&amp;, const PythonObjectWrapper&amp; v) : &quot;
+                &quot;cannot insert builtins in env.&quot;);
+    if(0 != PyDict_SetItemString(env, &quot;the_obj&quot;, v.m_object))
+        PLERROR(&quot;in operator&lt;&lt;(PStream&amp;, const PythonObjectWrapper&amp; v) : &quot;
+                &quot;cannot insert the_obj in env.&quot;);
+    PyObject* res= PyRun_String(&quot;\nfrom cPickle import *\nresult= dumps(the_obj)\n&quot;, 
+                                Py_file_input, env, env);
+    if(!res)
+    {
+        Py_DECREF(env);
+        if(PyErr_Occurred()) PyErr_Print();
+        PLERROR(&quot;in operator&lt;&lt;(PStream&amp;, const PythonObjectWrapper&amp; v) : &quot;
+                &quot;cannot pickle python object.&quot;);
+    }
+    Py_DECREF(res);
+    string pickle= 
+        PythonObjectWrapper(env).as&lt;std::map&lt;string, PythonObjectWrapper&gt; &gt;()[&quot;result&quot;];
+    Py_DECREF(env);
+    string toout= string(&quot;PythonObjectWrapper(ownership=&quot;) + tostring(v.m_ownership) + &quot;, object=\&quot;&quot; + pickle + &quot;\&quot;)&quot;;
+    out &lt;&lt; toout;
+*/
+    return out; // shut up compiler
+}
+
 //! debug
 void printWrappedObjects()
 {

Modified: trunk/plearn/python/PythonObjectWrapper.h
===================================================================
--- trunk/plearn/python/PythonObjectWrapper.h	2007-08-15 20:41:34 UTC (rev 7996)
+++ trunk/plearn/python/PythonObjectWrapper.h	2007-08-15 21:54:18 UTC (rev 7997)
@@ -876,6 +876,8 @@
     PyObject* m_object;
 
     template&lt;class T&gt; friend class ConvertToPyObject;
+    friend PStream&amp; operator&gt;&gt;(PStream&amp; in, PythonObjectWrapper&amp; v);
+    friend PStream&amp; operator&lt;&lt;(PStream&amp; out, const PythonObjectWrapper&amp; v);
 };
 
 // Specialization for General T*.  Attempt to cast into Object*.  If that works
@@ -931,17 +933,8 @@
 {
     return StaticConvertEnumFromPyObject&lt;T, boost::is_enum&lt;T&gt;::value&gt;
         ::convert(x, print_traceback);
-    /*
-    if(boost::is_enum&lt;T&gt;::value)
-        return ConvertFromPyObject&lt;int&gt;::convert(x, print_traceback);
-
-    PLERROR(&quot;Cannot convert this object by value from python (type=%s).&quot;,
-            TypeTraits&lt;T&gt;::name().c_str());
-    return T();//to silence compiler
-    */
 }
 
-
 template &lt;class T&gt;
 PP&lt;T&gt; ConvertFromPyObject&lt;PP&lt;T&gt; &gt;::convert(PyObject* pyobj,
                                            bool print_traceback)
@@ -1399,7 +1392,9 @@
         return PythonObjectWrapper::newPyObject();
 }
 
+
 PStream&amp; operator&gt;&gt;(PStream&amp; in, PythonObjectWrapper&amp; v);
+PStream&amp; operator&lt;&lt;(PStream&amp; out, const PythonObjectWrapper&amp; v);
 DECLARE_TYPE_TRAITS(PythonObjectWrapper);
 
 //! for debug purposes


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001444.html">[Plearn-commits] r7996 - trunk/plearn_learners/generic
</A></li>
	<LI>Next message: <A HREF="001446.html">[Plearn-commits] r7998 - trunk/plearn_learners_experimental
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1445">[ date ]</a>
              <a href="thread.html#1445">[ thread ]</a>
              <a href="subject.html#1445">[ subject ]</a>
              <a href="author.html#1445">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/plearn-commits">More information about the Plearn-commits
mailing list</a><br>
</body></html>
