<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Plearn-commits] r9078 - trunk/plearn/var/EXPERIMENTAL
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/plearn-commits/2008-May/index.html" >
   <LINK REL="made" HREF="mailto:plearn-commits%40lists.berlios.de?Subject=Re%3A%20%5BPlearn-commits%5D%20r9078%20-%20trunk/plearn/var/EXPERIMENTAL&In-Reply-To=%3C200805302232.m4UMWbie017661%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002525.html">
   <LINK REL="Next"  HREF="002527.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Plearn-commits] r9078 - trunk/plearn/var/EXPERIMENTAL</H1>
    <B>plearner at BerliOS</B> 
    <A HREF="mailto:plearn-commits%40lists.berlios.de?Subject=Re%3A%20%5BPlearn-commits%5D%20r9078%20-%20trunk/plearn/var/EXPERIMENTAL&In-Reply-To=%3C200805302232.m4UMWbie017661%40sheep.berlios.de%3E"
       TITLE="[Plearn-commits] r9078 - trunk/plearn/var/EXPERIMENTAL">plearner at mail.berlios.de
       </A><BR>
    <I>Sat May 31 00:32:37 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="002525.html">[Plearn-commits] r9077 - in trunk/scripts: . DEPRECATED
</A></li>
        <LI>Next message: <A HREF="002527.html">[Plearn-commits] r9079 - trunk/python_modules/plearn/plotting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2526">[ date ]</a>
              <a href="thread.html#2526">[ thread ]</a>
              <a href="subject.html#2526">[ subject ]</a>
              <a href="author.html#2526">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: plearner
Date: 2008-05-31 00:32:35 +0200 (Sat, 31 May 2008)
New Revision: 9078

Added:
   trunk/plearn/var/EXPERIMENTAL/ConstrainedSourceVariable.cc
   trunk/plearn/var/EXPERIMENTAL/ConstrainedSourceVariable.h
   trunk/plearn/var/EXPERIMENTAL/Cov2CorrVariable.cc
   trunk/plearn/var/EXPERIMENTAL/Cov2CorrVariable.h
   trunk/plearn/var/EXPERIMENTAL/DiagVariable.cc
   trunk/plearn/var/EXPERIMENTAL/DiagVariable.h
   trunk/plearn/var/EXPERIMENTAL/NonDiagVariable.cc
   trunk/plearn/var/EXPERIMENTAL/NonDiagVariable.h
   trunk/plearn/var/EXPERIMENTAL/TraceVariable.cc
   trunk/plearn/var/EXPERIMENTAL/TraceVariable.h
Log:
Added a few useful vars


Added: trunk/plearn/var/EXPERIMENTAL/ConstrainedSourceVariable.cc
===================================================================
--- trunk/plearn/var/EXPERIMENTAL/ConstrainedSourceVariable.cc	2008-05-30 19:46:52 UTC (rev 9077)
+++ trunk/plearn/var/EXPERIMENTAL/ConstrainedSourceVariable.cc	2008-05-30 22:32:35 UTC (rev 9078)
@@ -0,0 +1,151 @@
+// -*- C++ -*-
+
+// ConstrainedSourceVariable.cc
+//
+// Copyright (C) 2008 Pascal Vincent
+//
+// Redistribution and use in source and binary forms, with or without
+// modification, are permitted provided that the following conditions are met:
+// 
+//  1. Redistributions of source code must retain the above copyright
+//     notice, this list of conditions and the following disclaimer.
+// 
+//  2. Redistributions in binary form must reproduce the above copyright
+//     notice, this list of conditions and the following disclaimer in the
+//     documentation and/or other materials provided with the distribution.
+// 
+//  3. The name of the authors may not be used to endorse or promote
+//     products derived from this software without specific prior written
+//     permission.
+// 
+// THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR
+// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+// OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
+// NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+// TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+// 
+// This file is part of the PLearn library. For more information on the PLearn
+// library, go to the PLearn Web site at www.plearn.org
+
+// Authors: Pascal Vincent
+
+/*! \file ConstrainedSourceVariable.cc */
+
+
+#include &quot;ConstrainedSourceVariable.h&quot;
+#include&lt;plearn/math/TMat_maths.h&gt;
+
+namespace PLearn {
+using namespace std;
+
+/** ConstrainedSourceVariable **/
+
+PLEARN_IMPLEMENT_OBJECT(
+    ConstrainedSourceVariable,
+    &quot;SourceVariable that after each update, modifies values as needed to satisfy simple constraints&quot;,
+    &quot;The currently supported constraint is rows having norm 1.\n&quot;
+    &quot;i.e. after each update rows are divided by their norm.\n&quot;);
+
+
+void ConstrainedSourceVariable::satisfyConstraints()
+{
+    switch(constraint_mode)
+    {
+    case 0:
+        for(int i=0; i&lt;matValue.length(); i++)
+            normalize(matValue(i), 2);
+        break;
+    default:
+        PLERROR(&quot;Invalid constraint_mode %d&quot;,constraint_mode);
+    }
+}
+
+
+void ConstrainedSourceVariable::declareOptions(OptionList&amp; ol)
+{
+    declareOption(
+        ol, &quot;constraint_mode&quot;, &amp;ConstrainedSourceVariable::constraint_mode, OptionBase::buildoption,
+        &quot;The constraint_mode: \n&quot;
+        &quot;0: divide each row by its L2 norm after each update&quot;);
+    inherited::declareOptions(ol);
+}
+
+
+void ConstrainedSourceVariable::build_()
+{ }
+
+void ConstrainedSourceVariable::build()
+{
+    inherited::build();
+    build_();
+}
+
+void ConstrainedSourceVariable::makeDeepCopyFromShallowCopy(CopiesMap&amp; copies)
+{
+    inherited::makeDeepCopyFromShallowCopy(copies);
+}
+
+
+//#####  update*  #############################################################
+
+bool ConstrainedSourceVariable::update(real step_size, Vec direction_vec, real coeff, real b)
+{
+    bool ret = inherited::update(step_size, direction_vec, coeff, b);
+    satisfyConstraints();
+    return ret;
+}
+
+bool ConstrainedSourceVariable::update(Vec step_sizes, Vec direction_vec, real coeff, real b)
+{
+    bool ret = inherited::update(step_sizes, direction_vec, coeff, b);
+    satisfyConstraints();
+    return ret;
+}
+
+bool ConstrainedSourceVariable::update(real step_size, bool clear)
+{
+    bool ret = inherited::update(step_size, clear);
+    satisfyConstraints();
+    return ret;
+}
+
+bool ConstrainedSourceVariable::update(Vec new_value)
+{
+    bool ret = inherited::update(new_value);
+    satisfyConstraints();
+    return ret;
+}
+
+void ConstrainedSourceVariable::updateAndClear()
+{
+    inherited::updateAndClear();
+    satisfyConstraints();
+}
+
+void ConstrainedSourceVariable::updateWithWeightDecay(real step_size, real weight_decay,
+                                                 bool L1, bool clear)
+{
+    inherited::updateWithWeightDecay(step_size, weight_decay, L1, clear);
+    satisfyConstraints();
+}
+
+
+} // end of namespace PLearn
+
+
+/*
+  Local Variables:
+  mode:c++
+  c-basic-offset:4
+  c-file-style:&quot;stroustrup&quot;
+  c-file-offsets:((innamespace . 0)(inline-open . 0))
+  indent-tabs-mode:nil
+  fill-column:79
+  End:
+*/
+// vim: filetype=cpp:expandtab:shiftwidth=4:tabstop=8:softtabstop=4:encoding=utf-8:textwidth=79 :

Added: trunk/plearn/var/EXPERIMENTAL/ConstrainedSourceVariable.h
===================================================================
--- trunk/plearn/var/EXPERIMENTAL/ConstrainedSourceVariable.h	2008-05-30 19:46:52 UTC (rev 9077)
+++ trunk/plearn/var/EXPERIMENTAL/ConstrainedSourceVariable.h	2008-05-30 22:32:35 UTC (rev 9078)
@@ -0,0 +1,141 @@
+// -*- C++ -*-
+
+// ConstrainedSourceVariable.h
+//
+// Copyright (C) 2008 Pascal Vincent
+//
+// Redistribution and use in source and binary forms, with or without
+// modification, are permitted provided that the following conditions are met:
+// 
+//  1. Redistributions of source code must retain the above copyright
+//     notice, this list of conditions and the following disclaimer.
+// 
+//  2. Redistributions in binary form must reproduce the above copyright
+//     notice, this list of conditions and the following disclaimer in the
+//     documentation and/or other materials provided with the distribution.
+// 
+//  3. The name of the authors may not be used to endorse or promote
+//     products derived from this software without specific prior written
+//     permission.
+// 
+// THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR
+// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+// OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
+// NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+// TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+// 
+// This file is part of the PLearn library. For more information on the PLearn
+// library, go to the PLearn Web site at www.plearn.org
+
+// Authors: Pascal Vincent
+
+/*! \file ConstrainedSourceVariable.h */
+
+
+#ifndef ConstrainedSourceVariable_INC
+#define ConstrainedSourceVariable_INC
+
+#include &lt;plearn/var/SourceVariable.h&gt;
+
+namespace PLearn {
+using namespace std;
+
+/**
+ * SourceVariable that after each update, modifies values as needed to satisfy simple constraints.
+ *
+ * The currently supported constraint is rows having norm 1.
+ * i.e. after each update rows are divided by their norm.
+ */
+class ConstrainedSourceVariable : public SourceVariable
+{
+    typedef SourceVariable inherited;
+
+public:
+    //#####  Public Build Options  ############################################
+
+    int constraint_mode;
+
+public:
+    //!  Default constructor for persistence
+    ConstrainedSourceVariable()
+        :SourceVariable(), 
+         constraint_mode(0)
+    {}
+
+    ConstrainedSourceVariable(int thelength, int thewidth, int the_constraint_mode=0, bool call_build_ = true)
+        :SourceVariable(thelength, thewidth, call_build_), 
+         constraint_mode(the_constraint_mode)
+    {}
+
+    ConstrainedSourceVariable(const Vec&amp; v, bool vertical=true, int the_constraint_mode=0, bool call_build_ = true)
+        :SourceVariable(v, vertical, call_build_), 
+         constraint_mode(the_constraint_mode)
+    {}
+
+    ConstrainedSourceVariable(const Mat&amp; m, int the_constraint_mode=0, bool call_build_ = true)
+        :SourceVariable(m, call_build_), 
+         constraint_mode(the_constraint_mode)
+    {}
+
+    // The method that will be called after each update to satisfy the constraints.
+    virtual void satisfyConstraints();
+
+    //#####  PLearn::Object Protocol  #########################################
+
+    // Declares other standard object methods.
+    PLEARN_DECLARE_OBJECT(ConstrainedSourceVariable);
+
+    // Simply calls inherited::build() then build_()
+    virtual void build();
+
+    //! Transforms a shallow copy into a deep copy
+    virtual void makeDeepCopyFromShallowCopy(CopiesMap&amp; copies);
+
+    
+    //#####  'Variable' Interface  ############################################
+
+
+    // All the 'update' methods are overridden to be followed by a call to satisfyConstraints(),
+    // whose purpose is to &quot;correct&quot; the values after an update so that they fulfill the constraints
+    virtual bool update(real step_size, Vec direction_vec, real coeff = 1.0, real b = 0.0);
+    virtual bool update(Vec step_sizes, Vec direction_vec, real coeff = 1.0, real b = 0.0);
+    virtual bool update(real step_size, bool clear=false);
+    virtual bool update(Vec new_value);
+    virtual void updateAndClear();
+    virtual void updateWithWeightDecay(real step_size, real weight_decay,
+                                       bool L1, bool clear=true);
+    
+    
+protected:
+    //! Declares the class options.
+    static void declareOptions(OptionList&amp; ol);
+
+private:
+    //! This does the actual building.
+    void build_();
+};
+
+
+DECLARE_OBJECT_PTR(ConstrainedSourceVariable);
+
+} // end of namespace PLearn
+
+#endif
+
+
+/*
+  Local Variables:
+  mode:c++
+  c-basic-offset:4
+  c-file-style:&quot;stroustrup&quot;
+  c-file-offsets:((innamespace . 0)(inline-open . 0))
+  indent-tabs-mode:nil
+  fill-column:79
+  End:
+*/
+// vim: filetype=cpp:expandtab:shiftwidth=4:tabstop=8:softtabstop=4:encoding=utf-8:textwidth=79 :

Added: trunk/plearn/var/EXPERIMENTAL/Cov2CorrVariable.cc
===================================================================
--- trunk/plearn/var/EXPERIMENTAL/Cov2CorrVariable.cc	2008-05-30 19:46:52 UTC (rev 9077)
+++ trunk/plearn/var/EXPERIMENTAL/Cov2CorrVariable.cc	2008-05-30 22:32:35 UTC (rev 9078)
@@ -0,0 +1,232 @@
+// -*- C++ -*-
+
+// Cov2CorrVariable.cc
+//
+// Copyright (C) 2008 Pascal Vincent
+//
+// Redistribution and use in source and binary forms, with or without
+// modification, are permitted provided that the following conditions are met:
+// 
+//  1. Redistributions of source code must retain the above copyright
+//     notice, this list of conditions and the following disclaimer.
+// 
+//  2. Redistributions in binary form must reproduce the above copyright
+//     notice, this list of conditions and the following disclaimer in the
+//     documentation and/or other materials provided with the distribution.
+// 
+//  3. The name of the authors may not be used to endorse or promote
+//     products derived from this software without specific prior written
+//     permission.
+// 
+// THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR
+// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+// OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
+// NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+// TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+// 
+// This file is part of the PLearn library. For more information on the PLearn
+// library, go to the PLearn Web site at www.plearn.org
+
+// Authors: Pascal Vincent
+
+/*! \file Cov2CorrVariable.cc */
+
+#include &quot;Cov2CorrVariable.h&quot;
+//#include &quot;Var_operators.h&quot;
+//#include &quot;Var_utils.h&quot;
+
+namespace PLearn {
+using namespace std;
+
+
+/** Cov2CorrVariable **/
+
+PLEARN_IMPLEMENT_OBJECT(
+        Cov2CorrVariable,
+        &quot;Convert a covariance matrix to a correlation matrix&quot;,
+        &quot;i.e. it divides off-diagonal term A_ij by sqrt(A_ii A_jj + epsilon).\n&quot;
+        &quot;Diagonal terms are set according to option diaognal_choice\n&quot;
+);
+
+////////////////////
+// Cov2CorrVariable //
+////////////////////
+
+Cov2CorrVariable::Cov2CorrVariable():
+    diagonal_choice(1),
+    epsilon(0.)
+{}
+
+Cov2CorrVariable::Cov2CorrVariable(Variable* input, int diagonal_choice_,
+                                   double epsilon_, bool call_build_):
+    inherited(input, input-&gt;length(), input-&gt;width(), call_build_),
+    diagonal_choice(diagonal_choice_),
+    epsilon(epsilon_)
+{
+    if (call_build_)
+        build_();
+}
+
+void Cov2CorrVariable::declareOptions(OptionList&amp; ol)
+{
+    declareOption(
+        ol, &quot;diagonal_choice&quot;, &amp;Cov2CorrVariable::diagonal_choice, OptionBase::buildoption,
+        &quot;Controls how to fill the diagonal.\n&quot;
+        &quot;  0: fill it with 0\n&quot;
+        &quot;  1: fill it with 1\n&quot;
+        &quot;  2: keep the diagonal of the input (i.e. the original variances)\n&quot;);
+    declareOption(
+        ol, &quot;epsilon&quot;, &amp;Cov2CorrVariable::epsilon, OptionBase::buildoption,
+        &quot;value to add to product of variances before taking their sqrt.\n&quot;);
+    inherited::declareOptions(ol);
+}
+
+///////////
+// build //
+///////////
+void Cov2CorrVariable::build() {
+    inherited::build();
+    build_();
+}
+
+////////////
+// build_ //
+////////////
+void Cov2CorrVariable::build_() {
+    // Nothing to do here.
+}
+
+///////////////////
+// recomputeSize //
+///////////////////
+void Cov2CorrVariable::recomputeSize(int&amp; l, int&amp; w) const
+{
+    if (input) {
+        l = input-&gt;length();
+        w = input-&gt;width();
+    } else
+        l = w = 0;
+}
+
+
+void Cov2CorrVariable::fprop()
+{
+    Mat C = input-&gt;matValue;
+    int l = C.length();
+    int w = C.width();
+    for(int i=0; i&lt;l; i++)
+        for(int j=0; j&lt;w; j++)
+        {
+            if(i!=j)
+                matValue(i,j) = C(i,j)/sqrt(C(i,i)*C(j,j)+epsilon);
+            else // diagonal element
+            {
+                double diagval = 0;
+                switch(diagonal_choice)
+                {
+                case 0:
+                    diagval = 0;
+                    break;
+                case 1:
+                    diagval = 1;
+                    break;
+                case 2:
+                    diagval = C(i,j);
+                    break;
+                default:
+                    PLERROR(&quot;Invalid diagonal_choice option&quot;);
+                }
+                matValue(i,j) = diagval;
+            }
+        }
+}
+
+/*
+  Let C the covariance matrix and D the correlation matrix.
+  D_ij = C_ij (C_ii C_jj + epsilon)^(-1/2)
+
+  dL/dC_ij = \sum_i'j' dL/dD_i'j' dD_i'j'/dC_ij
+ 
+  case i!=j:
+     dL/dC_ij = dL/dD_ij dD_ij/dC_ij
+              = dL/dD_ij (C_ii C_jj + epsilon)^(-1/2)
+              = dL/dD_ij D_ij/C_ij
+
+  case i==j
+
+    D_ik = C_ik (C_ii C_kk + epsilon)^(-1/2)
+    dD_ik/dC_ii = C_ik (-1/2) C_kk (C_ii C_kk + epsilon)^(-3/2)
+                = -1/2 C_kk D_ik / (C_ii C_kk + epsilon)
+    D_ki = C_ki (C_kk C_ii + epsilon)^(-1/2)
+    dD_ki/dC_ii = C_ki (-1/2) C_kk (C_kk C_ii + epsilon)^(-3/2)
+                = -1/2 C_kk D_ki / (C_ii C_kk + epsilon)
+
+     dL/dC_ii = \sum_{k!=i}{   dL/dD_ik dD_ik/dC_ii 
+                             + dL/dD_ki dD_ki/dC_ii }
+              = \sum_{k!=i}{   dL/dD_ik [ -1/2 C_kk D_ik/(C_ii C_kk + epsilon) ]
+                             + dL/dD_ki [ -1/2 C_kk D_ki/(C_ii C_kk + epsilon) ]
+
+*/
+
+void Cov2CorrVariable::bprop()
+{
+    Mat C = input-&gt;matValue;
+    Mat Cg = input-&gt;matGradient;
+    Mat D = matValue;
+    Mat Dg = matGradient;
+    int l = C.length();
+    int w = C.width();
+    for(int i=0; i&lt;l; i++)
+        for(int j=0; j&lt;w; j++)
+        {
+            if(i!=j)
+            {
+                Cg(i,j) += Dg(i,j)*D(i,j)/C(i,j);
+                double h = -0.5*Dg(i,j)*D(i,j)/(C(i,i)*C(j,j)+epsilon);
+                Cg(i,i) += C(j,j)*h;
+                Cg(j,j) += C(i,i)*h;
+            }
+            else if(diagonal_choice==2)
+                Cg(i,i) += Dg(i,i);
+        }
+}
+
+
+void Cov2CorrVariable::bbprop()
+{
+    PLERROR(&quot;bbprop not implemented for this variable&quot;);
+}
+
+
+void Cov2CorrVariable::symbolicBprop()
+{
+    PLERROR(&quot;symbolic bprop not yet implemented for this variable&quot;);
+}
+
+
+void Cov2CorrVariable::rfprop()
+{
+    PLERROR(&quot;rfprop no yet implemented for this vairable&quot;);
+}
+
+
+
+} // end of namespace PLearn
+
+
+/*
+  Local Variables:
+  mode:c++
+  c-basic-offset:4
+  c-file-style:&quot;stroustrup&quot;
+  c-file-offsets:((innamespace . 0)(inline-open . 0))
+  indent-tabs-mode:nil
+  fill-column:79
+  End:
+*/
+// vim: filetype=cpp:expandtab:shiftwidth=4:tabstop=8:softtabstop=4:encoding=utf-8:textwidth=79 :

Added: trunk/plearn/var/EXPERIMENTAL/Cov2CorrVariable.h
===================================================================
--- trunk/plearn/var/EXPERIMENTAL/Cov2CorrVariable.h	2008-05-30 19:46:52 UTC (rev 9077)
+++ trunk/plearn/var/EXPERIMENTAL/Cov2CorrVariable.h	2008-05-30 22:32:35 UTC (rev 9078)
@@ -0,0 +1,102 @@
+// -*- C++ -*-
+
+// Cov2CorrVariable.h
+//
+// Copyright (C) 2008 Pascal Vincent
+//
+// Redistribution and use in source and binary forms, with or without
+// modification, are permitted provided that the following conditions are met:
+// 
+//  1. Redistributions of source code must retain the above copyright
+//     notice, this list of conditions and the following disclaimer.
+// 
+//  2. Redistributions in binary form must reproduce the above copyright
+//     notice, this list of conditions and the following disclaimer in the
+//     documentation and/or other materials provided with the distribution.
+// 
+//  3. The name of the authors may not be used to endorse or promote
+//     products derived from this software without specific prior written
+//     permission.
+// 
+// THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR
+// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+// OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
+// NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+// TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+// 
+// This file is part of the PLearn library. For more information on the PLearn
+// library, go to the PLearn Web site at www.plearn.org
+
+// Authors: Pascal Vincent
+
+/*! \file Cov2CorrVariable.h */
+
+#ifndef Cov2CorrVariable_INC
+#define Cov2CorrVariable_INC
+
+#include &lt;plearn/var/UnaryVariable.h&gt;
+
+namespace PLearn {
+using namespace std;
+
+
+class Cov2CorrVariable: public UnaryVariable
+{
+    typedef UnaryVariable inherited;
+
+public:
+    int diagonal_choice;
+    double epsilon;
+
+    //! Default constructor.
+    Cov2CorrVariable();
+
+    Cov2CorrVariable(Variable* input, int diagonal_choice_=1,
+                     double epsilon_=0, bool call_build_ = true);
+
+    PLEARN_DECLARE_OBJECT(Cov2CorrVariable);
+
+    static void declareOptions(OptionList&amp; ol);
+
+    virtual void build();
+
+    virtual void recomputeSize(int&amp; l, int&amp; w) const;
+    virtual void fprop();
+    virtual void bprop();
+    //!  here don't approximate, do d2C/dx^2 = 4 x^2 d2C/dy^2 + 2 dC/dy 
+    virtual void bbprop();
+    virtual void symbolicBprop();
+    virtual void rfprop();
+
+private:
+
+    void build_();
+
+};
+
+DECLARE_OBJECT_PTR(Cov2CorrVariable);
+
+inline Var cov2corr(Var v, int diagonal_choice=1, double epsilon=0.)
+{ return new Cov2CorrVariable(v,diagonal_choice,epsilon); }
+
+} // end of namespace PLearn
+
+#endif 
+
+
+/*
+  Local Variables:
+  mode:c++
+  c-basic-offset:4
+  c-file-style:&quot;stroustrup&quot;
+  c-file-offsets:((innamespace . 0)(inline-open . 0))
+  indent-tabs-mode:nil
+  fill-column:79
+  End:
+*/
+// vim: filetype=cpp:expandtab:shiftwidth=4:tabstop=8:softtabstop=4:encoding=utf-8:textwidth=79 :

Added: trunk/plearn/var/EXPERIMENTAL/DiagVariable.cc
===================================================================
--- trunk/plearn/var/EXPERIMENTAL/DiagVariable.cc	2008-05-30 19:46:52 UTC (rev 9077)
+++ trunk/plearn/var/EXPERIMENTAL/DiagVariable.cc	2008-05-30 22:32:35 UTC (rev 9078)
@@ -0,0 +1,148 @@
+// -*- C++ -*-
+
+// DiagVariable.cc
+//
+// Copyright (C) 2008 Pascal Vincent
+//
+// Redistribution and use in source and binary forms, with or without
+// modification, are permitted provided that the following conditions are met:
+// 
+//  1. Redistributions of source code must retain the above copyright
+//     notice, this list of conditions and the following disclaimer.
+// 
+//  2. Redistributions in binary form must reproduce the above copyright
+//     notice, this list of conditions and the following disclaimer in the
+//     documentation and/or other materials provided with the distribution.
+// 
+//  3. The name of the authors may not be used to endorse or promote
+//     products derived from this software without specific prior written
+//     permission.
+// 
+// THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR
+// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+// OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
+// NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+// TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+// 
+// This file is part of the PLearn library. For more information on the PLearn
+// library, go to the PLearn Web site at www.plearn.org
+
+// Authors: Pascal Vincent
+
+/*! \file DiagVariable.cc */
+
+#include &quot;DiagVariable.h&quot;
+// #include &quot;Var_operators.h&quot;
+//#include &quot;Var_utils.h&quot;
+
+namespace PLearn {
+using namespace std;
+
+
+/** DiagVariable **/
+
+PLEARN_IMPLEMENT_OBJECT(
+        DiagVariable,
+        &quot;Extracts the diagonal from a matrix source variable as a column vector.&quot;,
+        &quot;Resulting variable is a column vector.&quot;
+);
+
+////////////////////
+// DiagVariable //
+////////////////////
+
+DiagVariable::DiagVariable()
+{}
+
+DiagVariable::DiagVariable(Variable* input, bool call_build_):
+    inherited(input, min(input-&gt;length(), input-&gt;width()), 1, call_build_)
+{
+    if (call_build_)
+        build_();
+}
+
+///////////
+// build //
+///////////
+void DiagVariable::build() {
+    inherited::build();
+    build_();
+}
+
+////////////
+// build_ //
+////////////
+void DiagVariable::build_() {
+    // Nothing to do here.
+}
+
+///////////////////
+// recomputeSize //
+///////////////////
+void DiagVariable::recomputeSize(int&amp; l, int&amp; w) const
+{
+    if (input) 
+    {
+        l = min(input-&gt;length(), input-&gt;width());
+        w = 1;
+    } 
+    else
+        l = w = 0;
+}
+
+
+void DiagVariable::fprop()
+{
+    int l = value.length();
+    Mat V = input-&gt;matValue;
+    for(int i=0; i&lt;l; i++)
+        value[i] = V(i,i);
+}
+
+void DiagVariable::bprop()
+{
+    int l = gradient.length();
+    Mat G = input-&gt;matGradient;
+    for(int i=0; i&lt;l; i++)
+        G(i,i) += gradient[i];
+}
+
+
+void DiagVariable::bbprop()
+{
+    PLERROR(&quot;bbprop not implemented for this variable&quot;);
+}
+
+
+void DiagVariable::symbolicBprop()
+{
+    PLERROR(&quot;symbolic bprop not yet implemented for this variable&quot;);
+}
+
+
+void DiagVariable::rfprop()
+{
+    PLERROR(&quot;rfprop no yet implemented for this vairable&quot;);
+}
+
+
+
+} // end of namespace PLearn
+
+
+/*
+  Local Variables:
+  mode:c++
+  c-basic-offset:4
+  c-file-style:&quot;stroustrup&quot;
+  c-file-offsets:((innamespace . 0)(inline-open . 0))
+  indent-tabs-mode:nil
+  fill-column:79
+  End:
+*/
+// vim: filetype=cpp:expandtab:shiftwidth=4:tabstop=8:softtabstop=4:encoding=utf-8:textwidth=79 :

Added: trunk/plearn/var/EXPERIMENTAL/DiagVariable.h
===================================================================
--- trunk/plearn/var/EXPERIMENTAL/DiagVariable.h	2008-05-30 19:46:52 UTC (rev 9077)
+++ trunk/plearn/var/EXPERIMENTAL/DiagVariable.h	2008-05-30 22:32:35 UTC (rev 9078)
@@ -0,0 +1,97 @@
+// -*- C++ -*-
+
+// DiagVariable.h
+//
+// Copyright (C) 2008 Pascal Vincent
+//
+// Redistribution and use in source and binary forms, with or without
+// modification, are permitted provided that the following conditions are met:
+// 
+//  1. Redistributions of source code must retain the above copyright
+//     notice, this list of conditions and the following disclaimer.
+// 
+//  2. Redistributions in binary form must reproduce the above copyright
+//     notice, this list of conditions and the following disclaimer in the
+//     documentation and/or other materials provided with the distribution.
+// 
+//  3. The name of the authors may not be used to endorse or promote
+//     products derived from this software without specific prior written
+//     permission.
+// 
+// THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR
+// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+// OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
+// NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+// TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+// 
+// This file is part of the PLearn library. For more information on the PLearn
+// library, go to the PLearn Web site at www.plearn.org
+
+// Authors: Pascal Vincent
+
+/*! \file DiagVariable.h */
+
+#ifndef DiagVariable_INC
+#define DiagVariable_INC
+
+#include &lt;plearn/var/UnaryVariable.h&gt;
+
+namespace PLearn {
+using namespace std;
+
+
+class DiagVariable: public UnaryVariable
+{
+    typedef UnaryVariable inherited;
+
+public:
+
+    //! Default constructor.
+    DiagVariable();
+
+    DiagVariable(Variable* input, bool call_build_ = true);
+
+    PLEARN_DECLARE_OBJECT(DiagVariable);
+
+    virtual void build();
+
+    virtual void recomputeSize(int&amp; l, int&amp; w) const;
+    virtual void fprop();
+    virtual void bprop();
+    //!  here don't approximate, do d2C/dx^2 = 4 x^2 d2C/dy^2 + 2 dC/dy 
+    virtual void bbprop();
+    virtual void symbolicBprop();
+    virtual void rfprop();
+
+private:
+
+    void build_();
+
+};
+
+DECLARE_OBJECT_PTR(DiagVariable);
+
+inline Var diag(Var v)
+{ return new DiagVariable(v); }
+
+} // end of namespace PLearn
+
+#endif 
+
+
+/*
+  Local Variables:
+  mode:c++
+  c-basic-offset:4
+  c-file-style:&quot;stroustrup&quot;
+  c-file-offsets:((innamespace . 0)(inline-open . 0))
+  indent-tabs-mode:nil
+  fill-column:79
+  End:
+*/
+// vim: filetype=cpp:expandtab:shiftwidth=4:tabstop=8:softtabstop=4:encoding=utf-8:textwidth=79 :

Added: trunk/plearn/var/EXPERIMENTAL/NonDiagVariable.cc
===================================================================
--- trunk/plearn/var/EXPERIMENTAL/NonDiagVariable.cc	2008-05-30 19:46:52 UTC (rev 9077)
+++ trunk/plearn/var/EXPERIMENTAL/NonDiagVariable.cc	2008-05-30 22:32:35 UTC (rev 9078)
@@ -0,0 +1,156 @@
+// -*- C++ -*-
+
+// DiagVariable.cc
+//
+// Copyright (C) 2008 Pascal Vincent
+//
+// Redistribution and use in source and binary forms, with or without
+// modification, are permitted provided that the following conditions are met:
+// 
+//  1. Redistributions of source code must retain the above copyright
+//     notice, this list of conditions and the following disclaimer.
+// 
+//  2. Redistributions in binary form must reproduce the above copyright
+//     notice, this list of conditions and the following disclaimer in the
+//     documentation and/or other materials provided with the distribution.
+// 
+//  3. The name of the authors may not be used to endorse or promote
+//     products derived from this software without specific prior written
+//     permission.
+// 
+// THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR
+// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+// OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
+// NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+// TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+// 
+// This file is part of the PLearn library. For more information on the PLearn
+// library, go to the PLearn Web site at www.plearn.org
+
+// Authors: Pascal Vincent
+
+/*! \file NonDiagVariable.cc */
+
+#include &quot;NonDiagVariable.h&quot;
+// #include &quot;Var_operators.h&quot;
+//#include &quot;Var_utils.h&quot;
+
+namespace PLearn {
+using namespace std;
+
+
+/** NonDiagVariable **/
+
+PLEARN_IMPLEMENT_OBJECT(
+        NonDiagVariable,
+        &quot;Extracts all non-diagonal elements from a matrix source variable as a column vector.&quot;,
+        &quot;Resulting variable is a column vector.&quot;
+);
+
+////////////////////
+// NonDiagVariable //
+////////////////////
+
+NonDiagVariable::NonDiagVariable()
+{}
+
+NonDiagVariable::NonDiagVariable(Variable* input, bool call_build_):
+    inherited(input, input-&gt;length()*input-&gt;width()-min(input-&gt;length(), input-&gt;width()), 1, call_build_)
+{
+    if (call_build_)
+        build_();
+}
+
+///////////
+// build //
+///////////
+void NonDiagVariable::build() {
+    inherited::build();
+    build_();
+}
+
+////////////
+// build_ //
+////////////
+void NonDiagVariable::build_() {
+    // Nothing to do here.
+}
+
+///////////////////
+// recomputeSize //
+///////////////////
+void NonDiagVariable::recomputeSize(int&amp; l, int&amp; w) const
+{
+    if (input) 
+    {
+        l = input-&gt;length()*input-&gt;width()-min(input-&gt;length(), input-&gt;width());
+        w = 1;
+    } 
+    else
+        l = w = 0;
+}
+
+
+void NonDiagVariable::fprop()
+{
+    Mat V = input-&gt;matValue;
+    int l = V.length();
+    int w = V.width();
+    int k=0;
+    for(int i=0; i&lt;l; i++)
+        for(int j=0; j&lt;w; j++)
+            if(i!=j)
+                value[k++] = V(i,j);
+}
+
+void NonDiagVariable::bprop()
+{
+    Mat G = input-&gt;matGradient;
+    int l = G.length();
+    int w = G.width();
+    int k=0;
+    for(int i=0; i&lt;l; i++)
+        for(int j=0; j&lt;w; j++)
+            if(i!=j)
+                G(i,j) += gradient[k++];
+}
+
+
+void NonDiagVariable::bbprop()
+{
+    PLERROR(&quot;bbprop not implemented for this variable&quot;);
+}
+
+
+void NonDiagVariable::symbolicBprop()
+{
+    PLERROR(&quot;symbolic bprop not yet implemented for this variable&quot;);
+}
+
+
+void NonDiagVariable::rfprop()
+{
+    PLERROR(&quot;rfprop no yet implemented for this vairable&quot;);
+}
+
+
+
+} // end of namespace PLearn
+
+
+/*
+  Local Variables:
+  mode:c++
+  c-basic-offset:4
+  c-file-style:&quot;stroustrup&quot;
+  c-file-offsets:((innamespace . 0)(inline-open . 0))
+  indent-tabs-mode:nil
+  fill-column:79
+  End:
+*/
+// vim: filetype=cpp:expandtab:shiftwidth=4:tabstop=8:softtabstop=4:encoding=utf-8:textwidth=79 :

Added: trunk/plearn/var/EXPERIMENTAL/NonDiagVariable.h
===================================================================
--- trunk/plearn/var/EXPERIMENTAL/NonDiagVariable.h	2008-05-30 19:46:52 UTC (rev 9077)
+++ trunk/plearn/var/EXPERIMENTAL/NonDiagVariable.h	2008-05-30 22:32:35 UTC (rev 9078)
@@ -0,0 +1,97 @@
+// -*- C++ -*-
+
+// NonDiagVariable.h
+//
+// Copyright (C) 2008 Pascal Vincent
+//
+// Redistribution and use in source and binary forms, with or without
+// modification, are permitted provided that the following conditions are met:
+// 
+//  1. Redistributions of source code must retain the above copyright
+//     notice, this list of conditions and the following disclaimer.
+// 
+//  2. Redistributions in binary form must reproduce the above copyright
+//     notice, this list of conditions and the following disclaimer in the
+//     documentation and/or other materials provided with the distribution.
+// 
+//  3. The name of the authors may not be used to endorse or promote
+//     products derived from this software without specific prior written
+//     permission.
+// 
+// THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR
+// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+// OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
+// NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+// TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+// 
+// This file is part of the PLearn library. For more information on the PLearn
+// library, go to the PLearn Web site at www.plearn.org
+
+// Authors: Pascal Vincent
+
+/*! \file NonDiagVariable.h */
+
+#ifndef NonDiagVariable_INC
+#define NonDiagVariable_INC
+
+#include &lt;plearn/var/UnaryVariable.h&gt;
+
+namespace PLearn {
+using namespace std;
+
+
+class NonDiagVariable: public UnaryVariable
+{
+    typedef UnaryVariable inherited;
+
+public:
+
+    //! Default constructor.
+    NonDiagVariable();
+
+    NonDiagVariable(Variable* input, bool call_build_ = true);
+
+    PLEARN_DECLARE_OBJECT(NonDiagVariable);
+
+    virtual void build();
+
+    virtual void recomputeSize(int&amp; l, int&amp; w) const;
+    virtual void fprop();
+    virtual void bprop();
+    //!  here don't approximate, do d2C/dx^2 = 4 x^2 d2C/dy^2 + 2 dC/dy 
+    virtual void bbprop();
+    virtual void symbolicBprop();
+    virtual void rfprop();
+
+private:
+
+    void build_();
+
+};
+
+DECLARE_OBJECT_PTR(NonDiagVariable);
+
+inline Var nondiag(Var v)
+{ return new NonDiagVariable(v); }
+
+} // end of namespace PLearn
+
+#endif 
+
+
+/*
+  Local Variables:
+  mode:c++
+  c-basic-offset:4
+  c-file-style:&quot;stroustrup&quot;
+  c-file-offsets:((innamespace . 0)(inline-open . 0))
+  indent-tabs-mode:nil
+  fill-column:79
+  End:
+*/
+// vim: filetype=cpp:expandtab:shiftwidth=4:tabstop=8:softtabstop=4:encoding=utf-8:textwidth=79 :

Added: trunk/plearn/var/EXPERIMENTAL/TraceVariable.cc
===================================================================
--- trunk/plearn/var/EXPERIMENTAL/TraceVariable.cc	2008-05-30 19:46:52 UTC (rev 9077)
+++ trunk/plearn/var/EXPERIMENTAL/TraceVariable.cc	2008-05-30 22:32:35 UTC (rev 9078)
@@ -0,0 +1,145 @@
+// -*- C++ -*-
+
+// TraceVariable.cc
+//
+// Copyright (C) 2008 Pascal Vincent
+//
+// Redistribution and use in source and binary forms, with or without
+// modification, are permitted provided that the following conditions are met:
+// 
+//  1. Redistributions of source code must retain the above copyright
+//     notice, this list of conditions and the following disclaimer.
+// 
+//  2. Redistributions in binary form must reproduce the above copyright
+//     notice, this list of conditions and the following disclaimer in the
+//     documentation and/or other materials provided with the distribution.
+// 
+//  3. The name of the authors may not be used to endorse or promote
+//     products derived from this software without specific prior written
+//     permission.
+// 
+// THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR
+// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+// OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
+// NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+// TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+// 
+// This file is part of the PLearn library. For more information on the PLearn
+// library, go to the PLearn Web site at www.plearn.org
+
+// Authors: Pascal Vincent
+
+/*! \file TraceVariable.cc */
+
+#include &quot;TraceVariable.h&quot;
+//#include &quot;Var_operators.h&quot;
+//#include &quot;Var_utils.h&quot;
+
+namespace PLearn {
+using namespace std;
+
+
+/** TraceVariable **/
+
+PLEARN_IMPLEMENT_OBJECT(
+        TraceVariable,
+        &quot;Computes the trace of the input variable (i.e. the sum of its diagonal).&quot;,
+        &quot;Resulting variable is a scalar (1x1 matrix)&quot;
+);
+
+////////////////////
+// TraceVariable //
+////////////////////
+
+TraceVariable::TraceVariable()
+{}
+
+TraceVariable::TraceVariable(Variable* input, bool call_build_):
+    inherited(input, 1, 1, call_build_)
+{
+    if (call_build_)
+        build_();
+}
+
+///////////
+// build //
+///////////
+void TraceVariable::build() {
+    inherited::build();
+    build_();
+}
+
+////////////
+// build_ //
+////////////
+void TraceVariable::build_() {
+    // Nothing to do here.
+}
+
+///////////////////
+// recomputeSize //
+///////////////////
+void TraceVariable::recomputeSize(int&amp; l, int&amp; w) const
+{
+    l = w = 1;
+}
+
+
+void TraceVariable::fprop()
+{
+    Mat V = input-&gt;matValue;
+    int l = min(V.length(), V.width());
+    double result = 0;
+    for(int i=0; i&lt;l; i++)
+        result += V(i,i);
+    matValue(0,0) = result;
+}
+
+void TraceVariable::bprop()
+{
+    double g = matGradient(0,0);
+    Mat G = input-&gt;gradientValue;
+    int l = min(G.length(), G.width());
+    for(int i=0; i&lt;l; i++)
+        G(i,i) += g;
+}
+
+
+void TraceVariable::bbprop()
+{
+    PLERROR(&quot;bbprop not implemented for this variable&quot;);
+}
+
+
+void TraceVariable::symbolicBprop()
+{
+    PLERROR(&quot;symbolic bprop not yet implemented for this variable&quot;);
+}
+
+
+void TraceVariable::rfprop()
+{
+    PLERROR(&quot;rfprop no yet implemented for this vairable&quot;);
+}
+
+
+
+} // end of namespace PLearn
+
+
+/*
+  Local Variables:
+  mode:c++
+  c-basic-offset:4
+  c-file-style:&quot;stroustrup&quot;
+  c-file-offsets:((innamespace . 0)(inline-open . 0))
+  indent-tabs-mode:nil
+  fill-column:79
+  End:
+*/
+// vim: filetype=cpp:expandtab:shiftwidth=4:tabstop=8:softtabstop=4:encoding=utf-8:textwidth=79 :

Added: trunk/plearn/var/EXPERIMENTAL/TraceVariable.h
===================================================================
--- trunk/plearn/var/EXPERIMENTAL/TraceVariable.h	2008-05-30 19:46:52 UTC (rev 9077)
+++ trunk/plearn/var/EXPERIMENTAL/TraceVariable.h	2008-05-30 22:32:35 UTC (rev 9078)
@@ -0,0 +1,97 @@
+// -*- C++ -*-
+
+// TraceVariable.h
+//
+// Copyright (C) 2008 Pascal Vincent
+//
+// Redistribution and use in source and binary forms, with or without
+// modification, are permitted provided that the following conditions are met:
+// 
+//  1. Redistributions of source code must retain the above copyright
+//     notice, this list of conditions and the following disclaimer.
+// 
+//  2. Redistributions in binary form must reproduce the above copyright
+//     notice, this list of conditions and the following disclaimer in the
+//     documentation and/or other materials provided with the distribution.
+// 
+//  3. The name of the authors may not be used to endorse or promote
+//     products derived from this software without specific prior written
+//     permission.
+// 
+// THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR
+// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+// OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
+// NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+// TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+// 
+// This file is part of the PLearn library. For more information on the PLearn
+// library, go to the PLearn Web site at www.plearn.org
+
+// Authors: Pascal Vincent
+
+/*! \file TraceVariable.h */
+
+#ifndef TraceVariable_INC
+#define TraceVariable_INC
+
+#include &lt;plearn/var/UnaryVariable.h&gt;
+
+namespace PLearn {
+using namespace std;
+
+
+class TraceVariable: public UnaryVariable
+{
+    typedef UnaryVariable inherited;
+
+public:
+
+    //! Default constructor.
+    TraceVariable();
+
+    TraceVariable(Variable* input, bool call_build_ = true);
+
+    PLEARN_DECLARE_OBJECT(TraceVariable);
+
+    virtual void build();
+
+    virtual void recomputeSize(int&amp; l, int&amp; w) const;
+    virtual void fprop();
+    virtual void bprop();
+    //!  here don't approximate, do d2C/dx^2 = 4 x^2 d2C/dy^2 + 2 dC/dy 
+    virtual void bbprop();
+    virtual void symbolicBprop();
+    virtual void rfprop();
+
+private:
+
+    void build_();
+
+};
+
+DECLARE_OBJECT_PTR(TraceVariable);
+
+inline Var trace(Var v)
+{ return new TraceVariable(v); }
+
+} // end of namespace PLearn
+
+#endif 
+
+
+/*
+  Local Variables:
+  mode:c++
+  c-basic-offset:4
+  c-file-style:&quot;stroustrup&quot;
+  c-file-offsets:((innamespace . 0)(inline-open . 0))
+  indent-tabs-mode:nil
+  fill-column:79
+  End:
+*/
+// vim: filetype=cpp:expandtab:shiftwidth=4:tabstop=8:softtabstop=4:encoding=utf-8:textwidth=79 :


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002525.html">[Plearn-commits] r9077 - in trunk/scripts: . DEPRECATED
</A></li>
	<LI>Next message: <A HREF="002527.html">[Plearn-commits] r9079 - trunk/python_modules/plearn/plotting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2526">[ date ]</a>
              <a href="thread.html#2526">[ thread ]</a>
              <a href="subject.html#2526">[ subject ]</a>
              <a href="author.html#2526">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/plearn-commits">More information about the Plearn-commits
mailing list</a><br>
</body></html>
