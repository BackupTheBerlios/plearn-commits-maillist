<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Plearn-commits] r7042 - in trunk: . commands	commands/PLearnCommands plearn/base plearn/db plearn/display	plearn/io plearn/ker plearn/math plearn/misc plearn/opt	plearn/python plearn/python/test plearn/python/test/.pytest	plearn/python/test/.pytest/EmbeddedPython_Instances	plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results	plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results	plearn/var plearn/vmat plearn_learners/generic	plearn_learners/hyper plearn_learners/regressors	plearn_learners/testers python_modules/plearn	python_modules/plearn/pybridge
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/plearn-commits/2007-May/index.html" >
   <LINK REL="made" HREF="mailto:plearn-commits%40lists.berlios.de?Subject=Re%3A%20%5BPlearn-commits%5D%20r7042%20-%20in%20trunk%3A%20.%20commands%0A%09commands/PLearnCommands%20plearn/base%20plearn/db%20plearn/display%0A%09plearn/io%20plearn/ker%20plearn/math%20plearn/misc%20plearn/opt%0A%09plearn/python%20plearn/python/test%20plearn/python/test/.pytest%0A%09plearn/python/test/.pytest/EmbeddedPython_Instances%0A%09plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results%0A%09plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results%0A%09plearn/var%20plearn/vmat%20plearn_learners/generic%0A%09plearn_learners/hyper%20plearn_learners/regressors%0A%09plearn_learners/testers%20python_modules/plearn%0A%09python_modules/plearn/pybridge&In-Reply-To=%3C200705092344.l49NiRuO010478%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000490.html">
   <LINK REL="Next"  HREF="000492.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Plearn-commits] r7042 - in trunk: . commands	commands/PLearnCommands plearn/base plearn/db plearn/display	plearn/io plearn/ker plearn/math plearn/misc plearn/opt	plearn/python plearn/python/test plearn/python/test/.pytest	plearn/python/test/.pytest/EmbeddedPython_Instances	plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results	plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results	plearn/var plearn/vmat plearn_learners/generic	plearn_learners/hyper plearn_learners/regressors	plearn_learners/testers python_modules/plearn	python_modules/plearn/pybridge</H1>
    <B>saintmlx at BerliOS</B> 
    <A HREF="mailto:plearn-commits%40lists.berlios.de?Subject=Re%3A%20%5BPlearn-commits%5D%20r7042%20-%20in%20trunk%3A%20.%20commands%0A%09commands/PLearnCommands%20plearn/base%20plearn/db%20plearn/display%0A%09plearn/io%20plearn/ker%20plearn/math%20plearn/misc%20plearn/opt%0A%09plearn/python%20plearn/python/test%20plearn/python/test/.pytest%0A%09plearn/python/test/.pytest/EmbeddedPython_Instances%0A%09plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results%0A%09plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results%0A%09plearn/var%20plearn/vmat%20plearn_learners/generic%0A%09plearn_learners/hyper%20plearn_learners/regressors%0A%09plearn_learners/testers%20python_modules/plearn%0A%09python_modules/plearn/pybridge&In-Reply-To=%3C200705092344.l49NiRuO010478%40sheep.berlios.de%3E"
       TITLE="[Plearn-commits] r7042 - in trunk: . commands	commands/PLearnCommands plearn/base plearn/db plearn/display	plearn/io plearn/ker plearn/math plearn/misc plearn/opt	plearn/python plearn/python/test plearn/python/test/.pytest	plearn/python/test/.pytest/EmbeddedPython_Instances	plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results	plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results	plearn/var plearn/vmat plearn_learners/generic	plearn_learners/hyper plearn_learners/regressors	plearn_learners/testers python_modules/plearn	python_modules/plearn/pybridge">saintmlx at mail.berlios.de
       </A><BR>
    <I>Thu May 10 01:44:27 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000490.html">[Plearn-commits] r7041 - trunk/plearn/math
</A></li>
        <LI>Next message: <A HREF="000492.html">[Plearn-commits] r7043 - trunk/plearn_learners/online
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#491">[ date ]</a>
              <a href="thread.html#491">[ thread ]</a>
              <a href="subject.html#491">[ subject ]</a>
              <a href="author.html#491">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: saintmlx
Date: 2007-05-10 01:44:20 +0200 (Thu, 10 May 2007)
New Revision: 7042

Added:
   trunk/plearn/python/PythonGlobalInterpreterLock.h
   trunk/plearn/python/test/.pytest/EmbeddedPython_Instances/
   trunk/plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results/
   trunk/plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results/RUN.log
   trunk/plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results/linreg.psave
   trunk/plearn/python/test/InstanceSnippetTest.cc
   trunk/plearn/python/test/InstanceSnippetTest.h
   trunk/python_modules/plearn/pybridge/
   trunk/python_modules/plearn/pybridge/__init__.py
   trunk/python_modules/plearn/pybridge/embedded_code_snippet.py
   trunk/python_modules/plearn/pybridge/test_embedded_code_snippet.py
   trunk/python_modules/plearn/pybridge/wrapped_plearn_object.py
Modified:
   trunk/commands/PLearnCommands/HTMLHelpCommand.cc
   trunk/commands/PLearnCommands/PLearnCommand.h
   trunk/commands/PLearnCommands/VMatCommand.cc
   trunk/commands/PLearnCommands/VMatDictionaryCommand.cc
   trunk/commands/PLearnCommands/plearn_main.cc
   trunk/commands/plearn_noblas_inc.h
   trunk/commands/plearn_tests_inc.h
   trunk/plearn/base/HelpSystem.cc
   trunk/plearn/base/Object.cc
   trunk/plearn/base/Object.h
   trunk/plearn/base/ObjectGraphIterator.cc
   trunk/plearn/base/Option.h
   trunk/plearn/base/OptionBase.cc
   trunk/plearn/base/OptionBase.h
   trunk/plearn/base/RemoteMethodMap.h
   trunk/plearn/base/RemoteTrampoline.h
   trunk/plearn/base/TypeFactory.cc
   trunk/plearn/base/TypeFactory.h
   trunk/plearn/base/diff.h
   trunk/plearn/db/getDataSet.cc
   trunk/plearn/display/DisplayUtils.h
   trunk/plearn/io/PyPLearnScript.h
   trunk/plearn/ker/IIDNoiseKernel.cc
   trunk/plearn/ker/KroneckerBaseKernel.cc
   trunk/plearn/math/StatsCollector.cc
   trunk/plearn/math/StatsCollector.h
   trunk/plearn/math/VecStatsCollector.h
   trunk/plearn/math/stats_utils.h
   trunk/plearn/misc/Calendar.cc
   trunk/plearn/misc/HTMLUtils.cc
   trunk/plearn/misc/PLearnService.h
   trunk/plearn/misc/RemotePLearnServer.h
   trunk/plearn/misc/viewVMat.h
   trunk/plearn/misc/vmatmain.h
   trunk/plearn/opt/Optimizer.h
   trunk/plearn/python/PythonCodeSnippet.cc
   trunk/plearn/python/PythonCodeSnippet.h
   trunk/plearn/python/PythonIncludes.h
   trunk/plearn/python/PythonObjectWrapper.cc
   trunk/plearn/python/PythonObjectWrapper.h
   trunk/plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results/RUN.log
   trunk/plearn/python/test/pytest.config
   trunk/plearn/var/Func.h
   trunk/plearn/var/GaussianProcessNLLVariable.cc
   trunk/plearn/var/VarArray.h
   trunk/plearn/var/VarMeasurer.h
   trunk/plearn/var/Variable.h
   trunk/plearn/vmat/CompressedVMatrix.cc
   trunk/plearn/vmat/DictionaryVMatrix.h
   trunk/plearn/vmat/KNNVMatrix.cc
   trunk/plearn/vmat/RepeatSplitter.cc
   trunk/plearn/vmat/VMat.h
   trunk/plearn/vmat/VMatLanguage.cc
   trunk/plearn/vmat/VMatLanguage.h
   trunk/plearn/vmat/VMat_basic_stats.cc
   trunk/plearn/vmat/VMat_computeNearestNeighbors.cc
   trunk/plearn/vmat/VMat_computeStats.cc
   trunk/plearn/vmat/VMat_linalg.cc
   trunk/plearn/vmat/VMat_operations.cc
   trunk/plearn/vmat/VMatrix.cc
   trunk/plearn/vmat/VMatrix.h
   trunk/plearn/vmat/VVMatrix.cc
   trunk/plearn_learners/generic/PLearner.cc
   trunk/plearn_learners/generic/VPLPreprocessedLearner.cc
   trunk/plearn_learners/generic/VPLPreprocessedLearner.h
   trunk/plearn_learners/hyper/HyperOptimize.cc
   trunk/plearn_learners/hyper/HyperOptimize.h
   trunk/plearn_learners/regressors/KNNRegressor.cc
   trunk/plearn_learners/regressors/PLS.cc
   trunk/plearn_learners/regressors/WPLS.cc
   trunk/plearn_learners/testers/PTester.cc
   trunk/pymake.config.model
Log:
- PythonObjectWrapper can now wrap PLearn::Object's (instances of dynamically-created classes derived from WrappedPLearnObject)
- mod. PythonCodeSnippet so that it can represent a python instance (EmbeddedCodeSnippet instance)
- added -nopython option to pymake so that some versions of plearn can be compiled w/o python (e.g. plearn_light, plearn_curses)
- added declaring_file to Object, to point to the source file that declares a given class
- re-ordered includes so that python is always first



Modified: trunk/commands/PLearnCommands/HTMLHelpCommand.cc
===================================================================
--- trunk/commands/PLearnCommands/HTMLHelpCommand.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/commands/PLearnCommands/HTMLHelpCommand.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -42,6 +42,7 @@
 
 #define PL_LOG_MODULE_NAME &quot;HTMLHelpCommand&quot;
 
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;time.h&gt;
 #include &lt;fstream&gt;
 #include &lt;set&gt;
@@ -49,7 +50,6 @@
 
 #include &lt;plearn/base/general.h&gt;
 #include &lt;plearn/base/TypeFactory.h&gt;
-#include &lt;plearn/base/Object.h&gt;
 #include &lt;plearn/base/stringutils.h&gt;
 #include &lt;plearn/io/pl_log.h&gt;
 #include &quot;PLearnCommandRegistry.h&quot;

Modified: trunk/commands/PLearnCommands/PLearnCommand.h
===================================================================
--- trunk/commands/PLearnCommands/PLearnCommand.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/commands/PLearnCommands/PLearnCommand.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -37,12 +37,10 @@
  * This file is part of the PLearn library.
  ******************************************************* */
 
-
-/*! \file PLearnLibrary/PLearnCore/Object.h */
-
 #ifndef PLearnCommand_INC
 #define PLearnCommand_INC
 
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;string&gt;
 #include &lt;vector&gt;
 

Modified: trunk/commands/PLearnCommands/VMatCommand.cc
===================================================================
--- trunk/commands/PLearnCommands/VMatCommand.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/commands/PLearnCommands/VMatCommand.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -38,9 +38,9 @@
  ******************************************************* */
 
 /*! \file VMatCommand.cc */
+#include &lt;plearn/misc/vmatmain.h&gt;
 #include &quot;VMatCommand.h&quot;
 #include &lt;plearn/db/getDataSet.h&gt;
-#include &lt;plearn/misc/vmatmain.h&gt;
 #include &lt;plearn/base/lexical_cast.h&gt;
 
 namespace PLearn {

Modified: trunk/commands/PLearnCommands/VMatDictionaryCommand.cc
===================================================================
--- trunk/commands/PLearnCommands/VMatDictionaryCommand.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/commands/PLearnCommands/VMatDictionaryCommand.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -41,6 +41,7 @@
 #include &lt;plearn/vmat/DictionaryVMatrix.h&gt;
 #include &lt;plearn/db/getDataSet.h&gt;
 #include &lt;plearn/io/load_and_save.h&gt;
+#include &lt;plearn/vmat/VMat.h&gt;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/commands/PLearnCommands/plearn_main.cc
===================================================================
--- trunk/commands/PLearnCommands/plearn_main.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/commands/PLearnCommands/plearn_main.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -54,6 +54,7 @@
 #include &lt;plearn/misc/PLearnService.h&gt;
 #endif
 #include &lt;plearn/vmat/VMat.h&gt;
+#include &lt;plearn/base/RemoteDeclareMethod.h&gt;
 
 #if USING_MPI
 #include &lt;plearn/sys/PLMPI.h&gt;

Modified: trunk/commands/plearn_noblas_inc.h
===================================================================
--- trunk/commands/plearn_noblas_inc.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/commands/plearn_noblas_inc.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -59,7 +59,9 @@
 #include &lt;plearn_learners/misc/Grapher.h&gt;
 #include &lt;plearn_learners/misc/VariableSelectionWithDirectedGradientDescent.h&gt;
 #include &lt;plearn_learners/testers/PTester.h&gt;
+#include &lt;plearn/misc/HTMLHelpGenerator.h&gt;
 
+
 /***********
  * Command *
  ***********/
@@ -79,7 +81,7 @@
 #include &lt;commands/PLearnCommands/TestDependencyCommand.h&gt;
 
 // * extra stuff from Boost to generate help *
-#include &lt;commands/PLearnCommands/HTMLHelpCommand.h&gt;
+#include &lt;commands/PLearnCommands/HTMLHelpCommand.h&gt;//&lt;! DEPRECATED (will disappear soon)
 
 //#include &lt;commands/PLearnCommands/TxtmatCommand.h&gt;
 

Modified: trunk/commands/plearn_tests_inc.h
===================================================================
--- trunk/commands/plearn_tests_inc.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/commands/plearn_tests_inc.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -75,6 +75,7 @@
 #include &lt;plearn/vmat/test/IndexedVMatrixTest.h&gt;
 #include &lt;plearn/vmat/test/RowBufferedVMatrixTest.h&gt;
 
+#include &lt;plearn/python/test/InstanceSnippetTest.h&gt;
 // Some other minimal includes to be able to run tests.
 
 /***********

Modified: trunk/plearn/base/HelpSystem.cc
===================================================================
--- trunk/plearn/base/HelpSystem.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/base/HelpSystem.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -32,6 +32,7 @@
 // This file is part of the PLearn library. For more information on the PLearn
 // library, go to the PLearn Web site at www.plearn.org
 
+#include &lt;plearn/base/Object.h&gt;
 #include &quot;HelpSystem.h&quot;
 
 #include &lt;algorithm&gt;
@@ -50,7 +51,7 @@
 #include &lt;plearn/base/RemoteMethodDoc.h&gt;
 #include &lt;plearn/base/RemoteMethodMap.h&gt;
 #include &lt;commands/PLearnCommands/PLearnCommandRegistry.h&gt;
-#include &lt;plearn/base/Object.h&gt;
+//#include &lt;plearn/base/Object.h&gt;
 
 
 namespace PLearn {
@@ -326,6 +327,7 @@
     string s= &quot;################################################################## \n&quot;;
     s+= &quot;## &quot; + classname + &quot;\n&quot;;
     s+= &quot;## &quot; + helpClassParents(classname) + '\n';
+    s+= &quot;## declared in file '&quot; + entry.declaring_file.canonical() + &quot;'\n&quot;;
     s+= &quot;################################################################## \n\n&quot;;
 
     // Display basic help
@@ -407,7 +409,9 @@
     const TypeMapEntry&amp; entry= TypeFactory::instance().getTypeMapEntry(classname);
     s+= &quot;&lt;div class=\&quot;classname\&quot;&gt;&quot; + HTMLUtils::quote(classname) + &quot;&lt;/div&gt;\n&quot;
         &quot;&lt;div class=\&quot;classdescr\&quot;&gt;&quot; 
-        + HTMLUtils::quote(entry.one_line_descr) + &quot;&lt;/div&gt;\n&quot;
+        + HTMLUtils::quote(entry.one_line_descr) 
+        + &quot; (declared in '&quot; + HTMLUtils::quote(entry.declaring_file.canonical()) 
+        + &quot;')&lt;/div&gt;\n&quot;
         &quot;&lt;div class=\&quot;classhelp\&quot;&gt;&quot; 
         + HTMLUtils::quote_format_and_highlight(entry.multi_line_help) 
         + &quot;&lt;/div&gt;\n&quot;;

Modified: trunk/plearn/base/Object.cc
===================================================================
--- trunk/plearn/base/Object.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/base/Object.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -49,7 +49,7 @@
 #include &lt;plearn/io/openFile.h&gt;
 #include &lt;plearn/io/openString.h&gt;
 #include &quot;TypeFactory.h&quot;
-
+#include &quot;RemoteDeclareMethod.h&quot;
 #include &lt;algorithm&gt;
 
 namespace PLearn {
@@ -136,6 +136,14 @@
     return classname();
 }
 
+string Object::asString() const
+{
+    string s;
+    PStream out= openString(s, PStream::plearn_ascii, &quot;w&quot;);
+    out &lt;&lt; this;
+    out.flush();
+    return removeblanks(s);
+}
 
 //#####  Option-Manipulation Functions  #######################################
 
@@ -618,6 +626,23 @@
 			instance-&gt;writeOptionVal(io, optionname);
 			io.flush();
 		}
+
+#ifdef PL_PYTHON_VERSION 
+                virtual PythonObjectWrapper call(Object* instance, 
+                                                 const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+                {
+                    checkNargs(args.size(), 1);
+                    string optionname= args[0];
+                    OptionList &amp;options= instance-&gt;getOptionList();
+                    for (OptionList::iterator it= options.begin(); 
+                         it != options.end(); ++it)
+                        if ((*it)-&gt;optionname() == optionname)
+                            return (*it)-&gt;getAsPythonObject(instance);
+                    PLERROR(&quot;in ObjectTrampolineGetOption::call (python ver.) : &quot;
+                            &quot;unknown option: '%s'&quot;, optionname.c_str());
+                    return PythonObjectWrapper();//gcc: shut up!
+                }
+#endif //def PL_PYTHON_VERSION 
 	};
 
 	struct ObjectTrampolineGetObject : public RemoteTrampoline
@@ -633,6 +658,17 @@
 			io &lt;&lt; *instance;
 			io.flush();
 		}
+
+#ifdef PL_PYTHON_VERSION 
+                virtual PythonObjectWrapper call(Object* instance, 
+                                                 const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+                {
+			checkNargs(args.size(), 0);
+                        return PythonObjectWrapper(instance,
+                                                   PythonObjectWrapper::transfer_ownership);
+                }
+#endif //def PL_PYTHON_VERSION 
+
 	};
 
 } // End of anonymous namespace.
@@ -651,6 +687,10 @@
                    RetDoc (&quot;Object option in string form, or exception if &quot;
                            &quot;the option does not exist.&quot;)));
 
+    declareMethod(rmm, &quot;asString&quot;, &amp;Object::asString,
+                  (BodyDoc(&quot;Returns a string representation of this object.&quot;),
+                   RetDoc (&quot;string representation of the object&quot;)));
+
     declareMethod(rmm, &quot;run&quot;, &amp;Object::run,
                   (BodyDoc(&quot;Run the given object, if it is runnable; &quot;
                            &quot;raise an exception if it is not.&quot;)));
@@ -692,7 +732,7 @@
 
 void Object::run()
 {
-    PLERROR(&quot;Not a runnable Object&quot;);
+    PLERROR(&quot;%s::run() : Not a runnable Object&quot;, this-&gt;classname().c_str());
 }
 
 void Object::oldread(istream&amp; in)

Modified: trunk/plearn/base/Object.h
===================================================================
--- trunk/plearn/base/Object.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/base/Object.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -47,6 +47,9 @@
 #ifndef Object_INC
 #define Object_INC
 
+// Python stuff must be included first
+#include &lt;plearn/python/PythonIncludes.h&gt;
+
 #include &lt;map&gt;
 #include &lt;string&gt;
 #include &quot;PP.h&quot;
@@ -88,7 +91,9 @@
         static  bool _isa_(const Object* o);                    \
         virtual CLASSTYPE* deepCopy(CopiesMap &amp;copies) const;   \
         static  void _static_initialize_();                     \
-        static  StaticInitializer _static_initializer_
+        static  StaticInitializer _static_initializer_;         \
+        static  const PPath&amp; declaringFile()                    \
+               { static PPath df= __FILE__; return df;}
 
 #define PLEARN_IMPLEMENT_OBJECT(CLASSTYPE, ONELINEDESCR, MULTILINEHELP)                         \
         string CLASSTYPE::_classname_()                                                         \
@@ -161,7 +166,8 @@
                                        &amp;CLASSTYPE::_getRemoteMethodMap_,                        \
                                        &amp;CLASSTYPE::_isa_,                                       \
                                        ONELINEDESCR,                                            \
-                                       MULTILINEHELP);                                          \
+                                       MULTILINEHELP,                                           \
+                                       CLASSTYPE::declaringFile());                             \
         }                                                                                       \
         StaticInitializer CLASSTYPE::_static_initializer_(&amp;CLASSTYPE::_static_initialize_)
 
@@ -174,7 +180,9 @@
         static bool _isa_(const Object* o);                     \
         virtual CLASSTYPE* deepCopy(CopiesMap &amp;copies) const;   \
         static void _static_initialize_();                      \
-        static StaticInitializer _static_initializer_           
+        static StaticInitializer _static_initializer_;          \
+        static  const PPath&amp; declaringFile()                   \
+               { static PPath df= __FILE__; return df;}
 
 #define PLEARN_IMPLEMENT_ABSTRACT_OBJECT(CLASSTYPE, ONELINEDESCR, MULTILINEHELP)                \
         string CLASSTYPE::_classname_()                                                         \
@@ -222,7 +230,8 @@
                                        &amp;CLASSTYPE::_getRemoteMethodMap_,                        \
                                        &amp;CLASSTYPE::_isa_,                                       \
                                        ONELINEDESCR,                                            \
-                                       MULTILINEHELP  );                                        \
+                                       MULTILINEHELP,                                           \
+                                       CLASSTYPE::declaringFile());                             \
         }                                                                                       \
         StaticInitializer CLASSTYPE::_static_initializer_(&amp;CLASSTYPE::_static_initialize_)
 
@@ -265,7 +274,8 @@
         static  bool _isa_(const Object* o);                                                    \
         virtual CLASSTYPE&lt; TEMPLATE_ARGS_ ## CLASSTYPE &gt;* deepCopy(CopiesMap &amp;copies) const;    \
         static  void _static_initialize_();                                                     \
-        static  StaticInitializer _static_initializer_;
+        static  StaticInitializer _static_initializer_;                                         \
+        static  const PPath&amp; declaringFile() { static PPath df= __FILE__; return df;}
 
 #define PLEARN_IMPLEMENT_TEMPLATE_OBJECT(CLASSTYPE, ONELINEDESCR, MULTILINEHELP)                \
         template &lt; TEMPLATE_DEF_ ## CLASSTYPE &gt;                                                 \
@@ -349,7 +359,8 @@
                 &amp;CLASSTYPE&lt; TEMPLATE_ARGS_ ## CLASSTYPE &gt;::_getRemoteMethodMap_,                \
                 &amp;CLASSTYPE&lt; TEMPLATE_ARGS_ ## CLASSTYPE &gt;::_isa_,                               \
                 ONELINEDESCR,                                                                   \
-                MULTILINEHELP);                                                                 \
+                MULTILINEHELP,                                                                  \
+                CLASSTYPE&lt; TEMPLATE_ARGS_ ## CLASSTYPE &gt;::declaringFile());                     \
         }                                                                                       \
         template &lt; TEMPLATE_DEF_ ## CLASSTYPE &gt;                                                 \
         StaticInitializer CLASSTYPE&lt; TEMPLATE_ARGS_ ## CLASSTYPE &gt;::                            \
@@ -623,6 +634,10 @@
      */
     virtual string info() const; 
 
+    /**
+     * Returns a string representation of the object
+     */
+    virtual string asString() const; 
 
     //#####  Options-Related Functions  #######################################
     

Modified: trunk/plearn/base/ObjectGraphIterator.cc
===================================================================
--- trunk/plearn/base/ObjectGraphIterator.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/base/ObjectGraphIterator.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -40,13 +40,14 @@
 
 /*! \file ObjectGraphIterator.cc */
 
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;algorithm&gt;
 #include &lt;assert.h&gt;
 #include &lt;deque&gt;
 #include &lt;set&gt;
 
 #include &quot;ObjectGraphIterator.h&quot;
-#include &lt;plearn/base/Object.h&gt;
+//#include &lt;plearn/base/Object.h&gt;
 #include &lt;plearn/base/OptionBase.h&gt;
 #include &lt;plearn/base/TypeFactory.h&gt;
 

Modified: trunk/plearn/base/Option.h
===================================================================
--- trunk/plearn/base/Option.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/base/Option.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -123,6 +123,20 @@
     virtual const void* getAsVoidPtr(const Object* o) const
     { return &amp;(dynamic_cast&lt;const ObjectType*&gt;(o)-&gt;*ptr); }
     
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper getAsPythonObject(Object* o) const 
+    { 
+        return PythonObjectWrapper(*(OptionType*)getAsVoidPtr(o),
+                                   PythonObjectWrapper::transfer_ownership); 
+    }
+    virtual PythonObjectWrapper getAsPythonObject(const Object* o) const 
+    { 
+        return PythonObjectWrapper(*(OptionType*)getAsVoidPtr(o),
+                                   PythonObjectWrapper::transfer_ownership); 
+
+    }
+#endif //def PL_PYTHON_VERSION 
+
     virtual string optionHolderClassName(const Object* o) const
     { return dynamic_cast&lt;const ObjectType*&gt;(o)-&gt;ObjectType::_classname_(); }
 

Modified: trunk/plearn/base/OptionBase.cc
===================================================================
--- trunk/plearn/base/OptionBase.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/base/OptionBase.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -41,8 +41,8 @@
  * This file is part of the PLearn library.
  ******************************************************* */
 
+#include &quot;Object.h&quot;
 #include &quot;OptionBase.h&quot;
-#include &quot;Object.h&quot;
 #include &lt;plearn/base/stringutils.h&gt;
 #include &lt;plearn/base/tostring.h&gt;
 

Modified: trunk/plearn/base/OptionBase.h
===================================================================
--- trunk/plearn/base/OptionBase.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/base/OptionBase.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -47,6 +47,10 @@
 #ifndef OptionBase_INC
 #define OptionBase_INC
 
+#ifdef PL_PYTHON_VERSION 
+#include &lt;plearn/python/PythonObjectWrapper.h&gt;
+#endif //def PL_PYTHON_VERSION 
+
 #include &lt;plearn/io/pl_io.h&gt;
 #include &quot;PP.h&quot;
 #include &lt;plearn/io/PStream.h&gt;        //!&lt; For PStream.
@@ -223,7 +227,13 @@
     //! type.  Should be used sparingly and only when absolutely necessary.
     virtual const void* getAsVoidPtr(const Object* o) const = 0;
 
+#ifdef PL_PYTHON_VERSION 
+    //! Return the option as a python object
+    virtual PythonObjectWrapper getAsPythonObject(Object* o) const = 0;
+    virtual PythonObjectWrapper getAsPythonObject(const Object* o) const = 0;
+#endif //def PL_PYTHON_VERSION 
 
+
     //#####  Option Information  ##############################################
 
     //! Should this option be skipped upon reading it?

Modified: trunk/plearn/base/RemoteMethodMap.h
===================================================================
--- trunk/plearn/base/RemoteMethodMap.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/base/RemoteMethodMap.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -48,6 +48,7 @@
 
 // From PLearn
 #include &quot;PP.h&quot;
+
 #include &quot;RemoteTrampoline.h&quot;
 
 namespace PLearn {

Modified: trunk/plearn/base/RemoteTrampoline.h
===================================================================
--- trunk/plearn/base/RemoteTrampoline.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/base/RemoteTrampoline.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -40,6 +40,12 @@
 #ifndef RemoteTrampoline_INC
 #define RemoteTrampoline_INC
 
+// Python includes must come first (if needed)
+#ifdef PL_PYTHON_VERSION 
+#include &lt;plearn/python/PythonObjectWrapper.h&gt;
+#endif //def PL_PYTHON_VERSION
+
+
 // From C++ stdlib
 #include &lt;string&gt;
 
@@ -125,6 +131,13 @@
      */
     virtual void call(Object* instance, int nargs, PStream&amp; io) const = 0;
 
+#ifdef PL_PYTHON_VERSION 
+    //! call from python
+    virtual PythonObjectWrapper call(Object* instance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const = 0;
+#endif //def PL_PYTHON_VERSION 
+
+
     //! Check that the number of arguments is O.K. or PLERROR
     void checkNargs(int nargs, int expected_nargs) const;
 
@@ -240,6 +253,15 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(R) r = (as&lt;T&gt;(instance)-&gt;*m_method)();
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership) ;
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -268,6 +290,15 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        (as&lt;T&gt;(instance)-&gt;*m_method)();
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -301,6 +332,16 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(R) r= (as&lt;T&gt;(instance)-&gt;*m_method)(a1);
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership);
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -331,6 +372,16 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        (as&lt;T&gt;(instance)-&gt;*m_method)(a1);
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -365,6 +416,17 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(R) r= (as&lt;T&gt;(instance)-&gt;*m_method)(a1,a2);
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership);
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -396,6 +458,17 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        (as&lt;T&gt;(instance)-&gt;*m_method)(a1,a2);
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -431,6 +504,18 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(R) r= (as&lt;T&gt;(instance)-&gt;*m_method)(a1,a2,a3);
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership);
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -463,6 +548,18 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        (as&lt;T&gt;(instance)-&gt;*m_method)(a1,a2,a3);
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -500,6 +597,19 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(A4) a4= args[3].as&lt;TRAMPOLINE_TYPE(A4)&gt;();
+        TRAMPOLINE_TYPE(R) r= (as&lt;T&gt;(instance)-&gt;*m_method)(a1,a2,a3,a4);
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership);
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -534,6 +644,19 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(A4) a4= args[3].as&lt;TRAMPOLINE_TYPE(A4)&gt;();
+        (as&lt;T&gt;(instance)-&gt;*m_method)(a1,a2,a3,a4);
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -572,6 +695,20 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(A4) a4= args[3].as&lt;TRAMPOLINE_TYPE(A4)&gt;();
+        TRAMPOLINE_TYPE(A5) a5= args[4].as&lt;TRAMPOLINE_TYPE(A5)&gt;();
+        TRAMPOLINE_TYPE(R) r= (as&lt;T&gt;(instance)-&gt;*m_method)(a1,a2,a3,a4,a5);
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership);
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -607,6 +744,20 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(A4) a4= args[3].as&lt;TRAMPOLINE_TYPE(A4)&gt;();
+        TRAMPOLINE_TYPE(A5) a5= args[4].as&lt;TRAMPOLINE_TYPE(A5)&gt;();
+        (as&lt;T&gt;(instance)-&gt;*m_method)(a1,a2,a3,a4,a5);
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -646,6 +797,21 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(A4) a4= args[3].as&lt;TRAMPOLINE_TYPE(A4)&gt;();
+        TRAMPOLINE_TYPE(A5) a5= args[4].as&lt;TRAMPOLINE_TYPE(A5)&gt;();
+        TRAMPOLINE_TYPE(A6) a6= args[5].as&lt;TRAMPOLINE_TYPE(A6)&gt;();
+        TRAMPOLINE_TYPE(R) r= (as&lt;T&gt;(instance)-&gt;*m_method)(a1,a2,a3,a4,a5,a6);
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership);
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -682,6 +848,21 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* instance, const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(A4) a4= args[3].as&lt;TRAMPOLINE_TYPE(A4)&gt;();
+        TRAMPOLINE_TYPE(A5) a5= args[4].as&lt;TRAMPOLINE_TYPE(A5)&gt;();
+        TRAMPOLINE_TYPE(A6) a6= args[5].as&lt;TRAMPOLINE_TYPE(A6)&gt;();
+        (as&lt;T&gt;(instance)-&gt;*m_method)(a1,a2,a3,a4,a5,a6);
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     MethodType m_method;
 };
@@ -720,6 +901,16 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(R) r= (*m_function)();
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership);
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
@@ -747,6 +938,16 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        (*m_function)();
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
@@ -780,6 +981,17 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(R) r= (*m_function)(a1);
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership);
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
@@ -810,6 +1022,17 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        (*m_function)(a1);
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
@@ -844,6 +1067,18 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(R) r= (*m_function)(a1,a2);
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership);
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
@@ -875,6 +1110,18 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        (*m_function)(a1,a2);
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
@@ -910,6 +1157,19 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(R) r= (*m_function)(a1,a2,a3);
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership);
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
@@ -942,6 +1202,19 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        (*m_function)(a1,a2,a3);
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
@@ -979,6 +1252,20 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(A4) a4= args[3].as&lt;TRAMPOLINE_TYPE(A4)&gt;();
+        TRAMPOLINE_TYPE(R) r= (*m_function)(a1,a2,a3,a4);
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership);
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
@@ -1013,6 +1300,20 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(A4) a4= args[3].as&lt;TRAMPOLINE_TYPE(A4)&gt;();
+        (*m_function)(a1,a2,a3,a4);
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
@@ -1051,6 +1352,21 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(A4) a4= args[3].as&lt;TRAMPOLINE_TYPE(A4)&gt;();
+        TRAMPOLINE_TYPE(A5) a5= args[4].as&lt;TRAMPOLINE_TYPE(A5)&gt;();
+        TRAMPOLINE_TYPE(R) r= (*m_function)(a1,a2,a3,a4,a5);
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership);
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
@@ -1086,6 +1402,21 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(A4) a4= args[3].as&lt;TRAMPOLINE_TYPE(A4)&gt;();
+        TRAMPOLINE_TYPE(A5) a5= args[4].as&lt;TRAMPOLINE_TYPE(A5)&gt;();
+        (*m_function)(a1,a2,a3,a4,a5);
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
@@ -1125,6 +1456,22 @@
         sendRemoteMethodResult(io, r);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(A4) a4= args[3].as&lt;TRAMPOLINE_TYPE(A4)&gt;();
+        TRAMPOLINE_TYPE(A5) a5= args[4].as&lt;TRAMPOLINE_TYPE(A5)&gt;();
+        TRAMPOLINE_TYPE(A6) a6= args[5].as&lt;TRAMPOLINE_TYPE(A6)&gt;();
+        TRAMPOLINE_TYPE(R) r= (*m_function)(a1,a2,a3,a4,a5,a6);
+        return PythonObjectWrapper(r, PythonObjectWrapper::transfer_ownership);
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
@@ -1161,34 +1508,26 @@
         sendRemoteMethodVoidResult(io);
     }
 
+#ifdef PL_PYTHON_VERSION 
+    virtual PythonObjectWrapper call(Object* nullinstance, 
+                                     const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
+    {
+        checkNargs(args.size(), expected_nargs);
+        TRAMPOLINE_TYPE(A1) a1= args[0].as&lt;TRAMPOLINE_TYPE(A1)&gt;();
+        TRAMPOLINE_TYPE(A2) a2= args[1].as&lt;TRAMPOLINE_TYPE(A2)&gt;();
+        TRAMPOLINE_TYPE(A3) a3= args[2].as&lt;TRAMPOLINE_TYPE(A3)&gt;();
+        TRAMPOLINE_TYPE(A4) a4= args[3].as&lt;TRAMPOLINE_TYPE(A4)&gt;();
+        TRAMPOLINE_TYPE(A5) a5= args[4].as&lt;TRAMPOLINE_TYPE(A5)&gt;();
+        TRAMPOLINE_TYPE(A6) a6= args[5].as&lt;TRAMPOLINE_TYPE(A6)&gt;();
+        (*m_function)(a1,a2,a3,a4,a5,a6);
+        return PythonObjectWrapper(PythonObjectWrapper::transfer_ownership);//None
+    }
+#endif //def PL_PYTHON_VERSION 
+
 protected:
     FunctionType m_function;
 };
 
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
 } // end of namespace PLearn
 
 #endif

Modified: trunk/plearn/base/TypeFactory.cc
===================================================================
--- trunk/plearn/base/TypeFactory.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/base/TypeFactory.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -49,7 +49,8 @@
                                 GET_REMOTE_METHODS get_remote_methods,
                                 ISA_METHOD isa_method,
                                 const string&amp; one_line_descr,
-                                const string&amp; multi_line_help)
+                                const string&amp; multi_line_help,
+                                const PPath&amp; declaring_file)
 {
     TypeMapEntry entry(type_name, 
                        parent_class, 
@@ -58,7 +59,8 @@
                        get_remote_methods,
                        isa_method,
                        one_line_descr,
-                       multi_line_help);
+                       multi_line_help,
+                       declaring_file);
 
     instance().registerType(entry);
 }

Modified: trunk/plearn/base/TypeFactory.h
===================================================================
--- trunk/plearn/base/TypeFactory.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/base/TypeFactory.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -41,12 +41,14 @@
 #include &lt;map&gt;
 #include &quot;OptionBase.h&quot;
 #include &quot;RemoteMethodMap.h&quot;
+#include &lt;plearn/io/PPath.h&gt;
 
 namespace PLearn {
 using std::string;
 
 // Predeclarations
 class Object;
+class RemoteMethodMap;
 
 //!  Typedef for the &quot;new instance&quot; function type, which returns a
 //!  default-initialized Object
@@ -93,6 +95,9 @@
 
     //! Detailed documentation for users
     string multi_line_help;
+
+    //! Filename where this type (class) is declared (i.e. to include)
+    PPath declaring_file;
   
     TypeMapEntry(const string&amp; the_type_name, 
                  const string&amp; the_parent_class=&quot;&quot;, 
@@ -101,7 +106,8 @@
                  GET_REMOTE_METHODS the_get_remote_methods = 0,
                  ISA_METHOD the_isa_method=0,
                  const string&amp; the_one_line_descr = &quot;&quot;,
-                 const string&amp; the_multi_line_help = &quot;&quot;)
+                 const string&amp; the_multi_line_help = &quot;&quot;,
+                 const PPath&amp; the_declaring_file= PPath(&quot;&quot;))
         : type_name(the_type_name),
           parent_class(the_parent_class),
           constructor(the_constructor), 
@@ -109,7 +115,8 @@
           get_remote_methods(the_get_remote_methods),
           isa_method(the_isa_method),
           one_line_descr(the_one_line_descr),
-          multi_line_help(the_multi_line_help)
+          multi_line_help(the_multi_line_help),
+          declaring_file(the_declaring_file)
     { }
 };
 
@@ -147,7 +154,8 @@
                               GET_REMOTE_METHODS get_remote_methods,
                               ISA_METHOD isa_method,
                               const string&amp; one_line_descr,
-                              const string&amp; multi_line_help);  
+                              const string&amp; multi_line_help,
+                              const PPath&amp; declaring_file);
 
     //! Register a type
     void registerType(const TypeMapEntry&amp; entry);

Modified: trunk/plearn/base/diff.h
===================================================================
--- trunk/plearn/base/diff.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/base/diff.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -44,6 +44,7 @@
 #ifndef diff_INC
 #define diff_INC
 
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;map&gt;
 #include &lt;string&gt;
 #include &lt;plearn/base/OptionBase.h&gt;

Modified: trunk/plearn/db/getDataSet.cc
===================================================================
--- trunk/plearn/db/getDataSet.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/db/getDataSet.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -41,6 +41,7 @@
  * This file is part of the PLearn library.
  ******************************************************* */
 
+#include &lt;plearn/base/Object.h&gt;
 #include &quot;getDataSet.h&quot;
 #include &lt;plearn/io/MatIO.h&gt;              //!&lt; For loadAsciiSingleBinaryDescriptor().
 

Modified: trunk/plearn/display/DisplayUtils.h
===================================================================
--- trunk/plearn/display/DisplayUtils.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/display/DisplayUtils.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -49,10 +49,10 @@
 #ifndef DISPLAYUTILS_INC
 #define DISPLAYUTILS_INC
 
+#include &lt;plearn_learners/generic/PLearner.h&gt;
 #include &quot;GhostScript.h&quot;
 #include &lt;plearn/math/Mat.h&gt;
 #include &quot;Gnuplot.h&quot;
-#include &lt;plearn_learners/generic/PLearner.h&gt;
 #include &lt;plearn/var/Func.h&gt;
 
 namespace PLearn {

Modified: trunk/plearn/io/PyPLearnScript.h
===================================================================
--- trunk/plearn/io/PyPLearnScript.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/io/PyPLearnScript.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -44,9 +44,9 @@
 #ifndef PyPLearnScript_INC
 #define PyPLearnScript_INC
 
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;plearn/io/PPath.h&gt;
 #include &lt;plearn/io/openString.h&gt;
-#include &lt;plearn/base/Object.h&gt;
 
 namespace PLearn {
 

Modified: trunk/plearn/ker/IIDNoiseKernel.cc
===================================================================
--- trunk/plearn/ker/IIDNoiseKernel.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/ker/IIDNoiseKernel.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -36,9 +36,9 @@
 
 /*! \file IIDNoiseKernel.cc */
 
+#include &quot;IIDNoiseKernel.h&quot;
 #include &lt;plearn/base/lexical_cast.h&gt;
 #include &lt;plearn/math/TMat_maths.h&gt;
-#include &quot;IIDNoiseKernel.h&quot;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn/ker/KroneckerBaseKernel.cc
===================================================================
--- trunk/plearn/ker/KroneckerBaseKernel.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/ker/KroneckerBaseKernel.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -36,9 +36,9 @@
 
 /*! \file KroneckerBaseKernel.cc */
 
+#include &quot;KroneckerBaseKernel.h&quot;
 #include &lt;plearn/base/lexical_cast.h&gt;
 #include &lt;plearn/math/TMat_maths.h&gt;
-#include &quot;KroneckerBaseKernel.h&quot;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn/math/StatsCollector.cc
===================================================================
--- trunk/plearn/math/StatsCollector.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/math/StatsCollector.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -42,8 +42,8 @@
  * This file is part of the PLearn library.
  ******************************************************* */
 
+#include &quot;StatsCollector.h&quot;
 #include &lt;plearn/base/stringutils.h&gt;
-#include &quot;StatsCollector.h&quot;
 #include &quot;TMat_maths.h&quot;
 #include &quot;pl_erf.h&quot;
 #include &quot;pl_math.h&quot;

Modified: trunk/plearn/math/StatsCollector.h
===================================================================
--- trunk/plearn/math/StatsCollector.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/math/StatsCollector.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -43,9 +43,9 @@
 #ifndef StatsCollector_INC
 #define StatsCollector_INC
 
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;string&gt;
 #include &lt;plearn/base/general.h&gt;
-#include &lt;plearn/base/Object.h&gt;
 #include &lt;plearn/base/RealMapping.h&gt;
 #include &quot;TMat.h&quot;
 

Modified: trunk/plearn/math/VecStatsCollector.h
===================================================================
--- trunk/plearn/math/VecStatsCollector.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/math/VecStatsCollector.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -41,11 +41,12 @@
 #ifndef VecStatsCollector_INC
 #define VecStatsCollector_INC
 
+#include &lt;plearn/base/Object.h&gt;
+
 // From C++ stdlib
 #include &lt;map&gt;
 
 // From PLearn
-#include &lt;plearn/base/Object.h&gt;
 #include &quot;StatsCollector.h&quot;
 #include &quot;ObservationWindow.h&quot;
 

Modified: trunk/plearn/math/stats_utils.h
===================================================================
--- trunk/plearn/math/stats_utils.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/math/stats_utils.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -43,8 +43,8 @@
 #ifndef stats_utils_INC
 #define stats_utils_INC
 
+#include &lt;plearn/vmat/VMat.h&gt;
 #include &quot;Mat.h&quot;
-#include &lt;plearn/vmat/VMat.h&gt;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn/misc/Calendar.cc
===================================================================
--- trunk/plearn/misc/Calendar.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/misc/Calendar.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -45,6 +45,7 @@
 #include &lt;plearn/base/PDate.h&gt;
 #include &lt;plearn/math/TMat_sort.h&gt;
 #include &lt;set&gt;
+#include &lt;plearn/base/RemoteDeclareMethod.h&gt;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn/misc/HTMLUtils.cc
===================================================================
--- trunk/plearn/misc/HTMLUtils.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/misc/HTMLUtils.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -38,6 +38,8 @@
 /*! \file HTMLUtils.cc */
 
 
+#include &lt;plearn/base/Object.h&gt;
+
 #include &quot;HTMLUtils.h&quot;
 
 #include &lt;plearn/base/stringutils.h&gt;

Modified: trunk/plearn/misc/PLearnService.h
===================================================================
--- trunk/plearn/misc/PLearnService.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/misc/PLearnService.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -45,6 +45,7 @@
 #ifndef PLearnService_INC
 #define PLearnService_INC
 
+#include &lt;plearn/misc/RemotePLearnServer.h&gt;
 #include &lt;plearn/base/PP.h&gt;
 #include &lt;plearn/io/PPath.h&gt;
 #include &lt;plearn/io/PStream.h&gt;
@@ -52,7 +53,6 @@
 #include &lt;map&gt;
 #include &lt;set&gt;
 #include &lt;string&gt;
-#include &lt;plearn/misc/RemotePLearnServer.h&gt;
 
 namespace PLearn {
 

Modified: trunk/plearn/misc/RemotePLearnServer.h
===================================================================
--- trunk/plearn/misc/RemotePLearnServer.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/misc/RemotePLearnServer.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -45,9 +45,9 @@
 #ifndef RemotePLearnServer_INC
 #define RemotePLearnServer_INC
 
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;plearn/base/PP.h&gt;
 #include &lt;plearn/io/PStream.h&gt;
-#include &lt;plearn/base/Object.h&gt;
 #include &lt;plearn/sys/Popen.h&gt;
 #include &lt;plearn/io/pl_log.h&gt;
 

Modified: trunk/plearn/misc/viewVMat.h
===================================================================
--- trunk/plearn/misc/viewVMat.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/misc/viewVMat.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -38,8 +38,8 @@
 #ifndef viewVMat_INC
 #define viewVMat_INC
 
+#include &lt;plearn/vmat/VMat.h&gt;
 #include &lt;string&gt;
-#include &lt;plearn/vmat/VMat.h&gt;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn/misc/vmatmain.h
===================================================================
--- trunk/plearn/misc/vmatmain.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/misc/vmatmain.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -35,6 +35,7 @@
  * $Id$
  ******************************************************* */
 
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;plearn/base/Array.h&gt;
 #include &lt;plearn/vmat/VMat.h&gt;
 

Modified: trunk/plearn/opt/Optimizer.h
===================================================================
--- trunk/plearn/opt/Optimizer.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/opt/Optimizer.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -40,15 +40,13 @@
  * This file is part of the PLearn library.
  ******************************************************* */
 
-/*! \file PLearnLibrary/PLearnCore/Optimizer.h */
-
 #ifndef OPTIMIZER_INC
 #define OPTIMIZER_INC
 
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;plearn/var/Func.h&gt;
 #include &lt;plearn/math/Mat.h&gt;
 #include &lt;plearn/measure/Measurer.h&gt;
-#include &lt;plearn/base/Object.h&gt;
 #include &lt;plearn/math/VecStatsCollector.h&gt;
 #include &lt;plearn/vmat/VMat.h&gt;
 

Modified: trunk/plearn/python/PythonCodeSnippet.cc
===================================================================
--- trunk/plearn/python/PythonCodeSnippet.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/python/PythonCodeSnippet.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -46,6 +46,7 @@
 
 // From PLearn
 #include &lt;plearn/io/fileutils.h&gt;
+#include &lt;plearn/base/tostring.h&gt;
 
 
 namespace PLearn {
@@ -106,6 +107,8 @@
     : inherited(),
       m_code(code),
       m_remap_python_exceptions(remap_python_exceptions),
+      m_instance_params(),
+      m_instance(),
       m_handle(long(this)),
       m_compiled_code(),
       m_injected_functions(4),
@@ -137,7 +140,13 @@
         &quot;If true, Python exceptions raised during function execution are mapped\n&quot;
         &quot;to a C++ exception.  If false, then a normal Python stack dump is\n&quot;
         &quot;output to stderr and a PLERROR is raised.  Default=false.&quot;);
-    
+
+    declareOption(
+        ol, &quot;instance_params&quot;, &amp;PythonCodeSnippet::m_instance_params,
+        OptionBase::buildoption,
+        &quot;If this snippet represents a python object, these are the\n&quot;
+        &quot;parameters passed to the object's constructor.&quot;);
+
     // Now call the parent class' declareOptions
     inherited::declareOptions(ol);
 }
@@ -238,11 +247,24 @@
 bool PythonCodeSnippet::isInvokable(const char* function_name) const
 {
     PythonGlobalInterpreterLock gil;         // For thread-safety
-    PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
-                                           function_name);
-    // pFunc: Borrowed reference
 
-    return pFunc &amp;&amp; PyCallable_Check(pFunc);
+    PyObject* pFunc= 0;
+    bool instance_method= false;
+    char* fn= new char[strlen(function_name)+1];
+    strcpy(fn, function_name);
+    if(!m_instance.isNull())
+        pFunc= PyObject_GetAttrString(m_instance.getPyObject(),
+                                      fn);
+    delete[] fn;
+    if(pFunc) 
+        instance_method= true;
+    else
+        pFunc= PyDict_GetItemString(m_compiled_code.getPyObject(),
+                                    function_name);
+    // pFunc: Borrowed reference if not instance_method
+    bool ret= pFunc &amp;&amp; PyCallable_Check(pFunc);
+    if(instance_method) Py_DECREF(pFunc);
+    return ret;
 }
 
 
@@ -251,24 +273,43 @@
 PythonCodeSnippet::invoke(const char* function_name) const
 {
     PythonGlobalInterpreterLock gil;         // For thread-safety
-    PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
-                                           function_name);
-    // pFunc: Borrowed reference
 
+    PyObject* pFunc= 0;
+    bool instance_method= false;
+    char* fn= new char[strlen(function_name)+1];
+    strcpy(fn, function_name);
+    if(!m_instance.isNull())
+        pFunc= PyObject_GetAttrString(m_instance.getPyObject(),
+                                      fn);
+    delete[] fn;
+    if(pFunc) 
+        instance_method= true;
+    else
+        pFunc= PyDict_GetItemString(m_compiled_code.getPyObject(),
+                                    function_name);
+
+    // pFunc: Borrowed reference if not instance_method
+
     PyObject* return_value = 0;
     if (pFunc &amp;&amp; PyCallable_Check(pFunc)) {
         setCurrentSnippet(m_handle);
 
         return_value = PyObject_CallObject(pFunc, NULL);
         if (! return_value)
-            handlePythonErrors();
+            handlePythonErrors(string(&quot;Error while calling function '&quot;)
+                               + function_name
+                               + &quot;' with no params.&quot;);
 
         resetCurrentSnippet();
     }
     else
-        PLERROR(&quot;PythonCodeSnippet::invoke: cannot call function '%s'&quot;,
+    {
+        if(instance_method) Py_DECREF(pFunc);
+        PLERROR(&quot;PythonCodeSnippet::invoke: cannot call function '%s' (not callable).&quot;,
                 function_name);
+    }
 
+    if(instance_method) Py_DECREF(pFunc);
     return PythonObjectWrapper(return_value);
 }
 
@@ -279,30 +320,54 @@
                           const TVec&lt;PythonObjectWrapper&gt;&amp; args) const
 {
     PythonGlobalInterpreterLock gil;         // For thread-safety
-    PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
-                                           function_name);
-    // pFunc: Borrowed reference
 
+    PyObject* pFunc= 0;
+    bool instance_method= false;
+    char* fn= new char[strlen(function_name)+1];
+    strcpy(fn, function_name);
+    if(!m_instance.isNull())
+        pFunc= PyObject_GetAttrString(m_instance.getPyObject(),
+                                      fn);
+    delete[] fn;
+    if(pFunc) 
+        instance_method= true;
+    else
+        pFunc= PyDict_GetItemString(m_compiled_code.getPyObject(),
+                                    function_name);
+
+    // pFunc: Borrowed reference if not instance_method
+
     PyObject* return_value = 0;
     if (pFunc &amp;&amp; PyCallable_Check(pFunc)) {        
         setCurrentSnippet(m_handle);
-
+        
         // Create argument tuple.  Warning: PyTuple_SetItem STEALS references.
         PyObject* pArgs = PyTuple_New(args.size());
         for (int i=0, n=args.size() ; i&lt;n ; ++i)
+        {
             PyTuple_SetItem(pArgs, i, args[i].getPyObject());
+            Py_INCREF(args[i].getPyObject());
+        }
         
         return_value = PyObject_CallObject(pFunc, pArgs);
-        Py_XDECREF(pArgs);
+        Py_DECREF(pArgs);
         if (! return_value)
-            handlePythonErrors();
+            handlePythonErrors(string(&quot;Error while calling function '&quot;)
+                               + function_name
+                               + &quot;' with &quot; 
+                               + tostring(args.length())
+                               + &quot; params.&quot;);
 
         resetCurrentSnippet();        
     }
     else
+    {
+        if(instance_method) Py_DECREF(pFunc);
         PLERROR(&quot;PythonCodeSnippet::invoke: cannot call function '%s'&quot;,
                 function_name);
+    }
 
+    if(instance_method) Py_DECREF(pFunc);
     return PythonObjectWrapper(return_value);
 }
 
@@ -382,12 +447,22 @@
         // PythonObjectWrapper is constructed from a PyObject, it steals the
         // refcount, so we don't need to perform a Py_XDECREF on py_funcobj.
         this-&gt;setGlobalObject(python_name, py_funcobj);
-
-        // Publish the injection in the '__injected__' dictionary for imported modules
-        PythonObjectWrapper inj_dict = this-&gt;getGlobalObject(&quot;__injected__&quot;);
-        PyDict_SetItemString(inj_dict.getPyObject(), python_name, py_funcobj);
-        
-        Py_XDECREF(self);
+        if(!m_instance.isNull())
+        {
+            char* fn= new char[strlen(python_name)+1];
+            strcpy(fn, python_name);
+            PyObject_SetAttrString(m_instance.getPyObject(), 
+                                   fn, py_funcobj);
+            delete[] fn;
+        }
+        else
+        {
+            // Publish the injection in the '__injected__' dictionary for imported modules
+            PythonObjectWrapper inj_dict = this-&gt;getGlobalObject(&quot;__injected__&quot;);
+            PyDict_SetItemString(inj_dict.getPyObject(), python_name, py_funcobj);
+            
+            Py_XDECREF(self);
+        }
     }
     else
         PLERROR(&quot;PythonCodeSnippet::injectInternal: failed to inject &quot;
@@ -407,13 +482,17 @@
 
 //#####  Miscellaneous Functions  #############################################
 
-PythonObjectWrapper PythonCodeSnippet::compileGlobalCode(const string&amp; code) const
+PythonObjectWrapper PythonCodeSnippet::compileGlobalCode(const string&amp; code) //const
 {
     PythonGlobalInterpreterLock gil;         // For thread-safety
 
     PyObject* globals = PyDict_New();
     PyDict_SetItemString(globals, &quot;__builtins__&quot;, PyEval_GetBuiltins());
 
+    //always include EmbeddedCodeSnippet to check for an object to instantiate
+    string extracode= &quot;\nfrom plearn.pybridge.embedded_code_snippet &quot;
+        &quot;import EmbeddedCodeSnippet\n&quot;;
+
     if (code != &quot;&quot;) {
 #ifdef WIN32
         // Under Windows, it appears the Python code will not execute with
@@ -424,18 +503,122 @@
 #else
         const string&amp; code_copy = code;
 #endif
-        PyRun_String(code_copy.c_str(), Py_file_input /* exec code block */,
+        PyRun_String((code_copy+extracode).c_str(),
+                     Py_file_input /* exec code block */,
                      globals, globals);
         if (PyErr_Occurred()) {
             Py_XDECREF(globals);
             PyErr_Print();
-            PLERROR(&quot;PythonCodeSnippet::resetInternalState: error compiling &quot;
+            PLERROR(&quot;in PythonCodeSnippet::compileGlobalCode : error compiling &quot;
                     &quot;Python code contained in the 'code' option.&quot;);
         }
     }
-    return PythonObjectWrapper(globals);
+
+    //try to find an EmbeddedCodeSnippet to instantiate
+    PythonObjectWrapper wrapped_globals(globals);
+    Py_XDECREF(globals);
+    map&lt;string, PyObject*&gt; global_map= 
+        wrapped_globals.as&lt;map&lt;string, PyObject*&gt; &gt;();
+
+    PyObject* snippet_found= 0;
+    map&lt;string, PyObject*&gt;::iterator it_id= 
+        global_map.find(&quot;pl_embedded_code_snippet_type&quot;);
+
+    if(it_id != global_map.end())
+        snippet_found= it_id-&gt;second;
+    else //check for a single class deriving from EmbeddedCodeSnippet
+    {
+        list&lt;pair&lt;string, PyObject*&gt; &gt; classes_found;
+
+        //iter (find)
+        PyTypeObject* embedded_code_snippet_type= 
+            (PyTypeObject*)global_map[&quot;EmbeddedCodeSnippet&quot;];
+
+        //find all classes deriving from EmbeddedCodeSnippet
+        for(map&lt;string, PyObject*&gt;::iterator it= global_map.begin();
+            it != global_map.end(); ++it)
+        {
+            if(PyType_Check(it-&gt;second)
+               &amp;&amp; 0 != PyObject_Compare(it-&gt;second, 
+                                        (PyObject*)embedded_code_snippet_type)
+               &amp;&amp; PyType_IsSubtype((PyTypeObject*)it-&gt;second, 
+                                   embedded_code_snippet_type))
+            {
+                classes_found.push_back(*it);
+            }
+        }
+
+        int nclasses= classes_found.size();
+        list&lt;pair&lt;string, PyObject*&gt; &gt;::iterator jt= classes_found.begin();
+        if(nclasses &gt; 1)
+        {
+            string classes_list= jt-&gt;first;
+            for(++jt; jt != classes_found.end(); ++jt)
+                classes_list+= string(&quot;, &quot;) + jt-&gt;first;
+            PLERROR(&quot;in PythonCodeSnippet::compileGlobalCode : &quot;
+                    &quot;more than one class derives from EmbeddedCodeSnippet &quot;
+                    &quot;and pl_embedded_code_snippet_type is not defined. &quot;
+                    &quot;classes= [%s]&quot;,
+                    classes_list.c_str());
+        }
+        if(nclasses == 1)
+            snippet_found= jt-&gt;second;
+    }
+    
+    if(snippet_found)
+    {//instantiate object of appropriate type
+        PyObject* pyparams= PyDict_New();
+        if(!pyparams)
+            handlePythonErrors();
+        for(map&lt;string, string&gt;::const_iterator it= m_instance_params.begin();
+            it != m_instance_params.end(); ++it)
+        {// fill kwargs
+            PyObject* val= PyString_FromString(it-&gt;second.c_str());
+            PyDict_SetItemString(pyparams, it-&gt;first.c_str(), val);
+            Py_DECREF(val);
+        }
+
+        if(!PyCallable_Check(snippet_found))
+            PLERROR(&quot;in PythonCodeSnippet::compileGlobalCode : &quot;
+                    &quot;found something that is not callable [not a class?]&quot;);
+
+        PyObject* pargs= PyTuple_New(0);
+        PyObject* the_obj= PyObject_Call(snippet_found, pargs, pyparams);
+        Py_DECREF(pyparams);
+        Py_DECREF(pargs);
+        if(!the_obj)
+        {
+            if (PyErr_Occurred())
+                PyErr_Print();
+            PLERROR(&quot;in PythonCodeSnippet::compileGlobalCode : &quot;
+                    &quot;found subclass of EmbeddedCodeSnippet, but can't &quot;
+                    &quot;call constructor with given params.  &quot;
+                    &quot;class='%s', params=%s&quot;, 
+                    ((PyTypeObject*)snippet_found)-&gt;tp_name, 
+                    tostring(m_instance_params).c_str());
+        }
+        m_instance= PythonObjectWrapper(the_obj);
+    }
+
+    return wrapped_globals;
 }
 
+void PythonCodeSnippet::run()
+{
+    if(m_instance.isNull())
+        PLERROR(&quot;in PythonCodeSnippet::run : this snippet is not &quot;
+                &quot;an instance of EmbeddedCodeSnippet&quot;);
+    if(!PyCallable_Check(m_instance.getPyObject()))
+        PLERROR(&quot;in PythonCodeSnippet::run : this instance of &quot;
+                &quot;EmbeddedCodeSnippet is not callable.&quot;);
+    PyObject* pargs= PyTuple_New(0);
+    PyObject* res= PyObject_Call(m_instance.getPyObject(), pargs, 0);
+
+    Py_DECREF(pargs);
+    if(!res) handlePythonErrors();
+    Py_XDECREF(res);
+}
+
 void PythonCodeSnippet::setCurrentSnippet(const long&amp; handle) const
 {
     PythonGlobalInterpreterLock gil;         // For thread-safety
@@ -468,7 +651,7 @@
     }
 }
 
-void PythonCodeSnippet::handlePythonErrors() const
+void PythonCodeSnippet::handlePythonErrors(const string&amp; extramsg) const
 {
     PythonGlobalInterpreterLock gil;         // For thread-safety
     if (PyErr_Occurred()) {
@@ -478,75 +661,49 @@
             PyObject *exception, *v, *traceback;
             PyErr_Fetch(&amp;exception, &amp;v, &amp;traceback);
             PyErr_NormalizeException(&amp;exception, &amp;v, &amp;traceback);
+
+            if(!traceback)
+            {
+                //perr &lt;&lt; &quot;$$$$ before print&quot; &lt;&lt; endl;
+                PyErr_Print();
+                //perr &lt;&lt; &quot;$$$$ after print&quot; &lt;&lt; endl;
+                throw PythonException(string(&quot;PythonCodeSnippet: encountered Python &quot;
+                                             &quot;exception but there is no traceback.\n&quot;)
+                                      + extramsg);
+            }
             
-            //PyObject* tbstr= PyString_FromString(&quot;cgitb&quot;);
-            PyObject* tbstr= PyString_FromString(&quot;plearn.utilities.pltraceback&quot;);
+
+            PyObject* tbstr= 
+                PyString_FromString(&quot;plearn.utilities.pltraceback&quot;);
             PyObject* tbmod= PyImport_Import(tbstr);
             Py_XDECREF(tbstr);
             if(!tbmod)
-                throw PythonException(&quot;PythonCodeSnippet::handlePythonErrors : &quot;
-                                      &quot;Unable to import cgitb module.&quot;);
+                throw PythonException(&quot;PythonCodeSnippet::handlePythonErrors :&quot;
+                                      &quot; Unable to import cgitb module.&quot;);
             PyObject* tbdict= PyModule_GetDict(tbmod);
             Py_XDECREF(tbmod);
             PyObject* formatFunc= PyDict_GetItemString(tbdict, &quot;text&quot;);
             if(!formatFunc)
-                throw PythonException(&quot;PythonCodeSnippet::handlePythonErrors : &quot;
-                                      &quot;Can't find cgitb.text&quot;);
+                throw PythonException(&quot;PythonCodeSnippet::handlePythonErrors :&quot;
+                                      &quot; Can't find cgitb.text&quot;);
             PyObject* args= Py_BuildValue(&quot;((OOO))&quot;, exception, v, traceback);
             if(!args)
-                throw PythonException(&quot;PythonCodeSnippet::handlePythonErrors : &quot;
-                                      &quot;Can't build args for cgitb.text&quot;);
+                throw PythonException(&quot;PythonCodeSnippet::handlePythonErrors :&quot;
+                                      &quot; Can't build args for cgitb.text&quot;);
             PyObject* pystr= PyObject_CallObject(formatFunc, args);
             Py_XDECREF(args);
             if(!pystr)
-                throw PythonException(&quot;PythonCodeSnippet::handlePythonErrors : &quot;
-                                      &quot;call to cgitb.text failed&quot;);
+                throw PythonException(&quot;PythonCodeSnippet::handlePythonErrors :&quot;
+                                      &quot; call to cgitb.text failed&quot;);
             string str= PyString_AsString(pystr);
             Py_XDECREF(pystr);
             
-            throw PythonException(str);
-
-/*
-            PyObject *ptype = 0, *pvalue = 0, *ptraceback = 0;
-            PyErr_Fetch(&amp;ptype, &amp;pvalue, &amp;ptraceback);
-
-            // Convert the exception type, value and traceback to Python string
-            PyObject *ptype_str = 0, *pvalue_str = 0, *ptraceback_str = 0;
-            if (ptype)
-                ptype_str = PyObject_Str(ptype);
-            if (pvalue)
-                pvalue_str = PyObject_Str(pvalue);
-            if (ptraceback)
-                ptraceback_str = PyObject_Str(ptraceback);
-            
-            // From the strings we got, make a C++ string
-            string msg = &quot;Encountered Python Exception&quot;;
-            if (ptype_str)
-                msg += string(&quot;\nException Type: &quot;) + PyString_AsString(ptype_str);
-            if (pvalue_str)
-                msg += string(&quot;\nException Value: &quot;) + PyString_AsString(pvalue_str);
-            char* ptraceback_as_str= 0;
-            if (ptraceback_str)
-            {
-                ptraceback_as_str= PyTraceback_AsString(ptraceback_str);
-                //msg += string(&quot;\nTraceback: &quot;) + PyString_AsString(ptraceback_str);
-                msg += string(&quot;\nTraceback: &quot;) + ptraceback_as_str;
-                PyMem_Free(ptraceback_as_str);
-            }
-
-            Py_XDECREF(ptype);
-            Py_XDECREF(pvalue);
-            Py_XDECREF(ptraceback);
-            Py_XDECREF(ptype_str);
-            Py_XDECREF(pvalue_str);
-            Py_XDECREF(ptraceback_str);
-
-            throw PythonException(msg);
-*/
+            throw PythonException(str+extramsg);
         }
         else {
             PyErr_Print();
-            PLERROR(&quot;PythonCodeSnippet: encountered Python exception.&quot;);
+            PLERROR(&quot;PythonCodeSnippet: encountered Python exception.\n%s&quot;, 
+                    extramsg.c_str());
         }
     }  
 }

Modified: trunk/plearn/python/PythonCodeSnippet.h
===================================================================
--- trunk/plearn/python/PythonCodeSnippet.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/python/PythonCodeSnippet.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -44,6 +44,7 @@
 #define PythonCodeSnippet_INC
 
 // Python stuff must be included first
+#include &lt;plearn/python/PythonGlobalInterpreterLock.h&gt;
 #include &lt;plearn/python/PythonObjectWrapper.h&gt;
 
 // Boost stuff
@@ -145,6 +146,12 @@
      *  output to stderr and a PLERROR is raised.  Default=false
      */
     bool m_remap_python_exceptions;
+
+    //! parameters to the python ctor
+    map&lt;string, string&gt; m_instance_params;
+
+    //! the python object instance
+    PythonObjectWrapper m_instance;
     
 public:
     //! Default constructor.  Note that &quot;build&quot; IS NOT CALLED from the
@@ -298,13 +305,15 @@
     //! Transforms a shallow copy into a deep copy
     virtual void makeDeepCopyFromShallowCopy(CopiesMap&amp; copies);
 
+    virtual void run();
+
 protected: 
     //! Declares this class' options
     static void declareOptions(OptionList&amp; ol);
 
     //! Compile a code block into a new environment and return it.
     //! Call PLERROR if the code contains an error.
-    PythonObjectWrapper compileGlobalCode(const string&amp; code) const;
+    PythonObjectWrapper compileGlobalCode(const string&amp; code); //const;
 
     void setCurrentSnippet(const long&amp; handle) const;
     void resetCurrentSnippet() const;
@@ -312,7 +321,7 @@
     //! If no Python error, do nothing.  If an error occurred, convert the
     //! Python Exception into a C++ exception if required, or otherwise print a
     //! traceback and abort
-    void handlePythonErrors() const;
+    void handlePythonErrors(const string&amp; extramsg= &quot;&quot;) const;
 
     //! This is the trampoline function actually called by Python
     static PyObject* pythonTrampoline(PyObject* self, PyObject* args);
@@ -325,10 +334,12 @@
 protected:
     //! The Python handle for *this* instance
     long m_handle;
-    
+
+public:    
     //! Compiled Python code module and global environment
     PythonObjectWrapper m_compiled_code;
 
+protected:
     //! Functions to be injected into the compiled Python code
     PObjectPool&lt;StandaloneFunction&gt; m_injected_functions;
 
@@ -352,6 +363,11 @@
 PythonCodeSnippet::invoke(const char* function_name,
                           const T&amp; arg1) const
 {
+    TVec&lt;PythonObjectWrapper&gt; args(1);
+    args[0]= arg1;
+    return invoke(function_name, args);
+/*
+
     PythonGlobalInterpreterLock gil;         // For thread-safety
     PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
                                            function_name);
@@ -387,6 +403,7 @@
     }
 
     return PythonObjectWrapper(return_value);
+*/
 }
 
 
@@ -396,6 +413,11 @@
                           const T&amp; arg1,
                           const U&amp; arg2) const
 {
+    TVec&lt;PythonObjectWrapper&gt; args(2);
+    args[0]= arg1;
+    args[1]= arg2;
+    return invoke(function_name, args);
+/*
     PythonGlobalInterpreterLock gil;         // For thread-safety
     PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
                                            function_name);
@@ -433,6 +455,7 @@
                 function_name);
 
     return PythonObjectWrapper(return_value);
+*/
 }
 
 
@@ -443,6 +466,13 @@
                           const U&amp; arg2,
                           const V&amp; arg3) const
 {
+    TVec&lt;PythonObjectWrapper&gt; args(3);
+    args[0]= arg1;
+    args[1]= arg2;
+    args[2]= arg3;
+    return invoke(function_name, args);
+
+/*
     PythonGlobalInterpreterLock gil;         // For thread-safety
     PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
                                            function_name);
@@ -483,6 +513,7 @@
                 function_name);
 
     return PythonObjectWrapper(return_value);
+*/
 }
 
 
@@ -494,6 +525,13 @@
                           const V&amp; arg3,
                           const W&amp; arg4) const
 {
+    TVec&lt;PythonObjectWrapper&gt; args(4);
+    args[0]= arg1;
+    args[1]= arg2;
+    args[2]= arg3;
+    args[3]= arg4;
+    return invoke(function_name, args);
+/*
     PythonGlobalInterpreterLock gil;         // For thread-safety
     PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
                                            function_name);
@@ -537,6 +575,7 @@
                 function_name);
 
     return PythonObjectWrapper(return_value);
+*/
 }
 
 template &lt;class T, class U, class V, class W, class X&gt;
@@ -548,6 +587,14 @@
                           const W&amp; arg4,
                           const X&amp; arg5) const
 {
+    TVec&lt;PythonObjectWrapper&gt; args(5);
+    args[0]= arg1;
+    args[1]= arg2;
+    args[2]= arg3;
+    args[3]= arg4;
+    args[4]= arg5;
+    return invoke(function_name, args);
+/*
     PythonGlobalInterpreterLock gil;         // For thread-safety
     PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
                                            function_name);
@@ -594,6 +641,7 @@
                 function_name);
 
     return PythonObjectWrapper(return_value);
+*/
 }
 
 template &lt;class T, class U, class V, class W, class X, class Y&gt;
@@ -606,6 +654,15 @@
                           const X&amp; arg5,
                           const Y&amp; arg6) const
 {
+    TVec&lt;PythonObjectWrapper&gt; args(6);
+    args[0]= arg1;
+    args[1]= arg2;
+    args[2]= arg3;
+    args[3]= arg4;
+    args[4]= arg5;
+    args[5]= arg6;
+    return invoke(function_name, args);
+/*
     PythonGlobalInterpreterLock gil;         // For thread-safety
     PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
                                            function_name);
@@ -656,6 +713,7 @@
                 function_name);
 
     return PythonObjectWrapper(return_value);
+*/
 }
 
 
@@ -670,6 +728,16 @@
                           const Y&amp; arg6,
                           const Z&amp; arg7) const
 {
+    TVec&lt;PythonObjectWrapper&gt; args(7);
+    args[0]= arg1;
+    args[1]= arg2;
+    args[2]= arg3;
+    args[3]= arg4;
+    args[4]= arg5;
+    args[5]= arg6;
+    args[6]= arg7;
+    return invoke(function_name, args);
+/*
     PythonGlobalInterpreterLock gil;         // For thread-safety
     PyObject* pFunc = PyDict_GetItemString(m_compiled_code.getPyObject(),
                                            function_name);
@@ -723,6 +791,7 @@
                 function_name);
 
     return PythonObjectWrapper(return_value);
+*/
 }
 
 

Added: trunk/plearn/python/PythonGlobalInterpreterLock.h
===================================================================
--- trunk/plearn/python/PythonGlobalInterpreterLock.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/python/PythonGlobalInterpreterLock.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -0,0 +1,84 @@
+// -*- C++ -*-
+
+// PythonGlobalInterpreterLock.h
+//
+// Copyright (C) 2005 Nicolas Chapados 
+// 
+// Redistribution and use in source and binary forms, with or without
+// modification, are permitted provided that the following conditions are met:
+// 
+//  1. Redistributions of source code must retain the above copyright
+//     notice, this list of conditions and the following disclaimer.
+// 
+//  2. Redistributions in binary form must reproduce the above copyright
+//     notice, this list of conditions and the following disclaimer in the
+//     documentation and/or other materials provided with the distribution.
+// 
+//  3. The name of the authors may not be used to endorse or promote
+//     products derived from this software without specific prior written
+//     permission.
+// 
+// THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR
+// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+// OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
+// NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+// TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+// 
+// This file is part of the PLearn library. For more information on the PLearn
+// library, go to the PLearn Web site at www.plearn.org
+
+
+#include &lt;plearn/python/PythonIncludes.h&gt;
+
+//#####  PythonGlobalInterpreterLock  #########################################
+
+/**
+ *  @class  PythonGlobalInterpreterLock
+ *  @brief  Ensure thread safety by managing the Python Global Interpreter Lock
+ *
+ *  The Python interpreter is not fully reentrant and must be handled carefully
+ *  in the presence of multi-threading.  While this does not affect
+ *  multi-threaded pure Python code (for which reentrancy is properly managed),
+ *  it does affect extensions that are written in other languages.  To this
+ *  end, Python provides a Global Interpreter Lock (GIL) which must be acquired
+ *  before calling any of its API within extension code and released
+ *  afterwards.
+ *
+ *  This class provides a simple Resource-Acquisition-is-Initialization (RAII)
+ *  idiom to manage the GIL.  The idea is to construct a local variable of this
+ *  class at the beginning of a scope which uses Python.  The constructor
+ *  acquires the lock, and the destructor automatically releases it.  For
+ *  example:
+ *
+ *  @code
+ *  void foo()
+ *  {
+ *      // Acquire the Python lock.  This blocks if another thread
+ *      // already has the lock.
+ *      PythonGlobalInterpreterLock gil;
+ *
+ *      // Code which uses the Python C API comes here
+ *      // ...
+ *  }   // Destructor releases the lock, so nothing to do.
+ *  @endcode
+ */
+class PythonGlobalInterpreterLock
+{
+public:
+    PythonGlobalInterpreterLock()
+        : m_gilstate(PyGILState_Ensure())
+    { }
+       
+    ~PythonGlobalInterpreterLock()
+    {
+        PyGILState_Release(m_gilstate);
+    }
+
+    PyGILState_STATE m_gilstate;
+};
+

Modified: trunk/plearn/python/PythonIncludes.h
===================================================================
--- trunk/plearn/python/PythonIncludes.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/python/PythonIncludes.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -52,6 +52,8 @@
  *  library includes are carried out.  (Python.h plays hacks with some macros)
  */
 
+#ifdef PL_PYTHON_VERSION
+
 // Under Windows with Microsoft Visual Studio in debug mode, _DEBUG is defined
 // resulting in a dependence on the python24_d.lib library file. To get rid of
 // this, we undefine _DEBUG before including the python headers.
@@ -60,9 +62,11 @@
 #undef _DEBUG
 #endif
 
+/* allow to be undefined
 #ifndef PL_PYTHON_VERSION
 #  define PL_PYTHON_VERSION 230
 #endif
+*/
 
 #if PL_PYTHON_VERSION &gt;= 240
 
@@ -79,9 +83,10 @@
 #include &lt;python2.3/numarray/libnumarray.h&gt;
 
 #else
-
+/*
+// it is not an error not to include python
 #  error &quot;PL_PYTHON_VERSION should be defined to one of: 230, 240&quot;
-
+*/
 #endif
 
 // Redefine _DEBUG if needed (see above).
@@ -98,6 +103,8 @@
 //
 #undef HAVE_LONG_LONG
 
+#endif //def PL_PYTHON_VERSION
+
 
 /*
   Local Variables:

Modified: trunk/plearn/python/PythonObjectWrapper.cc
===================================================================
--- trunk/plearn/python/PythonObjectWrapper.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/python/PythonObjectWrapper.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -3,6 +3,7 @@
 // PythonObjectWrapper.cc
 //
 // Copyright (C) 2005-2006 Nicolas Chapados 
+// Copyright (C) 2007 Xavier Saint-Mleux, ApSTAT Technologies inc.
 // 
 // Redistribution and use in source and binary forms, with or without
 // modification, are permitted provided that the following conditions are met:
@@ -42,6 +43,7 @@
 
 // Must include Python first...
 #include &quot;PythonObjectWrapper.h&quot;
+#include &quot;PythonEmbedder.h&quot;
 
 // From C/C++ stdlib
 #include &lt;stdio.h&gt;
@@ -49,6 +51,8 @@
 
 // From PLearn
 #include &lt;plearn/base/plerror.h&gt;
+#include &lt;plearn/vmat/VMat.h&gt;
+#include &lt;plearn/base/RemoteTrampoline.h&gt;
 
 namespace PLearn {
 using namespace std;
@@ -80,6 +84,12 @@
 
 //#####  ConvertFromPyObject  #################################################
 
+PyObject* ConvertFromPyObject&lt;PyObject*&gt;::convert(PyObject* pyobj, bool print_traceback)
+{
+    PLASSERT( pyobj );
+    return pyobj;
+}
+
 bool ConvertFromPyObject&lt;bool&gt;::convert(PyObject* pyobj, bool print_traceback)
 {
     PLASSERT( pyobj );
@@ -128,6 +138,44 @@
     return PyString_AsString(pyobj);
 }
 
+PPath ConvertFromPyObject&lt;PPath&gt;::convert(PyObject* pyobj, bool print_traceback)
+{
+    PLASSERT( pyobj );
+    if (! PyString_Check(pyobj))
+        PLPythonConversionError(&quot;ConvertFromPyObject&lt;PPath&gt;&quot;, pyobj,
+                                print_traceback);
+    return PPath(PyString_AsString(pyobj));
+}
+
+PPointable* ConvertFromPyObject&lt;PPointable*&gt;::convert(PyObject* pyobj, bool print_traceback)
+{
+    PLASSERT(pyobj);
+    if (! PyCObject_Check(pyobj))
+        PLPythonConversionError(&quot;ConvertFromPyObject&lt;PPointable*&gt;&quot;, pyobj,
+                                print_traceback);
+    return static_cast&lt;PPointable*&gt;(PyCObject_AsVoidPtr(pyobj));
+}
+
+Object* ConvertFromPyObject&lt;Object*&gt;::convert(PyObject* pyobj, bool print_traceback)
+{
+    PLASSERT(pyobj);
+
+    PyObject* cptr= PyObject_GetAttrString(pyobj, &quot;_cptr&quot;);
+
+    if (! PyCObject_Check(cptr))
+        PLPythonConversionError(&quot;ConvertFromPyObject&lt;Object*&gt;&quot;, pyobj,
+                                print_traceback);
+    Object* obj= static_cast&lt;Object*&gt;(PyCObject_AsVoidPtr(cptr));
+   
+    Py_DECREF(cptr);
+    return obj;
+}
+/*
+Object&amp; ConvertFromPyObject&lt;Object&amp;&gt;::convert(PyObject* pyobj, bool print_traceback)
+{
+    return *ConvertFromPyObject&lt;Object*&gt;::convert(pyobj, print_traceback);
+}
+*/
 void ConvertFromPyObject&lt;Vec&gt;::convert(PyObject* pyobj, Vec&amp; v, bool print_traceback)
 {
     // NA_InputArray possibly creates a well-behaved temporary (i.e. not
@@ -186,7 +234,26 @@
 
 
 //#####  Constructors+Destructors  ############################################
+PythonObjectWrapper::PythonObjectWrapper(OwnershipMode o,
+                                         bool acquire_gil /* unused in this overload */)
+    : m_ownership(o),
+      m_object(Py_None)
+{
+    if (m_ownership == control_ownership)
+        Py_XINCREF(m_object);
+}
 
+//! Constructor for pre-existing PyObject
+PythonObjectWrapper::PythonObjectWrapper(PyObject* pyobj, OwnershipMode o,
+                                         bool acquire_gil /* unused in this overload */)
+    : m_ownership(o),
+      m_object(pyobj)
+{ 
+    if (m_ownership == control_ownership)
+        Py_XINCREF(m_object);
+}
+
+
 // Copy constructor: increment refcount if controlling ownership.
 // No need to manage GIL.
 PythonObjectWrapper::PythonObjectWrapper(const PythonObjectWrapper&amp; other)
@@ -240,9 +307,343 @@
     PyObject_Print(m_object, stderr, Py_PRINT_RAW);
 }
 
+bool PythonObjectWrapper::isNull() const
+{
+    return ! m_object || m_object == Py_None;
+}
+    
 
+//##### Trampoline ############################################################
+PyObject* PythonObjectWrapper::trampoline(PyObject* self, PyObject* args)
+{
+    PythonGlobalInterpreterLock gil;         // For thread-safety
+
+    //get object and trampoline from self
+    PythonObjectWrapper s(self, transfer_ownership);
+
+    //perr &lt;&lt; &quot;refcnt self= &quot; &lt;&lt; self-&gt;ob_refcnt &lt;&lt; endl;
+
+    RemoteTrampoline* tramp= 
+        dynamic_cast&lt;RemoteTrampoline*&gt;(s.as&lt;PPointable*&gt;());
+    if(!tramp) 
+        PLERROR(&quot;in PythonObjectWrapper::trampoline : &quot;
+                &quot;can't unwrap RemoteTrampoline.&quot;);
+
+    //wrap args
+    int size = PyTuple_GET_SIZE(args);
+    TVec&lt;PythonObjectWrapper&gt; args_tvec(size);
+    for(int i= 0; i &lt; size; ++i) 
+        args_tvec[i]= 
+            PythonObjectWrapper(PyTuple_GET_ITEM(args,i),
+                                PythonObjectWrapper::transfer_ownership);
+
+    // separate self from other params.
+    Object* obj= args_tvec[0];
+    args_tvec.subVecSelf(1, args_tvec.size()-1);
+
+    //call, catch and send any errors to python
+    try
+    {
+        return tramp-&gt;call(obj, args_tvec).getPyObject();
+    }
+    catch(const PLearnError&amp; e) 
+    {
+        PyErr_SetString(PyExc_Exception, e.message().c_str());
+        return 0;
+    }
+    catch(const std::exception&amp; e) 
+    {
+        PyErr_SetString(PyExc_Exception, e.what());
+        return 0;
+    }
+    catch(...) 
+    {
+        PyErr_SetString(PyExc_Exception,
+                        &quot;Caught unknown C++ exception while executing injected function &quot;
+                        &quot;inside a PythonObjectWrapper&quot;);
+        return 0;
+    }
+}
+
+PyObject* PythonObjectWrapper::python_del(PyObject* self, PyObject* args)
+{
+    TVec&lt;PyObject*&gt; args_tvec= 
+        PythonObjectWrapper(args, transfer_ownership).as&lt;TVec&lt;PyObject*&gt; &gt;();
+    Object* obj= PythonObjectWrapper(args_tvec[0], transfer_ownership);
+
+    string classname= obj-&gt;classname();
+    pypl_classes_t::iterator clit= m_pypl_classes.find(classname);
+    if(clit == m_pypl_classes.end())
+        PLERROR(&quot;in PythonObjectWrapper::python_del : &quot;
+                &quot;deleting obj. for which no python class exists!&quot;);
+    --clit-&gt;second.nref;
+    if(0 == clit-&gt;second.nref)
+    {
+        //perr &lt;&lt; &quot;*#*#*# python class &quot; &lt;&lt; classname &lt;&lt; &quot; deleted&quot; &lt;&lt; endl;
+        m_pypl_classes.erase(classname);//cleanup
+    }
+
+    obj-&gt;unref();//python no longer references this obj.
+
+    //perr &lt;&lt; &quot;**** Python object deleted! &quot; &lt;&lt; (void*)obj &lt;&lt; '/' &lt;&lt; (void*)args_tvec[0] &lt;&lt; endl;
+
+    m_wrapped_objects.erase(obj);
+    return PythonObjectWrapper().getPyObject();//None
+}
+
 //#####  newPyObject  #########################################################
 
+PyObject* PythonObjectWrapper::newPyObject()           //!&lt; Return None (increments refcount)
+{
+    Py_XINCREF(Py_None);
+    return Py_None;
+}
+
+PythonObjectWrapper::wrapped_objects_t 
+    PythonObjectWrapper::m_wrapped_objects;//init.
+
+PythonObjectWrapper::pypl_classes_t 
+    PythonObjectWrapper::m_pypl_classes;//init.
+//init.
+bool PythonObjectWrapper::m_unref_injected= false;
+PyMethodDef PythonObjectWrapper::m_unref_method_def;
+
+PyObject* PythonObjectWrapper::newPyObject(const Object* x)
+{
+    // void ptr becomes None
+    if(!x) return newPyObject();
+
+    PythonGlobalInterpreterLock gil;         // For thread-safety
+
+    static PythonEmbedder embedder;
+    initializePython();
+
+    //see if this obj. is already wrapped
+    wrapped_objects_t::iterator objit= m_wrapped_objects.find(x);
+    if(objit != m_wrapped_objects.end())
+    {
+        PyObject* o= objit-&gt;second;
+        Py_INCREF(o);//new ref
+        return o;//return ptr to already created pyobj
+    }
+
+    // import python class for wrapping PLearn objects
+    string importcode= &quot;\nfrom plearn.pybridge.wrapped_plearn_object &quot;
+        &quot;import *\n&quot;;
+    PyObject* pyenv= PyDict_New();
+    PyDict_SetItemString(pyenv, &quot;__builtins__&quot;, PyEval_GetBuiltins());
+    PyRun_String(importcode.c_str(), Py_file_input, pyenv, pyenv);
+    if (PyErr_Occurred()) 
+    {
+        Py_DECREF(pyenv);
+        PyErr_Print();
+        PLERROR(&quot;in PythonObjectWrapper::newPyObject : error compiling &quot;
+                &quot;WrappedPLearnObject python code.&quot;);
+    }
+
+    // now find the class in the env.
+    typedef map&lt;string, PyObject*&gt; env_t;
+    env_t env= PythonObjectWrapper(pyenv, transfer_ownership).as&lt;env_t&gt;();
+    env_t::iterator clit= env.find(&quot;WrappedPLearnObject&quot;);
+    if(clit == env.end())
+        PLERROR(&quot;in PythonObjectWrapper::newPyObject : &quot;
+                &quot;class WrappedPLearnObject not defined &quot;
+                &quot;in plearn.pybridge.wrapped_plearn_object&quot;);
+    PyObject* wrapper= clit-&gt;second;
+
+    //inject unref method if not already done
+    if(!m_unref_injected)
+    {
+        PyMethodDef* py_method= &amp;m_unref_method_def;
+        py_method-&gt;ml_name  = &quot;unref&quot;;
+        py_method-&gt;ml_meth  = python_del;
+        py_method-&gt;ml_flags = METH_VARARGS;
+        py_method-&gt;ml_doc   = &quot;injected-unref-function-from-PythonObjectWrapper&quot;;
+        
+        PyObject* py_funcobj= PyCFunction_NewEx(py_method, NULL, NULL);
+        PyObject* py_methobj= PyMethod_New(py_funcobj, NULL, wrapper);
+        Py_XDECREF(py_funcobj);
+        if(!py_funcobj || !py_methobj) 
+        {
+            Py_DECREF(pyenv);
+            Py_XDECREF(py_methobj);
+            PLERROR(&quot;in PythonObjectWrapper::newPyObject : &quot;
+                    &quot;can't inject method '%s' (i.e. __del__)&quot;, 
+                    py_method-&gt;ml_name);
+        }
+        PyObject_SetAttrString(wrapper, py_method-&gt;ml_name, py_methobj);
+        Py_DECREF(py_methobj);
+        m_unref_injected= true;
+    }
+
+    if(!PyCallable_Check(wrapper))
+        PLERROR(&quot;in PythonObjectWrapper::newPyObject : &quot;
+                &quot;WrappedPLearnObject is not callable [not a class?]&quot;);
+
+    // get ptr of object to wrap
+    PyObject* plobj= PyCObject_FromVoidPtr(const_cast&lt;Object*&gt;(x), NULL);
+
+    // try to find existing python class
+    string classname= x-&gt;classname();
+    pypl_classes_t::iterator clit2= m_pypl_classes.find(classname);
+    PyObject* the_pyclass= 0;
+    if(clit2 == m_pypl_classes.end())
+    {
+        // create new python type deriving from WrappedPLearnObject
+        string derivcode= string(&quot;\nclass &quot;)
+            + classname + &quot;(WrappedPLearnObject):\n&quot;
+            &quot;\tpass\n\n&quot;;
+
+        //pout &lt;&lt; &quot;** creating python class &quot; &lt;&lt; classname &lt;&lt; endl;
+
+        PyRun_String(derivcode.c_str(), Py_file_input, pyenv, pyenv);
+        env= PythonObjectWrapper(pyenv, transfer_ownership).as&lt;env_t&gt;();
+        clit= env.find(classname);
+        if(clit == env.end())
+            PLERROR(&quot;in PythonObjectWrapper::newPyObject : &quot;
+                    &quot;Cannot create new python class deriving from &quot;
+                    &quot;WrappedPLearnObject (%s).&quot;, classname.c_str());
+
+        //set option names
+        OptionList&amp; options= x-&gt;getOptionList();
+        unsigned int nopts= options.size();
+        TVec&lt;string&gt; optionnames(nopts);
+        for(unsigned int i= 0; i &lt; nopts; ++i)
+            optionnames[i]= options[i]-&gt;optionname();
+
+        the_pyclass= clit-&gt;second;
+        if(-1==PyObject_SetAttrString(the_pyclass, &quot;_optionnames&quot;, 
+                                      PythonObjectWrapper(optionnames).getPyObject()))
+        {
+            Py_DECREF(pyenv);
+            if (PyErr_Occurred()) 
+                PyErr_Print();
+            PLERROR(&quot;cannot set attr _optionnames&quot;);
+        }
+
+        // inject all declared methods
+        const RemoteMethodMap* methods= &amp;x-&gt;getRemoteMethodMap();
+
+        PP&lt;PObjectPool&lt;PyMethodDef&gt; &gt; meth_def_pool= 
+            new PObjectPool&lt;PyMethodDef&gt;(methods-&gt;size()+1);
+
+        m_pypl_classes.insert(
+            make_pair(classname, PLPyClass(the_pyclass, meth_def_pool)));
+
+        while(methods)
+        {
+            for(RemoteMethodMap::MethodMap::const_iterator it= methods-&gt;begin();
+                it != methods-&gt;end(); ++it)
+            {
+                //get the RemoteTrampoline
+                PyObject* tramp= PyCObject_FromVoidPtr(it-&gt;second, NULL);
+            
+                // Create a Python Function Object
+                PyMethodDef* py_method= meth_def_pool-&gt;allocate();
+                py_method-&gt;ml_name  = const_cast&lt;char*&gt;(it-&gt;first.first.c_str());
+                py_method-&gt;ml_meth  = trampoline;
+                py_method-&gt;ml_flags = METH_VARARGS;
+                py_method-&gt;ml_doc   = &quot;injected-function-from-PythonObjectWrapper&quot;;
+    
+                PyObject* py_funcobj= PyCFunction_NewEx(py_method, tramp, NULL);
+
+                // create an unbound method from the function
+                PyObject* py_methobj= PyMethod_New(py_funcobj, NULL, the_pyclass);
+
+                Py_DECREF(tramp);
+                Py_XDECREF(py_funcobj);
+                if(!py_funcobj || !py_methobj) 
+                {
+                    Py_DECREF(pyenv);
+                    Py_DECREF(plobj);
+                    Py_XDECREF(py_methobj);
+                    PLERROR(&quot;in PythonObjectWrapper::newPyObject : &quot;
+                            &quot;can't inject method '%s'&quot;, py_method-&gt;ml_name);
+                }
+
+                PyObject_SetAttrString(the_pyclass, py_method-&gt;ml_name, py_methobj);
+                Py_DECREF(py_methobj);
+            }
+            methods= methods-&gt;inheritedMethods();//get parent class methods
+        }
+    }
+    else
+    {
+        the_pyclass= clit2-&gt;second.pyclass;
+        ++clit2-&gt;second.nref;
+    }
+    
+    //create the python object itself from the_pyclass
+    PyObject* args= PyTuple_New(1);
+    Py_INCREF(plobj);//keep it after it is 'stolen'
+    PyTuple_SetItem(args, 0, plobj);
+    
+    PyObject* params= PyDict_New();
+    PyObject* the_obj= PyObject_Call(the_pyclass, args, params);
+    Py_DECREF(args);
+    Py_DECREF(params);
+    if(!the_obj)
+    {
+        Py_DECREF(pyenv);
+        Py_DECREF(plobj);
+        if (PyErr_Occurred()) PyErr_Print();
+        PLERROR(&quot;in PythonObjectWrapper::newPyObject : &quot;
+                &quot;can't construct a WrappedPLearnObject.&quot;);
+    }
+
+    //finalize
+    Py_DECREF(pyenv);
+    Py_DECREF(plobj);
+
+    // augment refcount since python now 'points' to this obj.
+    x-&gt;ref();
+
+    m_wrapped_objects[x]= the_obj;
+
+    //pout &lt;&lt; &quot;** python instance of &quot; &lt;&lt; (void*)x &lt;&lt; &quot; is &quot; &lt;&lt; (void*)the_obj &lt;&lt; endl;
+
+    return the_obj;
+}
+
+PyObject* PythonObjectWrapper::newPyObject(const bool&amp; x)
+{
+    if (x) {
+        Py_XINCREF(Py_True);
+        return Py_True;
+    }
+    else {
+        Py_XINCREF(Py_False);
+        return Py_False;
+    }
+}
+
+
+PyObject* PythonObjectWrapper::newPyObject(const int&amp; x)
+{
+    return PyInt_FromLong(long(x));
+}
+    
+PyObject* PythonObjectWrapper::newPyObject(const long&amp; x)
+{
+    return PyLong_FromLong(x);
+}
+    
+PyObject* PythonObjectWrapper::newPyObject(const double&amp; x)
+{
+    return PyFloat_FromDouble(x);
+}
+
+PyObject* PythonObjectWrapper::newPyObject(const char* x)
+{
+    return PyString_FromString(x);
+}
+    
+PyObject* PythonObjectWrapper::newPyObject(const string&amp; x)
+{
+    return PyString_FromString(x.c_str());
+}
+
+
 PyObject* PythonObjectWrapper::newPyObject(const Vec&amp; data)
 {
     PyArrayObject* pyarr = 0;
@@ -291,6 +692,21 @@
     return (PyObject*)pyarr;
 }
 
+PyObject* PythonObjectWrapper::newPyObject(const VMat&amp; vm)
+{
+    if (vm.isNull())
+        return newPyObject(Mat());
+    else
+        return newPyObject(vm.toMat());
+}
+
+PyObject* PythonObjectWrapper::newPyObject(const PythonObjectWrapper&amp; pow)
+{
+    Py_XINCREF(pow.m_object);
+    return pow.m_object;
+}
+
+
 } // end of namespace PLearn
 
 

Modified: trunk/plearn/python/PythonObjectWrapper.h
===================================================================
--- trunk/plearn/python/PythonObjectWrapper.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/python/PythonObjectWrapper.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -3,6 +3,7 @@
 // PythonObjectWrapper.h
 //
 // Copyright (C) 2005-2006 Nicolas Chapados 
+// Copyright (C) 2007 Xavier Saint-Mleux, ApSTAT Technologies inc.
 // 
 // Redistribution and use in source and binary forms, with or without
 // modification, are permitted provided that the following conditions are met:
@@ -55,8 +56,9 @@
 // From PLearn
 #include &lt;plearn/math/TVec.h&gt;
 #include &lt;plearn/math/TMat.h&gt;
-#include &lt;plearn/vmat/VMat.h&gt;
 #include &lt;plearn/base/tostring.h&gt;
+#include &lt;plearn/base/PMemPool.h&gt;
+#include &lt;plearn/base/TypeTraits.h&gt;
 
 #ifdef USEFLOAT
 #define tReal tFloat32
@@ -67,6 +69,8 @@
 namespace PLearn {
 
 class PythonObjectWrapper;                   // Forward-declare
+class Object;
+class VMat;
 
 //! Used for error reporting.  If 'print_traceback' is true, a full
 //! Python traceback is printed to stderr.  Otherwise, raise PLERROR.
@@ -74,54 +78,6 @@
                              bool print_traceback);
 
 
-//#####  PythonGlobalInterpreterLock  #########################################
-
-/**
- *  @class  PythonGlobalInterpreterLock
- *  @brief  Ensure thread safety by managing the Python Global Interpreter Lock
- *
- *  The Python interpreter is not fully reentrant and must be handled carefully
- *  in the presence of multi-threading.  While this does not affect
- *  multi-threaded pure Python code (for which reentrancy is properly managed),
- *  it does affect extensions that are written in other languages.  To this
- *  end, Python provides a Global Interpreter Lock (GIL) which must be acquired
- *  before calling any of its API within extension code and released
- *  afterwards.
- *
- *  This class provides a simple Resource-Acquisition-is-Initialization (RAII)
- *  idiom to manage the GIL.  The idea is to construct a local variable of this
- *  class at the beginning of a scope which uses Python.  The constructor
- *  acquires the lock, and the destructor automatically releases it.  For
- *  example:
- *
- *  @code
- *  void foo()
- *  {
- *      // Acquire the Python lock.  This blocks if another thread
- *      // already has the lock.
- *      PythonGlobalInterpreterLock gil;
- *
- *      // Code which uses the Python C API comes here
- *      // ...
- *  }   // Destructor releases the lock, so nothing to do.
- *  @endcode
- */
-class PythonGlobalInterpreterLock
-{
-public:
-    PythonGlobalInterpreterLock()
-        : m_gilstate(PyGILState_Ensure())
-    { }
-       
-    ~PythonGlobalInterpreterLock()
-    {
-        PyGILState_Release(m_gilstate);
-    }
-
-    PyGILState_STATE m_gilstate;
-};
-
-
 //#####  ConvertFromPyObject  #################################################
 
 /**
@@ -139,9 +95,24 @@
  */
 template &lt;class T&gt;
 struct ConvertFromPyObject
-{ };
+{ 
+    static T convert(PyObject*, bool print_traceback)
+    {
+        PLERROR(&quot;Cannot convert this object by value from python (type=%s).&quot;,
+                TypeTraits&lt;T&gt;::name().c_str());
+        return T();//to silence compiler
+    }
 
+};
+
 template &lt;&gt;
+struct ConvertFromPyObject&lt;PyObject*&gt;
+{
+    //trivial: no conversion
+    static PyObject* convert(PyObject*, bool print_traceback);
+};
+
+template &lt;&gt;
 struct ConvertFromPyObject&lt;bool&gt;
 {
     static bool convert(PyObject*, bool print_traceback);
@@ -177,7 +148,27 @@
     static string convert(PyObject*, bool print_traceback);
 };
 
+
 template &lt;&gt;
+struct ConvertFromPyObject&lt;PPath&gt;
+{
+    static PPath convert(PyObject*, bool print_traceback);
+};
+
+
+template &lt;&gt;
+struct ConvertFromPyObject&lt;PPointable*&gt;
+{
+    static PPointable* convert(PyObject*, bool print_traceback);
+};
+
+template &lt;&gt;
+struct ConvertFromPyObject&lt;Object*&gt;
+{
+    static Object* convert(PyObject*, bool print_traceback);
+};
+
+template &lt;&gt;
 struct ConvertFromPyObject&lt;Vec&gt;
 {
     // Return fresh storage
@@ -206,6 +197,12 @@
     static VMat convert(PyObject*, bool print_traceback);
 };
 
+template &lt;typename T&gt;
+struct ConvertFromPyObject&lt;PP&lt;T&gt; &gt;
+{
+    static PP&lt;T&gt; convert(PyObject*, bool print_traceback);
+};
+
 template &lt;class T&gt;
 struct ConvertFromPyObject&lt; TVec&lt;T&gt; &gt;
 {
@@ -230,7 +227,54 @@
     static std::pair&lt;T,U&gt; convert(PyObject*, bool print_traceback);
 };
 
+//#####  PythonGlobalInterpreterLock  #########################################
 
+/**
+ *  @class  PythonGlobalInterpreterLock
+ *  @brief  Ensure thread safety by managing the Python Global Interpreter Lock
+ *
+ *  The Python interpreter is not fully reentrant and must be handled carefully
+ *  in the presence of multi-threading.  While this does not affect
+ *  multi-threaded pure Python code (for which reentrancy is properly managed),
+ *  it does affect extensions that are written in other languages.  To this
+ *  end, Python provides a Global Interpreter Lock (GIL) which must be acquired
+ *  before calling any of its API within extension code and released
+ *  afterwards.
+ *
+ *  This class provides a simple Resource-Acquisition-is-Initialization (RAII)
+ *  idiom to manage the GIL.  The idea is to construct a local variable of this
+ *  class at the beginning of a scope which uses Python.  The constructor
+ *  acquires the lock, and the destructor automatically releases it.  For
+ *  example:
+ *
+ *  @code
+ *  void foo()
+ *  {
+ *      // Acquire the Python lock.  This blocks if another thread
+ *      // already has the lock.
+ *      PythonGlobalInterpreterLock gil;
+ *
+ *      // Code which uses the Python C API comes here
+ *      // ...
+ *  }   // Destructor releases the lock, so nothing to do.
+ *  @endcode
+ */
+class PythonGlobalInterpreterLock
+{
+public:
+    PythonGlobalInterpreterLock()
+        : m_gilstate(PyGILState_Ensure())
+    { }
+       
+    ~PythonGlobalInterpreterLock()
+    {
+        PyGILState_Release(m_gilstate);
+    }
+
+    PyGILState_STATE m_gilstate;
+};
+
+
 //#####  PythonObjectWrapper  #################################################
 
 /**
@@ -275,20 +319,11 @@
     //! Construct 'None'.  This object is a singleton in Python, but it must be
     //! reference-counted just like any other object.
     PythonObjectWrapper(OwnershipMode o = control_ownership,
-                        bool acquire_gil = true /* unused in this overload */)
-        : m_ownership(o),
-          m_object(Py_None)
-    {
-        if (m_ownership == control_ownership)
-            Py_XINCREF(m_object);
-    }
+                        bool acquire_gil = true /* unused in this overload */);
     
     //! Constructor for pre-existing PyObject
     PythonObjectWrapper(PyObject* pyobj, OwnershipMode o = control_ownership,
-                        bool acquire_gil = true /* unused in this overload */)
-        : m_ownership(o),
-          m_object(pyobj)
-    { }
+                        bool acquire_gil = true /* unused in this overload */);
     
     //! Constructor for general type (forwarded to newPyObject)
     template &lt;class T&gt;
@@ -314,6 +349,9 @@
     //! Assignment operator: manage refcount if necessary
     PythonObjectWrapper&amp; operator=(const PythonObjectWrapper&amp; rhs);
 
+    //! implicit conversion
+    template&lt;typename T&gt; operator T() const { return as&lt;T&gt;(); }
+
     //! Swap *this with another instance
     void swap(PythonObjectWrapper&amp; other);
     
@@ -324,10 +362,7 @@
     }
     
     //! Return true if m_object is either NULL or stands for Python's None
-    bool isNull() const
-    {
-        return ! m_object || m_object == Py_None;
-    }
+    bool isNull() const;
     
     //! Print out the Python object to stderr for debugging purposes
     void printDebug() const;
@@ -356,55 +391,35 @@
     }
     
 
+    //##### Trampoline for PLearn objects #####################################
+
+    static PyObject* trampoline(PyObject* self, PyObject* args);
+
+    static PyObject* python_del(PyObject* self, PyObject* args);
+
+
     //#####  Low-Level PyObject Creation  #####################################
 
     /**
      *  @function newPyObject
      *  @brief    Create a raw \c PyObject* from various types
      */
-    static PyObject* newPyObject()           //!&lt; Return None (increments refcount)
-    {
-        Py_XINCREF(Py_None);
-        return Py_None;
-    }
+    static PyObject* newPyObject();  //!&lt; Return None (increments refcount)
+
+    static PyObject* newPyObject(const Object* x);
+
+    static PyObject* newPyObject(const bool&amp; x);
     
-    static PyObject* newPyObject(const bool&amp; x)
-    {
-        if (x) {
-            Py_XINCREF(Py_True);
-            return Py_True;
-        }
-        else {
-            Py_XINCREF(Py_False);
-            return Py_False;
-        }
-    }
+    static PyObject* newPyObject(const int&amp; x);
     
-    static PyObject* newPyObject(const int&amp; x)
-    {
-        return PyInt_FromLong(long(x));
-    }
+    static PyObject* newPyObject(const long&amp; x);
     
-    static PyObject* newPyObject(const long&amp; x)
-    {
-        return PyLong_FromLong(x);
-    }
-    
-    static PyObject* newPyObject(const double&amp; x)
-    {
-        return PyFloat_FromDouble(x);
-    }
+    static PyObject* newPyObject(const double&amp; x);
 
-    static PyObject* newPyObject(const char* x)
-    {
-        return PyString_FromString(x);
-    }
+    static PyObject* newPyObject(const char* x);
     
-    static PyObject* newPyObject(const string&amp; x)
-    {
-        return PyString_FromString(x.c_str());
-    }
-    
+    static PyObject* newPyObject(const string&amp; x);
+  
     //! PLearn Vec: use numarray
     static PyObject* newPyObject(const Vec&amp;);
 
@@ -416,14 +431,12 @@
     //! are lost when converting to Python.
     //!
     //! @TODO  Must provide a complete Python wrapper over VMatrix objects
-    static PyObject* newPyObject(const VMat&amp; vm)
-    {
-        if (vm.isNull())
-            return newPyObject(Mat());
-        else
-            return newPyObject(vm.toMat());
-    }
+    static PyObject* newPyObject(const VMat&amp; vm);
     
+    //! Generic PP: wrap pointed object
+    template &lt;class T&gt;
+    static PyObject* newPyObject(const PP&lt;T&gt;&amp;);
+
     //! Generic vector: create a Python list of those objects recursively
     template &lt;class T&gt;
     static PyObject* newPyObject(const TVec&lt;T&gt;&amp;);
@@ -454,29 +467,64 @@
 
     //! For a general PythonObjectWrapper: we simply increment the refcount
     //! to the underlying Python object, no matter whether we own it or not.
-    static PyObject* newPyObject(const PythonObjectWrapper&amp; pow)
-    {
-        Py_XINCREF(pow.m_object);
-        return pow.m_object;
-    }
+    static PyObject* newPyObject(const PythonObjectWrapper&amp; pow);
     
-    
     /**
      *  This function is called by PythonCodeSnippet to carry out
      *  initializations related to libnumarray.
      */
     static void initializePython();
     
-    
 protected:
     OwnershipMode m_ownership;               //!&lt; Whether we own the PyObject or not
     PyObject* m_object;
+    
+    struct PLPyClass
+    {
+        // holds info about a PLearn class
+        // injected into python
+        PLPyClass(PyObject* pyclass_,
+                  PP&lt;PObjectPool&lt;PyMethodDef&gt; &gt;&amp; methods_)
+            :pyclass(pyclass_),
+             methods(methods_),
+             nref(1)
+        {}
+        PyObject* pyclass;
+        PP&lt;PObjectPool&lt;PyMethodDef&gt; &gt; methods;
+        int nref;
+    };
+
+    //for the unique unref injected method
+    static bool m_unref_injected;
+    static PyMethodDef m_unref_method_def;
+
+    typedef map&lt;const string, PLPyClass&gt; pypl_classes_t;
+    static pypl_classes_t m_pypl_classes;
+
+    typedef map&lt;const Object*, PyObject*&gt; wrapped_objects_t;
+
+    static wrapped_objects_t m_wrapped_objects; //!&lt; for wrapped PLearn Objects
 };
 
 
 //#####  ConvertFromPyObject Implementations  #################################
 
 template &lt;class T&gt;
+PP&lt;T&gt; ConvertFromPyObject&lt;PP&lt;T&gt; &gt;::convert(PyObject* pyobj, bool print_traceback)
+{
+    PPointable* o= 0;
+    if(PyCObject_Check(pyobj))
+        o= ConvertFromPyObject&lt;PPointable*&gt;::convert(pyobj, print_traceback);
+    else
+        o= ConvertFromPyObject&lt;Object*&gt;::convert(pyobj, print_traceback);
+    PP&lt;T&gt; p(dynamic_cast&lt;T*&gt;(o));
+    if(!p)
+        PLPythonConversionError(&quot;ConvertFromPyObject&lt;PP&lt;T&gt; &gt;&quot;, pyobj,
+                                print_traceback);
+    return p;
+}
+
+template &lt;class T&gt;
 TVec&lt;T&gt; ConvertFromPyObject&lt; TVec&lt;T&gt; &gt;::convert(PyObject* pyobj, bool print_traceback)
 {
     PLASSERT( pyobj );
@@ -564,9 +612,16 @@
 }
 
 
+
 //#####  newPyObject Implementations  #########################################
 
 template &lt;class T&gt;
+PyObject* PythonObjectWrapper::newPyObject(const PP&lt;T&gt;&amp; data)
+{
+    return newPyObject(static_cast&lt;T*&gt;(data));
+}
+
+template &lt;class T&gt;
 PyObject* PythonObjectWrapper::newPyObject(const TVec&lt;T&gt;&amp; data)
 {
     PyObject* newlist = PyList_New(data.size());


Property changes on: trunk/plearn/python/test/.pytest/EmbeddedPython_Instances
___________________________________________________________________
Name: svn:ignore
   + .plearn
run_results


Added: trunk/plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results/RUN.log
===================================================================
--- trunk/plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results/RUN.log	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results/RUN.log	2007-05-09 23:44:20 UTC (rev 7042)
@@ -0,0 +1,479 @@
+ WARNING: Cholesky decomposition would fail: add 1.79937e-16 to diagonal
+ WARNING: Cholesky decomposition would fail: add 4.15126e-12 to diagonal
+use result= [[ 144.90670482]
+ [ 418.68662628]]
+include_bias &lt;type 'bool'&gt; True
+cholesky &lt;type 'bool'&gt; True
+weight_decay &lt;type 'float'&gt; 0.0
+output_learned_weights &lt;type 'bool'&gt; False
+weights &lt;class 'numarray.numarraycore.NumArray'&gt; [[  2.19604274]
+ [ -1.0415409 ]
+ [-39.57186813]
+ [ 16.80245046]
+ [  4.3526955 ]]
+AIC &lt;type 'float'&gt; -16.4363107086
+BIC &lt;type 'float'&gt; -17.9386235608
+resid_variance &lt;class 'numarray.numarraycore.NumArray'&gt; [ -3.91810318e-09]
+expdir &lt;type 'str'&gt; 
+seed &lt;type 'long'&gt; 1827
+stage &lt;type 'int'&gt; 0
+n_examples &lt;type 'int'&gt; 3
+inputsize &lt;type 'int'&gt; 4
+targetsize &lt;type 'int'&gt; 1
+weightsize &lt;type 'int'&gt; 0
+forget_when_training_set_changes &lt;type 'bool'&gt; False
+nstages &lt;type 'int'&gt; 1
+report_progress &lt;type 'bool'&gt; True
+verbosity &lt;type 'int'&gt; 1
+nservers &lt;type 'int'&gt; 0
+save_trainingset_prefix &lt;type 'str'&gt; 
+parallelize_here &lt;type 'bool'&gt; True
+master_sends_testset_rows &lt;type 'bool'&gt; False
+*1 -&gt;LinearRegressor(
+include_bias = 1 ;
+cholesky = 1 ;
+weight_decay = 0 ;
+output_learned_weights = 0 ;
+weights = 5  1  [ 
+2.19604273868088962 	
+-1.04154089689183138 	
+-39.5718681295575294 	
+16.8024504629067799 	
+4.35269550398104066 	
+]
+;
+AIC = -16.4363107085968032 ;
+BIC = -17.9386235608166196 ;
+resid_variance = 1 [ -3.91810317523777485e-09 ] ;
+stage = 0 ;
+n_examples = 3 ;
+inputsize = 4 ;
+targetsize = 1 ;
+weightsize = 0 ;
+forget_when_training_set_changes = 0 ;
+nstages = 1 ;
+report_progress = 1 ;
+verbosity = 1 ;
+nservers = 0 ;
+save_trainingset_prefix = &quot;&quot;  )
+expdir &lt;type 'str'&gt; 
+dataset &lt;class 'numarray.numarraycore.NumArray'&gt; []
+splitter &lt;class 'TrainTestSplitter'&gt; *1 -&gt;TrainTestSplitter(
+append_train = 0 ;
+calc_with_pct = 1 ;
+test_fraction = 0 ;
+test_fraction_abs = 0 ;
+shuffle_seed = -1  )
+statnames &lt;type 'list'&gt; []
+statmask &lt;type 'list'&gt; []
+learner &lt;class 'LinearRegressor'&gt; *1 -&gt;LinearRegressor(
+include_bias = 1 ;
+cholesky = 1 ;
+weight_decay = 0 ;
+output_learned_weights = 0 ;
+weights = 5  1  [ 
+2.19604273868088962 	
+-1.04154089689183138 	
+-39.5718681295575294 	
+16.8024504629067799 	
+4.35269550398104066 	
+]
+;
+AIC = -16.4363107085968032 ;
+BIC = -17.9386235608166196 ;
+resid_variance = 1 [ -3.91810317523777485e-09 ] ;
+stage = 0 ;
+n_examples = 3 ;
+inputsize = 4 ;
+targetsize = 1 ;
+weightsize = 0 ;
+forget_when_training_set_changes = 0 ;
+nstages = 1999 ;
+report_progress = 1 ;
+verbosity = 1 ;
+nservers = 0 ;
+save_trainingset_prefix = &quot;&quot;  )
+perf_evaluators &lt;type 'dict'&gt; {}
+report_stats &lt;type 'bool'&gt; True
+save_initial_tester &lt;type 'bool'&gt; True
+save_stat_collectors &lt;type 'bool'&gt; True
+save_learners &lt;type 'bool'&gt; True
+save_initial_learners &lt;type 'bool'&gt; False
+save_data_sets &lt;type 'bool'&gt; False
+save_test_outputs &lt;type 'bool'&gt; False
+call_forget_in_run &lt;type 'bool'&gt; True
+save_test_costs &lt;type 'bool'&gt; False
+provide_learner_expdir &lt;type 'bool'&gt; False
+should_train &lt;type 'bool'&gt; True
+train &lt;type 'bool'&gt; True
+should_test &lt;type 'bool'&gt; True
+template_stats_collector &lt;type 'NoneType'&gt; None
+global_template_stats_collector &lt;type 'NoneType'&gt; None
+final_commands &lt;type 'list'&gt; ['allo', 'allo']
+save_test_confidence &lt;type 'bool'&gt; False
+enforce_clean_expdir &lt;type 'bool'&gt; True
+parallelize_here &lt;type 'bool'&gt; True
+*1 -&gt;PTester(
+expdir = &quot;&quot; ;
+dataset = *0 ;
+splitter = *2 -&gt;TrainTestSplitter(
+append_train = 0 ;
+calc_with_pct = 1 ;
+test_fraction = 0 ;
+test_fraction_abs = 0 ;
+shuffle_seed = -1  )
+;
+statnames = []
+;
+statmask = []
+;
+learner = *3 -&gt;LinearRegressor(
+include_bias = 1 ;
+cholesky = 1 ;
+weight_decay = 0 ;
+output_learned_weights = 0 ;
+weights = 5  1  [ 
+2.19604273868088962 	
+-1.04154089689183138 	
+-39.5718681295575294 	
+16.8024504629067799 	
+4.35269550398104066 	
+]
+;
+AIC = -16.4363107085968032 ;
+BIC = -17.9386235608166196 ;
+resid_variance = 1 [ -3.91810317523777485e-09 ] ;
+stage = 0 ;
+n_examples = 3 ;
+inputsize = 4 ;
+targetsize = 1 ;
+weightsize = 0 ;
+forget_when_training_set_changes = 0 ;
+nstages = 1999 ;
+report_progress = 1 ;
+verbosity = 1 ;
+nservers = 0 ;
+save_trainingset_prefix = &quot;&quot;  )
+;
+perf_evaluators = {};
+report_stats = 1 ;
+save_initial_tester = 1 ;
+save_stat_collectors = 1 ;
+save_learners = 1 ;
+save_initial_learners = 0 ;
+save_data_sets = 0 ;
+save_test_outputs = 0 ;
+call_forget_in_run = 1 ;
+save_test_costs = 0 ;
+provide_learner_expdir = 0 ;
+should_train = 1 ;
+should_test = 1 ;
+template_stats_collector = *0 ;
+global_template_stats_collector = *0 ;
+final_commands = 2 [ &quot;allo&quot; &quot;allo&quot; ] ;
+save_test_confidence = 0 ;
+enforce_clean_expdir = 1  )
+recTest	1900
+testRec 1900
+recTest	1800
+testRec 1800
+recTest	1700
+testRec 1700
+recTest	1600
+testRec 1600
+recTest	1500
+testRec 1500
+recTest	1400
+testRec 1400
+recTest	1300
+testRec 1300
+recTest	1200
+testRec 1200
+recTest	1100
+testRec 1100
+recTest	1000
+testRec 1000
+recTest	900
+testRec 900
+recTest	800
+testRec 800
+recTest	700
+testRec 700
+recTest	600
+testRec 600
+recTest	500
+testRec 500
+recTest	400
+testRec 400
+recTest	300
+testRec 300
+recTest	200
+testRec 200
+recTest	100
+testRec 100
+recTest	0
+FINI! []
+recTest2	1900	nrefs=102
+testRec2 1900
+recTest2	1800	nrefs=202
+testRec2 1800
+recTest2	1700	nrefs=302
+testRec2 1700
+recTest2	1600	nrefs=402
+testRec2 1600
+recTest2	1500	nrefs=502
+testRec2 1500
+recTest2	1400	nrefs=602
+testRec2 1400
+recTest2	1300	nrefs=702
+testRec2 1300
+recTest2	1200	nrefs=802
+testRec2 1200
+recTest2	1100	nrefs=902
+testRec2 1100
+recTest2	1000	nrefs=1002
+testRec2 1000
+recTest2	900	nrefs=1102
+testRec2 900
+recTest2	800	nrefs=1202
+testRec2 800
+recTest2	700	nrefs=1302
+testRec2 700
+recTest2	600	nrefs=1402
+testRec2 600
+recTest2	500	nrefs=1502
+testRec2 500
+recTest2	400	nrefs=1602
+testRec2 400
+recTest2	300	nrefs=1702
+testRec2 300
+recTest2	200	nrefs=1802
+testRec2 200
+recTest2	100	nrefs=1902
+testRec2 100
+recTest2	0	nrefs=2002
+FINI!2 []
+testRecCrash 3
+recTestCrash	2
+testRecCrash 1
+recTestCrash	0
+FINI! []
+[INTENDED ERROR] Caught Python Exception: 'Exception
+Python 2.X.Y: /usr/bin/python
+
+
+A problem occurred in a Python script.  Here is the sequence of
+function calls leading up to the error, in the order they occurred.
+
+ test_embedded_code_snippet.py in testRecCrash(self=&lt;plearn.pybridge.test_embedded_code_snippet.Machin object&gt;, n=3)
+   68             print &quot;testRecCrash&quot;,n
+   69             sys.stdout.flush()
+   70             self.recTestCrash(n-1)
+   71 
+   72     def fini(self):
+
+Exception: Exception
+Python 2.X.Y: /usr/bin/python
+
+
+A problem occurred in a Python script.  Here is the sequence of
+function calls leading up to the error, in the order they occurred.
+
+ test_embedded_code_snippet.py in testRecCrash(self=&lt;plearn.pybridge.test_embedded_code_snippet.Machin object&gt;, n=1)
+   68             print &quot;testRecCrash&quot;,n
+   69             sys.stdout.flush()
+   70             self.recTestCrash(n-1)
+   71 
+   72     def fini(self):
+
+Exception: RuntimeError
+Python 2.X.Y: /usr/bin/python
+
+
+A problem occurred in a Python script.  Here is the sequence of
+function calls leading up to the error, in the order they occurred.
+
+ test_embedded_code_snippet.py in testRecCrash(self=&lt;plearn.pybridge.test_embedded_code_snippet.Machin object&gt;, n=-1)
+   64             print 'FINI!', gc.garbage
+   65             sys.stdout.flush()
+   66             raise RuntimeError, 'Crash on purpose: test'
+   67         else:
+   68             print &quot;testRecCrash&quot;,n
+
+RuntimeError: Crash on purpose: test
+    __doc__ = 'Unspecified run-time error.'
+    __getitem__ = &lt;bound method RuntimeError.__getitem__ of &lt;exceptions.RuntimeError instance&gt;&gt;
+    __init__ = &lt;bound method RuntimeError.__init__ of &lt;exceptions.RuntimeError instance&gt;&gt;
+    __module__ = 'exceptions'
+    __str__ = &lt;bound method RuntimeError.__str__ of &lt;exceptions.RuntimeError instance&gt;&gt;
+    args = ('Crash on purpose: test',)
+
+The above is a description of an error in a Python program.  Here is
+the original traceback:
+
+Traceback (most recent call last):
+  File &quot;/home/saintmlx/PLearn/python_modules/plearn/pybridge/test_embedded_code_snippet.py&quot;, line 66, in testRecCrash
+    raise RuntimeError, 'Crash on purpose: test'
+RuntimeError: Crash on purpose: test
+
+Error while calling function 'testRecCrash' with 1 params.
+    __doc__ = 'Common base class for all exceptions.'
+    __getitem__ = &lt;bound method Exception.__getitem__ of &lt;exceptions.Exception instance&gt;&gt;
+    __init__ = &lt;bound method Exception.__init__ of &lt;exceptions.Exception instance&gt;&gt;
+    __module__ = 'exceptions'
+    __str__ = &lt;bound method Exception.__str__ of &lt;exceptions.Exception instance&gt;&gt;
+    args = (&quot;RuntimeError\nPython 2.X.Y: /usr/bin/python\n\n\nA p...le calling function 'testRecCrash' with 1 params.&quot;,)
+
+The above is a description of an error in a Python program.  Here is
+the original traceback:
+
+Traceback (most recent call last):
+  File &quot;/home/saintmlx/PLearn/python_modules/plearn/pybridge/test_embedded_code_snippet.py&quot;, line 70, in testRecCrash
+    self.recTestCrash(n-1)
+Exception: RuntimeError
+Python 2.X.Y: /usr/bin/python
+
+
+A problem occurred in a Python script.  Here is the sequence of
+function calls leading up to the error, in the order they occurred.
+
+ test_embedded_code_snippet.py in testRecCrash(self=&lt;plearn.pybridge.test_embedded_code_snippet.Machin object&gt;, n=-1)
+   64             print 'FINI!', gc.garbage
+   65             sys.stdout.flush()
+   66             raise RuntimeError, 'Crash on purpose: test'
+   67         else:
+   68             print &quot;testRecCrash&quot;,n
+
+RuntimeError: Crash on purpose: test
+    __doc__ = 'Unspecified run-time error.'
+    __getitem__ = &lt;bound method RuntimeError.__getitem__ of &lt;exceptions.RuntimeError instance&gt;&gt;
+    __init__ = &lt;bound method RuntimeError.__init__ of &lt;exceptions.RuntimeError instance&gt;&gt;
+    __module__ = 'exceptions'
+    __str__ = &lt;bound method RuntimeError.__str__ of &lt;exceptions.RuntimeError instance&gt;&gt;
+    args = ('Crash on purpose: test',)
+
+The above is a description of an error in a Python program.  Here is
+the original traceback:
+
+Traceback (most recent call last):
+  File &quot;/home/saintmlx/PLearn/python_modules/plearn/pybridge/test_embedded_code_snippet.py&quot;, line 66, in testRecCrash
+    raise RuntimeError, 'Crash on purpose: test'
+RuntimeError: Crash on purpose: test
+
+Error while calling function 'testRecCrash' with 1 params.
+
+Error while calling function 'testRecCrash' with 1 params.
+    __doc__ = 'Common base class for all exceptions.'
+    __getitem__ = &lt;bound method Exception.__getitem__ of &lt;exceptions.Exception instance&gt;&gt;
+    __init__ = &lt;bound method Exception.__init__ of &lt;exceptions.Exception instance&gt;&gt;
+    __module__ = 'exceptions'
+    __str__ = &lt;bound method Exception.__str__ of &lt;exceptions.Exception instance&gt;&gt;
+    args = (&quot;Exception\nPython 2.X.Y: /usr/bin/python\n\n\nA prob...le calling function 'testRecCrash' with 1 params.&quot;,)
+
+The above is a description of an error in a Python program.  Here is
+the original traceback:
+
+Traceback (most recent call last):
+  File &quot;/home/saintmlx/PLearn/python_modules/plearn/pybridge/test_embedded_code_snippet.py&quot;, line 70, in testRecCrash
+    self.recTestCrash(n-1)
+Exception: Exception
+Python 2.X.Y: /usr/bin/python
+
+
+A problem occurred in a Python script.  Here is the sequence of
+function calls leading up to the error, in the order they occurred.
+
+ test_embedded_code_snippet.py in testRecCrash(self=&lt;plearn.pybridge.test_embedded_code_snippet.Machin object&gt;, n=1)
+   68             print &quot;testRecCrash&quot;,n
+   69             sys.stdout.flush()
+   70             self.recTestCrash(n-1)
+   71 
+   72     def fini(self):
+
+Exception: RuntimeError
+Python 2.X.Y: /usr/bin/python
+
+
+A problem occurred in a Python script.  Here is the sequence of
+function calls leading up to the error, in the order they occurred.
+
+ test_embedded_code_snippet.py in testRecCrash(self=&lt;plearn.pybridge.test_embedded_code_snippet.Machin object&gt;, n=-1)
+   64             print 'FINI!', gc.garbage
+   65             sys.stdout.flush()
+   66             raise RuntimeError, 'Crash on purpose: test'
+   67         else:
+   68             print &quot;testRecCrash&quot;,n
+
+RuntimeError: Crash on purpose: test
+    __doc__ = 'Unspecified run-time error.'
+    __getitem__ = &lt;bound method RuntimeError.__getitem__ of &lt;exceptions.RuntimeError instance&gt;&gt;
+    __init__ = &lt;bound method RuntimeError.__init__ of &lt;exceptions.RuntimeError instance&gt;&gt;
+    __module__ = 'exceptions'
+    __str__ = &lt;bound method RuntimeError.__str__ of &lt;exceptions.RuntimeError instance&gt;&gt;
+    args = ('Crash on purpose: test',)
+
+The above is a description of an error in a Python program.  Here is
+the original traceback:
+
+Traceback (most recent call last):
+  File &quot;/home/saintmlx/PLearn/python_modules/plearn/pybridge/test_embedded_code_snippet.py&quot;, line 66, in testRecCrash
+    raise RuntimeError, 'Crash on purpose: test'
+RuntimeError: Crash on purpose: test
+
+Error while calling function 'testRecCrash' with 1 params.
+    __doc__ = 'Common base class for all exceptions.'
+    __getitem__ = &lt;bound method Exception.__getitem__ of &lt;exceptions.Exception instance&gt;&gt;
+    __init__ = &lt;bound method Exception.__init__ of &lt;exceptions.Exception instance&gt;&gt;
+    __module__ = 'exceptions'
+    __str__ = &lt;bound method Exception.__str__ of &lt;exceptions.Exception instance&gt;&gt;
+    args = (&quot;RuntimeError\nPython 2.X.Y: /usr/bin/python\n\n\nA p...le calling function 'testRecCrash' with 1 params.&quot;,)
+
+The above is a description of an error in a Python program.  Here is
+the original traceback:
+
+Traceback (most recent call last):
+  File &quot;/home/saintmlx/PLearn/python_modules/plearn/pybridge/test_embedded_code_snippet.py&quot;, line 70, in testRecCrash
+    self.recTestCrash(n-1)
+Exception: RuntimeError
+Python 2.X.Y: /usr/bin/python
+
+
+A problem occurred in a Python script.  Here is the sequence of
+function calls leading up to the error, in the order they occurred.
+
+ test_embedded_code_snippet.py in testRecCrash(self=&lt;plearn.pybridge.test_embedded_code_snippet.Machin object&gt;, n=-1)
+   64             print 'FINI!', gc.garbage
+   65             sys.stdout.flush()
+   66             raise RuntimeError, 'Crash on purpose: test'
+   67         else:
+   68             print &quot;testRecCrash&quot;,n
+
+RuntimeError: Crash on purpose: test
+    __doc__ = 'Unspecified run-time error.'
+    __getitem__ = &lt;bound method RuntimeError.__getitem__ of &lt;exceptions.RuntimeError instance&gt;&gt;
+    __init__ = &lt;bound method RuntimeError.__init__ of &lt;exceptions.RuntimeError instance&gt;&gt;
+    __module__ = 'exceptions'
+    __str__ = &lt;bound method RuntimeError.__str__ of &lt;exceptions.RuntimeError instance&gt;&gt;
+    args = ('Crash on purpose: test',)
+
+The above is a description of an error in a Python program.  Here is
+the original traceback:
+
+Traceback (most recent call last):
+  File &quot;/home/saintmlx/PLearn/python_modules/plearn/pybridge/test_embedded_code_snippet.py&quot;, line 66, in testRecCrash
+    raise RuntimeError, 'Crash on purpose: test'
+RuntimeError: Crash on purpose: test
+
+Error while calling function 'testRecCrash' with 1 params.
+
+Error while calling function 'testRecCrash' with 1 params.
+
+Error while calling function 'testRecCrash' with 1 params.'
+refs0: 1
+refs1: 1
+nrefs 1010 1
+self 12
+learner 0
+testRec 0
+recTest 2
+1010 1

Added: trunk/plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results/linreg.psave
===================================================================
--- trunk/plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results/linreg.psave	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/python/test/.pytest/EmbeddedPython_Instances/expected_results/linreg.psave	2007-05-09 23:44:20 UTC (rev 7042)
@@ -0,0 +1,27 @@
+LinearRegressor(
+include_bias = 1 ;
+cholesky = 1 ;
+weight_decay = 0 ;
+output_learned_weights = 0 ;
+weights = 5  1  [ 
+2.19604273868088962 	
+-1.04154089689183138 	
+-39.5718681295575294 	
+16.8024504629067799 	
+4.35269550398104066 	
+]
+;
+AIC = -16.4363107085968032 ;
+BIC = -17.9386235608166196 ;
+resid_variance = 1 [ -3.91810317523777485e-09 ] ;
+stage = 0 ;
+n_examples = 3 ;
+inputsize = 4 ;
+targetsize = 1 ;
+weightsize = 0 ;
+forget_when_training_set_changes = 0 ;
+nstages = 1 ;
+report_progress = 1 ;
+verbosity = 1 ;
+nservers = 0 ;
+save_trainingset_prefix = &quot;&quot;  )

Modified: trunk/plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results/RUN.log
===================================================================
--- trunk/plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results/RUN.log	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/python/test/.pytest/EmbeddedPython_InterfunctionXchg/expected_results/RUN.log	2007-05-09 23:44:20 UTC (rev 7042)
@@ -40,7 +40,7 @@
   File &quot;&lt;string&gt;&quot;, line 12, in get_value
 NameError: global name 'buf' is not defined
 
-'
+Error while calling function 'get_value' with no params.'
 Associated 'some_global_map' with: {Oui: 16, bon: 512, est: 64, et: 256, il: 32, juste: 128}
 Read back from Python environment: {Oui: 16, bon: 512, est: 64, et: 256, il: 32, juste: 128}
 Printing some_global_map within Python: {'Oui': 16L, 'est': 64L, 'juste': 128L, 'il': 32L, 'bon': 512L, 'et': 256L}

Added: trunk/plearn/python/test/InstanceSnippetTest.cc
===================================================================
--- trunk/plearn/python/test/InstanceSnippetTest.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/python/test/InstanceSnippetTest.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -0,0 +1,221 @@
+// -*- C++ -*-
+
+// InstanceSnippetTest.cc
+//
+// Copyright (C) 2007 Xavier Saint-Mleux, ApSTAT Technologies inc.
+//
+// Redistribution and use in source and binary forms, with or without
+// modification, are permitted provided that the following conditions are met:
+//
+//  1. Redistributions of source code must retain the above copyright
+//     notice, this list of conditions and the following disclaimer.
+//
+//  2. Redistributions in binary form must reproduce the above copyright
+//     notice, this list of conditions and the following disclaimer in the
+//     documentation and/or other materials provided with the distribution.
+//
+//  3. The name of the authors may not be used to endorse or promote
+//     products derived from this software without specific prior written
+//     permission.
+//
+// THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR
+// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+// OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
+// NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+// TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+//
+// This file is part of the PLearn library. For more information on the PLearn
+// library, go to the PLearn Web site at www.plearn.org
+
+// Authors: Xavier Saint-Mleux
+
+/*! \file InstanceSnippetTest.cc */
+
+
+#include &quot;InstanceSnippetTest.h&quot;
+#include &lt;plearn_learners/testers/PTester.h&gt;
+#include &lt;plearn/vmat/TrainTestSplitter.h&gt;
+#include &lt;plearn/sys/procinfo.h&gt;
+#include &lt;boost/regex.hpp&gt;
+
+namespace PLearn {
+using namespace std;
+
+PLEARN_IMPLEMENT_OBJECT(
+    InstanceSnippetTest,
+    &quot;ONE LINE USER DESCRIPTION&quot;,
+    &quot;MULTI LINE\nHELP FOR USERS&quot;
+);
+
+//////////////////
+// InstanceSnippetTest //
+//////////////////
+InstanceSnippetTest::InstanceSnippetTest()
+    /* ### Initialize all fields to their default value */
+{
+    // ...
+
+    // ### You may (or not) want to call build_() to finish building the object
+    // ### (doing so assumes the parent classes' build_() have been called too
+    // ### in the parent classes' constructors, something that you must ensure)
+}
+
+///////////
+// build //
+///////////
+void InstanceSnippetTest::build()
+{
+    inherited::build();
+    build_();
+}
+
+/////////////////////////////////
+// makeDeepCopyFromShallowCopy //
+/////////////////////////////////
+void InstanceSnippetTest::makeDeepCopyFromShallowCopy(CopiesMap&amp; copies)
+{
+    inherited::makeDeepCopyFromShallowCopy(copies);
+
+    // ### Call deepCopyField on all &quot;pointer-like&quot; fields
+    // ### that you wish to be deepCopied rather than
+    // ### shallow-copied.
+    // ### ex:
+    // deepCopyField(trainvec, copies);
+
+    // ### Remove this line when you have fully implemented this method.
+    PLERROR(&quot;InstanceSnippetTest::makeDeepCopyFromShallowCopy not fully (correctly) implemented yet!&quot;);
+}
+
+////////////////////
+// declareOptions //
+////////////////////
+void InstanceSnippetTest::declareOptions(OptionList&amp; ol)
+{
+    // ### Declare all of this object's options here.
+    // ### For the &quot;flags&quot; of each option, you should typically specify
+    // ### one of OptionBase::buildoption, OptionBase::learntoption or
+    // ### OptionBase::tuningoption. If you don't provide one of these three,
+    // ### this option will be ignored when loading values from a script.
+    // ### You can also combine flags, for example with OptionBase::nosave:
+    // ### (OptionBase::buildoption | OptionBase::nosave)
+
+    // ### ex:
+    // declareOption(ol, &quot;myoption&quot;, &amp;InstanceSnippetTest::myoption,
+    //               OptionBase::buildoption,
+    //               &quot;Help text describing this option&quot;);
+    // ...
+
+    // Now call the parent class' declareOptions
+    inherited::declareOptions(ol);
+}
+
+////////////
+// build_ //
+////////////
+void InstanceSnippetTest::build_()
+{
+    // ### This method should do the real building of the object,
+    // ### according to set 'options', in *any* situation.
+    // ### Typical situations include:
+    // ###  - Initial building of an object from a few user-specified options
+    // ###  - Building of a &quot;reloaded&quot; object: i.e. from the complete set of
+    // ###    all serialised options.
+    // ###  - Updating or &quot;re-building&quot; of an object after a few &quot;tuning&quot;
+    // ###    options have been modified.
+    // ### You should assume that the parent class' build_() has already been
+    // ### called.
+}
+
+/////////////
+// perform //
+/////////////
+void InstanceSnippetTest::perform()
+{
+    TestSnippet zz1;
+    zz1.build();
+
+    int n= zz1.invoke(&quot;getN&quot;);
+
+    zz1.invoke(&quot;test0&quot;);
+    
+    PP&lt;PTester&gt; t= new PTester();//on heap, please
+    t-&gt;final_commands= TVec&lt;string&gt;(2, &quot;allo&quot;);
+    t-&gt;splitter= new TrainTestSplitter();
+    t-&gt;learner= zz1.ll;
+    zz1.invoke(&quot;chkObj&quot;, t);
+
+    zz1.invoke(&quot;testRec&quot;, n);
+    zz1.invoke(&quot;testRec2&quot;, (Object*)zz1.ll);
+
+    try
+    {
+        zz1.invoke(&quot;testRecCrash&quot;, 3);
+    }
+    catch(const PLearnError&amp; e)
+    {
+        string exception_msg = e.message();
+        // Remove memory addresses from the exception message, as they may
+        // differ from one computer to another, causing the test to fail.
+        boost::regex memory_adr(&quot;0x[abcdef0123456789]{6,}&quot;,
+                                boost::regex::perl|boost::regex::icase);
+        string msg_without_sys_dependent_data =
+            regex_replace(exception_msg, memory_adr,
+                    &quot;0x[memory_address]&quot;);
+        boost::regex python_ver(&quot;Python 2\\.[0-9]\\.[0-9]&quot;,
+                                boost::regex::perl|boost::regex::icase);
+        msg_without_sys_dependent_data =
+            regex_replace(msg_without_sys_dependent_data, python_ver,
+                    &quot;Python 2.X.Y&quot;);
+        pout &lt;&lt; &quot;[INTENDED ERROR] Caught Python Exception: '&quot; 
+             &lt;&lt; msg_without_sys_dependent_data
+             &lt;&lt; &quot;'&quot; &lt;&lt; endl;
+    }
+
+    PythonCodeSnippet zz2(&quot;\nimport gc\n&quot;
+                          &quot;gc.collect()\n&quot;
+                          &quot;print 'nrefs 1010', len(gc.get_referrers(1010))\n&quot;);
+    zz2.build();
+
+    TVec&lt;PyObject*&gt; refs= zz1.invoke(&quot;getRecTestReferrers&quot;);
+
+    pout &lt;&lt; &quot;refs0: &quot; &lt;&lt; (refs[0] == zz1.m_compiled_code.getPyObject()) &lt;&lt; endl;
+    PyObject* dic= PyObject_GetAttrString(zz1.m_instance.getPyObject(), &quot;__dict__&quot;);
+    pout &lt;&lt; &quot;refs1: &quot; &lt;&lt; (refs[1] ==  dic) &lt;&lt; endl;
+    Py_DECREF(dic);
+
+
+#ifndef PYTEST_ACTIVE
+    for(int i= 0; i &lt; 1000; ++i)
+    {
+        zz1.invoke(&quot;testRec&quot;, n);
+        zz1.ll-&gt;nstages= n;
+        zz1.invoke(&quot;testRec2&quot;, (Object*)zz1.ll);
+        pout &lt;&lt; &quot;at iter &quot; &lt;&lt; i &lt;&lt; &quot;\t: &quot; &lt;&lt; getProcessDataMemory() &lt;&lt; endl;
+    }
+#endif //ndef PYTEST_ACTIVE
+
+
+
+    zz1.invoke(&quot;fini&quot;);
+
+}
+
+} // end of namespace PLearn
+
+
+/*
+  Local Variables:
+  mode:c++
+  c-basic-offset:4
+  c-file-style:&quot;stroustrup&quot;
+  c-file-offsets:((innamespace . 0)(inline-open . 0))
+  indent-tabs-mode:nil
+  fill-column:79
+  End:
+*/
+// vim: filetype=cpp:expandtab:shiftwidth=4:tabstop=8:softtabstop=4:encoding=utf-8:textwidth=79 :

Added: trunk/plearn/python/test/InstanceSnippetTest.h
===================================================================
--- trunk/plearn/python/test/InstanceSnippetTest.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/python/test/InstanceSnippetTest.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -0,0 +1,214 @@
+// -*- C++ -*-
+
+// InstanceSnippetTest.h
+//
+// Copyright (C) 2007 Xavier Saint-Mleux, ApSTAT Technologies inc.
+//
+// Redistribution and use in source and binary forms, with or without
+// modification, are permitted provided that the following conditions are met:
+//
+//  1. Redistributions of source code must retain the above copyright
+//     notice, this list of conditions and the following disclaimer.
+//
+//  2. Redistributions in binary form must reproduce the above copyright
+//     notice, this list of conditions and the following disclaimer in the
+//     documentation and/or other materials provided with the distribution.
+//
+//  3. The name of the authors may not be used to endorse or promote
+//     products derived from this software without specific prior written
+//     permission.
+//
+// THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR
+// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+// OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
+// NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+// TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+//
+// This file is part of the PLearn library. For more information on the PLearn
+// library, go to the PLearn Web site at www.plearn.org
+
+// Authors: Xavier Saint-Mleux
+
+/*! \file InstanceSnippetTest.h */
+
+
+#ifndef InstanceSnippetTest_INC
+#define InstanceSnippetTest_INC
+
+#include &lt;plearn/python/PythonCodeSnippet.h&gt; //python includes have to come first
+#include &lt;pytest/defines.h&gt;
+#include &lt;plearn/misc/PTest.h&gt;
+#include &lt;plearn_learners/regressors/LinearRegressor.h&gt;
+
+
+namespace PLearn {
+
+/**
+ * The first sentence should be a BRIEF DESCRIPTION of what the class does.
+ * Place the rest of the class programmer documentation here.  Doxygen supports
+ * Javadoc-style comments.  See <A HREF="http://www.doxygen.org/manual.html">http://www.doxygen.org/manual.html</A>
+ *
+ * @todo Write class to-do's here if there are any.
+ *
+ * @deprecated Write deprecated stuff here if there is any.  Indicate what else
+ * should be used instead.
+ */
+
+class TestSnippet : public PythonCodeSnippet
+{
+public:
+    typedef PythonCodeSnippet inherited;
+    
+    PP&lt;PLearner&gt; ll;
+
+    TestSnippet(const string&amp; xtra= &quot;&quot;)
+        :PythonCodeSnippet(string(&quot;from plearn.pybridge.test_embedded_code_snippet import *\n&quot;)
+                           + xtra,
+                           true),
+         ll(new LinearRegressor())
+    {}
+
+    virtual void build()
+    {
+        inherited::build();
+        build_();
+    }
+
+    void build_()
+    {
+        inject(&quot;getLearner&quot;, this, &amp;TestSnippet::getLearner);
+        inject(&quot;recTest&quot;, this, &amp;TestSnippet::recTest);
+        inject(&quot;recTest2&quot;, this, &amp;TestSnippet::recTest2);
+        inject(&quot;recTestCrash&quot;, this, &amp;TestSnippet::recTestCrash);
+    }
+
+    PythonObjectWrapper getLearner(const TVec&lt;PythonObjectWrapper&gt;&amp; args)
+    {
+        Object* p= ll;
+        return PythonObjectWrapper(p);
+    }
+
+    PythonObjectWrapper recTest(const TVec&lt;PythonObjectWrapper&gt;&amp; args)
+    {
+        int n= args[0];
+        if(n%100 == 0)
+            pout &lt;&lt; &quot;recTest\t&quot; &lt;&lt; n &lt;&lt; endl;
+        invoke(&quot;testRec&quot;, args);
+        return PythonObjectWrapper(n);
+    }
+
+    PythonObjectWrapper recTest2(const TVec&lt;PythonObjectWrapper&gt;&amp; args)
+    {
+        PP&lt;PLearner&gt; l= args[0];
+        --l-&gt;nstages;
+        if(l-&gt;nstages%100 == 0)
+            pout &lt;&lt; &quot;recTest2\t&quot; &lt;&lt; l-&gt;nstages &lt;&lt; &quot;\tnrefs=&quot; &lt;&lt; l-&gt;usage() &lt;&lt; endl;
+        invoke(&quot;testRec2&quot;, args);
+        return args[0];
+    }
+
+    PythonObjectWrapper recTestCrash(const TVec&lt;PythonObjectWrapper&gt;&amp; args)
+    {
+        int n= args[0];
+        pout &lt;&lt; &quot;recTestCrash\t&quot; &lt;&lt; n &lt;&lt; endl;
+        invoke(&quot;testRecCrash&quot;, n-1);
+        return PythonObjectWrapper();
+    }
+
+
+};
+
+
+class InstanceSnippetTest : public PTest
+{
+    typedef PTest inherited;
+
+public:
+    //#####  Public Build Options  ############################################
+
+    // ### declare public option fields (such as build options) here
+    // Start your comments with Doxygen-compatible comments such as //!
+    // ### Typically, a PTest options are used to store the test results.
+
+
+public:
+    //#####  Public Member Functions  #########################################
+
+    //! Default constructor
+    // ### Make sure the implementation in the .cc
+    // ### initializes all fields to reasonable default values.
+    InstanceSnippetTest();
+
+    // Your other public member functions go here
+
+
+    //#####  PLearn::Object Protocol  #########################################
+
+    // Declares other standard object methods.
+    // ### If your class is not instantiatable (it has pure virtual methods)
+    // ### you should replace this by PLEARN_DECLARE_ABSTRACT_OBJECT
+    PLEARN_DECLARE_OBJECT(InstanceSnippetTest);
+
+    // Simply calls inherited::build() then build_()
+    virtual void build();
+
+    //! Transforms a shallow copy into a deep copy
+    // (PLEASE IMPLEMENT IN .cc)
+    virtual void makeDeepCopyFromShallowCopy(CopiesMap&amp; copies);
+
+    //#####  PLearn::PTest Protocol  ##########################################
+
+    //! The method performing the test. A typical test consists in some output
+    //! (to pout and / or perr), and updates of this object's options.
+    virtual void perform();
+
+protected:
+    //#####  Protected Options  ###############################################
+
+    // ### Declare protected option fields (such as learned parameters) here
+    // ...
+
+protected:
+    //#####  Protected Member Functions  ######################################
+
+    //! Declares the class options.
+    // (PLEASE IMPLEMENT IN .cc)
+    static void declareOptions(OptionList&amp; ol);
+
+private:
+    //#####  Private Member Functions  ########################################
+
+    //! This does the actual building.
+    // (PLEASE IMPLEMENT IN .cc)
+    void build_();
+
+private:
+    //#####  Private Data Members  ############################################
+
+    // The rest of the private stuff goes here
+};
+
+// Declares a few other classes and functions related to this class
+DECLARE_OBJECT_PTR(InstanceSnippetTest);
+
+} // end of namespace PLearn
+
+#endif
+
+
+/*
+  Local Variables:
+  mode:c++
+  c-basic-offset:4
+  c-file-style:&quot;stroustrup&quot;
+  c-file-offsets:((innamespace . 0)(inline-open . 0))
+  indent-tabs-mode:nil
+  fill-column:79
+  End:
+*/
+// vim: filetype=cpp:expandtab:shiftwidth=4:tabstop=8:softtabstop=4:encoding=utf-8:textwidth=79 :

Modified: trunk/plearn/python/test/pytest.config
===================================================================
--- trunk/plearn/python/test/pytest.config	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/python/test/pytest.config	2007-05-09 23:44:20 UTC (rev 7042)
@@ -92,6 +92,7 @@
     bool
     
 &quot;&quot;&quot;
+
 Test(
     name = &quot;EmbeddedPython_BasicIdentityCalls&quot;,
     description = &quot;Tests the core of PythonCodeSnippet through identity function calls in Python&quot;,
@@ -181,3 +182,18 @@
     pfileprg = &quot;__program__&quot;,
     disabled = False
     )
+
+Test(
+    name = &quot;EmbeddedPython_Instances&quot;,
+    description = &quot;Tests PythonCodeSnippet w/instances and PythonObjectWrapper&quot;,
+    category = &quot;General&quot;,
+    program = Program(
+        name = &quot;plearn_tests&quot;,
+        compiler = &quot;pymake&quot;
+        ),
+    arguments = &quot;PLEARNDIR:scripts/command_line_object.plearn \&quot;object=InstanceSnippetTest(save = 0)\&quot;&quot;,
+    resources = [ ],
+    precision = 1e-06,
+    pfileprg = &quot;__program__&quot;,
+    disabled = False
+    )

Modified: trunk/plearn/var/Func.h
===================================================================
--- trunk/plearn/var/Func.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/var/Func.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -33,21 +33,16 @@
 // This file is part of the PLearn library. For more information on the PLearn
 // library, go to the PLearn Web site at www.plearn.org
 
-
- 
-
 /* *******************************************************      
  * $Id$
  * AUTHORS: Pascal Vincent &amp; Yoshua Bengio
  * This file is part of the PLearn library.
  ******************************************************* */
 
-
-/*! \file PLearnLibrary/PLearnCore/Func.h */
-
 #ifndef FUNCTION_INC
 #define FUNCTION_INC
 
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;plearn/base/general.h&gt;
 #include &lt;plearn/base/PP.h&gt;
 #include &lt;plearn/math/TMat.h&gt;

Modified: trunk/plearn/var/GaussianProcessNLLVariable.cc
===================================================================
--- trunk/plearn/var/GaussianProcessNLLVariable.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/var/GaussianProcessNLLVariable.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -39,10 +39,10 @@
 #define PL_LOG_MODULE_NAME &quot;GaussianProcessNLLVariable&quot;
 
 // From PLearn
+#include &quot;GaussianProcessNLLVariable.h&quot;
 #include &lt;plearn/io/pl_log.h&gt;
 #include &lt;plearn/math/TMat_maths.h&gt;
 #include &lt;plearn/io/MatIO.h&gt;
-#include &quot;GaussianProcessNLLVariable.h&quot;
 
 #ifdef USE_BLAS_SPECIALISATIONS
 #include &lt;plearn/math/plapack.h&gt;

Modified: trunk/plearn/var/VarArray.h
===================================================================
--- trunk/plearn/var/VarArray.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/var/VarArray.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -46,9 +46,9 @@
 #ifndef VARARRAY_INC
 #define VARARRAY_INC
 
+#include &quot;Variable.h&quot;
 #include &lt;plearn/base/general.h&gt;
 #include &lt;plearn/base/Array.h&gt;
-#include &quot;Variable.h&quot;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn/var/VarMeasurer.h
===================================================================
--- trunk/plearn/var/VarMeasurer.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/var/VarMeasurer.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -43,8 +43,8 @@
 #ifndef VARMEASURER_INC
 #define VARMEASURER_INC
 
+#include &quot;Var.h&quot;
 #include &lt;plearn/measure/Measurer.h&gt;
-#include &quot;Var.h&quot;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn/var/Variable.h
===================================================================
--- trunk/plearn/var/Variable.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/var/Variable.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -44,8 +44,8 @@
 #ifndef Variable_INC
 #define Variable_INC
 
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;plearn/math/TMat.h&gt;
-#include &lt;plearn/base/Object.h&gt;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn/vmat/CompressedVMatrix.cc
===================================================================
--- trunk/plearn/vmat/CompressedVMatrix.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/CompressedVMatrix.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -38,8 +38,8 @@
  * $Id$
  ******************************************************* */
 
+#include &quot;CompressedVMatrix.h&quot;
 #include &lt;plearn/math/VecCompressor.h&gt;
-#include &quot;CompressedVMatrix.h&quot;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn/vmat/DictionaryVMatrix.h
===================================================================
--- trunk/plearn/vmat/DictionaryVMatrix.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/DictionaryVMatrix.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -56,9 +56,6 @@
 namespace PLearn {
 using namespace std;
 
-// Forward declaration.
-class PythonCodeSnippet;
-
 //! VMat of text files, encoded  with Dictionaries,
 //! The lines of the text files that are empty are ommited. If no Dictionary
 //! objects are given by the user, then new Dictionary objects

Modified: trunk/plearn/vmat/KNNVMatrix.cc
===================================================================
--- trunk/plearn/vmat/KNNVMatrix.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/KNNVMatrix.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -40,8 +40,8 @@
 
 /*! \file KNNVMatrix.cc */
 
+#include &lt;plearn/ker/DistanceKernel.h&gt;
 #include &lt;plearn/base/tostring.h&gt;
-#include &lt;plearn/ker/DistanceKernel.h&gt;
 #include &quot;KNNVMatrix.h&quot;
 #include &quot;SelectRowsVMatrix.h&quot;
 #include &quot;SubVMatrix.h&quot;

Modified: trunk/plearn/vmat/RepeatSplitter.cc
===================================================================
--- trunk/plearn/vmat/RepeatSplitter.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/RepeatSplitter.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -38,8 +38,8 @@
 
 /*! \file RepeatSplitter.cc */
 
+#include &quot;RepeatSplitter.h&quot;
 #include &lt;plearn/math/random.h&gt;
-#include &quot;RepeatSplitter.h&quot;
 #include &quot;SelectRowsVMatrix.h&quot;
 
 namespace PLearn {

Modified: trunk/plearn/vmat/VMat.h
===================================================================
--- trunk/plearn/vmat/VMat.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/VMat.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -47,11 +47,11 @@
 #ifndef VMat_INC
 #define VMat_INC
 
+#include &quot;VMatrix.h&quot;
 //#include &lt;cstdlib&gt;
 #include &lt;plearn/base/PP.h&gt;
 #include &lt;plearn/math/TMat.h&gt;
 //#include &quot;VMField.h&quot;
-#include &quot;VMatrix.h&quot;
 #include &quot;VVec.h&quot;
 
 namespace PLearn {

Modified: trunk/plearn/vmat/VMatLanguage.cc
===================================================================
--- trunk/plearn/vmat/VMatLanguage.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/VMatLanguage.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -1400,16 +1400,16 @@
 
 void  PreprocessingVMatrix::getNewRow(int i, const Vec&amp; v) const
 {
-    program.run(i,v);
+    program-&gt;run(i,v);
 }
 
 PLEARN_IMPLEMENT_OBJECT(PreprocessingVMatrix, &quot;DEPRECATED: use ProcessingVMatrix instead&quot;, &quot;NO HELP&quot;);
 
 
 PreprocessingVMatrix::PreprocessingVMatrix(VMat the_source, const string&amp; program_string)
-    : source(the_source), program(the_source)
+    : source(the_source), program(new VMatLanguage(the_source))
 {
-    program.compileString(program_string,fieldnames);
+    program-&gt;compileString(program_string,fieldnames);
     build();
 }
 

Modified: trunk/plearn/vmat/VMatLanguage.h
===================================================================
--- trunk/plearn/vmat/VMatLanguage.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/VMatLanguage.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -173,7 +173,7 @@
 
 protected:
     VMat source;
-    VMatLanguage program;
+    PP&lt;VMatLanguage&gt; program;
     Vec sourcevec;
     vector&lt;string&gt; fieldnames;
 

Modified: trunk/plearn/vmat/VMat_basic_stats.cc
===================================================================
--- trunk/plearn/vmat/VMat_basic_stats.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/VMat_basic_stats.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -41,7 +41,7 @@
 
 /*! \file VMat_basic_stats.cc */
 
-
+#include &lt;plearn/base/Object.h&gt;
 #include &quot;VMat_basic_stats.h&quot;
 //#include &quot;VMat.h&quot;
 #include &quot;MemoryVMatrix.h&quot;

Modified: trunk/plearn/vmat/VMat_computeNearestNeighbors.cc
===================================================================
--- trunk/plearn/vmat/VMat_computeNearestNeighbors.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/VMat_computeNearestNeighbors.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -41,6 +41,7 @@
 /*! \file VMat_computeNearestNeighbors.cc */
 
 
+#include &lt;plearn/base/Object.h&gt;
 #include &quot;VMat_computeNearestNeighbors.h&quot;
 #include &lt;plearn/vmat/VMat.h&gt;
 #include &lt;plearn/math/BottomNI.h&gt;

Modified: trunk/plearn/vmat/VMat_computeStats.cc
===================================================================
--- trunk/plearn/vmat/VMat_computeStats.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/VMat_computeStats.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -41,6 +41,7 @@
 /*! \file VMat_computeStats.cc */
 
 
+#include &lt;plearn/base/Object.h&gt;
 #include &quot;VMat_computeStats.h&quot;
 #include &lt;plearn/vmat/VMat.h&gt;
 #include &lt;plearn/math/StatsCollector.h&gt;

Modified: trunk/plearn/vmat/VMat_linalg.cc
===================================================================
--- trunk/plearn/vmat/VMat_linalg.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/VMat_linalg.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -42,6 +42,7 @@
 
 
 // From PLearn
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;plearn/base/ProgressBar.h&gt;
 #include &quot;VMat_linalg.h&quot;
 #include &lt;plearn/math/TMat_maths.h&gt;

Modified: trunk/plearn/vmat/VMat_operations.cc
===================================================================
--- trunk/plearn/vmat/VMat_operations.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/VMat_operations.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -41,8 +41,8 @@
 /*! \file VMat_operations.cc */
 
 
+#include &quot;VMat.h&quot;
 #include &quot;VMat_operations.h&quot;
-#include &quot;VMat.h&quot;
 #include &lt;plearn/math/random.h&gt;
 #include &lt;plearn/io/TmpFilenames.h&gt;
 #include &lt;plearn/io/IntVecFile.h&gt;

Modified: trunk/plearn/vmat/VMatrix.cc
===================================================================
--- trunk/plearn/vmat/VMatrix.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/VMatrix.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -51,6 +51,7 @@
 #include &lt;plearn/io/fileutils.h&gt;     //!&lt; For isfile()
 #include &lt;plearn/io/load_and_save.h&gt;
 #include &lt;plearn/math/random.h&gt;      //!&lt; For uniform_multinomial_sample()
+#include &lt;plearn/base/RemoteDeclareMethod.h&gt;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn/vmat/VMatrix.h
===================================================================
--- trunk/plearn/vmat/VMatrix.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/VMatrix.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -44,6 +44,7 @@
 #define VMatrix_INC
 
 //#include &lt;cstdlib&gt;
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;map&gt;
 #include &lt;plearn/base/PP.h&gt;
 #include &lt;plearn/math/TMat.h&gt;

Modified: trunk/plearn/vmat/VVMatrix.cc
===================================================================
--- trunk/plearn/vmat/VVMatrix.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn/vmat/VVMatrix.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -37,6 +37,7 @@
  * This file is part of the PLearn library.
  ******************************************************* */
 
+#include &lt;plearn/base/Object.h&gt;
 #include &lt;plearn/db/getDataSet.h&gt;
 #include &lt;plearn/io/IntVecFile.h&gt;
 #include &lt;plearn/math/random.h&gt;

Modified: trunk/plearn_learners/generic/PLearner.cc
===================================================================
--- trunk/plearn_learners/generic/PLearner.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn_learners/generic/PLearner.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -56,6 +56,7 @@
 #include &lt;plearn/misc/RemotePLearnServer.h&gt;
 #endif
 #include &lt;plearn/vmat/PLearnerOutputVMatrix.h&gt;
+#include &lt;plearn/base/RemoteDeclareMethod.h&gt;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn_learners/generic/VPLPreprocessedLearner.cc
===================================================================
--- trunk/plearn_learners/generic/VPLPreprocessedLearner.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn_learners/generic/VPLPreprocessedLearner.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -163,14 +163,16 @@
 
     deepCopyField(learner_, copies);    
 
-    // deepCopyField(row_prg, copies);
-    // deepCopyField(input_prg, copies);
-    // deepCopyField(output_prg, copies);
-    // deepCopyField(costs_prg, copies);
+    deepCopyField(row_prg, copies);
+    deepCopyField(input_prg, copies);
+    deepCopyField(output_prg, copies);
+    deepCopyField(costs_prg, copies);
+/*
     row_prg.makeDeepCopyFromShallowCopy(copies);
     input_prg.makeDeepCopyFromShallowCopy(copies);
     output_prg.makeDeepCopyFromShallowCopy(copies);
     costs_prg.makeDeepCopyFromShallowCopy(copies);
+*/
  
     deepCopyField(row_prg_fieldnames, copies); 
     deepCopyField(input_prg_fieldnames, copies);
@@ -199,7 +201,7 @@
 
 int VPLPreprocessedLearner::outputsize() const
 {
-    if(output_prg)
+    if(output_prg &amp;&amp; *output_prg)
         return output_prg_fieldnames.length();
     else
     {
@@ -233,10 +235,12 @@
 {
     PLASSERT( learner_ );
 
+    if(!row_prg) 
+        row_prg= new VMatLanguage();
     if(trainset_preproc!=&quot;&quot;)
     {
-        row_prg.setSource(training_set);
-        row_prg.compileString(trainset_preproc, row_prg_fieldnames);
+        row_prg-&gt;setSource(training_set);
+        row_prg-&gt;compileString(trainset_preproc, row_prg_fieldnames);
         int newinputsize = row_prg_fieldnames.length()-(newtargetsize+newweightsize+newextrasize);
         VMat processed_trainset = new ProcessingVMatrix(training_set, trainset_preproc);
         processed_trainset-&gt;defineSizes(newinputsize,newtargetsize,newweightsize,newextrasize);
@@ -244,7 +248,7 @@
     }
     else
     {
-        row_prg.clear();
+        row_prg-&gt;clear();
         row_prg_fieldnames.resize(0);
         learner_-&gt;setTrainingSet(training_set, false);
     }
@@ -255,42 +259,48 @@
         learner_-&gt;build();
     inherited::setTrainingSet(training_set, call_forget); // will call forget if needed
 
+    if(!input_prg) 
+        input_prg= new VMatLanguage();
     if(input_preproc!=&quot;&quot;)
     {
         int insize = training_set-&gt;inputsize();
         TVec&lt;string&gt; infieldnames = training_set-&gt;fieldNames().subVec(0,insize);
-        input_prg.setSourceFieldNames(infieldnames);
-        input_prg.compileString(input_preproc, input_prg_fieldnames);
+        input_prg-&gt;setSourceFieldNames(infieldnames);
+        input_prg-&gt;compileString(input_preproc, input_prg_fieldnames);
     }
     else
     {
-        input_prg.clear();
+        input_prg-&gt;clear();
         input_prg_fieldnames.resize(0);
     }
 
+    if(!output_prg) 
+        output_prg= new VMatLanguage();
     if(output_postproc!=&quot;&quot;)
     {
         int outsize = learner_-&gt;outputsize();
         TVec&lt;string&gt; outfieldnames(outsize);
         for(int k=0; k&lt;outsize; k++)
             outfieldnames[k] = &quot;output&quot;+tostring(k);
-        output_prg.setSourceFieldNames(outfieldnames);
-        output_prg.compileString(output_postproc, output_prg_fieldnames);
+        output_prg-&gt;setSourceFieldNames(outfieldnames);
+        output_prg-&gt;compileString(output_postproc, output_prg_fieldnames);
     }
     else
     {
-        output_prg.clear();
+        output_prg-&gt;clear();
         output_prg_fieldnames.resize(0);
     }
 
+    if(!costs_prg) 
+        costs_prg= new VMatLanguage();
     if(costs_postproc!=&quot;&quot;)
     {
-        costs_prg.setSourceFieldNames(learner_-&gt;getTestCostNames());
-        costs_prg.compileString(costs_postproc, costs_prg_fieldnames);
+        costs_prg-&gt;setSourceFieldNames(learner_-&gt;getTestCostNames());
+        costs_prg-&gt;compileString(costs_postproc, costs_prg_fieldnames);
     }
     else
     {
-        costs_prg.clear();
+        costs_prg-&gt;clear();
         costs_prg_fieldnames.resize(0);
     }
 }
@@ -301,19 +311,19 @@
     PLASSERT( learner_ );
     output.resize(outputsize());
     Vec newinput = input;
-    if(input_prg)
+    if(input_prg &amp;&amp; *input_prg)
     {
         processed_input.resize(input_prg_fieldnames.length());
-        input_prg.run(input, processed_input);
+        input_prg-&gt;run(input, processed_input);
         newinput = processed_input;
     }
 
-    if(output_prg)
+    if(output_prg &amp;&amp; *output_prg)
     {
         learner_-&gt;computeOutput(newinput, pre_output);
-        output_prg.setMemory(input);           // Put original input vector
+        output_prg-&gt;setMemory(input);           // Put original input vector
         // as context for output postproc
-        output_prg.run(pre_output, output);
+        output_prg-&gt;run(pre_output, output);
     }
     else
         learner_-&gt;computeOutput(newinput, output);
@@ -332,7 +342,7 @@
     PLASSERT(ilen==inputsize());
     PLASSERT(tlen==targetsize());
 
-    if(row_prg)
+    if(row_prg &amp;&amp; *row_prg)
     {
         row.resize(ilen+tlen);
         row.subVec(0,ilen) &lt;&lt; input;
@@ -342,7 +352,7 @@
 
         int newrowsize = row_prg_fieldnames.length();
         processed_row.resize(newrowsize);
-        row_prg.run(row, processed_row);
+        row_prg-&gt;run(row, processed_row);
         int newinputsize = newrowsize-(newtargetsize+newweightsize+newextrasize);
         Vec processed_input = processed_row.subVec(0,newinputsize);
         Vec processed_target = processed_row.subVec(newinputsize,newtargetsize);
@@ -351,16 +361,16 @@
     else
         learner_-&gt;computeOutputAndCosts(input, target, pre_output, pre_costs);
 
-    if(output_prg) {
-        output_prg.setMemory(input);           // Put original input vector
+    if(output_prg &amp;&amp; *output_prg) {
+        output_prg-&gt;setMemory(input);           // Put original input vector
         // as context for output postproc
-        output_prg.run(pre_output, output);
+        output_prg-&gt;run(pre_output, output);
     }
     else
         output &lt;&lt; pre_output;
 
-    if(costs_prg)
-        costs_prg.run(pre_costs, costs);
+    if(costs_prg &amp;&amp; *costs_prg)
+        costs_prg-&gt;run(pre_costs, costs);
     else
         costs &lt;&lt; pre_costs;
 }
@@ -383,15 +393,15 @@
 
     PLASSERT( learner_ );
     Vec newinput = input;
-    if(input_prg)
+    if(input_prg &amp;&amp; *input_prg)
     {
         processed_input.resize(input_prg_fieldnames.length());
-        input_prg.run(input, processed_input);
+        input_prg-&gt;run(input, processed_input);
         newinput = processed_input;
     }
 
     bool status = false;
-    if(!output_prg) // output is already the output of the underlying learner
+    if(!output_prg || !(*output_prg)) // output is already the output of the underlying learner
         status = learner_-&gt;computeConfidenceFromOutput(newinput, output, probability, intervals);
     else // must recompute the output of underlying learner, and post-process returned intervals
     {
@@ -420,12 +430,12 @@
             Vec post_high(d); // postprocessed high
 
             // Put original input vector as context for output postproc
-            output_prg.setMemory(input);
-            output_prg.run(low, post_low);
+            output_prg-&gt;setMemory(input);
+            output_prg-&gt;run(low, post_low);
 
             // Put original input vector as context for output postproc
-            output_prg.setMemory(input);
-            output_prg.run(high, post_high);
+            output_prg-&gt;setMemory(input);
+            output_prg-&gt;run(high, post_high);
 
             // Now copy post_low and post_high to intervals
             intervals.resize(d);
@@ -438,7 +448,7 @@
 
 TVec&lt;string&gt; VPLPreprocessedLearner::getOutputNames() const
 {
-    if(output_prg)
+    if(output_prg &amp;&amp; *output_prg)
         return output_prg_fieldnames;
     else
         return learner_-&gt;getOutputNames();
@@ -447,7 +457,7 @@
 
 TVec&lt;string&gt; VPLPreprocessedLearner::getTestCostNames() const
 {
-    if(costs_prg)
+    if(costs_prg &amp;&amp; *costs_prg)
         return costs_prg_fieldnames;
     else
         return learner_-&gt;getTestCostNames();

Modified: trunk/plearn_learners/generic/VPLPreprocessedLearner.h
===================================================================
--- trunk/plearn_learners/generic/VPLPreprocessedLearner.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn_learners/generic/VPLPreprocessedLearner.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -63,10 +63,10 @@
     // *********************
 
     // ### declare protected option fields (such as learnt parameters) here
-    VMatLanguage row_prg;
-    VMatLanguage input_prg;
-    VMatLanguage output_prg;
-    VMatLanguage costs_prg;
+    PP&lt;VMatLanguage&gt; row_prg;
+    PP&lt;VMatLanguage&gt; input_prg;
+    PP&lt;VMatLanguage&gt; output_prg;
+    PP&lt;VMatLanguage&gt; costs_prg;
 
     TVec&lt;string&gt; row_prg_fieldnames; 
     TVec&lt;string&gt; input_prg_fieldnames;

Modified: trunk/plearn_learners/hyper/HyperOptimize.cc
===================================================================
--- trunk/plearn_learners/hyper/HyperOptimize.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn_learners/hyper/HyperOptimize.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -361,7 +361,120 @@
 
     return best_results;
 }
+/*
+void HyperOptimize::launchTest(int trialnum, PP&lt;RemotePLearnServer&gt; server,
+                               map&lt;PP&lt;RemotePLearnServer&gt;, int&gt;&amp; testers_ids)
+{
+    PP&lt;PTester&gt; tester= hlearner-&gt;tester;
 
+    string testerexpdir= &quot;&quot;;
+    if(expdir!=&quot;&quot; &amp;&amp; provide_tester_expdir)
+        testerexpdir = expdir / (&quot;Trials&quot;+tostring(trialnum)) / &quot;&quot;;
+    tester-&gt;setExperimentDirectory(testerexpdir);
+
+    PP&lt;Splitter&gt; default_splitter = tester-&gt;splitter;
+    if(splitter)  // set our own splitter
+        tester-&gt;splitter = splitter;
+
+    int id= testers_ids[server];
+    if(id &gt; 0) server-&gt;deleteObject(id);// delete prev. tester
+    id= server-&gt;newObject(tester);// send new tester
+    testers_ids[server]= id;
+    tester-&gt;splitter= default_splitter;// restore default splitter
+
+    server-&gt;callMethod(id, &quot;perform&quot;, false);
+}
+
+Vec HyperOptimize::parOptimize()
+{
+    real best_objective = REAL_MAX;
+    Vec best_results;
+    PP&lt;PLearner&gt; best_learner;
+
+    TVec&lt;string&gt; option_names;
+    option_names = oracle-&gt;getOptionNames();
+
+    TVec&lt;string&gt; option_vals = oracle-&gt;generateFirstTrial();
+    if (option_vals.size() != option_names.size())
+        PLERROR(&quot;HyperOptimize::optimize: the number of option values (%d) &quot;
+                &quot;does not match the number of option names (%d)&quot;,
+                option_vals.size(), option_names.size());
+
+    int trialnum = 0;
+
+    which_cost_pos= getResultNames().find(which_cost);
+    if(which_cost_pos &lt; 0)
+        which_cost_pos= toint(which_cost);
+
+    PLearnService&amp; service(PLearnService::instance());
+    int nservers= service.availableServers();
+    TVec&lt;PP&lt;RemotePLearnServer&gt; &gt; servers= service.reserveServers(nservers);
+    nservers= servers.length();
+    map&lt;PP&lt;RemotePLearnServer&gt;, int&gt; testers_ids;
+    map&lt;PP&lt;RemotePLearnServer&gt;, int&gt; trialnums;
+    for(int i= 0; i &lt; nservers; ++i)
+        testers_ids[servers[i]]= -1;//init.
+    int nworking= 0;
+
+    Vec results;
+    bool finished= false;
+    while(!finished)
+    {
+        map&lt;PP&lt;RemotePLearnServer&gt;, int&gt;::iterator it= testers_ids.find(-1);
+        if(option_vals &amp;&amp; it != testers_ids.end())
+        {
+            hlearner-&gt;setLearnerOptions(option_names, option_vals);
+            launchTest(trialnum, it-&gt;first, testers_ids);
+            ++nworking;
+            trialnums[it-&gt;first]= trialnum;
+            ++trialnum;
+            option_vals= 0;
+        }
+        else if(nworking &gt; 0)
+        {
+            PP&lt;RemotePLearnServer&gt; s= service.waitForResult();
+            s-&gt;getResults(results);
+            --nworking;
+            testers_ids[s]= -1;
+            reportResult(trialnums[s], results);
+            real objective= results[which_cost_pos];
+
+            option_vals= oracle-&gt;generateNextTrial(option_vals,objective);
+            
+            if(!is_missing(objective) &amp;&amp;
+               (objective &lt; best_objective || best_results.length()==0) &amp;&amp; (trialnum&gt;=min_n_trials || !option_vals))
+            {
+                best_objective = objective;
+                best_results = results;
+                CopiesMap copies;
+                best_learner = NULL;
+                best_learner = hlearner-&gt;getLearner()-&gt;deepCopy(copies);
+            }
+        }
+        else
+            finished= true;
+    }
+
+    // Detect the case where no trials at all were performed!
+    if (trialnum == 0)
+        PLWARNING(&quot;In HyperOptimize::optimize - No trials at all were completed;\n&quot;
+                  &quot;perhaps the oracle settings are wrong?&quot;);
+
+    // revert to best_learner
+    hlearner-&gt;setLearner(best_learner);
+
+    if (best_results.isEmpty())
+        // This could happen for instance if all results are NaN.
+        PLWARNING(&quot;In HyperOptimize::optimize - Could not find a best result, something &quot;
+                  &quot;must be wrong&quot;);
+    else
+        // report best result again, if not empty
+        reportResult(-1,best_results);
+
+    return best_results;
+}
+*/
+
 void HyperOptimize::makeDeepCopyFromShallowCopy(CopiesMap&amp; copies)
 {
     inherited::makeDeepCopyFromShallowCopy(copies);

Modified: trunk/plearn_learners/hyper/HyperOptimize.h
===================================================================
--- trunk/plearn_learners/hyper/HyperOptimize.h	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn_learners/hyper/HyperOptimize.h	2007-05-09 23:44:20 UTC (rev 7042)
@@ -156,6 +156,12 @@
     void reportResult(int trialnum,  const Vec&amp; results);
     Vec runTest(int trialnum);
 
+/*    
+    //! for parallel optimize
+    void launchTest(int trialnum, PP&lt;RemotePLearnServer&gt; server,
+                    map&lt;PP&lt;RemotePLearnServer&gt;, int&gt;&amp; testers_ids);
+*/
+
 public:
 
     //! Sets the expdir and calls createResultsMat.

Modified: trunk/plearn_learners/regressors/KNNRegressor.cc
===================================================================
--- trunk/plearn_learners/regressors/KNNRegressor.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn_learners/regressors/KNNRegressor.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -40,6 +40,7 @@
 
 /*! \file KNNRegressor.cc */
 
+#include &quot;KNNRegressor.h&quot;
 #include &lt;assert.h&gt;
 #include &lt;math.h&gt;
 
@@ -47,7 +48,6 @@
 #include &lt;plearn/math/TMat_maths.h&gt;
 #include &lt;plearn_learners/nearest_neighbors/ExhaustiveNearestNeighbors.h&gt;
 #include &lt;plearn/ker/EpanechnikovKernel.h&gt;
-#include &quot;KNNRegressor.h&quot;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn_learners/regressors/PLS.cc
===================================================================
--- trunk/plearn_learners/regressors/PLS.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn_learners/regressors/PLS.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -43,6 +43,7 @@
 #define PL_LOG_MODULE_NAME &quot;PLS&quot;
 
 // From PLearn
+#include &quot;PLS.h&quot;
 #include &lt;plearn/io/pl_log.h&gt;
 #include &lt;plearn/math/TMat_maths.h&gt;    //!&lt; For dist.
 #include &lt;plearn/math/pl_erf.h&gt;
@@ -50,7 +51,6 @@
 #include &lt;plearn/vmat/ShiftAndRescaleVMatrix.h&gt;
 #include &lt;plearn/vmat/SubVMatrix.h&gt;
 #include &lt;plearn/vmat/VMat_linalg.h&gt;
-#include &quot;PLS.h&quot;
 
 namespace PLearn {
 using namespace std;

Modified: trunk/plearn_learners/regressors/WPLS.cc
===================================================================
--- trunk/plearn_learners/regressors/WPLS.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn_learners/regressors/WPLS.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -40,8 +40,8 @@
 
 /*! \file WPLS.cc */
 
+#include &quot;WPLS.h&quot;
 #include &lt;plearn/math/plapack.h&gt;
-#include &quot;WPLS.h&quot;
 #include &lt;plearn/vmat/ShiftAndRescaleVMatrix.h&gt;
 #include &lt;plearn/vmat/SubVMatrix.h&gt;
 #include &lt;plearn/math/TMat_maths.h&gt;    //!&lt; For dist.

Modified: trunk/plearn_learners/testers/PTester.cc
===================================================================
--- trunk/plearn_learners/testers/PTester.cc	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/plearn_learners/testers/PTester.cc	2007-05-09 23:44:20 UTC (rev 7042)
@@ -45,6 +45,7 @@
 #include &lt;plearn/vmat/MemoryVMatrix.h&gt;
 #include &lt;assert.h&gt;
 #include &quot;PTester.h&quot;
+#include &lt;plearn/base/RemoteDeclareMethod.h&gt;
 
 #ifndef BUGGED_SERVER
 #include &lt;plearn/misc/PLearnService.h&gt;

Modified: trunk/pymake.config.model
===================================================================
--- trunk/pymake.config.model	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/pymake.config.model	2007-05-09 23:44:20 UTC (rev 7042)
@@ -416,7 +416,7 @@
   [ 'double', 'float' ],
   
   # [ 'throwerrors', 'exiterrors' ],
-  [ 'python23', 'python24', 'python25' ],
+  [ 'python23', 'python24', 'python25', 'nopython' ],
   
   [ 'blas', 'p3blas','p4blas','athlonblas','pentiumblas', 'mammouthblas',
     'noblas', 'veclib', 'scs', 'goto', 'lisa' ],
@@ -614,7 +614,10 @@
 pymakeOption( name = 'python25',
               description = 'the installed version of python is 2.5.X',
               cpp_definitions = ['PL_PYTHON_VERSION=250'] )
+pymakeOption( name = 'nopython',
+              description = 'compile w/o python')
 
+cpp_variables += ['PL_PYTHON_VERSION']
 
 #####  Error Behavior  ######################################################
 

Added: trunk/python_modules/plearn/pybridge/__init__.py
===================================================================

Added: trunk/python_modules/plearn/pybridge/embedded_code_snippet.py
===================================================================
--- trunk/python_modules/plearn/pybridge/embedded_code_snippet.py	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/python_modules/plearn/pybridge/embedded_code_snippet.py	2007-05-09 23:44:20 UTC (rev 7042)
@@ -0,0 +1,7 @@
+
+class EmbeddedCodeSnippet(object):
+    &quot;&quot;&quot;
+    Base class for embedded code snippets
+    (see PLEARNDIR/plearn/python/PythonCodeSnippet.{h|cc})
+    &quot;&quot;&quot;
+

Added: trunk/python_modules/plearn/pybridge/test_embedded_code_snippet.py
===================================================================
--- trunk/python_modules/plearn/pybridge/test_embedded_code_snippet.py	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/python_modules/plearn/pybridge/test_embedded_code_snippet.py	2007-05-09 23:44:20 UTC (rev 7042)
@@ -0,0 +1,85 @@
+
+from embedded_code_snippet import *
+import gc, sys
+
+class Bidule(EmbeddedCodeSnippet):
+    def __init__(self, **kwargs):
+        pass
+
+class Machin(EmbeddedCodeSnippet):
+    def __init__(self, **kwargs):
+        pass
+
+    def getN(self):
+        sys.setrecursionlimit(2999)
+        return 1999
+    
+    def test0(self):
+        l= self.getLearner()
+        l.setTrainingSet([[20,0,0,50,199],
+                          [36,1,0,45,121],
+                          [55,0,1,32,101]],
+                         False)
+        l.inputsize= 4
+        l.targetsize= 1
+        l.weightsize= 0
+        l.train()
+        print 'use result=',l.use2([[25,1,1,44],
+                                    [64,0,0,111]])
+        sys.stdout.flush()
+        l.save('linreg.psave','plearn_ascii')
+        self.chkObj(l)
+        l.nstages= self.getN()
+
+    def chkObj(self, o):
+        for opt in o._optionnames:
+            x= o.__getattr__(opt)
+            print opt, type(x), x
+            sys.stdout.flush()
+        print o
+        sys.stdout.flush()
+            
+    def testRec(self, n):
+        if n &lt;= 0:
+            print 'FINI!', gc.garbage
+            sys.stdout.flush()
+        else:
+            if n%100 == 0:
+                print &quot;testRec&quot;,n
+                sys.stdout.flush()
+            self.recTest(n-1)
+
+    def testRec2(self, l):
+        if l.nstages &lt;= 0:
+            print 'FINI!2', gc.garbage
+            sys.stdout.flush()
+        else:
+            if l.nstages%100 == 0:
+                print &quot;testRec2&quot;,l.nstages
+                sys.stdout.flush()
+            self.recTest2(l)
+
+    def testRecCrash(self, n):
+        if n &lt;= 0:
+            print 'FINI!', gc.garbage
+            sys.stdout.flush()
+            raise RuntimeError, 'Crash on purpose: test'
+        else:
+            print &quot;testRecCrash&quot;,n
+            sys.stdout.flush()
+            self.recTestCrash(n-1)
+
+    def fini(self):
+        gc.collect()
+        print &quot;self&quot;, len(gc.get_referrers(self))
+        print &quot;learner&quot;, len(gc.get_referrers(self.getLearner()))
+        print &quot;testRec&quot;, len(gc.get_referrers(self.testRec))
+        print &quot;recTest&quot;, len(gc.get_referrers(self.recTest))
+        print &quot;1010&quot;, len(gc.get_referrers(1010))
+        sys.stdout.flush()
+        
+    def getRecTestReferrers(self):
+        gc.collect()
+        return gc.get_referrers(self.recTest)
+
+pl_embedded_code_snippet_type= Machin

Added: trunk/python_modules/plearn/pybridge/wrapped_plearn_object.py
===================================================================
--- trunk/python_modules/plearn/pybridge/wrapped_plearn_object.py	2007-05-09 23:41:30 UTC (rev 7041)
+++ trunk/python_modules/plearn/pybridge/wrapped_plearn_object.py	2007-05-09 23:44:20 UTC (rev 7042)
@@ -0,0 +1,30 @@
+
+class WrappedPLearnObject(object):
+
+    def __init__(self, cptr):
+        self._cptr= cptr # ptr to c++ obj
+    
+    def __setattr__(self, attr, val):
+        if attr != '_optionnames' and attr in self._optionnames:
+            self.changeOptions({attr: str(val)})
+        else:
+            object.__setattr__(self, attr, val)
+
+    def __getattr__(self, attr):
+        if attr in self._optionnames:
+            return self.getOption(attr)
+        else:
+            raise AttributeError, (&quot;no attribute &quot;
+                                   + attr + &quot; in &quot;
+                                   + repr(self))
+        
+    def __del__(self):
+        return self.unref()
+
+    def __repr__(self):
+        #s= self.__class__.__name__ + '('
+        #s+= ', '.join([o+'= '+repr(self.__getattr__(o))
+        #               for o in self._optionnames])
+        #s+= ')'
+        #return s
+        return self.asString() #PLearn repr. for now


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000490.html">[Plearn-commits] r7041 - trunk/plearn/math
</A></li>
	<LI>Next message: <A HREF="000492.html">[Plearn-commits] r7043 - trunk/plearn_learners/online
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#491">[ date ]</a>
              <a href="thread.html#491">[ thread ]</a>
              <a href="subject.html#491">[ subject ]</a>
              <a href="author.html#491">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/plearn-commits">More information about the Plearn-commits
mailing list</a><br>
</body></html>
